<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Cleartrack - User Dashboard</title>
    <link rel="icon" type="image/png" href="assets/images/icon%20logo.png">
    
    <!-- PWA Features - Only on app.cleartrack.co.za -->
    <script>
      (function() {
        if (window.location.hostname === 'app.cleartrack.co.za') {
          // Use DOM manipulation instead of document.write to prevent blocking
          const head = document.head || document.getElementsByTagName('head')[0];
          
          // Manifest
          const manifest = document.createElement('link');
          manifest.rel = 'manifest';
          manifest.href = '/manifest.json';
          head.appendChild(manifest);
          
          // Theme color
          const themeColor = document.createElement('meta');
          themeColor.name = 'theme-color';
          themeColor.content = '#0b7285';
          head.appendChild(themeColor);
          
          // Apple Touch Icons
          const iconSizes = [72, 96, 128, 144, 152, 192, 384, 512];
          iconSizes.forEach(size => {
            const icon = document.createElement('link');
            icon.rel = 'apple-touch-icon';
            icon.sizes = size + 'x' + size;
            icon.href = '/icons/cleartrack-' + size + '.png';
            head.appendChild(icon);
          });
          
          // PWA Meta Tags
          const metaTags = [
            { name: 'apple-mobile-web-app-capable', content: 'yes' },
            { name: 'apple-mobile-web-app-status-bar-style', content: 'default' },
            { name: 'apple-mobile-web-app-title', content: 'ClearTrack' },
            { name: 'mobile-web-app-capable', content: 'yes' }
          ];
          metaTags.forEach(tag => {
            const meta = document.createElement('meta');
            meta.name = tag.name;
            meta.content = tag.content;
            head.appendChild(meta);
          });
          
          // iOS Splash Screens
          const splashScreens = [
            { media: '(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-iphone-se.png' },
            { media: '(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-iphone-se.png' },
            { media: '(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-iphone-xr.png' },
            { media: '(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)', href: '/splash/splash-iphone-xs.png' },
            { media: '(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)', href: '/splash/splash-iphone-12.png' },
            { media: '(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)', href: '/splash/splash-iphone-14-pro.png' },
            { media: '(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)', href: '/splash/splash-iphone-8-plus.png' },
            { media: '(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)', href: '/splash/splash-iphone-xs-max.png' },
            { media: '(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)', href: '/splash/splash-iphone-12-pro-max.png' },
            { media: '(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)', href: '/splash/splash-iphone-14-pro-max.png' },
            { media: '(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-ipad-mini.png' },
            { media: '(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-ipad.png' },
            { media: '(device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-ipad-air.png' },
            { media: '(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-ipad-pro-11.png' },
            { media: '(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)', href: '/splash/splash-ipad-pro-12.png' }
          ];
          splashScreens.forEach(screen => {
            const link = document.createElement('link');
            link.rel = 'apple-touch-startup-image';
            link.media = screen.media;
            link.href = screen.href;
            head.appendChild(link);
          });
        }
      })();
    </script>
    
    <!-- Service Worker Registration - Only on app.cleartrack.co.za -->
    <script>
      if (window.location.hostname === 'app.cleartrack.co.za') {
        var script = document.createElement('script');
        script.src = '/sw-register.js';
        document.head.appendChild(script);
      }
    </script>
    
    <!-- CRITICAL: Define handleNavClick in head so it's available immediately -->
    <script>
      window.handleNavClick = function(sectionName, event) {
        if (event) {
          event.preventDefault();
        }
        
        // ALWAYS close mobile menu first
        const nav = document.getElementById("nav-style6");
        const toggle = document.querySelector(".menu-toggle-style6");
        if (nav && nav.classList.contains("active")) {
          nav.classList.remove("active");
          if (toggle) toggle.classList.remove("active");
        }
        
        const clickedLink = event ? (event.target || event.currentTarget) : null;
        if (window.showSection) { 
          window.showSection(sectionName); 
        } else {
          // Fallback if showSection not loaded yet
          document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
          const t = document.getElementById(sectionName); 
          if (t) t.classList.remove("hidden");
        }
        
        // Update active state for ALL nav links (both desktop .nav a and mobile .nav-style6 a)
        document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
          link.classList.remove('active');
        });
        
        // Activate the clicked link
        if (clickedLink) {
          const link = clickedLink.closest('.nav-link') || clickedLink.closest('a');
          if (link) {
            link.classList.add('active');
            
            // Also activate corresponding link in the other nav by matching onclick attribute
            const clickedOnclick = link.getAttribute('onclick');
            if (clickedOnclick) {
              document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(navLink => {
                if (navLink.getAttribute('onclick') === clickedOnclick) {
                  navLink.classList.add('active');
                }
              });
            }
          }
        } else {
          // Fallback: find link by section name
          document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
            const onclick = link.getAttribute('onclick');
            if (onclick && onclick.includes("'" + sectionName + "'")) {
              link.classList.add('active');
            }
          });
        }
      };
      
      // Style 6 Mobile Menu Functions - EXACT FROM REFERENCE
      window.toggleMenu = function(style) {
        const nav = document.getElementById(`nav-${style}`);
        const toggle = document.querySelector(`.menu-toggle-${style}`);
        
        if (nav) {
          nav.classList.toggle('active');
        }
        if (toggle) {
          toggle.classList.toggle('active');
        }
      };
    </script>
    
    <link rel="stylesheet" href="global-styles.css">
    <link rel="stylesheet" href="whatsapp-messaging.css">
    <link rel="stylesheet" href="responsive-fixes.css">
    <link rel="stylesheet" href="css/ct-theme.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e5f3f7;
            color: #333;
        }
        
        /* ============================================
           HEADER CONTAINER - Desktop Base Styles
           ============================================ */
        .header {
            background: #0b7285;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        
        /* ============================================
           HEADER TOP SECTION
           ============================================ */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2.5rem;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* ============================================
           LOGOUT BUTTON - DESKTOP POSITIONING
           ============================================ */
        #desktopLogoutBtn {
            display: block;
            margin-left: auto;
        }
        
        /* ============================================
           LOGO
           ============================================ */
        .header .logo {
            display: flex;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .header .logo img {
            height: 48px;
            width: auto;
            filter: brightness(0) invert(1);
            display: block;
        }
        
        /* ============================================
           NAVIGATION
           ============================================ */
        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
            justify-content: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            width: 100%;
            box-sizing: border-box;
        }
        
        .nav a {
            text-decoration: none;
            color: #e0fbff;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
        }
        
        .nav a::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 0;
            width: 0;
            height: 2px;
            background: #ffffff;
            transition: width 0.3s ease;
        }
        
        .nav a:hover::after,
        .nav a.active::after {
            width: 100%;
        }
        
        .nav a:hover,
        .nav a.active {
            color: #ffffff;
        }
        
        /* ============================================
           MENU TOGGLE BUTTON (Style 6)
           ============================================ */
        .menu-toggle-style6 {
            display: none;
            background: transparent;
            border: none;
            color: #e0fbff;
            cursor: pointer;
            font-size: 1.3rem;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            transition: transform 0.3s ease;
            padding: 0;
        }
        
        .menu-toggle-style6:hover {
            transform: scale(1.1);
        }
        
        .menu-toggle-style6.active {
            transform: rotate(90deg);
        }
        
        /* ============================================
           NAVIGATION (nav-style6) - Desktop Base Styles
           ============================================ */
        .nav-style6 {
            /* Desktop: horizontal navigation bar */
            display: flex;
            gap: 2rem;
            align-items: center;
            justify-content: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            width: 100%;
            box-sizing: border-box;
            position: static;
        }
        
        .nav-style6 a {
            color: #e0fbff;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
            padding: 0.5rem 0;
            display: inline-block;
        }
        
        .nav-style6 a::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 0;
            width: 0;
            height: 2px;
            background: #ffffff;
            transition: width 0.3s ease;
        }
        
        .nav-style6 a:hover::after,
        .nav-style6 a.active::after {
            width: 100%;
        }
        
        .nav-style6 a:hover,
        .nav-style6 a.active {
            color: #ffffff;
        }
        
        /* ============================================
           DESKTOP STYLES (min-width: 769px)
           ============================================ */
        @media (min-width: 769px) {
            /* Hide mobile menu toggle on desktop */
            .menu-toggle-style6 {
                display: none;
            }
            
            /* Desktop: nav-style6 is horizontal nav bar (already styled above) */
        }
        
        /* ============================================
           MOBILE STYLES (max-width: 768px) - STYLE 6 EXACT COPY
           ============================================ */
        @media (max-width: 768px) {
            /* STYLE 6: Header - EXACT COPY from hamburger-menu-styles.html */
            .header {
                background: #0b7285;
                color: #fff;
                padding: 1rem 1.5rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: relative;
            }
            
            /* STYLE 6: Header-top - flex container for logo and hamburger */
            .header-top {
                padding: 0 !important;
                display: flex !important;
                align-items: center;
                justify-content: space-between !important;
                width: 100%;
                position: static !important;
            }
            
            /* STYLE 6: Logo becomes brand-style6 - EXACT (left side) */
            /* Must override desktop absolute positioning to participate in flexbox */
            .header .logo {
                font-weight: 700;
                font-size: 1.2rem;
                position: static !important;
                left: auto !important;
                right: auto !important;
                transform: none !important;
                display: flex !important;
                align-items: center;
            }
            
            /* Increase logo image size on mobile - maintain aspect ratio */
            .header .logo img {
                height: 44px !important;
                width: auto !important;
                max-width: none !important;
                object-fit: contain !important;
            }
            
            /* STYLE 6: Hide logout on mobile */
            #desktopLogoutBtn {
                display: none !important;
            }
            
            /* STYLE 6: Menu toggle - EXACT COPY (right side) - Increased size */
            .menu-toggle-style6 {
                background: transparent;
                border: none;
                color: #e0fbff;
                cursor: pointer;
                font-size: 1.6rem;
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                transition: transform 0.3s ease;
            }
            
            .menu-toggle-style6:hover {
                transform: scale(1.1);
            }
            
            .menu-toggle-style6.active {
                transform: rotate(90deg);
            }
            
            /* STYLE 6: Navigation dropdown - EXACT COPY from hamburger-menu-styles.html */
            /* Reset ALL desktop styles and apply Style 6 dropdown */
            .nav-style6 {
                /* Reset desktop styles */
                display: block;
                gap: 0;
                align-items: stretch;
                justify-content: flex-start;
                padding: 0;
                background: white;
                border-top: none;
                width: auto;
                box-sizing: border-box;
                
                /* Style 6 dropdown styles */
                position: absolute;
                top: calc(100% + 0.5rem);
                right: 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                min-width: 220px;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease, opacity 0.3s ease;
                opacity: 0;
                z-index: 1000;
            }
            
            .nav-style6.active {
                max-height: 500px;
                opacity: 1;
                display: flex;
                flex-direction: column;
            }
            
            /* Reset desktop link styles and apply Style 6 link styles */
            .nav-style6 a {
                color: #1f2933;
                text-decoration: none;
                padding: 0.75rem 1.25rem;
                display: block;
                font-size: 0.95rem;
                transition: all 0.2s;
                font-weight: normal;
                position: static;
                width: auto;
            }
            
            .nav-style6 a::after {
                display: none;
            }
            
            .nav-style6 a:hover {
                background: #f5f7fa;
                color: #0b7285;
                padding-left: 1.5rem;
            }
            
            .nav-style6 a.active {
                background: #e0f7fb;
                color: #0b7285;
                font-weight: 600;
            }
            
            .nav-style6 a:first-child {
                border-radius: 12px 12px 0 0;
            }
            
            .nav-style6 a:last-child {
                border-radius: 0 0 12px 12px;
            }
        }
        
        /* ============================================
           SMALL MOBILE STYLES (max-width: 480px)
           ============================================ */
        @media (max-width: 480px) {
            /* Adjust dropdown position for smaller screens */
            .nav-style6.active {
                right: 0.75rem !important;
                min-width: 200px !important;
            }
            
            /* Slightly smaller text and padding for compact mobile */
            .nav-style6 a {
                font-size: 0.9rem;
                padding: 0.625rem 1rem;
            }
        }
        
        /* ============================================
           USER MENU
           ============================================ */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .main {
                padding: 1rem;
            }
        }
        
        /* Clickable Tiles */
        .clickable-tile {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .clickable-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .clickable-tile:active {
            transform: translateY(0);
        }
        
        .clickable-tile::after {
            content: 'â†’';
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 1.2rem;
            color: #6b7280;
        }
        
        .clickable-tile:hover::after {
            opacity: 1;
        }
        
        /* Edit mode styling */
        .edit-mode .modal-title {
            color: #0b7285;
        }
        
        .edit-mode .btn-primary {
            background-color: #0b7285;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0b7285;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            z-index: 10;
        }
        
        .btn-primary {
            background: #0b7285;
            color: white;
        }
        
        .btn-primary:hover {
            background: #095a69;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        
        /* Clean Drag & Drop Styles */
        .file-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafafa;
        }
        
        .file-drop-zone:hover,
        .file-drop-zone.drag-active {
            border-color: #0b7285;
            background: #f0f9ff;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .drop-zone-icon {
            font-size: 2.5rem;
            color: #6b7280;
        }
        
        .drop-zone-text {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .drop-zone-primary {
            font-size: 1rem;
            font-weight: 500;
            color: #374151;
        }
        
        .drop-zone-secondary {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        /* Combobox Styles */
        .combobox-container {
            position: relative;
        }
        
        .combobox-container input[list] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .combobox-container input[list]:focus {
            outline: none;
            border-color: #0b7285;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .combobox-container input[list]:hover {
            border-color: #9ca3af;
        }
        
        /* Scan Options Styles */
        .scan-options {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: center;
        }
        
        .scan-options .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .scan-options .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .scan-options .btn:active {
            transform: translateY(0);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .table tbody tr:hover {
            background: #f9fafb;
        }
        
        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafbfc;
            position: relative;
            overflow: hidden;
        }
        
        .file-upload:hover {
            border-color: #2563eb;
            background-color: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }
        
        .file-upload.drag-over {
            border-color: #10b981;
            background-color: #f0fdf4;
            border-style: solid;
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .file-upload-icon {
            font-size: 3rem;
            opacity: 0.6;
        }
        
        .file-upload-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .file-upload-primary {
            color: #374151;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .file-upload-secondary {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .selected-files-list {
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        
        .selected-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f3f4f6;
            font-weight: 500;
            color: #374151;
        }
        
        .btn-clear-files {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .btn-clear-files:hover {
            background: #b91c1c;
        }
        
        .selected-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .selected-file-item:last-child {
            border-bottom: none;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .file-icon {
            font-size: 1.25rem;
        }
        
        .file-details {
            display: flex;
            flex-direction: column;
        }
        
        .file-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .file-size {
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .file-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .file-remove:hover {
            background: #dc2626;
        }
        
        .upload-progress {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
        }
        
        .upload-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1e40af;
        }
        
        .upload-progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0b7285, #095a69);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .modal-close:hover {
            color: #374151;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Ensure sections with .hidden class are always hidden, even if they have other display rules */
        .section.hidden {
            display: none !important;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid;
        }
        
        .alert-success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }
        
        .alert-error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }
        
        .alert-info {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: #1e40af;
        }
        
        /* Vehicle Acquisition Type Styles */
        .vehicle-acquisition-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .vehicle-acquisition-type {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .checkbox-row {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 0.875rem;
            padding: 1rem 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: auto;
            overflow: visible;
        }
        
        /* Ensure checkbox text is visible and readable */
        .checkbox-row {
            color: #374151 !important;
            font-size: 0.9375rem;
            font-weight: 400;
            line-height: 1.5;
            text-align: left;
            font-family: inherit;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .checkbox-row:hover {
            background: #f8fafc;
            border-color: #0b7285;
            box-shadow: 0 2px 4px rgba(11, 114, 133, 0.1);
        }
        
        .checkbox-row:has(input:checked) {
            background: #e5f3f7;
            border-color: #0b7285;
            box-shadow: 0 2px 8px rgba(11, 114, 133, 0.15);
        }
        
        .checkbox-row input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            margin: 0;
            flex-shrink: 0;
            accent-color: #0b7285;
            border-radius: 4px;
            grid-column: 2; /* Place checkbox in the second column */
            justify-self: end; /* Align to the right edge of the column */
        }
        
        /* Text content alignment */
        .checkbox-row {
            text-align: left;
        }
        
        /* Ensure text area takes available space but checkboxes align */
        .checkbox-row {
            position: relative;
        }
        
        .checkbox-row input[type="checkbox"]:checked {
            accent-color: #0b7285;
        }
        
        .checkbox-row:has(input:checked) {
            font-weight: 500;
            color: #095a69;
        }
        
        .vehicle-notice {
            padding: 0.875rem 1rem;
            background: #e5f3f7;
            border: 1px solid #0b7285;
            border-radius: 8px;
            color: #095a69;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .vehicle-document-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .vehicle-document-label {
            display: block;
            font-weight: 600;
            color: #374151;
            font-size: 0.9375rem;
            margin: 0;
        }
        
        .vehicle-file-upload {
            border: 2px dashed #d1d5db;
            padding: 1.5rem;
            text-align: center;
            border-radius: 8px;
            background: #fafafa;
            transition: all 0.2s ease;
        }
        
        .vehicle-file-upload:hover {
            border-color: #0b7285;
            background: #f0f9fb;
        }
        
        .vehicle-upload-area {
            cursor: pointer;
        }
        
        .vehicle-upload-text {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .vehicle-upload-hint {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .vehicle-file-name {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #e5f3f7;
            border-radius: 6px;
            color: #095a69;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .vehicle-remove-btn {
            background: none;
            border: none;
            color: #0b7285;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.875rem;
            padding: 0;
            margin-left: 0.75rem;
        }
        
        .vehicle-remove-btn:hover {
            color: #095a69;
        }
        
        .vehicle-action-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding-top: 0.5rem;
        }
        
        .vehicle-disabled-message {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .practitioner-code {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .practitioner-code:hover {
            background: #e0f2fe;
            border-color: #7dd3fc;
            transform: translateY(-2px);
        }
        
        .practitioner-code h4 {
            color: #0369a1;
            margin-bottom: 0.5rem;
        }
        
        .practitioner-code .code {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: #0b7285;
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            margin: 0.5rem 0;
        }
        
        .connection-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .connection-success h4 {
            color: #166534;
            margin-bottom: 0.5rem;
        }
        
        .connection-success p {
            color: #166534;
            margin-bottom: 0.5rem;
        }
        
        
        @media (max-width: 480px) {
            
            .section h1 {
                font-size: 1.25rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }
            
            .stat-card {
                padding: 0.625rem;
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .table {
                font-size: 0.75rem;
            }
            
            .table th,
            .table td {
                padding: 0.375rem 0.375rem;
                font-size: 0.75rem;
                white-space: normal;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Messages section mobile fixes */
            #messages.section {
                padding: 0;
                height: calc(100vh - 120px);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            /* Ensure messages section is hidden when it has the .hidden class */
            #messages.section.hidden {
                display: none !important;
            }
            
            /* Hide all messaging children when parent section is hidden */
            #messages.section.hidden .whatsapp-messaging,
            #messages.section.hidden .whatsapp-main,
            #messages.section.hidden .whatsapp-input-area {
                display: none !important;
            }
            
            #messages.section h1 {
                padding: 0.75rem;
                margin: 0;
                font-size: 1.25rem;
                flex-shrink: 0;
            }
            
            .whatsapp-messaging {
                flex: 1;
                height: auto !important;
                min-height: 0;
                border-radius: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            .whatsapp-main {
                height: 100%;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }
            
            .whatsapp-chat-header {
                flex-shrink: 0;
            }
            
            .whatsapp-messages {
                flex: 1;
                overflow-y: auto;
                padding: 0.75rem;
                padding-bottom: 1rem;
                -webkit-overflow-scrolling: touch;
                min-height: 0;
            }
            
            .whatsapp-input-area {
                flex-shrink: 0;
                background: #f0f2f5;
                border-top: 1px solid #e9edef;
                padding: 0.5rem;
                z-index: 100;
            }
            
            .whatsapp-input-container {
                padding: 0.5rem 0.75rem;
            }
            
            .whatsapp-input {
                font-size: 16px; /* Prevents zoom on iOS */
                max-height: 80px;
            }
            
            .whatsapp-input-actions button {
                min-width: 36px;
                min-height: 36px;
                padding: 0.5rem;
                font-size: 18px;
            }
            
            /* Vehicle Acquisition Type Mobile Styles */
            .vehicle-acquisition-container {
                gap: 1.25rem;
            }
            
            .vehicle-acquisition-type {
                display: flex;
                flex-direction: column;
                gap: 0.625rem;
                width: 100%;
            }
            
            .checkbox-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-direction: row; /* Normal row direction */
                gap: 0.875rem;
                padding: 1rem 1.25rem;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                background: #ffffff;
                cursor: pointer;
                width: 100%;
                box-sizing: border-box;
                min-height: 48px; /* Touch-friendly minimum height */
                font-size: 0.875rem;
                color: #374151;
                font-weight: 400;
                transition: all 0.2s ease;
                overflow: visible;
                white-space: normal;
                word-wrap: break-word;
                text-align: left;
                font-family: inherit;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            /* Ensure checkbox text is visible on mobile */
            .checkbox-row {
                color: #374151 !important;
                font-size: 0.875rem !important;
            }
            
            /* Uniform checkbox positioning on the right - all aligned */
            .checkbox-row input[type="checkbox"] {
                order: 2;
                flex-shrink: 0;
                width: 20px;
                height: 20px;
                margin-left: auto; /* Push to the right and align all checkboxes */
                min-width: 20px; /* Ensure consistent width */
            }
            
            /* Ensure all checkboxes align at the same horizontal position */
            .vehicle-acquisition-type {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }
            
            .checkbox-row {
                display: grid;
                grid-template-columns: 1fr auto;
                align-items: center;
                gap: 0.875rem;
            }
            
            .checkbox-row input[type="checkbox"] {
                grid-column: 2;
                justify-self: end;
            }
            
            /* Text content on the left */
            .checkbox-row {
                text-align: left;
            }
            
            .checkbox-row:hover {
                background: #f8fafc;
                border-color: #0b7285;
                box-shadow: 0 2px 4px rgba(11, 114, 133, 0.1);
            }
            
            .checkbox-row:has(input:checked) {
                background: #e5f3f7;
                border-color: #0b7285;
                box-shadow: 0 2px 8px rgba(11, 114, 133, 0.15);
                font-weight: 500;
                color: #095a69;
            }
            
            .checkbox-row input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
                margin: 0;
                flex-shrink: 0;
                accent-color: #0b7285;
                border-radius: 4px;
            }
            
            .vehicle-notice {
                padding: 0.75rem 1rem;
                font-size: 0.8125rem;
            }
            
            .vehicle-document-section {
                gap: 0.625rem;
            }
            
            .vehicle-document-label {
                font-size: 0.875rem;
            }
            
            .vehicle-file-upload {
                padding: 1.25rem 1rem;
            }
            
            .vehicle-upload-text {
                font-size: 0.8125rem;
                margin-bottom: 0.375rem;
            }
            
            .vehicle-upload-hint {
                font-size: 0.6875rem;
            }
            
            .vehicle-action-section {
                gap: 0.625rem;
                padding-top: 0.25rem;
            }
            
            .vehicle-disabled-message {
                font-size: 0.8125rem;
            }
            
            /* No practitioner message mobile styling */
            #noPractitionerMessage {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem 1rem !important;
                min-height: calc(100vh - 200px);
                text-align: center;
            }
            
            #noPractitionerMessage div[style*="font-size: 3rem"] {
                font-size: 4rem !important;
                margin-bottom: 1rem;
            }
            
            #noPractitionerMessage h3 {
                font-size: 1.125rem !important;
                margin-bottom: 0.75rem !important;
                color: #374151 !important;
            }
            
            #noPractitionerMessage p {
                font-size: 0.875rem !important;
                line-height: 1.5;
                color: #6b7280 !important;
                max-width: 90%;
            }
            
            .btn {
                font-size: 0.8125rem;
                padding: 0.5rem;
            }
            
            .btn-sm {
                font-size: 0.6875rem;
                padding: 0.25rem 0.375rem;
            }
            
            /* Quick Actions buttons - REBUILT: side-by-side on mobile - MUST BE LAST */
            /* Using maximum specificity and !important to override ALL button styles */
            body div.card > div.card-body.quick-actions-buttons {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                width: 100% !important;
                align-items: stretch !important;
            }
            
            body div.card > div.card-body.quick-actions-buttons > button.btn,
            body div.card > div.card-body.quick-actions-buttons > button.btn-primary,
            body div.card > div.card-body.quick-actions-buttons > button.btn-secondary,
            body div.card > div.card-body.quick-actions-buttons > button.btn-success,
            body div.card > div.card-body.quick-actions-buttons > button.btn-outline {
                display: inline-flex !important;
                flex: 1 1 calc(50% - 0.25rem) !important;
                flex-basis: calc(50% - 0.25rem) !important;
                flex-grow: 1 !important;
                flex-shrink: 1 !important;
                min-width: 0 !important;
                width: calc(50% - 0.25rem) !important;
                max-width: calc(50% - 0.25rem) !important;
                padding: 0.5rem 0.5rem !important;
                font-size: 0.75rem !important;
                min-height: 38px !important;
                max-height: none !important;
                margin: 0 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                box-sizing: border-box !important;
            }
            
            /* Ensure all text elements wrap properly */
            h1, h2, h3, h4, h5, h6, p, span, div, label {
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
            }
            
            /* Fix card headers and titles */
            .card-header,
            .card-title {
                font-size: 0.875rem;
                word-wrap: break-word;
            }
            
            /* Connect section fixes */
            .connection-form,
            .connection-success {
                width: 100%;
                max-width: 100%;
                padding: 1rem;
            }
            
            /* Profile section fixes */
            .profile-section {
                width: 100%;
                max-width: 100%;
            }
            
            .profile-image-container {
                width: 100%;
                max-width: 100%;
            }
            
            /* Prevent horizontal scroll on body */
            body {
                overflow-x: hidden;
                width: 100%;
            }
            
            /* Ensure main containers respect viewport */
            .app,
            .main,
            .section,
            .card,
            .card-body {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Table container with horizontal scroll */
            .card-body {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Ensure tables can scroll horizontally on mobile */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }
        }

        /* Document Preview Styles */
        .document-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }
        
        .document-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .document-preview-container {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 1200px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .document-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .document-preview-header h3 {
            margin: 0;
            color: #374151;
            font-size: 1.125rem;
        }
        
        .document-preview-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: #f8f9fa;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .document-preview-content iframe {
            width: 100%;
            height: 80vh;
            border: none;
            display: block;
            background: white;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* PDF content styling to prevent text overlap */
        .document-preview-content iframe[src*="pdf"] {
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            height: 100vh;
        }
        
        /* Additional PDF viewer styling */
        .document-preview-content {
            overflow: auto;
        }
        
        .document-preview-content iframe[src*="pdf"] + * {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* Enhanced PDF viewer container */
        .document-preview-content.pdf-viewer {
            position: relative;
            overflow: hidden;
        }
        
        .document-preview-content.pdf-viewer iframe {
            transform: scale(0.75);
            transform-origin: top left;
            width: 133.33%;
            height: 133.33%;
            border: none;
        }
        
        /* Alternative PDF viewer styling */
        .document-preview-content iframe[src*="data:application/pdf"] {
            transform: scale(0.7);
            transform-origin: top left;
            width: 142.86%;
            height: 142.86%;
        }
        
        .document-preview-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .document-preview-modal .close-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .document-preview-modal .download-btn {
            background: #0b7285;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Enhanced Document Attachment Styles */
        .message-attachment.document {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .document-preview {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .document-icon {
            font-size: 2rem;
            color: #0b7285;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .document-size {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .document-actions {
            display: flex;
            gap: 0.5rem;
        }

        .preview-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .preview-btn:hover {
            background: #059669;
        }
        
        /* Document Preview Modal Styles */
        .document-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }
        
        .document-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .document-preview-container {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 1200px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .document-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .document-preview-header h3 {
            margin: 0;
            color: #374151;
            font-size: 1.125rem;
        }
        
        .document-preview-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: #f8f9fa;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .document-preview-content iframe {
            width: 100%;
            height: 80vh;
            border: none;
            display: block;
            background: white;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* PDF content styling to prevent text overlap */
        .document-preview-content iframe[src*="pdf"] {
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            height: 100vh;
        }
        
        /* Additional PDF viewer styling */
        .document-preview-content {
            overflow: auto;
        }
        
        .document-preview-content iframe[src*="pdf"] + * {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* Enhanced PDF viewer container */
        .document-preview-content.pdf-viewer {
            position: relative;
            overflow: hidden;
        }
        
        .document-preview-content.pdf-viewer iframe {
            transform: scale(0.75);
            transform-origin: top left;
            width: 133.33%;
            height: 133.33%;
            border: none;
        }
        
        /* Alternative PDF viewer styling */
        .document-preview-content iframe[src*="data:application/pdf"] {
            transform: scale(0.7);
            transform-origin: top left;
            width: 142.86%;
            height: 142.86%;
        }
        
        .document-preview-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .close-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .download-btn {
            background: #0b7285;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .whatsapp-file-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .whatsapp-file-preview {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .pdf-attachment {
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <img src="assets/images/full%20logo%20CT.png" alt="ClearTrack Logo">
                </div>
                <button class="menu-toggle-style6" id="menuToggle" onclick="toggleMenu('style6')" aria-label="Toggle navigation menu">â˜°</button>
                <button class="btn btn-outline" onclick="window.location.href='/login.html'" style="background: rgba(255,255,255,0.2); color: #ffffff; border-color: rgba(255,255,255,0.3);" id="desktopLogoutBtn">Logout</button>
            </div>
            <nav class="nav-style6" id="nav-style6">
                <a href="#" class="nav-link active" onclick="handleNavClick('dashboard', event)">Dashboard</a>
                <a href="#" class="nav-link" onclick="handleNavClick('documents', event)">Documents</a>
                <a href="#" class="nav-link" onclick="handleNavClick('vehicles', event)">Vehicles</a>
                <a href="#" class="nav-link" onclick="handleNavClick('expenses', event)">Expenses</a>
                <a href="#" class="nav-link" onclick="handleNavClick('messages', event)">Messages</a>
                <a href="#" class="nav-link" onclick="handleNavClick('connect', event)">Connect</a>
                <a href="#" class="nav-link" onclick="handleNavClick('profile', event)">Profile</a>
            </nav>
        </header>
        
        <main class="main">
            <!-- Client Dashboard Main (shown when practitioner is linked) -->
            <div id="client-dashboard-main">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <h1 class="mb-6">Dashboard</h1>
                
                
                <div class="dashboard-grid">
                    <div class="stat-card clickable-tile" onclick="openDocumentsSection()">
                        <div class="stat-value" id="documentCount">0</div>
                        <div class="stat-label">Documents Uploaded</div>
                    </div>
                    
                    <div class="stat-card clickable-tile" onclick="openVehiclesSection()">
                        <div class="stat-value" id="vehicleCount">0</div>
                        <div class="stat-label">Vehicles Registered</div>
                    </div>
                    
                    <div class="stat-card clickable-tile" onclick="openExpensesSection()">
                        <div class="stat-value" id="expenseCount">0</div>
                        <div class="stat-label">Expenses Recorded</div>
                    </div>
                    
                    <div class="stat-card clickable-tile" onclick="openExpensesSection()">
                        <div class="stat-value" id="totalExpenses">R 0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body quick-actions-buttons">
                        <button class="btn btn-primary" onclick="showSection('documents')">Upload Document</button>
                        <button class="btn btn-secondary" onclick="showSection('vehicles')">Add Vehicle</button>
                        <button class="btn btn-success" onclick="showSection('expenses')">Record Expense</button>
                        <button class="btn btn-outline" onclick="showSection('profile')">Update Profile</button>
                    </div>
                    <style>
                        /* Force Quick Actions buttons side-by-side on mobile - using Grid for reliability */
                        @media screen and (max-width: 768px) {
                            .quick-actions-buttons {
                                display: grid !important;
                                grid-template-columns: repeat(2, 1fr) !important;
                                gap: 0.5rem !important;
                                width: 100% !important;
                            }
                            .quick-actions-buttons .btn,
                            .quick-actions-buttons button {
                                width: 100% !important;
                                min-width: 0 !important;
                                max-width: 100% !important;
                                padding: 0.5rem 0.5rem !important;
                                font-size: 0.75rem !important;
                                margin: 0 !important;
                                box-sizing: border-box !important;
                            }
                        }
                    </style>
                </div>
            </div>
            
            <!-- Documents Section -->
            <div id="documents" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1>Documents</h1>
                    <button class="btn btn-primary" onclick="showUploadModal()">Upload Document</button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Documents</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Document Type</th>
                                    <th>Tax Year</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTable">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #6b7280;">No documents uploaded yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Vehicles Section -->
            <div id="vehicles" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1>Vehicles</h1>
                </div>
                
                <!-- Vehicle Acquisition Type Selection -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title">Vehicle Acquisition Type</h3>
                    </div>
                    <div class="card-body vehicle-acquisition-container">
                        <div class="vehicle-acquisition-type">
                            <label class="checkbox-row">
                                <input type="checkbox" id="vehiclePurchased">
                                Purchased
                            </label>
                            <label class="checkbox-row">
                                <input type="checkbox" id="vehicleLeased">
                                Leased
                            </label>
                        </div>
                        
                        <div id="vehicleAcquisitionNotice" class="vehicle-notice" style="display:none;"></div>
                        
                        <!-- Document Upload Section (shown after selection) -->
                        <div id="vehicleDocumentUploadSection" class="vehicle-document-section" style="display:none;">
                            <label class="form-label vehicle-document-label">Required Document</label>
                            <div class="file-upload vehicle-file-upload">
                                <input type="file" id="vehicleDocumentUpload" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                                <div id="vehicleDocumentUploadArea" class="vehicle-upload-area">
                                    <div class="vehicle-upload-text">Click to upload or drag and drop</div>
                                    <div class="vehicle-upload-hint">PDF, JPG, PNG (Max 10MB)</div>
                                </div>
                                <div id="vehicleDocumentFileName" class="vehicle-file-name" style="display: none;">
                                    <span id="vehicleDocumentName"></span>
                                    <button type="button" onclick="clearVehicleDocument()" class="vehicle-remove-btn">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="vehicle-action-section">
                            <button id="addVehicleBtn" class="btn btn-primary" onclick="showVehicleModal()" disabled>Add Vehicle</button>
                            <span id="addVehicleDisabledMessage" class="vehicle-disabled-message" style="display: none;">Please select acquisition type and upload required document</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Vehicles</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Registration</th>
                                    <th>Make & Model</th>
                                    <th>Year</th>
                                    <th>Business Use %</th>
                                    <th>Mileage (km)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #6b7280;">No vehicles added yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Expenses Section -->
            <div id="expenses" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1>Expenses</h1>
                    <button class="btn btn-primary" onclick="showExpenseModal()">Add Expense</button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Expenses</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #6b7280;">No expenses recorded yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Messages Section -->
            <div id="messages" class="section hidden">
                <h1 class="mb-6">Messages</h1>
                
                <!-- Simplified messaging interface -->
                <div class="whatsapp-messaging">
                    <!-- Main chat area - Full width -->
                    <div class="whatsapp-main" style="width: 100%;">
                        <div class="whatsapp-chat-header">
                            <div class="whatsapp-chat-contact">
                                <div class="whatsapp-chat-contact-avatar" id="headerPractitionerAvatar">P</div>
                                <div class="whatsapp-chat-contact-info">
                                    <h3 id="headerPractitionerName">Your Practitioner</h3>
                                    <p id="practitionerStatus">Not Connected</p>
                                </div>
                            </div>
                            <div class="whatsapp-chat-actions">
                                <button onclick="callPractitioner()" title="Call">ðŸ“ž</button>
                                <button onclick="videoCallPractitioner()" title="Video">ðŸ“¹</button>
                                <button onclick="openChatMenu()" title="Menu">â‹®</button>
                            </div>
                        </div>
                        
                        <div class="whatsapp-messages" id="messagesContainer">
                            <div id="messagesList" style="display: flex; flex-direction: column; gap: 4px;">
                                <div class="whatsapp-date-separator">
                                    <div class="whatsapp-date-badge">Today</div>
                                </div>
                                <p style="color: #667781; text-align: center; padding: 20px;">No messages yet. Start a conversation with your practitioner!</p>
                            </div>
                        </div>
                        
                        <div class="whatsapp-input-area" id="messageInputContainer" style="display: none;">
                            <!-- Attachment menu -->
                            <div class="whatsapp-attachment-menu" id="attachmentMenu">
                                <button class="whatsapp-attachment-item" onclick="document.getElementById('messageFileInput').click(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">ðŸ“„</div>
                                    <div class="whatsapp-attachment-text">Document</div>
                                </button>
                                <button class="whatsapp-attachment-item" onclick="document.getElementById('imageInput').click(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">ðŸ“·</div>
                                    <div class="whatsapp-attachment-text">Camera</div>
                                </button>
                                <button class="whatsapp-attachment-item" onclick="document.getElementById('messageFileInput').click(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">ðŸ–¼ï¸</div>
                                    <div class="whatsapp-attachment-text">Gallery</div>
                                </button>
                                <button class="whatsapp-attachment-item" onclick="startVoiceRecording(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">ðŸŽ¤</div>
                                    <div class="whatsapp-attachment-text">Audio</div>
                                </button>
                        </div>
                        
                            <!-- Emoji picker -->
                            <div class="whatsapp-emoji-picker" id="emojiPicker">
                                <div class="whatsapp-emoji-grid" id="emojiGrid">
                                <!-- Emojis will be added here -->
                            </div>
                        </div>
                        
                            <div class="whatsapp-input-container">
                                <div class="whatsapp-input-actions">
                                    <button onclick="toggleAttachmentMenu()" title="Attach">âž•</button>
                                    <button onclick="toggleEmojiPicker()" title="Emoji">ðŸ˜Š</button>
                                </div>
                                <textarea id="messageText" class="whatsapp-input" placeholder="Type a message" rows="1" onkeydown="handleMessageKeydown(event)" oninput="autoResize(this)"></textarea>
                                <div class="whatsapp-input-actions">
                                    <button onclick="sendMessage()" class="send" title="Send">âž¤</button>
                                </div>
                        </div>
                        
                        <!-- Hidden file inputs -->
                        <input type="file" id="messageFileInput" accept="image/*,.pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" class="hidden-input" onchange="handleMessageFileUpload(event)">
                        <input type="file" id="imageInput" accept="image/*,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" capture="camera" class="hidden-input" onchange="handleMessageFileUpload(event)">
                        </div>
                        
                        <!-- Voice recording indicator -->
                        <div class="whatsapp-voice-recording" id="voiceRecording">
                            <div class="whatsapp-voice-indicator">
                                <div class="whatsapp-voice-dot"></div>
                                <span>Recording... Tap to stop</span>
                                <button onclick="stopVoiceRecording()" style="background: #dc2626; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-left: 8px;">Stop</button>
                            </div>
                            </div>
                        </div>
                        </div>
                        
                <!-- No practitioner message -->
                <div id="noPractitionerMessage" style="display: none; text-align: center; padding: 2rem; color: #6b7280; background: #ffffff; border-radius: 8px; margin: 0.75rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ’¬</div>
                    <h3 style="margin-bottom: 0.5rem; color: #374151;">No Practitioner Connected</h3>
                    <p style="line-height: 1.5; max-width: 90%; margin: 0 auto;">You need to connect with a practitioner to start messaging. Go to the Connect section to find and connect with a practitioner.</p>
                </div>
            </div>
            
            <!-- Connect Section -->
            <div id="connect" class="section hidden">
                <h1 class="mb-6">Connect to Practitioner</h1>
                
                
                <div class="card" id="practitionerConnectionCard">
                    <div class="card-header">
                        <h3 class="card-title">Practitioner Connection</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: #6b7280; margin-bottom: 1.5rem;">
                            Connect with a tax practitioner to manage your tax returns. Enter the practitioner code provided by your tax practitioner.
                        </p>
                        
                        <form id="connectForm">
                            <div class="form-group">
                                <label for="practitionerCode">Practitioner Code</label>
                                <input type="text" id="practitionerCode" placeholder="Enter practitioner code" required>
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem;">
                            <button type="submit" class="btn btn-primary">Connect to Practitioner</button>
                                <button type="button" class="btn btn-secondary" onclick="showCurrentConnection()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Refresh Status</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Current Connection Status -->
                <div class="card" id="connectionStatusCard" style="display: none; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
                    <div class="card-header" style="background: #f0fdf4; border-bottom: 1px solid #bbf7d0;">
                        <h3 class="card-title" style="color: #166534; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;"></span>
                            Connected to Practitioner
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="currentConnectionInfo" style="padding: 1rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; margin-bottom: 1rem;">
                            <!-- Connection info will be displayed here -->
                        </div>
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <button class="btn btn-secondary" onclick="disconnectFromPractitioner()" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem;">
                                Disconnect from Practitioner
                            </button>
                            <span class="text-sm text-gray-500">
                                You can disconnect at any time to connect to a different practitioner
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Available Practitioners Directory -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Available Practitioners</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: #6b7280; margin-bottom: 1rem;">
                            Browse and connect with qualified tax practitioners:
                        </p>
                        
                        <div id="practitionersDirectory" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <!-- Practitioners will be loaded here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div id="profile" class="section hidden">
                <h1 class="mb-6">Profile</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Personal Information</h3>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="form-group">
                                <label>Profile Image</label>
                                <div class="profile-section-flex">
                                    <div class="profile-image-section">
                                        <div id="userProfileImageContainer" class="profile-image-container clickable" onclick="triggerUserProfileImageSelect()" tabindex="0" role="button" aria-label="Upload profile image" onkeypress="if(event.key==='Enter'||event.key===' '){triggerUserProfileImageSelect();}">
                                            <img id="userProfileImage" src="" alt="Profile Image" class="profile-image">
                                            <div id="userProfileImagePlaceholder" class="profile-image-placeholder">No Image</div>
                                        </div>
                                        <button type="button" onclick="openUserProfileImageModal()" class="profile-edit-btn">Edit</button>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="userProfileImageInput" accept="image/*" class="hidden-input" onchange="handleUserProfileImageUpload(event)">
                                        <input type="file" id="userCameraInput" accept="image/*" capture="environment" class="hidden-input" onchange="handleUserProfileImageUpload(event)">
                                        <input type="file" id="userGalleryInput" accept="image/*" class="hidden-input" onchange="handleUserProfileImageUpload(event)">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name</label>
                                    <input type="text" id="firstName" value="" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name</label>
                                    <input type="text" id="lastName" value="" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" value="" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" value="">
                                </div>
                                <div class="form-group">
                                    <label for="idNumber">ID Number</label>
                                    <input type="text" id="idNumber" value="">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="taxNumber">Tax Number</label>
                                <input type="text" id="taxNumber" value="">
                            </div>
                            
                            <div class="form-group">
                                <label for="address">Address</label>
                                <textarea id="address" rows="3" placeholder="Enter your address"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Document Upload Modal -->
    <div id="uploadModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload Document</h3>
                <button class="modal-close" onclick="hideUploadModal()">&times;</button>
            </div>
            
            <form id="uploadForm">
                <div class="form-group">
                    <label for="docType">Document Type</label>
                    <div class="combobox-container">
                        <input type="text" id="docType" list="docTypeOptions" placeholder="Select or type document type" required>
                        <datalist id="docTypeOptions">
                            <option value="IRP5">
                            <option value="IT3">
                            <option value="Payslip">
                            <option value="Bank Statement">
                            <option value="Invoice">
                            <option value="Receipt">
                            <option value="Income Statement">
                            <option value="Tax Certificate">
                            <option value="Medical Aid Certificate">
                            <option value="Retirement Annuity Certificate">
                            <option value="Travel Allowance">
                            <option value="Home Office Expenses">
                            <option value="Vehicle Expenses">
                            <option value="Professional Fees">
                            <option value="Other">
                        </datalist>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="taxYear">Tax Year</label>
                    <input type="number" id="taxYear" value="2024" min="2020" max="2024" required>
                </div>
                
                <div class="form-group">
                    <label for="docDescription">Description (Optional)</label>
                    <textarea id="docDescription" rows="3" placeholder="Enter document description"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Select Files</label>
                    <div id="fileDropZone" class="file-drop-zone">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls" multiple class="hidden-input">
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-input">
                        <div class="drop-zone-content">
                            <div class="drop-zone-icon">
                                <svg class="icon icon-2xl icon-gray-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22 19C22 19.5304 21.7893 20.0391 21.4142 20.4142C21.0391 20.7893 20.5304 21 20 21H4C3.46957 21 2.96086 20.7893 2.58579 20.4142C2.21071 20.0391 2 19.5304 2 19V5C2 4.46957 2.21071 3.96086 2.58579 3.58579C2.96086 3.21071 3.46957 3 4 3H9L11 5H20C20.5304 5 21.0391 5.21071 21.4142 5.58579C21.7893 5.96086 22 6.46957 22 7V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="drop-zone-text">
                                <div class="drop-zone-primary">Click to browse, drag files, or scan document</div>
                                <div class="drop-zone-secondary">PDF, DOC, DOCX, JPG, PNG, XLS, XLSX (Max 10MB each)</div>
                            </div>
                        </div>
                    </div>
                    <div class="scan-options">
                        <button type="button" class="btn btn-outline btn-sm" onclick="openCameraScanner()">
                            <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 4H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg> Scan Document
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Vehicle</h3>
                <button class="modal-close" onclick="hideVehicleModal()">&times;</button>
            </div>
            
            <form id="vehicleForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="regNumber">Registration Number</label>
                        <input type="text" id="regNumber" placeholder="CA123GP" required>
                    </div>
                    <div class="form-group">
                        <label for="vehicleMake">Make</label>
                        <input type="text" id="vehicleMake" placeholder="Toyota" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vehicleModel">Model</label>
                        <input type="text" id="vehicleModel" placeholder="Corolla" required>
                    </div>
                    <div class="form-group">
                        <label for="vehicleYear">Year</label>
                        <input type="number" id="vehicleYear" value="2020" min="1900" max="2024" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fuelType">Fuel Type</label>
                        <select id="fuelType">
                            <option value="PETROL">Petrol</option>
                            <option value="DIESEL">Diesel</option>
                            <option value="HYBRID">Hybrid</option>
                            <option value="ELECTRIC">Electric</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="businessUse">Business Use %</label>
                        <input type="number" id="businessUse" value="80" min="0" max="100" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="openingMileage">Opening Mileage (km)</label>
                        <input type="number" id="openingMileage" placeholder="e.g., 50000" min="0">
                    </div>
                    <div class="form-group">
                        <label for="closingMileage">Closing Mileage (km)</label>
                        <input type="number" id="closingMileage" placeholder="e.g., 55000" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vehicleNotes">Notes (Optional)</label>
                    <textarea id="vehicleNotes" rows="3" placeholder="Additional notes about the vehicle"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Add Vehicle</button>
                    <button type="button" class="btn btn-outline" onclick="hideVehicleModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Expense Modal -->
    <div id="expenseModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Expense</h3>
                <button class="modal-close" onclick="hideExpenseModal()">&times;</button>
            </div>
            
            <form id="expenseForm">
                <div class="form-group">
                    <label for="expenseDesc">Description</label>
                    <input type="text" id="expenseDesc" placeholder="Business expense description" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="expenseAmount">Amount (R)</label>
                        <input type="number" id="expenseAmount" step="0.01" min="0" placeholder="1500.00" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseCategory">Category</label>
                        <select id="expenseCategory" required>
                            <option value="">Select category</option>
                            <option value="OFFICE_SUPPLIES">Office Supplies</option>
                            <option value="TRAVEL">Travel</option>
                            <option value="VEHICLE_EXPENSES">Vehicle Expenses</option>
                            <option value="COMMUNICATION">Communication</option>
                            <option value="PROFESSIONAL_SERVICES">Professional Services</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="expenseDate">Date</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseBusinessUse">Business Use %</label>
                        <input type="number" id="expenseBusinessUse" value="100" min="0" max="100" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="expenseNotes">Notes (Optional)</label>
                    <textarea id="expenseNotes" rows="3" placeholder="Additional notes about the expense"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Expense Document (Optional)</label>
                    <div id="expenseDocumentArea" style="margin-bottom: 0.5rem;">
                        <div id="expenseDocumentPreview" style="display: none; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f3f4f6; border-radius: 0.375rem;">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span id="expenseDocumentName" style="flex: 1; font-size: 0.875rem; color: #374151;"></span>
                                <button type="button" onclick="removeExpenseDocument()" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.25rem;">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-outline btn-sm" onclick="openExpenseFileBrowser()" style="flex: 1;">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 0.25rem;">
                                    <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9L11 5H19C19.5304 5 20.0391 5.21071 20.4142 5.58579C20.7893 5.96086 21 6.46957 21 7V11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Upload Document
                            </button>
                            <button type="button" class="btn btn-outline btn-sm" onclick="openExpenseCameraScanner()" style="flex: 1;">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 0.25rem;">
                                    <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 4H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Scan Document
                            </button>
                        </div>
                    </div>
                    <input type="file" id="expenseFileInput" accept="*/*" class="hidden-input" style="display: none;">
                    <input type="file" id="expenseCameraInput" accept="image/*" capture="environment" class="hidden-input" style="display: none;">
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Add Expense</button>
                    <button type="button" class="btn btn-outline" onclick="hideExpenseModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
            </div> <!-- End client-dashboard-main -->

    <script src="shared-data.js"></script>
    <script src="firestore-data.js"></script>
    <script>
        // Application state - now using real data storage
        let currentUser = null;
        window.currentUser = currentUser; // Make it global for event listeners
        let documents = [];
        let vehicles = [];
        let expenses = [];
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Messaging service is already initialized globally in messaging-service.js
            // Just ensure it's available
            if (!window.messagingService) {
                console.warn('MessagingService not available, using local storage fallback');
            }
            
            // Clear any sample practitioners that might exist
            cleartrackData.clearSamplePractitioners();
            
            // Clear any test practitioner data that might have been created during testing
            const data = cleartrackData.getData();
            if (data && data.practitioners) {
                for (let practitionerId in data.practitioners) {
                    const practitioner = data.practitioners[practitionerId];
                    // Only remove practitioners with specific test names, not default names
                    if (practitioner.name === 'Dr. Test Practitioner' ||
                        practitioner.name === 'Test Practitioner' ||
                        practitioner.practiceName === 'Test Practice') {
                        delete data.practitioners[practitionerId];
                    }
                }
                cleartrackData.setData(data);
            }
            // Clear any existing connections to allow fresh connections
            (async () => {
                try {
                    await initializeUser();
                    
                    // Load data with error handling
                    try {
                        loadUserData();
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        showUserNotification('Error loading some data. Please refresh if issues persist.', 'warning');
                    }
                    
                    try {
                        updateDashboard();
                    } catch (error) {
                        console.error('Error updating dashboard:', error);
                    }
                    
                    try {
                        setCurrentDate();
                    } catch (error) {
                        console.error('Error setting current date:', error);
                    }
                    
                    try {
                        showCurrentConnection();
                    } catch (error) {
                        console.error('Error showing current connection:', error);
                    }
                    
                    // Debug: Check if user was initialized
                    if (!currentUser) {
                        console.error('User initialization failed!');
                        showUserNotification('Unable to load user profile. Some features may be unavailable.', 'warning');
                    }
                } catch (error) {
                    console.error('Error initializing application:', error);
                    showUserNotification('Error initializing application. Please refresh the page.', 'error');
                }
            })();
            
            // Onboarding is now handled on separate page (client-onboarding.html)
            // No handlers needed here - users without practitioner are redirected
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                const attachmentMenu = document.getElementById('attachmentMenu');
                const emojiPicker = document.getElementById('emojiPicker');
                const attachmentButton = document.querySelector('[onclick="toggleAttachmentMenu()"]');
                const emojiButton = document.querySelector('[onclick="toggleEmojiPicker()"]');
                
                // Check if click is outside both modals and their buttons
                if (!attachmentMenu.contains(event.target) && 
                    !emojiPicker.contains(event.target) && 
                    !attachmentButton.contains(event.target) && 
                    !emojiButton.contains(event.target)) {
                    closeAllModals();
                }
            });
            
        });
        
        // ============================================
        // UTILITY FUNCTIONS - Error Handling & Common Patterns
        // ============================================
        
        /**
         * Safe async error handler wrapper
         * @param {Function} asyncFn - Async function to wrap
         * @param {string} errorMessage - User-friendly error message
         * @param {Function} onError - Optional error callback
         * @returns {Promise} Result of async function
         */
        async function safeAsync(asyncFn, errorMessage = 'An error occurred. Please try again.', onError = null) {
            try {
                return await asyncFn();
            } catch (error) {
                console.error('Error:', error);
                if (onError) {
                    onError(error);
                } else {
                    showUserNotification(errorMessage, 'error');
                }
                throw error; // Re-throw for caller to handle if needed
            }
        }
        
        /**
         * Show user-friendly notification
         * @param {string} message - Message to display
         * @param {string} type - Type: 'success', 'error', 'warning', 'info'
         * @param {number} duration - Duration in milliseconds (default: 3000)
         */
        function showUserNotification(message, type = 'info', duration = 3000) {
            // Remove existing notifications
            const existing = document.querySelectorAll('.user-notification');
            existing.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'user-notification';
            const bgColor = {
                'success': '#10b981',
                'error': '#ef4444',
                'warning': '#f59e0b',
                'info': '#3b82f6'
            }[type] || '#3b82f6';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }
        
        /**
         * Sanitize user input to prevent XSS
         * @param {string} input - Input string to sanitize
         * @returns {string} Sanitized string
         */
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }
        
        /**
         * Validate email format
         * @param {string} email - Email to validate
         * @returns {boolean} True if valid
         */
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        /**
         * Validate phone number (basic validation)
         * @param {string} phone - Phone number to validate
         * @returns {boolean} True if valid
         */
        function isValidPhone(phone) {
            if (!phone) return true; // Optional field
            const phoneRegex = /^[\d\s\-\+\(\)]+$/;
            return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
        }
        
        /**
         * Show confirmation dialog
         * @param {string} message - Confirmation message
         * @param {string} title - Dialog title
         * @returns {Promise<boolean>} True if confirmed
         */
        function showConfirmation(message, title = 'Confirm Action') {
            return new Promise((resolve) => {
                const confirmed = confirm(`${title}\n\n${message}`);
                resolve(confirmed);
            });
        }
        
        /**
         * Set loading state for an element
         * @param {HTMLElement|string} element - Element or selector
         * @param {boolean} isLoading - Loading state
         * @param {string} loadingText - Text to show while loading
         */
        function setLoadingState(element, isLoading, loadingText = 'Loading...') {
            const el = typeof element === 'string' ? document.querySelector(element) : element;
            if (!el) return;
            
            if (isLoading) {
                el.disabled = true;
                if (el.tagName === 'BUTTON') {
                    el.dataset.originalText = el.textContent;
                    el.textContent = loadingText;
                }
            } else {
                el.disabled = false;
                if (el.tagName === 'BUTTON' && el.dataset.originalText) {
                    el.textContent = el.dataset.originalText;
                }
            }
        }
        
        /**
         * Add timeout to async operations
         * @param {Promise} promise - Promise to add timeout to
         * @param {number} timeoutMs - Timeout in milliseconds
         * @param {string} errorMessage - Error message if timeout
         * @returns {Promise} Promise with timeout
         */
        function withTimeout(promise, timeoutMs = 10000, errorMessage = 'Operation timed out. Please try again.') {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
                )
            ]);
        }
        
        // Add CSS for notifications
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ============================================
        // END UTILITY FUNCTIONS
        // ============================================
        
        // Initialize user from Firebase Auth and Firestore
        async function initializeUser() {
            return safeAsync(
                async () => {
                    console.log('ðŸ” DEBUG: initializeUser() called');
                    
                    // Ensure data storage is properly initialized
                    if (!cleartrackData.getData()) {
                        console.log('ðŸ” DEBUG: Initializing data storage');
                        cleartrackData.initializeData();
                    }
                    
                    // Check if Firebase Auth is available
                    if (!window.firebaseAuth) {
                        console.error('ðŸ” DEBUG: Firebase Auth not available');
                        // Fallback to local storage
                        loadUserFromLocalStorage();
                        return;
                    }
                    
                    // Get current Firebase user
                    const firebaseUser = window.firebaseAuth.currentUser;
                    if (!firebaseUser) {
                        console.log('ðŸ” DEBUG: No Firebase user logged in, checking auth state...');
                        // Wait for auth state to be determined - return a promise
                        return new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => {
                                unsubscribe();
                                console.warn('Auth state check timed out, falling back to local storage');
                                loadUserFromLocalStorage();
                                resolve();
                            }, 5000); // 5 second timeout
                            
                            const unsubscribe = window.firebaseAuth.onAuthStateChanged(async (user) => {
                                clearTimeout(timeout);
                                unsubscribe(); // Only listen once
                                try {
                                    if (user) {
                                        await withTimeout(
                                            loadUserFromFirestore(user.uid),
                                            10000,
                                            'Loading user profile timed out'
                                        );
                                    } else {
                                        loadUserFromLocalStorage();
                                    }
                                    resolve();
                                } catch (error) {
                                    console.error('Error in auth state change handler:', error);
                                    loadUserFromLocalStorage();
                                    resolve();
                                }
                            });
                        });
                    }
                    
                    // Load user profile from Firestore with timeout
                    await withTimeout(
                        loadUserFromFirestore(firebaseUser.uid),
                        10000,
                        'Loading user profile timed out'
                    );
                },
                'Error initializing user. Using local storage.',
                (error) => {
                    console.error('Error in initializeUser:', error);
                    loadUserFromLocalStorage();
                }
            );
        }
        
        // Load user profile from Firestore and sync with local storage
        async function loadUserFromFirestore(uid) {
            try {
                console.log('ðŸ” DEBUG: Loading user from Firestore, UID:', uid);
                
                // Load profile from Firestore
                let firestoreProfile = null;
                if (window.cleartrackAuthApi && window.cleartrackAuthApi.getUserProfile) {
                    firestoreProfile = await window.cleartrackAuthApi.getUserProfile(uid);
                } else if (window.firebaseApi && window.firebaseApi.getData) {
                    firestoreProfile = await window.firebaseApi.getData('users', uid);
                }
                
                if (!firestoreProfile) {
                    console.warn('ðŸ” DEBUG: No Firestore profile found, falling back to local storage');
                    loadUserFromLocalStorage();
                    return;
                }
                
                console.log('ðŸ” DEBUG: Firestore profile loaded:', firestoreProfile);
                
                // Get or create user in local storage using Firebase UID as the user ID
            const data = cleartrackData.getData();
                
                // Use Firebase UID as the user ID to ensure consistency
                if (data.users[uid]) {
                    // Update existing user with Firestore data
                    currentUser = data.users[uid];
                    
                    // Merge Firestore data into local user (prioritize Firestore for firstName, lastName, email)
                    currentUser = {
                        ...currentUser,
                        id: uid, // Ensure ID matches Firebase UID
                        firstName: firestoreProfile.firstName || currentUser.firstName || '',
                        lastName: firestoreProfile.lastName || currentUser.lastName || '',
                        email: firestoreProfile.email || currentUser.email || '',
                        name: firestoreProfile.name || `${firestoreProfile.firstName || ''} ${firestoreProfile.lastName || ''}`.trim() || currentUser.name || '',
                        // Keep local storage fields if they exist, otherwise use Firestore
                        phone: currentUser.phone || firestoreProfile.phone || '',
                        idNumber: currentUser.idNumber || firestoreProfile.idNumber || '',
                        taxNumber: currentUser.taxNumber || firestoreProfile.taxNumber || '',
                        address: currentUser.address || firestoreProfile.address || '',
                        profileImage: currentUser.profileImage || firestoreProfile.profileImage || '',
                        // Preserve connection if it exists
                        connectedPractitioner: currentUser.connectedPractitioner || firestoreProfile.connectedPractitioner || null
                    };
                    
                    // Update local storage
                    cleartrackData.updateUser(uid, currentUser);
                    
                    // Update desktop header user name
                    const desktopUserNameElement = document.getElementById('desktopUserName');
                    if (desktopUserNameElement && currentUser.name) {
                        desktopUserNameElement.textContent = currentUser.name;
                    }
                } else {
                    // Create new user in local storage with Firebase UID as ID
                    currentUser = cleartrackData.createUserWithId(uid, {
                        firstName: firestoreProfile.firstName || '',
                        lastName: firestoreProfile.lastName || '',
                        email: firestoreProfile.email || '',
                        name: firestoreProfile.name || `${firestoreProfile.firstName || ''} ${firestoreProfile.lastName || ''}`.trim() || '',
                        phone: firestoreProfile.phone || '',
                        idNumber: firestoreProfile.idNumber || '',
                        taxNumber: firestoreProfile.taxNumber || '',
                        address: firestoreProfile.address || '',
                        profileImage: firestoreProfile.profileImage || '',
                        connectedPractitioner: firestoreProfile.connectedPractitioner || null
                    });
                    
                    // Update desktop header user name
                    const desktopUserNameElement = document.getElementById('desktopUserName');
                    if (desktopUserNameElement && currentUser.name) {
                        desktopUserNameElement.textContent = currentUser.name;
                    }
                }
                
                // Load connection from Firestore if it exists
                await loadConnectionFromFirestore(uid);
                
                window.currentUser = currentUser;
                console.log('ðŸ” DEBUG: Current user set from Firestore:', currentUser);
                updateUserInterface();
                
                // Ensure desktop user name is updated
                const desktopUserNameElement = document.getElementById('desktopUserName');
                if (desktopUserNameElement && currentUser && currentUser.name) {
                    desktopUserNameElement.textContent = currentUser.name;
                }
                
                // Update mobile user name
                const mobileUserNameElement = document.getElementById('mobileUserName');
                if (mobileUserNameElement && currentUser && currentUser.name) {
                    mobileUserNameElement.textContent = currentUser.name;
                }
                
                // Gate access based on practitioner link
                gateClientAccess(firestoreProfile);
                
                // Set up real-time listener for practitionerId changes
                setupPractitionerIdListener(uid);
                
            } catch (error) {
                console.error('ðŸ” DEBUG: Error loading user from Firestore:', error);
                // Fallback to local storage
                loadUserFromLocalStorage();
            }
        }
        
        // Set up real-time listener for practitionerId changes
        function setupPractitionerIdListener(uid) {
            if (!window.firebaseDb) return;
            
            const userRef = window.firebaseDb.collection('users').doc(uid);
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    const practitionerId = userData.practitionerId || userData.connectedPractitioner || null;
                    
                    // If practitioner was just linked, reload to show dashboard
                    if (practitionerId && userData.role === 'client') {
                        // Practitioner was linked - reload to show dashboard
                        window.location.reload();
                    }
                }
            }, (error) => {
                console.error('Error setting up practitionerId listener:', error);
            });
        }
        
        // Gate client access - redirect to onboarding page if no practitioner, show dashboard if linked
        function gateClientAccess(userDoc) {
            const dashboardMain = document.getElementById('client-dashboard-main');
            
            // Handle case where userDoc might be null/undefined (local storage fallback)
            if (!userDoc) {
                // Default to showing dashboard for fallback scenarios
                if (dashboardMain) dashboardMain.style.display = '';
                return;
            }
            
            const role = userDoc.role;
            const practitionerId = userDoc.practitionerId || userDoc.connectedPractitioner || null;
            
            // Only apply gating for clients
            if (role === 'client') {
                if (!practitionerId) {
                    // No practitioner - redirect to onboarding page
                    window.location.href = '/client-onboarding.html';
                    return;
                } else {
                    // Has practitioner - show dashboard
                    if (dashboardMain) dashboardMain.style.display = '';
                }
            } else {
                // For other roles (practitioner/admin) or undefined role, show dashboard
                if (dashboardMain) dashboardMain.style.display = '';
            }
        }
        
        // Load connection from Firestore and restore to local storage
        async function loadConnectionFromFirestore(uid) {
            try {
                if (!window.firebaseApi || !window.firebaseApi.getData) {
                    console.log('ðŸ” DEBUG: Firebase API not available, skipping connection load');
                    return;
                }
                
                // Get user document from Firestore
                const userDoc = await window.firebaseApi.getData('users', uid);
                
                if (userDoc && userDoc.connectedPractitioner) {
                    const practitionerId = userDoc.connectedPractitioner;
                    console.log('ðŸ” DEBUG: Found connection in Firestore:', practitionerId);
                    
                    // Restore connection in local storage
                    const data = cleartrackData.getData();
                    if (data.users[uid] && data.practitioners[practitionerId]) {
                        // Update user's connected practitioner
                        data.users[uid].connectedPractitioner = practitionerId;
                        currentUser.connectedPractitioner = practitionerId;
                        
                        // Update practitioner's connected users
                        if (!data.practitioners[practitionerId].connectedUsers) {
                            data.practitioners[practitionerId].connectedUsers = [];
                        }
                        if (!data.practitioners[practitionerId].connectedUsers.includes(uid)) {
                            data.practitioners[practitionerId].connectedUsers.push(uid);
                        }
                        
                        // Create connection record if it doesn't exist
                        if (!data.connections) {
                            data.connections = {};
                        }
                        
                        // Check if connection record already exists
                        let connectionExists = false;
                        for (let connId in data.connections) {
                            if (data.connections[connId].userId === uid && 
                                data.connections[connId].practitionerId === practitionerId &&
                                data.connections[connId].status === 'active') {
                                connectionExists = true;
                                break;
                            }
                        }
                        
                        if (!connectionExists) {
                            const connectionId = 'conn_' + Date.now();
                            data.connections[connectionId] = {
                                id: connectionId,
                                userId: uid,
                                practitionerId: practitionerId,
                                connectedAt: userDoc.connectedAt || new Date().toISOString(),
                                status: 'active'
                            };
                        }
                        
                        cleartrackData.setData(data);
                        console.log('ðŸ” DEBUG: Connection restored from Firestore');
                    } else {
                        console.warn('ðŸ” DEBUG: Practitioner not found in local storage:', practitionerId);
                    }
                } else {
                    console.log('ðŸ” DEBUG: No connection found in Firestore');
                }
            } catch (error) {
                console.error('ðŸ” DEBUG: Error loading connection from Firestore:', error);
                // Continue anyway - connection might not exist yet
            }
        }
        
        // Fallback: Load user from local storage only
        function loadUserFromLocalStorage() {
            console.log('ðŸ” DEBUG: Loading user from local storage');
            const data = cleartrackData.getData();
            const userIds = Object.keys(data.users || {});
            
            if (userIds.length > 0) {
                currentUser = data.users[userIds[0]];
                window.currentUser = currentUser;
                console.log('ðŸ” DEBUG: Current user set from local storage:', currentUser);
                updateUserInterface();
                
                // For local storage fallback, try to gate access if we have role info
                if (currentUser && currentUser.role) {
                    gateClientAccess({ role: currentUser.role, practitionerId: currentUser.connectedPractitioner || null });
                } else {
                    // Default to showing dashboard for fallback
                    const dashboardMain = document.getElementById('client-dashboard-main');
                    if (dashboardMain) dashboardMain.style.display = '';
                }
            } else {
                console.log('ðŸ” DEBUG: No users found, creating new user');
                currentUser = cleartrackData.createUser({
                    firstName: 'User',
                    lastName: '',
                    email: '',
                    phone: '',
                    idNumber: '',
                    taxNumber: '',
                    address: ''
                });
                window.currentUser = currentUser;
                console.log('ðŸ” DEBUG: New user created:', currentUser);
                updateUserInterface();
                
                // Default to redirecting to onboarding for new users (they won't have practitioner yet)
                window.location.href = '/client-onboarding.html';
            }
        }
        
        // Load user data from storage
        function loadUserData() {
            if (currentUser) {
                documents = cleartrackData.getUserDocuments(currentUser.id);
                vehicles = cleartrackData.getUserVehicles(currentUser.id);
                expenses = cleartrackData.getUserExpenses(currentUser.id);
                
                updateDocumentsTable();
                updateVehiclesTable();
                updateExpensesTable();
            }
        }
        
        // Update user interface with current user data
        function updateUserInterface() {
            if (currentUser) {
                // Update mobile menu user name
                const welcomeText = `Welcome, ${currentUser.firstName} ${currentUser.lastName}`;
                const mobileUserName = document.querySelector('.mobile-user-name');
                if (mobileUserName) {
                    mobileUserName.textContent = welcomeText;
                }
                
                // Update profile form
                document.getElementById('firstName').value = currentUser.firstName || '';
                document.getElementById('lastName').value = currentUser.lastName || '';
                document.getElementById('email').value = currentUser.email || '';
                document.getElementById('phone').value = currentUser.phone || '';
                document.getElementById('idNumber').value = currentUser.idNumber || '';
                document.getElementById('taxNumber').value = currentUser.taxNumber || '';
                document.getElementById('address').value = currentUser.address || '';
                
                // Update profile image
                const profileImg = document.getElementById('userProfileImage');
                const placeholder = document.getElementById('userProfileImagePlaceholder');
                const removeBtn = document.getElementById('removeUserProfileImage');
                
                if (currentUser.profileImage) {
                    profileImg.src = currentUser.profileImage;
                    profileImg.style.display = 'block';
                    placeholder.style.display = 'none';
                    removeBtn.style.display = 'inline-block';
                } else {
                    profileImg.src = '';
                    profileImg.style.display = 'none';
                    placeholder.style.display = 'block';
                    removeBtn.style.display = 'none';
                }
                
                // Check for existing practitioner connection
                const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
                if (connectedPractitioner) {
                    showExistingConnection(connectedPractitioner);
                }
            }
        }
        
        // Set current date for expense form
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        }
        
        // Show section
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update data if needed
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'messages') {
                loadMessages();
            } else if (sectionName === 'connect') {
                loadPractitionersDirectory();
            }
        }
        
        // Handle navigation click - wraps showSection and closes mobile nav
        function handleNavClick(sectionName, event) {
            if (event) {
                event.preventDefault();
            }
            
            // ALWAYS close mobile menu first (before any other logic)
            const nav = document.getElementById("nav-style6");
            const toggle = document.querySelector(".menu-toggle-style6");
            if (nav && nav.classList.contains("active")) {
                nav.classList.remove("active");
                if (toggle) toggle.classList.remove("active");
            }
            
            // Get the clicked element - handle both direct clicks and clicks on child elements
            let clickedLink = event ? (event.target || event.currentTarget) : null;
            if (clickedLink && !clickedLink.classList.contains('nav-link')) {
                clickedLink = clickedLink.closest('.nav-link') || clickedLink.closest('a');
            }
            
            showSection(sectionName);
            
            // Update active state for ALL nav links (both desktop .nav a and mobile .nav-style6 a)
            document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Activate the clicked link
            if (clickedLink) {
                clickedLink.classList.add('active');
                
                // Also activate corresponding link in the other nav by matching onclick attribute
                const clickedOnclick = clickedLink.getAttribute('onclick');
                if (clickedOnclick) {
                    document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
                        if (link.getAttribute('onclick') === clickedOnclick) {
                            link.classList.add('active');
                        }
                    });
                }
            } else {
                // Fallback: find link by section name
                document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
                    const onclick = link.getAttribute('onclick');
                    if (onclick && onclick.includes("'" + sectionName + "'")) {
                        link.classList.add('active');
                    }
                });
            }
        }
        
        // Close menus when clicking outside (for dropdowns) - EXACT FROM REFERENCE
        document.addEventListener('click', function(event) {
            const nav = document.getElementById('nav-style6');
            const toggle = document.querySelector('.menu-toggle-style6');
            const header = toggle?.closest('.header');
            
            if (nav && nav.classList.contains('active')) {
                if (header && !header.contains(event.target)) {
                    nav.classList.remove('active');
                    if (toggle) toggle.classList.remove('active');
                }
            }
        });
        
        // Close Style 6 menu when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const nav = document.getElementById('nav-style6');
                const toggle = document.querySelector('.menu-toggle-style6');
                if (nav && nav.classList.contains('active')) {
                    nav.classList.remove('active');
                    if (toggle) toggle.classList.remove('active');
                }
            }
        });
        
        // Dashboard tile click functions
        function openDocumentsSection() {
            showSection('documents');
        }
        
        function openVehiclesSection() {
            showSection('vehicles');
        }
        
        function openExpensesSection() {
            showSection('expenses');
        }
        
        // Update dashboard statistics
        function updateDashboard() {
            document.getElementById('documentCount').textContent = documents.length;
            document.getElementById('vehicleCount').textContent = vehicles.length;
            document.getElementById('expenseCount').textContent = expenses.length;
            
            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = 'R ' + totalExpenses.toLocaleString();
        }
        
        // Document upload
        function showUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
            // Initialize drag and drop, combobox, and camera scanner when modal opens
            setTimeout(() => {
                setupDragAndDrop();
                setupCombobox();
                setupCameraScanner();
            }, 100);
        }
        
        function hideUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('edit-mode');
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadForm').removeAttribute('data-edit-id');
            
            // Reset modal title and button
            const modalTitle = document.querySelector('#uploadModal .modal-title');
            const submitButton = document.querySelector('#uploadForm button[type="submit"]');
            
            if (modalTitle) modalTitle.textContent = 'Upload Document';
            if (submitButton) submitButton.textContent = 'Upload Document';
            
            // Reset drop zone display
            const dropZone = document.getElementById('fileDropZone');
            if (dropZone) {
                const content = dropZone.querySelector('.drop-zone-content');
                if (content) {
                    content.innerHTML = `
                        <div class="drop-zone-icon">
                        <svg class="icon icon-2xl icon-gray-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 19C22 19.5304 21.7893 20.0391 21.4142 20.4142C21.0391 20.7893 20.5304 21 20 21H4C3.46957 21 2.96086 20.7893 2.58579 20.4142C2.21071 20.0391 2 19.5304 2 19V5C2 4.46957 2.21071 3.96086 2.58579 3.58579C2.96086 3.21071 3.46957 3 4 3H9L11 5H20C20.5304 5 21.0391 5.21071 21.4142 5.58579C21.7893 5.96086 22 6.46957 22 7V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                        <div class="drop-zone-text">
                            <div class="drop-zone-primary">Click to browse or drag files here</div>
                            <div class="drop-zone-secondary">PDF, DOC, DOCX, JPG, PNG, XLS, XLSX (Max 10MB each)</div>
                        </div>
                    `;
                }
            }
        }
        
        // SIMPLE FILE UPLOAD SYSTEM
        function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const isEditMode = document.getElementById('uploadForm').hasAttribute('data-edit-id');
            const editId = document.getElementById('uploadForm').getAttribute('data-edit-id');
            
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            // Get form data
            const docType = document.getElementById('docType').value;
            const taxYear = document.getElementById('taxYear').value;
            const description = document.getElementById('docDescription').value;
            
            if (!docType) {
                showUserNotification('Please select a document type', 'warning');
                return;
            }
            
            // For edit mode, we don't require a new file
            if (!isEditMode && files.length === 0) {
                showUserNotification('Please select at least one file', 'warning');
                return;
            }
            
            // If in edit mode and no new file selected, just update the metadata
            if (isEditMode && files.length === 0) {
                try {
                    const existingDoc = documents.find(doc => doc.id == editId);
                    if (existingDoc) {
                        existingDoc.type = docType;
                        existingDoc.taxYear = taxYear;
                        existingDoc.description = description;
                        existingDoc.uploadedAt = new Date().toISOString();
                        
                        // Save updated document
                        cleartrackData.updateDocument(currentUser.id, existingDoc);
                        showUserNotification('Document updated successfully!', 'success');
                        hideUploadModal();
                        loadUserData();
                        updateDashboard();
                    }
                } catch (error) {
                    console.error('Error updating document:', error);
                    showUserNotification('Error updating document: ' + error.message, 'error');
                }
                return;
            }
            
            // Process the first file (simplified)
            const file = files[0];
            
            // Validate file
            const validTypes = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            const isValid = validTypes.includes(fileExtension) && file.size <= 10 * 1024 * 1024;
            
            if (!isValid) {
                showUserNotification(`File ${file.name} is invalid. Only PDF, DOC, DOCX, JPG, PNG, XLS, XLSX files under 10MB are allowed.`, 'error');
                return;
            }
            
            // Convert to base64 and store
            const reader = new FileReader();
            reader.onload = function(e) {
                const documentData = {
                    id: isEditMode ? editId : Date.now() + Math.random(),
                    fileName: file.name,
                    fileContent: e.target.result,
                    type: docType,
                    taxYear: taxYear,
                    description: description,
                    uploadDate: new Date().toISOString(),
                    uploadedAt: new Date().toISOString()
                };
                
                // Try to save the document
                try {
                    if (isEditMode) {
                        cleartrackData.updateDocument(currentUser.id, documentData);
                        alert('Document updated successfully!');
                    } else {
                        cleartrackData.addDocument(currentUser.id, documentData);
                        showUserNotification('File uploaded successfully!', 'success');
                    }
                    hideUploadModal();
                    
                    // Reload data and update UI with a small delay to ensure data is saved
                    setTimeout(() => {
                        loadUserData();
                        updateDashboard();
                    }, 100);
                } catch (error) {
                    console.error('Error saving document:', error);
                    showUserNotification('Error saving document: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file: ' + file.name);
            };
            
            reader.readAsDataURL(file);
        }
        
        
        
        
        // Simple form submission
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleFileUpload();
        });
        
        // Document Scanner Functions
        function openCameraScanner() {
            const cameraInput = document.getElementById('cameraInput');
            if (cameraInput) {
                cameraInput.click();
            }
        }
        
        function openFileBrowser() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            }
        }
        
        function setupCameraScanner() {
            const cameraInput = document.getElementById('cameraInput');
            if (!cameraInput) return;
            
            // Check if device supports camera
            const hasCamera = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            const scanButton = document.querySelector('button[onclick="openCameraScanner()"]');
            
            if (!hasCamera && scanButton) {
                scanButton.style.display = 'none';
            }
            
            // Handle camera capture
            cameraInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    // Process the captured image
                    processScannedDocument(files[0]);
                }
            });
        }
        
        function processScannedDocument(file) {
            // Show loading state
            const dropZone = document.getElementById('fileDropZone');
            const originalContent = dropZone.innerHTML;
            
            dropZone.innerHTML = `
                <div class="drop-zone-content">
                        <div class="drop-zone-icon" style="animation: spin 1s linear infinite;">
                            <svg class="icon icon-2xl icon-gray-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    <div class="drop-zone-text">
                        <div class="drop-zone-primary">Processing scanned document...</div>
                        <div class="drop-zone-secondary">Please wait</div>
                    </div>
                </div>
            `;
            
            // Add spin animation
            if (!document.getElementById('scan-animations')) {
                const style = document.createElement('style');
                style.id = 'scan-animations';
                style.textContent = `
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Validate the scanned image
            if (!file.type.startsWith('image/')) {
                dropZone.innerHTML = originalContent;
                showUserNotification('Please capture a valid image file.', 'warning');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                dropZone.innerHTML = originalContent;
                showUserNotification('Scanned image is too large. Please try again with a smaller image.', 'warning');
                return;
            }
            
            // Simulate processing time for better UX
            setTimeout(() => {
                // Update the main file input with the scanned image
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('fileInput').files = dataTransfer.files;
                
                // Update the display to show the scanned document
                updateFileDisplay([file]);
                
                // Show success message
                showScanSuccess();
            }, 1000);
        }
        
        function showScanSuccess() {
            // Create a temporary success indicator
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 0.75rem 1rem;
                border-radius: 6px;
                font-size: 0.875rem;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                animation: slideIn 0.3s ease;
            `;
            successMsg.innerHTML = '<svg class="icon icon-sm icon-green-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 4H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Document scanned successfully!';
            
            // Add animation keyframes
            if (!document.getElementById('scan-animations')) {
                const style = document.createElement('style');
                style.id = 'scan-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(successMsg);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 3000);
        }
        
        // Enhanced Combobox Functionality
        function setupCombobox() {
            const docTypeInput = document.getElementById('docType');
            if (!docTypeInput) return;
            
            // Add autocomplete behavior
            docTypeInput.addEventListener('input', function(e) {
                const value = e.target.value;
                // Allow custom input while maintaining validation
                if (value.length > 0) {
                    e.target.setCustomValidity('');
                }
            });
            
            // Handle datalist selection
            docTypeInput.addEventListener('change', function(e) {
                const value = e.target.value;
                if (value && value.trim() !== '') {
                    e.target.setCustomValidity('');
                }
            });
            
            // Validate on blur
            docTypeInput.addEventListener('blur', function(e) {
                const value = e.target.value.trim();
                if (!value) {
                    e.target.setCustomValidity('Please select or enter a document type');
            } else {
                    e.target.setCustomValidity('');
                }
            });
        }
        
        // Clean Drag & Drop Implementation
        function setupDragAndDrop() {
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('fileInput');
            
            if (!dropZone || !fileInput) return;
            
            // Click to open file dialog (only on drop zone content, not buttons)
            dropZone.addEventListener('click', (e) => {
                // Only trigger if clicking on the drop zone content, not buttons or form elements
                if (e.target.closest('.drop-zone-content') && !e.target.closest('button') && !e.target.closest('input')) {
                    openFileBrowser();
                }
            });
            
            // Handle file input change (when files are selected via click)
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileDisplay(Array.from(e.target.files));
                }
            });
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight(e) {
            document.getElementById('fileDropZone').classList.add('drag-active');
        }
        
        function unhighlight(e) {
            document.getElementById('fileDropZone').classList.remove('drag-active');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                // Update the file input with dropped files
                const dataTransfer = new DataTransfer();
                Array.from(files).forEach(file => dataTransfer.items.add(file));
                document.getElementById('fileInput').files = dataTransfer.files;
                
                // Update display
                updateFileDisplay(Array.from(files));
            }
        }
        
        function updateFileDisplay(files) {
            const dropZone = document.getElementById('fileDropZone');
            const content = dropZone.querySelector('.drop-zone-content');
            
            if (files.length === 1) {
                content.innerHTML = `
                    <div class="drop-zone-icon">
                        <svg class="icon icon-2xl icon-gray-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="drop-zone-text">
                        <div class="drop-zone-primary">${files[0].name}</div>
                        <div class="drop-zone-secondary">${formatFileSize(files[0].size)} â€¢ Click to change</div>
                    </div>
                `;
            } else if (files.length > 1) {
                content.innerHTML = `
                    <div class="drop-zone-icon">
                        <svg class="icon icon-2xl icon-gray-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 19C22 19.5304 21.7893 20.0391 21.4142 20.4142C21.0391 20.7893 20.5304 21 20 21H4C3.46957 21 2.96086 20.7893 2.58579 20.4142C2.21071 20.0391 2 19.5304 2 19V5C2 4.46957 2.21071 3.96086 2.58579 3.58579C2.96086 3.21071 3.46957 3 4 3H9L11 5H20C20.5304 5 21.0391 5.21071 21.4142 5.58579C21.7893 5.96086 22 6.46957 22 7V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="drop-zone-text">
                        <div class="drop-zone-primary">${files.length} files selected</div>
                        <div class="drop-zone-secondary">Click to change files</div>
                    </div>
                `;
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        
        
        
        
        
        function updateDocumentsTable() {
            const tbody = document.getElementById('documentsTable');
            
            if (documents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6b7280;">No documents uploaded yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = documents.map(doc => `
                <tr>
                    <td>${doc.type}</td>
                    <td>${doc.taxYear}</td>
                    <td>${doc.uploadedAt}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editDocument('${doc.id}')" style="margin-right: 0.5rem;">
                            <img src="assets/icons/edit.svg" class="icon icon-sm" alt="Edit"> Edit
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="deleteDocument('${doc.id}')">
                            <img src="assets/icons/trash.svg" class="icon icon-sm" alt="Delete"> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function deleteDocument(id) {
            const confirmed = await showConfirmation('Are you sure you want to delete this document?', 'Delete Document');
            if (!confirmed) return;
            
            try {
                // Remove from local array
                documents = documents.filter(doc => String(doc.id) !== String(id));
                
                // Update in storage
                if (currentUser) {
                    cleartrackData.deleteDocument(currentUser.id, id);
                }
                
                // Update UI
                updateDocumentsTable();
                updateDashboard();
                
                showUserNotification('Document deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting document:', error);
                showUserNotification('Error deleting document: ' + error.message, 'error');
            }
        }
        
        function editDocument(id) {
            const document = documents.find(doc => String(doc.id) === String(id));
            if (!document) {
                showUserNotification('Document not found', 'error');
                return;
            }
            
            // Populate the upload form with existing document data
            document.getElementById('docType').value = document.type;
            document.getElementById('taxYear').value = document.taxYear;
            
            // Show the upload modal in edit mode
            document.getElementById('uploadModal').classList.remove('hidden');
            document.getElementById('uploadModal').classList.add('edit-mode');
            
            // Update the modal title and button
            const modalTitle = document.querySelector('#uploadModal .modal-title');
            const submitButton = document.querySelector('#uploadForm button[type="submit"]');
            
            if (modalTitle) modalTitle.textContent = 'Edit Document';
            if (submitButton) submitButton.textContent = 'Update Document';
            
            // Store the document ID for updating
            document.getElementById('uploadForm').setAttribute('data-edit-id', id);
        }
        
        // Vehicle management
        function showVehicleModal() {
            // Reset editing mode if just opening for new vehicle
            if (!editingVehicleId) {
                // Reset form and change title/button back to Add mode
                document.getElementById('vehicleForm').reset();
                const modalTitle = document.querySelector('#vehicleModal .modal-title');
                const submitButton = document.querySelector('#vehicleForm button[type="submit"]');
                if (modalTitle) modalTitle.textContent = 'Add Vehicle';
                if (submitButton) submitButton.textContent = 'Add Vehicle';
            }
            document.getElementById('vehicleModal').classList.remove('hidden');
        }
        
        function hideVehicleModal() {
            document.getElementById('vehicleModal').classList.add('hidden');
            document.getElementById('vehicleForm').reset();
            editingVehicleId = null;
            // Reset title and button
            const modalTitle = document.querySelector('#vehicleModal .modal-title');
            const submitButton = document.querySelector('#vehicleForm button[type="submit"]');
            if (modalTitle) modalTitle.textContent = 'Add Vehicle';
            if (submitButton) submitButton.textContent = 'Add Vehicle';
            // Reset vehicle acquisition type checkboxes and notice
            resetVehicleAcquisitionSelection();
        }
        
        document.getElementById('vehicleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            // Check if acquisition type and document are selected/uploaded
            const purchasedCheckbox = document.getElementById('vehiclePurchased');
            const leasedCheckbox = document.getElementById('vehicleLeased');
            const documentUploadInput = document.getElementById('vehicleDocumentUpload');
            
            if (!purchasedCheckbox || !leasedCheckbox || !documentUploadInput) {
                showUserNotification('Please select acquisition type and upload document on the Vehicles page first.', 'warning');
                hideVehicleModal();
                return;
            }
            
            if (!purchasedCheckbox.checked && !leasedCheckbox.checked) {
                alert('Please select whether the vehicle is Purchased or Leased before adding a vehicle.');
                hideVehicleModal();
                return;
            }
            
            if (!vehicleDocumentFile && (!documentUploadInput.files || documentUploadInput.files.length === 0)) {
                alert('Please upload the required document (purchase invoice or lease agreement) before adding a vehicle.');
                hideVehicleModal();
                return;
            }
            
            const documentFile = vehicleDocumentFile || documentUploadInput.files[0];
            const acquisitionType = purchasedCheckbox.checked ? 'purchased' : 'leased';
            
            const vehicleData = {
                registration: document.getElementById('regNumber').value,
                make: document.getElementById('vehicleMake').value,
                model: document.getElementById('vehicleModel').value,
                year: parseInt(document.getElementById('vehicleYear').value),
                fuelType: document.getElementById('fuelType').value,
                businessUse: parseInt(document.getElementById('businessUse').value),
                openingMileage: parseInt(document.getElementById('openingMileage').value) || 0,
                closingMileage: parseInt(document.getElementById('closingMileage').value) || 0,
                notes: document.getElementById('vehicleNotes').value,
                acquisitionType: acquisitionType,
                documentUploaded: true,
                documentFileName: documentFile.name
            };
            
            if (editingVehicleId) {
                // Update existing vehicle
                const vehicleIndex = vehicles.findIndex(v => v.id === editingVehicleId);
                if (vehicleIndex !== -1) {
                    // Update vehicle in array
                    vehicles[vehicleIndex] = {
                        ...vehicles[vehicleIndex],
                        ...vehicleData
                    };
                    
                    // Update in storage
                    const data = cleartrackData.getData();
                    if (data.users[currentUser.id] && data.users[currentUser.id].vehicles) {
                        const storageVehicleIndex = data.users[currentUser.id].vehicles.findIndex(v => v.id === editingVehicleId);
                        if (storageVehicleIndex !== -1) {
                            data.users[currentUser.id].vehicles[storageVehicleIndex] = {
                                ...data.users[currentUser.id].vehicles[storageVehicleIndex],
                                ...vehicleData
                            };
                            cleartrackData.setData(data);
                        }
                    }
                    
                    // Refresh display
                    loadUserData();
                    updateDashboard();
                    hideVehicleModal();
                    // Reset acquisition type selection after successful update
                    resetVehicleAcquisitionSelection();
                    alert('Vehicle updated successfully!');
                } else {
                    alert('Vehicle not found. Please try again.');
                }
            } else {
                // Add new vehicle
                const newVehicle = cleartrackData.addVehicle(currentUser.id, vehicleData);
                
                if (newVehicle) {
                    // Reset acquisition type selection after successful add
                    resetVehicleAcquisitionSelection();
                    loadUserData(); // Reload data from storage
                    updateDashboard();
                    hideVehicleModal();
                    alert('Vehicle added successfully!');
                } else {
                    alert('Error adding vehicle. Please try again.');
                }
            }
        });
        
        function updateVehiclesTable() {
            const tbody = document.getElementById('vehiclesTable');
            
            if (vehicles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No vehicles added yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = vehicles.map(vehicle => {
                const mileage = vehicle.openingMileage && vehicle.closingMileage ? 
                    `${vehicle.openingMileage.toLocaleString()} - ${vehicle.closingMileage.toLocaleString()}` : 
                    (vehicle.openingMileage ? `${vehicle.openingMileage.toLocaleString()}+` : 'Not recorded');
                
                return `
                    <tr>
                        <td>${vehicle.registration}</td>
                        <td>${vehicle.make} ${vehicle.model}</td>
                        <td>${vehicle.year}</td>
                        <td>${vehicle.businessUse}%</td>
                        <td>${mileage}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editVehicle('${vehicle.id}')" style="margin-right: 0.5rem;">Edit</button>
                            <button class="btn btn-outline" onclick="deleteVehicle('${vehicle.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function deleteVehicle(id) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                vehicles = vehicles.filter(vehicle => vehicle.id !== id);
                updateVehiclesTable();
                updateDashboard();
            }
        }
        
        // Edit vehicle function
        let editingVehicleId = null;
        
        function editVehicle(id) {
            // Convert id to string for comparison
            const vehicleId = String(id);
            const vehicle = vehicles.find(v => String(v.id) === vehicleId);
            
            if (!vehicle) {
                alert('Vehicle not found.');
                console.error('Vehicle not found. ID:', id, 'Available vehicles:', vehicles);
                return;
            }
            
            // Set editing mode BEFORE showing modal
            editingVehicleId = vehicleId;
            
            // Populate form fields with existing data
            document.getElementById('regNumber').value = vehicle.registration || '';
            document.getElementById('vehicleMake').value = vehicle.make || '';
            document.getElementById('vehicleModel').value = vehicle.model || '';
            document.getElementById('vehicleYear').value = vehicle.year || '';
            document.getElementById('fuelType').value = vehicle.fuelType || 'PETROL';
            document.getElementById('businessUse').value = vehicle.businessUse || 0;
            document.getElementById('openingMileage').value = vehicle.openingMileage || '';
            document.getElementById('closingMileage').value = vehicle.closingMileage || '';
            document.getElementById('vehicleNotes').value = vehicle.notes || '';
            
            // Change modal title and button text
            const modalTitle = document.querySelector('#vehicleModal .modal-title');
            const submitButton = document.querySelector('#vehicleForm button[type="submit"]');
            
            if (modalTitle) {
                modalTitle.textContent = 'Edit Vehicle';
            }
            if (submitButton) {
                submitButton.textContent = 'Update Vehicle';
            }
            
            // Show modal directly
            const modal = document.getElementById('vehicleModal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                alert('Vehicle modal not found. Please refresh the page.');
                console.error('Vehicle modal element not found');
            }
        }
        
        // Expense management
        let expenseDocumentFile = null;
        let expenseDocumentData = null;
        
        function showExpenseModal() {
            // Reset editing mode if just opening for new expense
            if (!editingExpenseId) {
                // Reset form and change title/button back to Add mode
                document.getElementById('expenseForm').reset();
                const modalTitle = document.querySelector('#expenseModal .modal-title');
                const submitButton = document.querySelector('#expenseForm button[type="submit"]');
                if (modalTitle) modalTitle.textContent = 'Add Expense';
                if (submitButton) submitButton.textContent = 'Add Expense';
                setCurrentDate();
                // Clear document preview
                removeExpenseDocument();
            }
            document.getElementById('expenseModal').classList.remove('hidden');
            // Ensure file input listeners are set up when modal opens
            setTimeout(setupExpenseDocumentInputs, 100);
        }
        
        function hideExpenseModal() {
            document.getElementById('expenseModal').classList.add('hidden');
            document.getElementById('expenseForm').reset();
            editingExpenseId = null;
            expenseDocumentFile = null;
            expenseDocumentData = null;
            // Reset title and button
            const modalTitle = document.querySelector('#expenseModal .modal-title');
            const submitButton = document.querySelector('#expenseForm button[type="submit"]');
            if (modalTitle) modalTitle.textContent = 'Add Expense';
            if (submitButton) submitButton.textContent = 'Add Expense';
            setCurrentDate();
            // Clear document preview
            removeExpenseDocument();
        }
        
        // Expense document upload functions
        function openExpenseFileBrowser() {
            const fileInput = document.getElementById('expenseFileInput');
            if (fileInput) {
                fileInput.click();
            }
        }
        
        function openExpenseCameraScanner() {
            const cameraInput = document.getElementById('expenseCameraInput');
            if (cameraInput) {
                cameraInput.click();
            }
        }
        
        function removeExpenseDocument() {
            expenseDocumentFile = null;
            expenseDocumentData = null;
            const preview = document.getElementById('expenseDocumentPreview');
            if (preview) {
                preview.style.display = 'none';
            }
            const fileInput = document.getElementById('expenseFileInput');
            const cameraInput = document.getElementById('expenseCameraInput');
            if (fileInput) fileInput.value = '';
            if (cameraInput) cameraInput.value = '';
        }
        
        function handleExpenseDocumentUpload(file) {
            if (!file) return;
            
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size exceeds 10MB limit. Please select a smaller file.');
                return;
            }
            
            // Accept all file types - no type validation restrictions
            expenseDocumentFile = file;
            
            // Read file as base64
            const reader = new FileReader();
            reader.onload = function(e) {
                expenseDocumentData = {
                    fileName: file.name,
                    fileContent: e.target.result,
                    fileSize: file.size,
                    mimeType: file.type || 'application/octet-stream',
                    uploadedAt: new Date().toISOString()
                };
                
                // Show preview
                const preview = document.getElementById('expenseDocumentPreview');
                const nameSpan = document.getElementById('expenseDocumentName');
                if (preview) {
                    preview.style.display = 'block';
                }
                if (nameSpan) {
                    nameSpan.textContent = file.name;
                }
            };
            reader.onerror = function() {
                alert('Error reading file: ' + file.name);
                removeExpenseDocument();
            };
            reader.readAsDataURL(file);
        }
        
        // Set up file input listeners
        function setupExpenseDocumentInputs() {
            const expenseFileInput = document.getElementById('expenseFileInput');
            const expenseCameraInput = document.getElementById('expenseCameraInput');
            
            if (expenseFileInput && !expenseFileInput.hasAttribute('data-listener-attached')) {
                expenseFileInput.addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (files.length > 0) {
                        handleExpenseDocumentUpload(files[0]);
                    }
                });
                expenseFileInput.setAttribute('data-listener-attached', 'true');
            }
            
            if (expenseCameraInput && !expenseCameraInput.hasAttribute('data-listener-attached')) {
                expenseCameraInput.addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (files.length > 0) {
                        handleExpenseDocumentUpload(files[0]);
                    }
                });
                expenseCameraInput.setAttribute('data-listener-attached', 'true');
            }
        }
        
        // Set up listeners when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupExpenseDocumentInputs);
        } else {
            setupExpenseDocumentInputs();
        }
        
        
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            const expenseData = {
                description: document.getElementById('expenseDesc').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                category: document.getElementById('expenseCategory').value,
                date: document.getElementById('expenseDate').value,
                businessUse: parseInt(document.getElementById('expenseBusinessUse').value),
                notes: document.getElementById('expenseNotes').value
            };
            
            // Include document if uploaded or already exists
            if (expenseDocumentData) {
                expenseData.document = expenseDocumentData;
            } else if (editingExpenseId) {
                // When editing, preserve existing document if no new one is uploaded
                const existingExpense = expenses.find(e => String(e.id) === editingExpenseId);
                if (existingExpense && existingExpense.document) {
                    expenseData.document = existingExpense.document;
                }
            }
            
            if (editingExpenseId) {
                // Update existing expense
                const expenseIndex = expenses.findIndex(e => String(e.id) === editingExpenseId);
                if (expenseIndex !== -1) {
                    // Update expense in array
                    expenses[expenseIndex] = {
                        ...expenses[expenseIndex],
                        ...expenseData
                    };
                    
                    // Update in storage
                    const data = cleartrackData.getData();
                    if (data.users[currentUser.id] && data.users[currentUser.id].expenses) {
                        const storageExpenseIndex = data.users[currentUser.id].expenses.findIndex(e => String(e.id) === editingExpenseId);
                        if (storageExpenseIndex !== -1) {
                            data.users[currentUser.id].expenses[storageExpenseIndex] = {
                                ...data.users[currentUser.id].expenses[storageExpenseIndex],
                                ...expenseData
                            };
                            cleartrackData.setData(data);
                        }
                    }
                    
                    // Refresh display
                    loadUserData();
                    updateDashboard();
                    hideExpenseModal();
                    alert('Expense updated successfully!');
                } else {
                    alert('Expense not found. Please try again.');
                }
            } else {
                // Add new expense
                const newExpense = cleartrackData.addExpense(currentUser.id, expenseData);
                
                if (newExpense) {
                    loadUserData(); // Reload data from storage
                    updateDashboard();
                    hideExpenseModal();
                    alert('Expense added successfully!');
                } else {
                    alert('Error adding expense. Please try again.');
                }
            }
        });
        
        function updateExpensesTable() {
            const tbody = document.getElementById('expensesTable');
            
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">No expenses recorded yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = expenses.map(expense => `
                <tr>
                    <td>${expense.description}</td>
                    <td>R ${expense.amount.toLocaleString()}</td>
                    <td>${expense.category.replace('_', ' ')}</td>
                    <td>${new Date(expense.date).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editExpense('${expense.id}')" style="margin-right: 0.5rem;">Edit</button>
                        <button class="btn btn-outline" onclick="deleteExpense('${expense.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function deleteExpense(id) {
            const expenseId = String(id);
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(expense => String(expense.id) !== expenseId);
                
                // Also remove from storage
                if (currentUser) {
                    const data = cleartrackData.getData();
                    if (data.users[currentUser.id] && data.users[currentUser.id].expenses) {
                        data.users[currentUser.id].expenses = data.users[currentUser.id].expenses.filter(
                            expense => String(expense.id) !== expenseId
                        );
                        cleartrackData.setData(data);
                    }
                }
                
                loadUserData();
                updateExpensesTable();
                updateDashboard();
            }
        }
        
        // Edit expense function
        let editingExpenseId = null;
        
        function editExpense(id) {
            // Convert id to string for comparison
            const expenseId = String(id);
            const expense = expenses.find(e => String(e.id) === expenseId);
            
            if (!expense) {
                alert('Expense not found.');
                console.error('Expense not found. ID:', id, 'Available expenses:', expenses);
                return;
            }
            
            // Set editing mode BEFORE showing modal
            editingExpenseId = expenseId;
            
            // Populate form fields with existing data
            document.getElementById('expenseDesc').value = expense.description || '';
            document.getElementById('expenseAmount').value = expense.amount || '';
            document.getElementById('expenseCategory').value = expense.category || '';
            
            // Format date for input (YYYY-MM-DD)
            const expenseDate = expense.date ? new Date(expense.date).toISOString().split('T')[0] : '';
            document.getElementById('expenseDate').value = expenseDate;
            
            document.getElementById('expenseBusinessUse').value = expense.businessUse || 100;
            document.getElementById('expenseNotes').value = expense.notes || '';
            
            // Load existing document if available
            if (expense.document) {
                expenseDocumentData = expense.document;
                const preview = document.getElementById('expenseDocumentPreview');
                const nameSpan = document.getElementById('expenseDocumentName');
                if (preview) {
                    preview.style.display = 'block';
                }
                if (nameSpan && expense.document.fileName) {
                    nameSpan.textContent = expense.document.fileName;
                }
            } else {
                removeExpenseDocument();
            }
            
            // Change modal title and button text
            const modalTitle = document.querySelector('#expenseModal .modal-title');
            const submitButton = document.querySelector('#expenseForm button[type="submit"]');
            
            if (modalTitle) {
                modalTitle.textContent = 'Edit Expense';
            }
            if (submitButton) {
                submitButton.textContent = 'Update Expense';
            }
            
            // Show modal directly
            const modal = document.getElementById('expenseModal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                alert('Expense modal not found. Please refresh the page.');
                console.error('Expense modal element not found');
            }
        }
        
        // Profile management
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Ensure user is initialized
            if (!currentUser) {
                // Try to get existing user first
                const data = cleartrackData.getData();
                const userIds = Object.keys(data.users || {});
                if (userIds.length > 0) {
                    currentUser = data.users[userIds[0]];
                } else {
                    showUserNotification('User not found. Please refresh the page.', 'error');
                    return;
                }
            }
            
            // Basic form validation
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!firstName || !lastName) {
                alert('First name and last name are required.');
                return;
            }
            
            if (email && !isValidEmail(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Prepare updated user data
            const updatedData = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                name: `${firstName} ${lastName}`.trim(),
                phone: document.getElementById('phone').value.trim(),
                idNumber: document.getElementById('idNumber').value.trim(),
                taxNumber: document.getElementById('taxNumber').value.trim(),
                address: document.getElementById('address').value.trim()
            };
            
            // Update local storage
            const updatedUser = cleartrackData.updateUser(currentUser.id, updatedData);
            
            // Also save to Firestore if Firebase is available
            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                try {
                    const uid = window.firebaseAuth.currentUser.uid;
                    if (window.firebaseApi && window.firebaseApi.saveData) {
                        await window.firebaseApi.saveData('users', uid, updatedData);
                        console.log('ðŸ” DEBUG: Profile updated in Firestore');
                    }
                } catch (error) {
                    console.error('ðŸ” DEBUG: Error updating profile in Firestore:', error);
                    // Continue anyway - local storage update succeeded
                }
            }
            
            if (updatedUser) {
                currentUser = updatedUser;
                window.currentUser = currentUser; // Update global reference
                // Update mobile menu user name
                const welcomeText = `Welcome, ${currentUser.firstName} ${currentUser.lastName}`;
                const mobileUserName = document.querySelector('.mobile-user-name');
                if (mobileUserName) {
                    mobileUserName.textContent = welcomeText;
                }
                alert('Profile updated successfully!');
            } else {
                alert('Error updating profile. Please try again.');
            }
        });
        
        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Test messaging system
        function testMessagingSystem() {
            console.log('ðŸ§ª Testing messaging system...');
            console.log('Current user:', currentUser);
            console.log('Connected practitioner:', cleartrackData.getConnectedPractitioner(currentUser.id));
            console.log('Messages:', cleartrackData.getMessages(currentUser.id, cleartrackData.getConnectedPractitioner(currentUser.id)?.id));
        }
        
        // Logout handler function
        async function handleLogout(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            console.log('[logout] Logout button clicked');
            
            // Close mobile nav if it's open
            const mainNav = document.getElementById('mainNav');
            const menuToggle = document.getElementById('menuToggle');
            if (mainNav && menuToggle) {
                mainNav.classList.remove('active');
                menuToggle.classList.remove('active');
            }
            
            try {
                // Check if Firebase Auth is available
                if (!window.firebaseAuth) {
                    console.error('[logout] Firebase Auth not available. Please ensure firebase-init.js is loaded.');
                    return;
                }
                
                console.log('[logout] Signing out from Firebase...');
                
                // Sign out from Firebase
                await window.firebaseAuth.signOut();
                
                console.log('[logout] Firebase sign out successful');
                
                // Clear any local storage
                localStorage.removeItem('token');
                localStorage.removeItem('firebaseUser');
                
                console.log('[logout] Local storage cleared, redirecting to login...');
                
                // Redirect to login page
                window.location.href = '/index.html';
            } catch (error) {
                console.error('[logout] Error signing out:', error);
                console.error('[logout] Error details:', error.message, error.code);
            }
        }
        
        // Initialize logout buttons on page load
        function initLogoutButtons() {
            const logoutButtons = document.querySelectorAll('[data-ct-logout]');
            
            console.log('[logout] Found logout buttons:', logoutButtons.length);
            
            if (logoutButtons.length === 0) {
                console.warn('[logout] No logout buttons found with data-ct-logout attribute');
                return;
            }
            
            logoutButtons.forEach((button, index) => {
                // Remove any existing event listeners by cloning the button
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // Add click event listener
                newButton.addEventListener('click', handleLogout);
                console.log(`[logout] Attached event listener to button ${index + 1}`);
            });
        }
        
        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initLogoutButtons();
                
                // Show/hide desktop logout button based on screen size
                const desktopLogoutBtn = document.getElementById('desktopLogoutBtn');
                const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
                
                function updateLogoutButtonVisibility() {
                    if (window.innerWidth > 768) {
                        // Desktop: show logout button, hide mobile menu toggle
                        if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'block';
                        if (mobileMenuToggle) mobileMenuToggle.style.display = 'none';
                    } else {
                        // Mobile: hide logout button, show mobile menu toggle
                        if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'none';
                        if (mobileMenuToggle) mobileMenuToggle.style.display = 'block';
                    }
                }
                
                // Update on load and resize
                updateLogoutButtonVisibility();
                window.addEventListener('resize', updateLogoutButtonVisibility);
            });
        } else {
            // DOM already loaded
            initLogoutButtons();
            
            // Show/hide desktop logout button based on screen size
            const desktopLogoutBtn = document.getElementById('desktopLogoutBtn');
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            
            function updateLogoutButtonVisibility() {
                if (window.innerWidth > 768) {
                    // Desktop: show logout button, hide mobile menu toggle
                    if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'block';
                    if (mobileMenuToggle) mobileMenuToggle.style.display = 'none';
                } else {
                    // Mobile: hide logout button, show mobile menu toggle
                    if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'none';
                    if (mobileMenuToggle) mobileMenuToggle.style.display = 'block';
                }
            }
            
            // Update on load and resize
            updateLogoutButtonVisibility();
            window.addEventListener('resize', updateLogoutButtonVisibility);
        }
        
        
        // Practitioner connection functionality
        let connectedPractitioner = null;
        
        
        // Connection form submission
        document.getElementById('connectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            const code = document.getElementById('practitionerCode').value.toUpperCase();
            const practitioner = await cleartrackData.getPractitionerByCode(code);
            
            if (practitioner) {
                // Send connection request to practitioner using new system
                const result = await cleartrackData.sendConnectionRequest(currentUser.id, practitioner.id);
                
                if (result.success) {
                    if (result.message) {
                        alert(`Connection request already exists for ${practitioner.name} at ${practitioner.practiceName}. Please wait for approval.`);
                    } else {
                    alert(`Connection request sent to ${practitioner.name} at ${practitioner.practiceName}! Please wait for approval.`);
                    }
                    // Clear the form
                    document.getElementById('practitionerCode').value = '';
                } else {
                    alert(`Error: ${result.error}. Please try again.`);
                }
            } else {
                alert('Invalid practitioner code. Please check the code and try again.');
            }
        });
        
        // Show existing connection
        function showExistingConnection(practitioner) {
            // This function is no longer needed as showCurrentConnection handles the display
            showCurrentConnection();
        }
        
        // Fill practitioner code
        function fillPractitionerCode(code) {
            document.getElementById('practitionerCode').value = code;
        }
        
        
        // Disconnect practitioner

        // Force clear all connections (for debugging/testing)

        // Show current connection status
        function showCurrentConnection() {
            if (!currentUser) return;
            
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            const connectionStatusCard = document.getElementById('connectionStatusCard');
            const currentConnectionInfo = document.getElementById('currentConnectionInfo');
            const practitionerConnectionCard = document.getElementById('practitionerConnectionCard');
            
            if (connectedPractitioner) {
                // Update the detailed connection card
                currentConnectionInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: #f3f4f6; color: #6b7280; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem; overflow: hidden; border: 2px solid #e5e7eb;">
                            ${connectedPractitioner.profileImage ? 
                                `<img src="${connectedPractitioner.profileImage}" alt="${connectedPractitioner.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />` : 
                                connectedPractitioner.name.charAt(0)
                            }
                        </div>
                        <div>
                            <h4 style="margin: 0 0 0.25rem 0; color: #374151;">${connectedPractitioner.name}</h4>
                            <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">${connectedPractitioner.practiceName}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.75rem;">
                        <div style="font-size: 0.875rem;">
                            <strong>Experience:</strong> ${connectedPractitioner.yearsExperience || 0} years
                        </div>
                        <div style="font-size: 0.875rem;">
                            <strong>Code:</strong> ${connectedPractitioner.practitionerCode}
                        </div>
                        <div style="font-size: 0.875rem;">
                            <strong>Specializations:</strong> ${connectedPractitioner.specializations ? connectedPractitioner.specializations.join(', ') : 'Not specified'}
                        </div>
                    </div>
                `;
                connectionStatusCard.style.display = 'block';
                practitionerConnectionCard.style.display = 'none';
            } else {
                connectionStatusCard.style.display = 'none';
                practitionerConnectionCard.style.display = 'block';
            }
        }

        // Disconnect from current practitioner
        async function disconnectFromPractitioner() {
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to disconnect from your current practitioner? This will end your professional relationship.')) {
                    const success = await cleartrackData.disconnectUserFromPractitioner(currentUser.id);
                    if (success) {
                    alert('Successfully disconnected from practitioner.');
                    showCurrentConnection(); // Update the display - this will show the connection form again
                    loadPractitionersDirectory(); // Refresh available practitioners
                    } else {
                        alert('Error disconnecting from practitioner. Please try again.');
                }
            }
        }
        
        // Check for existing connection on page load
            // Check if there's a stored connection (in a real app, this would come from the backend)
            if (connectedPractitioner) {
                connectToPractitioner(connectedPractitioner);
            }
        
        // Set up periodic connection status check
        setInterval(function() {
            if (currentUser) {
                const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
                if (connectedPractitioner) {
                    showCurrentConnection();
                }
            }
        }, 2000); // Check every 2 seconds
        
        // Check for call end events
        setInterval(function() {
            checkForCallEnd();
        }, 1000); // Check every second for call end events
        
        function checkForCallEnd() {
            const callEvents = JSON.parse(localStorage.getItem('cleartrack_call_events') || '[]');
            if (callEvents.length > 0) {
                const latestEvent = callEvents[callEvents.length - 1];
                if (latestEvent.type === 'call_end') {
                    // End call on user side
                    if (isCallActive) {
                        endCall();
                    }
                    // Clear call events
                    localStorage.removeItem('cleartrack_call_events');
                }
            }
        }
        
        // Event listeners moved outside DOMContentLoaded to ensure they're always available
        
        
        // Messaging functionality - Updated to use backend API
        async function loadMessages() {
            console.log('ðŸ” loadMessages called');
            if (!currentUser) {
                console.log('âŒ No currentUser in loadMessages');
                return;
            }
            
            // Make function global for polling
            window.loadMessages = loadMessages;
            
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            console.log('ðŸ” Connected practitioner:', connectedPractitioner);
            
            if (!connectedPractitioner) {
                console.log('âŒ No connected practitioner found');
                document.getElementById('noPractitionerMessage').style.display = 'flex';
                document.getElementById('messageInputContainer').style.display = 'none';
                const messagingContainer = document.querySelector('.whatsapp-messaging');
                if (messagingContainer) {
                    messagingContainer.style.display = 'none';
                }
                // Update practitioner status to show not connected
                document.getElementById('headerPractitionerName').textContent = 'Your Practitioner';
                document.getElementById('practitionerStatus').textContent = 'Not Connected';
                return;
            }
            
            document.getElementById('noPractitionerMessage').style.display = 'none';
            const messagingContainer = document.querySelector('.whatsapp-messaging');
            if (messagingContainer) {
                messagingContainer.style.display = 'flex';
            }
            document.getElementById('messageInputContainer').style.display = 'block';
            
            // Update practitioner status to show connected and avatar image
            document.getElementById('headerPractitionerName').textContent = connectedPractitioner.name;
            document.getElementById('practitionerStatus').textContent = 'Online';
            const headerAvatar = document.getElementById('headerPractitionerAvatar');
            if (headerAvatar) {
                headerAvatar.innerHTML = connectedPractitioner.profileImage ? `
                    <img src="${connectedPractitioner.profileImage}" alt="${connectedPractitioner.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                ` : (connectedPractitioner.name ? connectedPractitioner.name.charAt(0).toUpperCase() : 'P');
            }
            
            try {
                // Force use of local storage for now to ensure document data is preserved
                console.log('ðŸ’¾ Using local storage for message loading');
                const messages = cleartrackData.getMessages(currentUser.id, connectedPractitioner.id);
                console.log('ðŸ’¾ Messages retrieved:', messages.length);
                console.log('ðŸ’¾ Sample message:', messages[0]);
                displayMessages(messages);
                
                // Check if messaging service is available for read receipts
                if (window.messagingService && typeof messagingService.markAllMessagesAsRead === 'function') {
                    await messagingService.markAllMessagesAsRead(connectedPractitioner.id);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
                // Fallback to local storage if backend fails
                const messages = cleartrackData.getMessages(currentUser.id, connectedPractitioner.id);
                displayMessages(messages);
            }
        }
        
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            
            if (!messagesList) {
                console.error('âŒ messagesList element not found');
                return;
            }
            
            if (!messages || messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="whatsapp-date-separator">
                        <div class="whatsapp-date-badge">Today</div>
                    </div>
                    <p style="color: #667781; text-align: center; padding: 20px;">No messages yet. Start a conversation with your practitioner!</p>
                `;
                return;
            }
            
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            const practitionerName = connectedPractitioner ? `${connectedPractitioner.firstName} ${connectedPractitioner.lastName}` : 'Practitioner';
            
            // Group messages by date
            const groupedMessages = groupMessagesByDate(messages);
            
            let html = '';
            for (const [date, dayMessages] of Object.entries(groupedMessages)) {
                html += `
                    <div class="whatsapp-date-separator">
                        <div class="whatsapp-date-badge">${date}</div>
                    </div>
                `;
                
                html += dayMessages.map(message => {
                // Determine if message is from user or practitioner
                // Check multiple ways to determine sender
                const isUserMessage = message.sender === 'user' || 
                                     (message.userId && String(message.userId) === String(currentUser.id) && message.sender !== 'practitioner') ||
                                     (!message.sender && message.userId && String(message.userId) === String(currentUser.id));
                    const messageTime = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    let content = '';
                    if (message.type === 'voice' || message.type === 'audio') {
                    content = `
                            <div class="whatsapp-file-attachment">
                                <div class="whatsapp-file-icon">ðŸŽµ</div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">Voice Message</div>
                                    <div class="whatsapp-file-size">Audio</div>
                                </div>
                            <audio controls style="max-width: 200px;">
                                <source src="${message.audioData}" type="audio/wav">
                            </audio>
                        </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                    `;
                } else if (message.type === 'image') {
                    const fileData = message.fileData || (message.attachment && message.attachment.fileData);
                    const fileName = message.fileName || (message.attachment && message.attachment.fileName);
                    content = `
                            <div class="whatsapp-image-attachment">
                                <img src="${fileData}" alt="${fileName}" onclick="openImageModal('${fileData}', '${fileName}')">
                        </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                    `;
                } else if (message.type === 'file' || message.type === 'document') {
                    console.log('ðŸ” Processing document message:', message);
                    let fileData = message.fileData || (message.attachment && message.attachment.fileData);
                    const fileName = message.fileName || (message.attachment && message.attachment.fileName);
                    const fileType = message.fileType || (message.attachment && message.attachment.fileType);
                    
                    // Ensure fileData is properly formatted as a data URL
                    if (fileData && !fileData.startsWith('data:')) {
                        const fileExtension = fileName.split('.').pop().toLowerCase();
                        let mimeType = 'application/octet-stream';
                        
                        // Determine MIME type based on file extension
                        switch (fileExtension) {
                            case 'pdf':
                                mimeType = 'application/pdf';
                                break;
                            case 'jpg':
                            case 'jpeg':
                                mimeType = 'image/jpeg';
                                break;
                            case 'png':
                                mimeType = 'image/png';
                                break;
                            case 'gif':
                                mimeType = 'image/gif';
                                break;
                            case 'txt':
                                mimeType = 'text/plain';
                                break;
                            case 'csv':
                                mimeType = 'text/csv';
                                break;
                            case 'doc':
                                mimeType = 'application/msword';
                                break;
                            case 'docx':
                                mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                                break;
                        }
                        
                        fileData = `data:${mimeType};base64,${fileData}`;
                    }
                    
                    console.log('ðŸ“„ Document data:', { fileData: !!fileData, fileName, fileType });
                    
                    // Check if it's a PDF for inline viewing
                    if (fileType === 'application/pdf') {
                        content = `
                            <div class="whatsapp-file-attachment pdf-attachment">
                                <div class="whatsapp-file-icon">ðŸ“„</div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">${fileName || 'PDF Document'}</div>
                                    <div class="whatsapp-file-size">PDF Document</div>
                                </div>
                                <div class="whatsapp-file-actions">
                                    ${fileData ? `<button class="whatsapp-file-preview" onclick="openDocumentPreview('${fileData}', '${fileName}')">Preview</button>` : ''}
                                    ${fileData ? `<button class="whatsapp-file-download" onclick="downloadFile('${fileData}', '${fileName}')">Download</button>` : ''}
                                </div>
                            </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                        `;
                    } else {
                        // Other document types
                        content = `
                            <div class="whatsapp-file-attachment">
                                <div class="whatsapp-file-icon">ðŸ“„</div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">${fileName || 'Document'}</div>
                                    <div class="whatsapp-file-size">Document</div>
                                </div>
                                ${fileData ? `<button class="whatsapp-file-download" onclick="downloadFile('${fileData}', '${fileName}')">Download</button>` : ''}
                            </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                        `;
                    }
                } else if (message.type === 'invoice') {
                    const inv = message.invoiceData || {};
                    const invNum = inv.invoiceNumber || 'N/A';
                    const invId = inv.id || inv.invoiceId || '';
                    const totalNum = Number(inv.total ?? inv.amount ?? 0);
                    const totalDisplay = isFinite(totalNum) ? totalNum.toFixed(2) : '0.00';
                    content = `
                            <div class="whatsapp-file-attachment">
                                <div class="whatsapp-file-icon">ðŸ“„</div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">Invoice ${invNum}</div>
                                    <div class="whatsapp-file-size">R ${totalDisplay}</div>
                                </div>
                                <div class="whatsapp-file-actions">
                                    <button class="whatsapp-file-preview" onclick="viewInvoiceFromChatUser('${invId}')">View</button>
                                    <button class="whatsapp-file-download" onclick="downloadInvoiceFromChatUser('${invId}')">Download</button>
                                </div>
                            </div>
                            ${message.text ? `<div class=\"whatsapp-message-text\">${message.text}</div>` : ''}
                    `;
                } else {
                    // Regular text message
                    const messageText = message.text || message.message || '';
                    content = `<div class="whatsapp-message-text">${messageText}</div>`;
                }
                    
                // Determine message status for read receipts
                let statusIcon = '';
                if (isUserMessage) {
                    const messageStatus = message.read ? 'read' : (message.delivered ? 'delivered' : 'sent');
                    const statusColor = message.read ? 'read' : (message.delivered ? 'delivered' : 'sent');
                    statusIcon = `<span class="whatsapp-message-status ${statusColor}">${message.read ? 'âœ“âœ“' : (message.delivered ? 'âœ“âœ“' : 'âœ“')}</span>`;
                }
                
                return `
                        <div class="whatsapp-message ${isUserMessage ? 'sent' : 'received'}">
                            <div class="whatsapp-message-bubble">
                            ${content}
                                <div class="whatsapp-message-time">
                                    ${messageTime}
                                    ${statusIcon}
                                </div>
                        </div>
                    </div>
                `;
            }).join('');
            }
            
            messagesList.innerHTML = html;
            
            // User dashboard doesn't have sidebar, so no need to update last message
            
            // Scroll to bottom
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // View invoice from chat (user view) - opens in modal with identical format as practitioner
        function viewInvoiceFromChatUser(invoiceId) {
            try {
                const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
                if (!connectedPractitioner || !invoiceId) {
                    alert('Invoice not found.');
                    return;
                }
                const allInvoices = cleartrackData.getInvoicesForPractitioner(connectedPractitioner.id);
                const invoice = allInvoices.find(inv => String(inv.id) === String(invoiceId));
                if (!invoice) {
                    alert('Invoice not found.');
                    return;
                }
                // Open invoice in modal with the same format as practitioner generates
                createInvoiceViewModal(invoice, connectedPractitioner);
            } catch (e) {
                console.error('Failed to view invoice:', e);
                alert('Invoice not found.');
            }
        }
        
        // Download invoice from chat (user view)
        function downloadInvoiceFromChatUser(invoiceId) {
            try {
                const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
                if (!connectedPractitioner || !invoiceId) {
                    alert('Invoice not found.');
                    return;
                }
                const allInvoices = cleartrackData.getInvoicesForPractitioner(connectedPractitioner.id);
                const invoice = allInvoices.find(inv => String(inv.id) === String(invoiceId));
                if (!invoice) {
                    alert('Invoice not found.');
                    return;
                }
                if (typeof downloadInvoiceAsPDF === 'function') {
                    downloadInvoiceAsPDF(invoice);
                } else if (typeof createInvoicePDFFile === 'function') {
                    createInvoicePDFFile(invoice);
                } else {
                    // Use the same view generation for print/save
                    createInvoiceViewModal(invoice, connectedPractitioner, true);
                }
            } catch (e) {
                console.error('Failed to download invoice:', e);
                alert('Invoice not found.');
            }
        }
        
        // Unified Invoice HTML Generator - Used by all invoice functions to ensure identical output
        function generateUnifiedInvoiceHTML(invoice, options = {}) {
            // Get practitioner details from options or use provided practitioner
            const practitionerName = options.practitionerName || (options.practitioner ? `${options.practitioner.firstName} ${options.practitioner.lastName}` : 'Practitioner');
            const practitionerEmail = options.practitionerEmail || (options.practitioner ? options.practitioner.email : '');
            const practitionerPhone = options.practitionerPhone || (options.practitioner ? options.practitioner.phone : '');
            
            const bankDetails = invoice.bankDetails || {
                bankName: '', bankBranch: '', accountNumber: '', accountType: 'business', bankReference: ''
            };
            
            // VAT label helper
            function getVATLabel(vatType) {
                switch (vatType) {
                    case 'standard': return 'VAT (15%)';
                    case 'exempt': return 'VAT Exempt';
                    case 'zero': return 'Zero Rated (0%)';
                    default: return 'VAT';
                }
            }
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${invoice.invoiceNumber}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: white; }
        .invoice-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }
        .invoice-header-left { flex-shrink: 0; }
        .invoice-header-right { flex: 1; text-align: right; }
        .invoice-title { font-size: 28px; font-weight: bold; color: #2563eb; margin: 0 0 5px 0; }
        .invoice-subtitle { font-size: 16px; color: #6b7280; margin: 0; }
        .invoice-details { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .invoice-info { flex: 1; }
        .client-info { flex: 1; text-align: right; }
        .info-section h3 { margin: 0 0 10px 0; color: #374151; font-size: 16px; }
        .info-section p { margin: 5px 0; color: #6b7280; font-size: 14px; }
        .invoice-table { width: 100%; border-collapse: collapse; margin: 30px 0; }
        .invoice-table th, .invoice-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; word-wrap: break-word; word-break: break-word; white-space: normal; overflow-wrap: break-word; }
        .invoice-table th { background-color: #f9fafb; font-weight: bold; color: #374151; }
        .invoice-table .amount { text-align: right; }
        .invoice-totals { margin-top: 20px; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .total-row.final { font-weight: bold; font-size: 18px; color: #2563eb; border-top: 2px solid #2563eb; margin-top: 10px; }
        .invoice-notes { margin-top: 30px; padding: 15px; background-color: #f9fafb; border-radius: 8px; }
        .invoice-notes h4 { margin: 0 0 10px 0; color: #374151; }
        .invoice-notes p { margin: 0; color: #6b7280; font-size: 14px; line-height: 1.5; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="invoice-header">
        <div class="invoice-header-left">
            <img src="assets/images/full logo CT.png" alt="ClearTrack Logo" style="max-width: 200px; height: auto;">
        </div>
        <div class="invoice-header-right">
            <h1 class="invoice-title">INVOICE</h1>
            <p class="invoice-subtitle">ClearTrack Tax Services</p>
        </div>
    </div>
    
    <div class="invoice-details">
        <div class="invoice-info">
            <div class="info-section">
                <h3>From:</h3>
                <p><strong>${practitionerName}</strong></p>
                <p>${practitionerEmail}</p>
                <p>${practitionerPhone}</p>
            </div>
        </div>
        <div class="client-info">
            <div class="info-section">
                <h3>Invoice Details:</h3>
                <p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
                <p><strong>Date:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString()}</p>
                <p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>
            </div>
            <div class="info-section" style="margin-top: 20px;">
                <h3>Bill To:</h3>
                <p><strong>${invoice.clientName}</strong></p>
                <p>Tax Year: ${invoice.taxYear}</p>
            </div>
        </div>
    </div>
    
    <table class="invoice-table">
        <thead>
            <tr>
                <th>Description</th>
                <th class="amount">Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>${invoice.description || 'Services'}</td>
                <td class="amount">R ${Number(invoice.amount || 0).toFixed(2)}</td>
            </tr>
        </tbody>
    </table>
    
    <div class="invoice-totals">
        <div class="total-row">
            <span>Subtotal:</span>
            <span>R ${Number(invoice.amount || 0).toFixed(2)}</span>
        </div>
        <div class="total-row">
            <span>${getVATLabel(invoice.vatType || 'standard')}:</span>
            <span>R ${Number(invoice.vat || 0).toFixed(2)}</span>
        </div>
        ${invoice.vatReason ? `<div class="total-row" style="font-size: 12px; color: #6b7280;"><span>VAT Exemption Reason:</span><span>${invoice.vatReason}</span></div>` : ''}
        <div class="total-row final">
            <span>Total:</span>
            <span>R ${Number(invoice.total || 0).toFixed(2)}</span>
        </div>
    </div>
    
    <div class="invoice-notes">
        <h4>Payment Details</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
            <div>
                <h5 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">Bank Details:</h5>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Bank:</strong> ${bankDetails.bankName || 'Not specified'}</p>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Branch:</strong> ${bankDetails.bankBranch || 'Not specified'}</p>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Account:</strong> ${bankDetails.accountNumber || 'Not specified'}</p>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Type:</strong> ${bankDetails.accountType || 'business'}</p>
            </div>
            <div>
                <h5 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">Payment Reference:</h5>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">${bankDetails.bankReference || invoice.invoiceNumber}</p>
            </div>
        </div>
        ${invoice.notes ? `<p style="margin: 10px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.5;">${invoice.notes}</p>` : ''}
    </div>
</body>
</html>`;
        }
        
        // Create invoice view modal (identical format to practitioner invoice)
        function createInvoiceViewModal(invoice, practitioner, forPrint = false) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            // Use unified invoice HTML generator
            const invoiceHTML = generateUnifiedInvoiceHTML(invoice, { practitioner });
            
            if (forPrint) {
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('Please allow pop-ups to download the invoice.');
                    return;
                }
                printWindow.document.write(invoiceHTML);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            } else {
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'width: 90%; max-width: 900px; height: 90vh; border: none; border-radius: 8px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
                modal.appendChild(iframe);
                document.body.appendChild(modal);
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
                
                // Write content immediately
                iframe.onload = () => {
                    try {
                        iframe.contentDocument.open();
                        iframe.contentDocument.write(invoiceHTML);
                        iframe.contentDocument.close();
                    } catch (err) {
                        console.error('Error writing to iframe:', err);
                        // Fallback: use srcdoc if available
                        if (iframe.srcdoc !== undefined) {
                            iframe.srcdoc = invoiceHTML;
                        } else {
                            modal.innerHTML = '<div style="padding: 40px; background: white; border-radius: 8px;"><h2>Unable to display invoice</h2><p>Please use the Download button instead.</p></div>';
                        }
                    }
                };
                
                // Set content immediately if iframe is already loaded
                try {
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(invoiceHTML);
                    iframe.contentDocument.close();
                } catch (err) {
                    // If iframe not ready, wait for onload
                }
            }
        }

        // Lightweight print/"PDF" generator for the user app
        function createInvoicePDFFallback(invoice) {
            try {
                const w = window.open('', '_blank');
                if (!w) { alert('Please allow pop-ups to download the invoice.'); return; }
                const bank = invoice.bankDetails || {};
                const html = `<!DOCTYPE html>
                <html><head><meta charset="UTF-8"><title>Invoice ${invoice.invoiceNumber}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #fff; }
                    .container { max-width: 820px; margin: 0 auto; }
                    .header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:2px solid #e5e7eb; padding-bottom:16px; margin-bottom:24px; }
                    .title { font-size:28px; font-weight:700; color:#111827; }
                    .num { color:#6b7280; }
                    .section h3 { margin:0 0 8px 0; color:#374151; }
                    .table { width:100%; border-collapse:collapse; margin:20px 0; }
                    .table th,.table td { padding:12px; border-bottom:1px solid #e5e7eb; text-align:left; }
                    .amount { text-align:right; }
                    .totals { width:300px; margin-left:auto; }
                    .row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #e5e7eb; }
                    .row.final { font-weight:700; border-top:2px solid #e5e7eb; }
                    .notes { background:#f9fafb; padding:12px; border-radius:8px; }
                </style></head>
                <body><div class="container">
                    <div class="header">
                        <div class="title">INVOICE</div>
                        <div class="num">
                            <div>${invoice.invoiceNumber}</div>
                            <div>Date: ${new Date(invoice.invoiceDate).toLocaleDateString()}</div>
                            <div>Due: ${new Date(invoice.dueDate).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="section">
                        <h3>Bill To</h3>
                        <div><strong>${invoice.clientName || ''}</strong></div>
                        <div>${invoice.clientEmail || ''}</div>
                    </div>
                    <table class="table">
                        <thead><tr><th>Description</th><th class="amount">Amount</th></tr></thead>
                        <tbody><tr><td>${invoice.description || 'Services'}</td><td class="amount">R ${(Number(invoice.amount||0)).toFixed(2)}</td></tr></tbody>
                    </table>
                    <div class="totals">
                        <div class="row"><span>Subtotal</span><span>R ${(Number(invoice.amount||0)).toFixed(2)}</span></div>
                        <div class="row"><span>${invoice.vatType==='standard'?'VAT (15%)':'VAT'}</span><span>R ${(Number(invoice.vat||0)).toFixed(2)}</span></div>
                        <div class="row final"><span>Total</span><span>R ${(Number(invoice.total||0)).toFixed(2)}</span></div>
                    </div>
                    <div class="section">
                        <h3>Payment Details</h3>
                        <div class="notes">
                            <div><strong>Bank:</strong> ${bank.bankName||'-'}</div>
                            <div><strong>Branch:</strong> ${bank.bankBranch||'-'}</div>
                            <div><strong>Account:</strong> ${bank.accountNumber||'-'}</div>
                            <div><strong>Reference:</strong> ${bank.bankReference||invoice.invoiceNumber}</div>
                        </div>
                    </div>
                    ${invoice.notes ? `<div class="section"><h3>Notes</h3><div class="notes">${invoice.notes}</div></div>` : ''}
                </div>
                <script>window.onload = function(){ setTimeout(function(){ window.print(); window.close(); }, 400); }<\/script>
                </body></html>`;
                w.document.open();
                w.document.write(html);
                w.document.close();
            } catch(err) {
                console.error('PDF fallback failed', err);
                alert('Unable to render invoice.');
            }
        }
        
        function groupMessagesByDate(messages) {
            const groups = {};
            messages.forEach(message => {
                const date = new Date(message.timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let dateKey;
                if (date.toDateString() === today.toDateString()) {
                    dateKey = 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    dateKey = 'Yesterday';
                } else {
                    dateKey = date.toLocaleDateString();
                }
                
                if (!groups[dateKey]) {
                    groups[dateKey] = [];
                }
                groups[dateKey].push(message);
            });
            return groups;
        }
        
        // Helper functions for file handling
        function openImageModal(imageSrc, fileName) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = () => document.body.removeChild(modal);
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
            img.onclick = (e) => e.stopPropagation();
            
            modal.appendChild(img);
            document.body.appendChild(modal);
        }
        
        function downloadFile(fileData, fileName) {
            console.log('Downloading file:', fileName, 'Data type:', typeof fileData);
            
            // If it's already a data URL, use it directly
            if (fileData && fileData.startsWith('data:')) {
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }
            
            // If it's a file path, try to fetch it first
            if (fileData && !fileData.startsWith('http')) {
                fetch(fileData)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('File not found');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(error => {
                        console.error('Error downloading file:', error);
                        alert('Error downloading file. Please try again.');
                    });
                return;
            }
            
            // For HTTP URLs, try to download directly
            if (fileData && fileData.startsWith('http')) {
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }
            
            // Fallback: try to create a data URL from the file data
            try {
                // If fileData looks like base64 content, try to create a data URL
                if (fileData && typeof fileData === 'string' && !fileData.includes(' ')) {
                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    let mimeType = 'application/octet-stream';
                    
                    // Determine MIME type based on file extension
                    switch (fileExtension) {
                        case 'pdf':
                            mimeType = 'application/pdf';
                            break;
                        case 'jpg':
                        case 'jpeg':
                            mimeType = 'image/jpeg';
                            break;
                        case 'png':
                            mimeType = 'image/png';
                            break;
                        case 'gif':
                            mimeType = 'image/gif';
                            break;
                        case 'txt':
                            mimeType = 'text/plain';
                            break;
                        case 'csv':
                            mimeType = 'text/csv';
                            break;
                        case 'doc':
                            mimeType = 'application/msword';
                            break;
                        case 'docx':
                            mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                            break;
                    }
                    
                    const dataUrl = `data:${mimeType};base64,${fileData}`;
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    return;
                }
            } catch (error) {
                console.error('Error creating data URL:', error);
            }
            
            // Final fallback: show error message
            alert('Unable to download file. The file data is not in a supported format.');
        }
        
        // Document preview functionality
        function openDocumentPreview(fileData, fileName) {
            const modal = document.createElement('div');
            modal.className = 'document-preview-modal';
            
            // Determine file type and create appropriate content
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let previewContent = '';
            let isPdf = false;
            
            // Check if it's a PDF by extension or content
            if (fileExtension === 'pdf' || (fileData && fileData.includes('pdf'))) {
                isPdf = true;
                previewContent = `
                    <div class="document-preview-content pdf-viewer">
                        <iframe src="${fileData}" width="100%" height="600px" frameborder="0" style="border: none; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;"></iframe>
                    </div>
                `;
            } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                previewContent = `
                    <div class="document-preview-content">
                        <div style="text-align: center;">
                            <img src="${fileData}" alt="${fileName}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                `;
            } else if (['txt', 'csv'].includes(fileExtension)) {
                // Try to display text files
                try {
                    if (fileData.includes('data:text/') || fileData.includes('data:application/')) {
                        const textContent = atob(fileData.split(',')[1]);
                        previewContent = `
                            <div class="document-preview-content">
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 60vh; overflow-y: auto; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                    ${textContent}
                                </div>
                            </div>
                        `;
                    } else {
                        throw new Error('Not a data URL');
                    }
                } catch (e) {
                    previewContent = `
                        <div class="document-preview-content">
                            <div style="text-align: center; padding: 2rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                <div class="no-client-icon">
                                    <svg class="icon icon-2xl icon-gray-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <p style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">This file type cannot be previewed in the browser.</p>
                                <p class="text-gray-500 text-sm" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">Please download the file to view it.</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                // For other file types, try to display as iframe first
                previewContent = `
                    <div class="document-preview-content">
                        <iframe src="${fileData}" width="100%" height="600px" frameborder="0" style="border: none; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;"></iframe>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="document-preview-overlay" onclick="closeDocumentPreview()">
                    <div class="document-preview-container" onclick="event.stopPropagation()">
                        <div class="document-preview-header">
                            <h3>${fileName}</h3>
                            <button class="close-btn" onclick="closeDocumentPreview()">&times;</button>
                        </div>
                        ${previewContent}
                        <div class="document-preview-footer">
                            <button onclick="downloadFile('${fileData}', '${fileName}')" class="download-btn">Download</button>
                            <button onclick="closeDocumentPreview()" class="close-btn">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add PDF-specific handling
            if (isPdf) {
                const iframe = modal.querySelector('iframe');
                if (iframe) {
                    iframe.onload = function() {
                        // Add a small delay to ensure proper rendering
                        setTimeout(() => {
                            iframe.style.transform = 'scale(0.7)';
                            iframe.style.transformOrigin = 'top left';
                            iframe.style.width = '142.86%';
                            iframe.style.height = '142.86%';
                        }, 100);
                    };
                }
            }
        }
        
        function closeDocumentPreview() {
            const modal = document.querySelector('.document-preview-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        
        async function sendMessage() {
            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText) return;
            
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            if (!connectedPractitioner) {
                alert('You are not connected to a practitioner.');
                return;
            }
            
            // Create messageData for immediate display (always define it)
            const messageData = {
                text: messageText,
                sender: 'user',
                type: 'text',
                sent: true,
                delivered: false,
                read: false
            };
            
            // Clear input immediately for better UX
            document.getElementById('messageText').value = '';
            
            // Display message immediately for better UX
            displayMessages([messageData]);
            
            try {
                // Check if messaging service is available and working
                if (window.messagingService && typeof messagingService.sendMessage === 'function') {
                    try {
                        // Try backend API first
                        await messagingService.sendMessage(connectedPractitioner.id, messageText);
                        console.log('âœ… Message sent via backend API');
                    } catch (apiError) {
                        console.log('âš ï¸ Backend API failed, using local storage fallback:', apiError.message);
                        // Fallback to local storage
                        cleartrackData.addMessage(currentUser.id, connectedPractitioner.id, messageData);
                    }
                } else {
                    // Use local storage directly
                    console.log('ðŸ’¾ Using local storage for message');
                    const storedMessage = cleartrackData.addMessage(currentUser.id, connectedPractitioner.id, messageData);
                    console.log('ðŸ’¾ Message stored with ID:', storedMessage.id);
                }
                
                // Refresh from storage to ensure consistency
                await loadMessages();
                
                // Simulate message status updates (delivery and read receipts)
                simulateMessageStatusUpdates();
                
            } catch (error) {
                console.error('Failed to send message:', error);
                // Don't show error alert since message is already displayed
                // The message was successfully displayed, just storage might have failed
                console.log('Message displayed but storage failed - this is not critical');
            }
        }
        
        function cancelMessage() {
            document.getElementById('messageText').value = '';
        }
        
        // WhatsApp-style interface functions
        // Removed unused functions: refreshMessages, openSettings, searchInChat
        // These were for sidebar functionality that has been removed
        
        // WebRTC calling functionality for user dashboard
        let localStream = null;
        let peerConnection = null;
        let isCallActive = false;

        function callPractitioner() {
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            if (!connectedPractitioner) {
                alert('Please connect to a practitioner first');
                return;
            }
            
            if (isCallActive) {
                alert('A call is already active');
                return;
            }
            
            startAudioCall();
        }
        
        function videoCallPractitioner() {
            if (!currentUser) {
                showUserNotification('User not found. Please refresh the page.', 'error');
                return;
            }
            
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            if (!connectedPractitioner) {
                alert('Please connect to a practitioner first');
                return;
            }
            
            if (isCallActive) {
                alert('A call is already active');
                return;
            }
            
            startVideoCall();
        }
        
        function openChatMenu() {
            alert('Chat menu functionality coming soon!');
        }
        
        async function startAudioCall() {
            try {
                // Request microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
                
                // Create peer connection
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    const remoteStream = event.streams[0];
                    playRemoteAudio(remoteStream);
                };
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Send call offer to practitioner via messaging system
                const callOffer = {
                    type: 'call_offer',
                    offer: offer,
                    callType: 'audio',
                    timestamp: new Date().toISOString()
                };
                
                // Store call offer in local storage for practitioner to pick up
                const callOffers = JSON.parse(localStorage.getItem('cleartrack_call_offers') || '[]');
                callOffers.push(callOffer);
                localStorage.setItem('cleartrack_call_offers', JSON.stringify(callOffers));
                
                console.log('Call offer created and stored:', offer);
                
                isCallActive = true;
                showCallInterface('audio');
                
                // Simulate practitioner accepting the call (in real app, this would come from practitioner)
                setTimeout(() => {
                    simulatePractitionerCallAcceptance();
                }, 2000);
                
            } catch (error) {
                console.error('Error starting call:', error);
                alert('Unable to start call. Please check microphone permissions.');
            }
        }
        
        async function startVideoCall() {
            try {
                // Request camera and microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: true 
                });
                
                // Create peer connection
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    const remoteStream = event.streams[0];
                    playRemoteVideo(remoteStream);
                };
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Send call offer to practitioner via messaging system
                const callOffer = {
                    type: 'call_offer',
                    offer: offer,
                    callType: 'video',
                    timestamp: new Date().toISOString()
                };
                
                // Store call offer in local storage for practitioner to pick up
                const callOffers = JSON.parse(localStorage.getItem('cleartrack_call_offers') || '[]');
                callOffers.push(callOffer);
                localStorage.setItem('cleartrack_call_offers', JSON.stringify(callOffers));
                
                console.log('Video call offer created and stored:', offer);
                
                isCallActive = true;
                showCallInterface('video');
                
                // Simulate practitioner accepting the call (in real app, this would come from practitioner)
                setTimeout(() => {
                    simulatePractitionerCallAcceptance();
                }, 2000);
                
            } catch (error) {
                console.error('Error starting video call:', error);
                alert('Unable to start video call. Please check camera and microphone permissions.');
            }
        }
        
        function showCallInterface(type) {
            // Get practitioner name
            const practitionerName = document.getElementById('headerPractitionerName').textContent;
            
            // Create call interface overlay
            const callOverlay = document.createElement('div');
            callOverlay.id = 'callOverlay';
            callOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
            `;
            
            callOverlay.innerHTML = `
                <div style="text-align: center; background: #1a1a1a; padding: 2rem; border-radius: 10px;">
                    <h3>Calling ${practitionerName}</h3>
                    <p>${type === 'video' ? 'Video' : 'Audio'} call in progress...</p>
                    <div style="margin: 1rem 0;">
                        <button onclick="endCall()" style="background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            End Call
                        </button>
                    </div>
                    ${type === 'video' ? '<video id="localVideo" autoplay muted style="width: 200px; height: 150px; background: #333;"></video>' : ''}
                </div>
            `;
            
            document.body.appendChild(callOverlay);
            
            // Show local video if it's a video call
            if (type === 'video' && localStream) {
                const localVideo = document.getElementById('localVideo');
                if (localVideo) {
                    localVideo.srcObject = localStream;
                }
            }
        }
        
        function playRemoteAudio(stream) {
            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.volume = 1.0;
            document.body.appendChild(audio);
        }
        
        function playRemoteVideo(stream) {
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.style.cssText = 'width: 200px; height: 150px; background: #333;';
            document.getElementById('callOverlay').querySelector('div').appendChild(video);
        }
        
        function simulatePractitionerCallAcceptance() {
            // In a real app, this would be triggered by the practitioner accepting the call
            console.log('Practitioner accepted the call');
        }
        
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            isCallActive = false;
            
            // Remove call overlay
            const callOverlay = document.getElementById('callOverlay');
            if (callOverlay) {
                callOverlay.remove();
            }
            
            // Notify practitioner that call ended
            const callEnd = {
                type: 'call_end',
                timestamp: new Date().toISOString()
            };
            
            // Store call end notification in localStorage for practitioner to pick up
            const callEvents = JSON.parse(localStorage.getItem('cleartrack_call_events') || '[]');
            callEvents.push(callEnd);
            localStorage.setItem('cleartrack_call_events', JSON.stringify(callEvents));
            
            console.log('Call ended - notification sent to practitioner');
        }
        
        // Simulate message status updates (like WhatsApp)
        function simulateMessageStatusUpdates() {
            // Simulate delivery after 1-2 seconds
            setTimeout(() => {
                updateMessageStatus('delivered');
            }, Math.random() * 1000 + 1000);
            
            // Simulate read after 3-5 seconds
            setTimeout(() => {
                updateMessageStatus('read');
            }, Math.random() * 2000 + 3000);
        }
        
        function updateMessageStatus(status) {
            const messages = document.querySelectorAll('.whatsapp-message.sent');
            const lastMessage = messages[messages.length - 1];
            if (lastMessage) {
                const statusElement = lastMessage.querySelector('.whatsapp-message-status');
                if (statusElement) {
                    if (status === 'delivered') {
                        statusElement.textContent = 'âœ“âœ“';
                        statusElement.className = 'whatsapp-message-status delivered';
                    } else if (status === 'read') {
                        statusElement.textContent = 'âœ“âœ“';
                        statusElement.className = 'whatsapp-message-status read';
                    }
                }
            }
        }
        
        
        // Load practitioners directory
        function loadPractitionersDirectory() {
            const practitioners = cleartrackData.getAllPractitioners();
            const directory = document.getElementById('practitionersDirectory');
            
            if (practitioners.length === 0) {
                directory.innerHTML = '<p style="color: #6b7280; text-align: center;">No practitioners available at the moment.</p>';
                return;
            }
            
            directory.innerHTML = practitioners.map(practitioner => {
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; background: white; transition: box-shadow 0.2s;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; color: #6b7280; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; overflow: hidden; flex-shrink: 0; border: 2px solid #e5e7eb;">
                                    ${practitioner.profileImage ? 
                                        `<img src="${practitioner.profileImage}" alt="${practitioner.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />` : 
                                        practitioner.name.charAt(0)
                                    }
                                </div>
                            <div>
                                <h4 style="margin: 0 0 0.25rem 0; color: #374151;">${practitioner.name}</h4>
                                <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">${practitioner.practiceName}</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; color: #6b7280;">${practitioner.yearsExperience} years experience</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Code: ${practitioner.practitionerCode}</div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="viewPractitionerDetails('${practitioner.id}')" style="flex: 1; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; padding: 0.5rem; cursor: pointer; font-size: 0.875rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
                                View Details
                            </button>
                            <button onclick="sendConnectionRequest('${practitioner.id}')" style="flex: 1; background: #0b7285; color: white; border: none; border-radius: 6px; padding: 0.5rem; cursor: pointer; font-size: 0.875rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#095a69'" onmouseout="this.style.backgroundColor='#0b7285'">
                                Connect
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View practitioner details
        function viewPractitionerDetails(practitionerId) {
            const practitioner = cleartrackData.getAllPractitioners().find(p => p.id === practitionerId);
            if (!practitioner) return;
            
            const specializations = Array.isArray(practitioner.specializations) 
                ? practitioner.specializations.join(', ') 
                : practitioner.specializations || 'Not specified';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #374151;">${practitioner.name}</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                    </div>
                    
                    <div class="mb-4">
                        <strong>Practice:</strong> ${practitioner.practiceName}<br>
                        <strong>Experience:</strong> ${practitioner.yearsExperience} years<br>
                        <strong>Code:</strong> ${practitioner.practitionerCode}
                    </div>
                    
                    <div class="mb-4">
                        <strong>Qualifications:</strong><br>
                        <div style="color: #6b7280; margin-top: 0.25rem;">${practitioner.qualifications || 'Not specified'}</div>
                    </div>
                    
                    <div class="mb-4">
                        <strong>Specializations:</strong><br>
                        <div style="color: #6b7280; margin-top: 0.25rem;">${specializations}</div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <strong>About:</strong><br>
                        <div style="color: #6b7280; margin-top: 0.25rem; line-height: 1.4;">${practitioner.bio || 'No bio available.'}</div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer;">Close</button>
                        <button onclick="sendConnectionRequest('${practitioner.id}'); this.closest('.modal-overlay').remove();" style="background: #0b7285; color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer;">Connect</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Send connection request
        async function sendConnectionRequest(practitionerId) {
            if (!currentUser) {
                alert('Please log in to send connection requests.');
                return;
            }
            
            // Try to get practitioner from Firestore or localStorage
            let practitioner = null;
            try {
                // First try to get from Firestore if available
                if (window.firestoreData && window.firestoreData.db) {
                    const userDoc = await window.firestoreData.db.collection('users').doc(practitionerId).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        if (data.role === 'practitioner') {
                            practitioner = { id: userDoc.id, ...data };
                        }
                    }
                }
                
                // Fallback to localStorage
                if (!practitioner) {
                    const allPractitioners = cleartrackData.getAllPractitioners();
                    practitioner = allPractitioners.find(p => p.id === practitionerId);
                }
            } catch (error) {
                console.error('Error getting practitioner:', error);
                const allPractitioners = cleartrackData.getAllPractitioners();
                practitioner = allPractitioners.find(p => p.id === practitionerId);
            }
            
            if (!practitioner) {
                alert('Practitioner not found.');
                return;
            }
            
            // Check if already connected
            const existingConnection = cleartrackData.getConnectedPractitioner(currentUser.id);
            if (existingConnection) {
                alert('You are already connected to a practitioner. Please disconnect first to connect to a new one.');
                return;
            }
            
            // Send connection request using new system
            const result = await cleartrackData.sendConnectionRequest(currentUser.id, practitionerId);
            
            if (result.success) {
                if (result.message) {
                    alert(`Connection request already exists for ${practitioner.name}. Please wait for approval.`);
                } else {
                alert(`Connection request sent to ${practitioner.name}. They will be notified and can approve your request.`);
                }
            } else {
                alert(`Error: ${result.error}. Please try again.`);
            }
        }
        
        
        // Mobile keyboard support
        function handleMessageKeydown(event) {
            // Send message on Enter (but allow Shift+Enter for new lines)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Simple emoji picker functions
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const attachmentMenu = document.getElementById('attachmentMenu');
            
            // Close attachment menu if open
            attachmentMenu.style.display = 'none';
            
            if (picker.style.display === 'none') {
                picker.style.display = 'block';
                loadEmojis();
            } else {
                picker.style.display = 'none';
            }
        }
        
        function closeEmojiPicker() {
            document.getElementById('emojiPicker').style.display = 'none';
        }
        
        // WhatsApp-style attachment menu
        function toggleAttachmentMenu() {
            const menu = document.getElementById('attachmentMenu');
            const emojiPicker = document.getElementById('emojiPicker');
            
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                emojiPicker.style.display = 'none';
            } else {
                menu.style.display = 'none';
            }
        }
        
        function closeAttachmentMenu() {
            document.getElementById('attachmentMenu').style.display = 'none';
        }
        
        // Close modals when clicking outside
        function closeAllModals() {
            document.getElementById('attachmentMenu').style.display = 'none';
            document.getElementById('emojiPicker').style.display = 'none';
        }
        
        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }
        
        function loadEmojis() {
            const grid = document.getElementById('emojiGrid');
            if (grid.children.length > 0) return; // Already loaded
            
            const emojis = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜‡','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Œ','ðŸ˜','ðŸ¥°','ðŸ˜˜','ðŸ˜—','ðŸ˜™','ðŸ˜š','ðŸ˜‹','ðŸ˜›','ðŸ˜','ðŸ˜œ','ðŸ¤ª','ðŸ¤¨','ðŸ§','ðŸ¤“','ðŸ˜Ž','ðŸ¤©','ðŸ¥³','ðŸ˜','ðŸ˜’','ðŸ˜ž','ðŸ˜”','ðŸ˜Ÿ','ðŸ˜•','ðŸ™','â˜¹ï¸','ðŸ˜£','ðŸ˜–','ðŸ˜«','ðŸ˜©','ðŸ¥º','ðŸ˜¢','ðŸ˜­','ðŸ˜¤','ðŸ˜ ','ðŸ˜¡','ðŸ¤¬','ðŸ¤¯','ðŸ˜³','ðŸ¥µ','ðŸ¥¶','ðŸ˜±','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜“','ðŸ¤—','ðŸ¤”','ðŸ¤­','ðŸ¤«','ðŸ¤¥','ðŸ˜¶','ðŸ˜','ðŸ˜‘','ðŸ˜¬','ðŸ™„','ðŸ˜¯','ðŸ˜¦','ðŸ˜§','ðŸ˜®','ðŸ˜²','ðŸ¥±','ðŸ˜´','ðŸ¤¤','ðŸ˜ª','ðŸ˜µ','ðŸ¤','ðŸ¥´','ðŸ¤¢','ðŸ¤®','ðŸ¤§','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤‘','ðŸ¤ ','ðŸ˜ˆ','ðŸ‘¿','ðŸ‘¹','ðŸ‘º','ðŸ¤¡','ðŸ’©','ðŸ‘»','ðŸ’€','â˜ ï¸','ðŸ‘½','ðŸ‘¾','ðŸ¤–','ðŸŽƒ','ðŸ˜º','ðŸ˜¸','ðŸ˜¹','ðŸ˜»','ðŸ˜¼','ðŸ˜½','ðŸ™€','ðŸ˜¿','ðŸ˜¾','ðŸ‘¶','ðŸ‘§','ðŸ§’','ðŸ‘¦','ðŸ‘©','ðŸ§‘','ðŸ‘¨','ðŸ‘µ','ðŸ§“','ðŸ‘´','ðŸ‘²','ðŸ‘³','ðŸ§•','ðŸ‘®','ðŸ‘·','ðŸ’‚','ðŸ•µï¸','ðŸ‘°','ðŸ¤µ','ðŸ‘¸','ðŸ¤´','ðŸ¦¸','ðŸ¦¹','ðŸ¤¶','ðŸŽ…','ðŸ§™','ðŸ§š','ðŸ§›','ðŸ§œ','ðŸ§','ðŸ§ž','ðŸ§Ÿ','ðŸ’†','ðŸ’‡','ðŸš¶','ðŸƒ','ðŸ’ƒ','ðŸ•º','ðŸ‘¯','ðŸ§˜','ðŸ›€','ðŸ›Œ','ðŸ‘­','ðŸ‘«','ðŸ‘¬','ðŸ’','ðŸ’‘','ðŸ‘ª','ðŸ—£ï¸','ðŸ‘¤','ðŸ‘¥','ðŸ‘£','ðŸµ','ðŸ’','ðŸ¦','ðŸ¦§','ðŸ¶','ðŸ•','ðŸ¦®','ðŸ•â€ðŸ¦º','ðŸ©','ðŸº','ðŸ¦Š','ðŸ¦','ðŸ±','ðŸˆ','ðŸ¦','ðŸ¯','ðŸ…','ðŸ†','ðŸ´','ðŸŽ','ðŸ¦„','ðŸ¦“','ðŸ¦Œ','ðŸ®','ðŸ‚','ðŸƒ','ðŸ„','ðŸ·','ðŸ–','ðŸ—','ðŸ½','ðŸ','ðŸ‘','ðŸ','ðŸª','ðŸ«','ðŸ¦™','ðŸ¦’','ðŸ˜','ðŸ¦','ðŸ¦›','ðŸ­','ðŸ','ðŸ€','ðŸ¹','ðŸ°','ðŸ‡','ðŸ¿ï¸','ðŸ¦”','ðŸ¦‡','ðŸ»','ðŸ¨','ðŸ¼','ðŸ¦¥','ðŸ¦¦','ðŸ¦¨','ðŸ¦˜','ðŸ¦¡','ðŸ¾','ðŸ¦ƒ','ðŸ”','ðŸ“','ðŸ£','ðŸ¤','ðŸ¥','ðŸ¦','ðŸ¦…','ðŸ¦†','ðŸ¦¢','ðŸ¦‰','ðŸ¦©','ðŸ¦š','ðŸ¦œ','ðŸ¸','ðŸŠ','ðŸ¢','ðŸ¦Ž','ðŸ','ðŸ²','ðŸ‰','ðŸ¦•','ðŸ¦–','ðŸ³','ðŸ‹','ðŸ¬','ðŸ¦­','ðŸŸ','ðŸ ','ðŸ¡','ðŸ¦ˆ','ðŸ™','ðŸš','ðŸŒ','ðŸ¦‹','ðŸ›','ðŸœ','ðŸ','ðŸž','ðŸ¦—','ðŸ•·ï¸','ðŸ•¸ï¸','ðŸ¦‚','ðŸ¦Ÿ','ðŸ¦ ','ðŸ’','ðŸŒ¸','ðŸ’®','ðŸµï¸','ðŸŒ¹','ðŸ¥€','ðŸŒº','ðŸŒ»','ðŸŒ¼','ðŸŒ·','ðŸŒ±','ðŸŒ²','ðŸŒ³','ðŸŒ´','ðŸŒµ','ðŸŒ¶ï¸','ðŸŒ½','ðŸŒ¾','ðŸŒ¿','ðŸ€','ðŸ','ðŸ‚','ðŸƒ','ðŸ‡','ðŸˆ','ðŸ‰','ðŸŠ','ðŸ‹','ðŸŒ','ðŸ','ðŸ¥­','ðŸŽ','ðŸ','ðŸ','ðŸ‘','ðŸ’','ðŸ“','ðŸ¥','ðŸ…','ðŸ¥¥','ðŸ¥‘','ðŸ†','ðŸ¥”','ðŸ¥•','ðŸŒ½','ðŸŒ¶ï¸','ðŸ¥’','ðŸ¥¬','ðŸ¥¦','ðŸ§„','ðŸ§…','ðŸ„','ðŸ¥œ','ðŸŒ°','ðŸž','ðŸ¥','ðŸ¥–','ðŸ«“','ðŸ¥¨','ðŸ¥¯','ðŸ¥ž','ðŸ§‡','ðŸ§€','ðŸ–','ðŸ—','ðŸ¥©','ðŸ¥“','ðŸ”','ðŸŸ','ðŸ•','ðŸŒ­','ðŸ¥ª','ðŸŒ®','ðŸŒ¯','ðŸ«”','ðŸ¥™','ðŸ§†','ðŸ¥š','ðŸ³','ðŸ¥˜','ðŸ²','ðŸ«•','ðŸ¥£','ðŸ¥—','ðŸ¿','ðŸ§ˆ','ðŸ§‚','ðŸ¥«','ðŸ±','ðŸ˜','ðŸ™','ðŸš','ðŸ›','ðŸœ','ðŸ','ðŸ ','ðŸ¢','ðŸ£','ðŸ¤','ðŸ¥','ðŸ¥®','ðŸ¡','ðŸ¥Ÿ','ðŸ¥ ','ðŸ¥¡','ðŸ¦€','ðŸ¦ž','ðŸ¦','ðŸ¦‘','ðŸ¦ª','ðŸ¦','ðŸ§','ðŸ¨','ðŸ©','ðŸª','ðŸŽ‚','ðŸ°','ðŸ§','ðŸ¥§','ðŸ«','ðŸ¬','ðŸ­','ðŸ®','ðŸ¯','ðŸ¼','ðŸ¥›','â˜•','ðŸ«–','ðŸµ','ðŸ¶','ðŸ¾','ðŸ·','ðŸ¸','ðŸ¹','ðŸº','ðŸ»','ðŸ¥‚','ðŸ¥ƒ','ðŸ¥¤','ðŸ§‹','ðŸ§ƒ','ðŸ§‰','ðŸ§Š','ðŸ¥¢','ðŸ½ï¸','ðŸ´','ðŸ¥„','ðŸ”ª','ðŸº'];
            
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.textContent = emoji;
                button.style.cssText = 'background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.25rem; border-radius: 4px; transition: background-color 0.2s;';
                button.onmouseover = () => button.style.backgroundColor = '#f3f4f6';
                button.onmouseout = () => button.style.backgroundColor = 'transparent';
                button.onclick = () => insertEmoji(emoji);
                grid.appendChild(button);
            });
        }
        
        function insertEmoji(emoji) {
            const textarea = document.getElementById('messageText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + emoji.length, start + emoji.length);
            
            closeEmojiPicker();
        }
        
        // Voice recording functionality
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        
        function startVoiceRecording() {
            const currentUser = cleartrackData.getCurrentUser();
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            
            if (!connectedPractitioner) {
                alert('Please connect to a practitioner first');
                return;
            }
            
            if (isRecording) {
                stopVoiceRecording();
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendVoiceMessage(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('voiceRecording').style.display = 'block';
                    document.getElementById('voiceButton').innerHTML = '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="6" width="12" height="12" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    alert('Microphone access denied. Please allow microphone access to record voice notes.');
                });
        }
        
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('voiceRecording').style.display = 'none';
                document.getElementById('voiceButton').innerHTML = '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1C10.34 1 9 2.34 9 4V12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12V4C15 2.34 13.66 1 12 1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 10V12C19 15.87 15.87 19 12 19C8.13 19 5 15.87 5 12V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            }
        }
        
        function sendVoiceMessage(audioBlob) {
            const currentUser = cleartrackData.getCurrentUser();
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            
            const message = cleartrackData.addMessage(currentUser.id, connectedPractitioner.id, {
                text: '[Voice Message]',
                sender: 'user',
                type: 'voice',
                audioData: URL.createObjectURL(audioBlob)
            });
            
            if (message) {
                loadMessages();
            }
        }
        
        // Message file upload functionality
        // Simple document sending function
        function handleMessageFileUpload(event) {
            console.log('ðŸš€ File upload triggered!');
            const file = event.target.files[0];
            if (!file) {
                console.log('âŒ No file selected');
                return;
            }
            
            console.log('ðŸ“ File selected:', file.name, file.type, file.size);
            
            const currentUser = cleartrackData.getCurrentUser();
            const connectedPractitioner = cleartrackData.getConnectedPractitioner(currentUser.id);
            
            if (!connectedPractitioner) {
                alert('Please connect to a practitioner first');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size too large. Please select a file smaller than 10MB.');
                return;
            }
            
            console.log('ðŸ”„ Converting file to base64...');
            // Convert file to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('âœ… File converted to base64');
                const fileData = e.target.result;
                const messageType = file.type.startsWith('image/') ? 'image' : 'document';
                
                console.log('ðŸ’¾ Creating message with attachment...');
                // Create message with attachment
                const message = cleartrackData.addMessage(currentUser.id, connectedPractitioner.id, {
                    text: `[${file.type.startsWith('image/') ? 'Image' : 'Document'}: ${file.name}]`,
                    sender: 'user',
                    type: messageType,
                    fileName: file.name,
                    fileData: fileData,
                    fileType: file.type,
                    fileSize: file.size
                });
                
                if (message) {
                    console.log('ðŸ“Ž Document sent successfully:', message);
                    loadMessages();
                } else {
                    console.error('âŒ Failed to create message');
                }
            };
            reader.onerror = function(error) {
                console.error('âŒ File conversion failed:', error);
            };
            reader.readAsDataURL(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // Profile image handling - modern, efficient upload with orientation, crop-to-square, resize, and compression
        async function handleUserProfileImageUpload(event) {
            const input = event.target;
            const file = input && input.files && input.files[0];
            if (!file) return;
            
            // Basic validation
            const isImage = file.type && file.type.startsWith('image/');
            if (!isImage) {
                alert('Please select a valid image file (JPEG/PNG/HEIC/WebP).');
                input.value = '';
                return;
            }
            // Hard cap (10MB) with guidance
            const MAX_BYTES = 10 * 1024 * 1024;
            if (file.size > MAX_BYTES) {
                alert('Image is too large. Please choose a file smaller than 10MB.');
                input.value = '';
                return;
            }
            
            try {
                const processedDataUrl = await resizeAndCompressToSquareUser(file, 512, 0.85);
                
                // Update UI instantly
                const profileImg = document.getElementById('userProfileImage');
                const placeholder = document.getElementById('userProfileImagePlaceholder');
                const container = document.getElementById('userProfileImageContainer');
                if (profileImg) {
                    profileImg.src = processedDataUrl;
                    profileImg.style.display = 'block';
                }
                if (placeholder) placeholder.style.display = 'none';
                if (container) {
                    container.classList.add('flash-success');
                    setTimeout(() => container.classList.remove('flash-success'), 900);
                }
                
                // Persist to user data store
                if (currentUser) {
                    currentUser.profileImage = processedDataUrl;
                    cleartrackData.updateUser(currentUser.id, { profileImage: processedDataUrl });
                }
            } catch (err) {
                console.error('Profile image processing failed:', err);
                alert('Could not process the image. Please try a different photo.');
            } finally {
                // Reset input so selecting same file again retriggers change
                input.value = '';
            }
        }

        // Helper: resize and compress to a square canvas with EXIF orientation respected
        async function resizeAndCompressToSquareUser(file, targetSize, quality) {
            const useBitmap = typeof createImageBitmap === 'function';
            let source;
            if (useBitmap) {
                try {
                    source = await createImageBitmap(file, { imageOrientation: 'from-image' });
                } catch (_) {
                    source = await loadHTMLImageUser(file);
                }
            } else {
                source = await loadHTMLImageUser(file);
            }
            const width = source.width || source.naturalWidth;
            const height = source.height || source.naturalHeight;
            if (!width || !height) throw new Error('Invalid image dimensions');
            
            // Compute cover crop rect to make a square without distortion (center-crop)
            const srcAspect = width / height;
            const dstSize = targetSize;
            let sx, sy, sw, sh;
            if (srcAspect > 1) {
                sh = height;
                sw = height;
                sx = (width - sw) / 2;
                sy = 0;
            } else {
                sw = width;
                sh = width;
                sx = 0;
                sy = (height - sh) / 2;
            }
            
            // Draw to canvas at target size
            const canvas = document.createElement('canvas');
            canvas.width = dstSize;
            canvas.height = dstSize;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0, 0, dstSize, dstSize);
            ctx.drawImage(source, sx, sy, sw, sh, 0, 0, dstSize, dstSize);
            
            // Export as high-quality JPEG
            return canvas.toDataURL('image/jpeg', quality);
        }

        function loadHTMLImageUser(file) {
            return new Promise((resolve, reject) => {
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
                img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
                img.src = url;
            });
        }
        
        function triggerUserProfileImageSelect() {
            const input = document.getElementById('userProfileImageInput');
            if (input) {
                input.click();
            }
        }
        
        function removeUserProfileImage() {
            const img = document.getElementById('userProfileImage');
            const placeholder = document.getElementById('userProfileImagePlaceholder');
            
            img.src = '';
            img.style.display = 'none';
            placeholder.style.display = 'block';
            
            // Remove from user data
            if (currentUser) {
                currentUser.profileImage = null;
                cleartrackData.updateUser(currentUser.id, {
                    profileImage: null
                });
            }
        }
        
        // Image Editor Functions
        let currentImageData = null;
        let currentRotation = 0;
        let userZoom = 1;
        let isDragging = false;
        let startX, startY, currentX, currentY;
        
        // Crop functionality variables
        let isCropMode = false;
        let isDraggingCrop = false;
        let isResizingCrop = false;
        let cropBox = null;
        let cropStartX, cropStartY;
        let cropBoxX = 0, cropBoxY = 0, cropBoxWidth = 200, cropBoxHeight = 200;
        
        function editUserProfileImage() {
            if (!currentUser || !currentUser.profileImage) {
                alert('No image to edit. Please upload an image first.');
                closeUserProfileImageModal();
                return;
            }
            closeUserProfileImageModal();
            currentImageData = currentUser.profileImage;
            currentRotation = 0;
            userZoom = 1;
            isCropMode = false;
            const modal = document.getElementById('imageEditorModal');
            if (modal) {
                modal.classList.remove('hidden');
                loadImageIntoEditor();
            } else {
                alert('Image editor not available. Please refresh the page.');
            }
        }
        
        function loadImageIntoEditor() {
            const canvas = document.getElementById('imageEditorCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Set canvas size - compact to match modal size
                const canvasSize = 350;
                canvas.width = canvasSize;
                canvas.height = canvasSize;
                
                // Calculate image dimensions to fit canvas while maintaining aspect ratio
                const imgAspect = img.width / img.height;
                const canvasAspect = canvasSize / canvasSize;
                
                let drawWidth, drawHeight;
                if (imgAspect > canvasAspect) {
                    // Image is wider than canvas
                    drawWidth = canvasSize;
                    drawHeight = canvasSize / imgAspect;
                } else {
                    // Image is taller than canvas
                    drawHeight = canvasSize;
                    drawWidth = canvasSize * imgAspect;
                }
                
                // Center the image
                const x = (canvasSize - drawWidth) / 2;
                const y = (canvasSize - drawHeight) / 2;
                
                // Clear canvas and draw the image
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((currentRotation * Math.PI) / 180);
                ctx.scale(userZoom, userZoom);
                ctx.drawImage(img, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
                ctx.restore();
                
                // Store original image data for reference
                window.userOriginalImage = img;
                window.userImageX = x;
                window.userImageY = y;
                window.userImageWidth = drawWidth;
                window.userImageHeight = drawHeight;
                
                // Initialize crop functionality
                addCropEventListeners();
                updateUserZoomSlider();
            };
            
            img.src = currentImageData;
        }
        
        function drawUserImage() {
            const canvas = document.getElementById('imageEditorCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((currentRotation * Math.PI) / 180);
                ctx.scale(userZoom, userZoom);
                const drawWidth = window.userImageWidth || 350;
                const drawHeight = window.userImageHeight || 350;
                ctx.drawImage(img, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
                ctx.restore();
            };
            
            img.src = currentImageData;
        }
        
        function rotateImage(degrees) {
            currentRotation += degrees;
            drawUserImage();
        }
        
        function resetImage() {
            currentRotation = 0;
            userZoom = 1;
            loadImageIntoEditor();
        }
        
        function setUserZoomFromSlider(value) {
            const normalized = Math.max(50, Math.min(300, Number(value)));
            const target = normalized / 100; // 0.5 - 3.0
            userZoom = target;
            drawUserImage();
        }
        
        function updateUserZoomSlider() {
            const slider = document.getElementById('userZoomSlider');
            if (slider) slider.value = String(Math.round(userZoom * 100));
        }
        
        function saveEditedImage() {
            const canvas = document.getElementById('imageEditorCanvas');
            const resizedCanvas = document.createElement('canvas');
            const resizedCtx = resizedCanvas.getContext('2d');
            
            // Create high-quality resized version (512x512 matching practitioner)
            const size = 512;
            resizedCanvas.width = size;
            resizedCanvas.height = size;
            
            resizedCtx.imageSmoothingEnabled = true;
            resizedCtx.imageSmoothingQuality = 'high';
            
            if (isCropMode) {
                // Crop the image based on crop box
                const sourceX = cropBoxX;
                const sourceY = cropBoxY;
                const sourceWidth = cropBoxWidth;
                const sourceHeight = cropBoxHeight;
                
                // Draw cropped portion to resized canvas
                resizedCtx.drawImage(
                    canvas,
                    sourceX, sourceY, sourceWidth, sourceHeight,
                    0, 0, size, size
                );
            } else {
                // Use entire image - get the actual image area
                const imageX = window.userImageX || 0;
                const imageY = window.userImageY || 0;
                const imageWidth = window.userImageWidth || canvas.width;
                const imageHeight = window.userImageHeight || canvas.height;
                
                resizedCtx.drawImage(
                    canvas,
                    imageX, imageY, imageWidth, imageHeight,
                    0, 0, size, size
                );
            }
            
            const editedDataUrl = resizedCanvas.toDataURL('image/jpeg', 0.85);
            
            // Update profile image
            const profileImg = document.getElementById('userProfileImage');
            const placeholder = document.getElementById('userProfileImagePlaceholder');
            const container = document.getElementById('userProfileImageContainer');
            
            profileImg.src = editedDataUrl;
            profileImg.style.display = 'block';
            placeholder.style.display = 'none';
            if (container) {
                container.classList.add('flash-success');
                setTimeout(() => container.classList.remove('flash-success'), 900);
            }
            
            // Save to user data
            if (currentUser) {
                currentUser.profileImage = editedDataUrl;
                cleartrackData.updateUser(currentUser.id, {
                    profileImage: editedDataUrl
                });
            }
            
            closeImageEditor();
        }
        
        function closeImageEditor() {
            document.getElementById('imageEditorModal').classList.add('hidden');
        }
        
        // Crop functionality
        function toggleCropMode() {
            isCropMode = !isCropMode;
            const cropOverlay = document.getElementById('cropOverlay');
            const cropToggleBtn = document.getElementById('cropToggleBtn');
            
            if (isCropMode) {
                cropOverlay.style.pointerEvents = 'auto';
                cropToggleBtn.style.background = '#dc2626';
                cropToggleBtn.title = 'Exit crop';
                initializeCropBox();
            } else {
                cropOverlay.style.pointerEvents = 'none';
                cropToggleBtn.style.background = 'rgba(17,24,39,0.7)';
                cropToggleBtn.title = 'Toggle crop';
            }
        }
        
        function initializeCropBox() {
            const canvas = document.getElementById('imageEditorCanvas');
            
            // Set initial crop box to center of the actual image area
            const imageX = window.userImageX || 0;
            const imageY = window.userImageY || 0;
            const imageWidth = window.userImageWidth || canvas.width;
            const imageHeight = window.userImageHeight || canvas.height;
            
            // Make crop box 80% of the smaller dimension of the image
            const cropSize = Math.min(imageWidth, imageHeight) * 0.8;
            cropBoxWidth = cropSize;
            cropBoxHeight = cropSize; // Square crop
            
            // Center crop box within the image area
            cropBoxX = imageX + (imageWidth - cropSize) / 2;
            cropBoxY = imageY + (imageHeight - cropSize) / 2;
            
            updateCropBox();
        }
        
        function updateCropBox() {
            const cropBoxElement = document.getElementById('cropBox');
            cropBoxElement.style.left = cropBoxX + 'px';
            cropBoxElement.style.top = cropBoxY + 'px';
            cropBoxElement.style.width = cropBoxWidth + 'px';
            cropBoxElement.style.height = cropBoxHeight + 'px';
        }
        
        // Add event listeners for crop functionality
        function addCropEventListeners() {
            const canvas = document.getElementById('imageEditorCanvas');
            const cropBoxElement = document.getElementById('cropBox');
            const cropHandles = document.querySelectorAll('.crop-handle');
            
            // Canvas click to move crop box
            canvas.addEventListener('mousedown', function(e) {
                if (!isCropMode) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if click is inside crop box
                if (x >= cropBoxX && x <= cropBoxX + cropBoxWidth && 
                    y >= cropBoxY && y <= cropBoxY + cropBoxHeight) {
                    isDraggingCrop = true;
                    cropStartX = x - cropBoxX;
                    cropStartY = y - cropBoxY;
                }
            });
            
            // Crop box drag
            cropBoxElement.addEventListener('mousedown', function(e) {
                if (!isCropMode) return;
                e.stopPropagation();
                isDraggingCrop = true;
                const rect = canvas.getBoundingClientRect();
                cropStartX = e.clientX - rect.left - cropBoxX;
                cropStartY = e.clientY - rect.top - cropBoxY;
            });
            
            // Crop handle resize
            cropHandles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    if (!isCropMode) return;
                    e.stopPropagation();
                    isResizingCrop = true;
                    isDraggingCrop = false;
                    
                    const rect = canvas.getBoundingClientRect();
                    cropStartX = e.clientX - rect.left;
                    cropStartY = e.clientY - rect.top;
                });
            });
            
            // Mouse move
            document.addEventListener('mousemove', function(e) {
                if (!isCropMode) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (isDraggingCrop) {
                    // Move crop box
                    cropBoxX = Math.max(0, Math.min(canvas.width - cropBoxWidth, x - cropStartX));
                    cropBoxY = Math.max(0, Math.min(canvas.height - cropBoxHeight, y - cropStartY));
                    updateCropBox();
                } else if (isResizingCrop) {
                    // Resize crop box (simplified - just adjust width/height)
                    const deltaX = x - cropStartX;
                    const deltaY = y - cropStartY;
                    const newWidth = Math.max(50, cropBoxWidth + deltaX);
                    const newHeight = Math.max(50, cropBoxHeight + deltaY);
                    
                    // Keep square aspect ratio
                    const size = Math.min(newWidth, newHeight);
                    cropBoxWidth = size;
                    cropBoxHeight = size;
                    
                    // Ensure crop box stays within canvas bounds
                    if (cropBoxX + cropBoxWidth > canvas.width) {
                        cropBoxWidth = canvas.width - cropBoxX;
                        cropBoxHeight = cropBoxWidth;
                    }
                    if (cropBoxY + cropBoxHeight > canvas.height) {
                        cropBoxHeight = canvas.height - cropBoxY;
                        cropBoxWidth = cropBoxHeight;
                    }
                    
                    updateCropBox();
                }
            });
            
            // Mouse up
            document.addEventListener('mouseup', function() {
                isDraggingCrop = false;
                isResizingCrop = false;
            });
        }
        
        // Profile Image Options Modal Functions
        // Professional user profile image functions - Complete modern implementation
        function openUserProfileImageModal() {
            document.getElementById('userProfileImageOptionsModal').classList.remove('hidden');
        }
        
        function closeUserProfileImageModal() {
            document.getElementById('userProfileImageOptionsModal').classList.add('hidden');
        }
        
        function takeUserPhoto() {
            closeUserProfileImageModal();
            document.getElementById('userCameraInput').click();
        }
        
        function chooseUserPhoto() {
            closeUserProfileImageModal();
            document.getElementById('userGalleryInput').click();
        }
        
        function createUserAIImage() {
            closeUserProfileImageModal();
            alert('AI Image Generation\n\nThis feature will allow you to create professional profile images using AI technology.\n\nComing soon: Generate headshots, multiple styles, high-quality AI images.\n\nFor now, please use "Choose photo" to upload an existing image.');
        }
        
        function deleteUserPhoto() {
            closeUserProfileImageModal();
            const currentImg = document.getElementById('userProfileImage');
            if (!currentImg.src || currentImg.style.display === 'none') {
                alert('No profile photo to delete.');
                return;
            }
            if (confirm('Are you sure you want to delete your profile photo?\n\nThis action cannot be undone.')) {
                removeUserProfileImage();
                const container = document.getElementById('userProfileImageContainer');
                if (container) {
                    container.classList.remove('flash-success');
                    setTimeout(() => {}, 100);
                }
            }
        }
        
        // Add drag & drop and paste from clipboard support
        function initializeUserProfileImageDragDrop() {
            const container = document.getElementById('userProfileImageContainer');
            if (!container) return;
            
            // Drag & drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                container.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                container.addEventListener(eventName, () => container.classList.add('drag-over'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                container.addEventListener(eventName, () => container.classList.remove('drag-over'), false);
            });
            
            container.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files && files.length > 0) {
                    const file = files[0];
                    if (file.type && file.type.startsWith('image/')) {
                        const input = document.getElementById('userProfileImageInput');
                        if (input) {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            input.files = dataTransfer.files;
                            handleUserProfileImageUpload({ target: input });
                        }
                    }
                }
            }, false);
            
            // Paste from clipboard
            document.addEventListener('paste', (e) => {
                if (document.getElementById('userProfileImageOptionsModal') && !document.getElementById('userProfileImageOptionsModal').classList.contains('hidden')) {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const blob = items[i].getAsFile();
                            const file = new File([blob], 'pasted-image.png', { type: blob.type });
                            const input = document.getElementById('userProfileImageInput');
                            if (input) {
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                input.files = dataTransfer.files;
                                handleUserProfileImageUpload({ target: input });
                            }
                            break;
                        }
                    }
                }
            });
        }
        
        // Initialize drag & drop on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeUserProfileImageDragDrop);
        } else {
            initializeUserProfileImageDragDrop();
        }
        
    </script>

    <!-- Profile Image Options Modal -->
    <div id="userProfileImageOptionsModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px; width: 90%;">
            <div class="modal-header">
                <h3>Edit profile picture</h3>
                <button onclick="closeUserProfileImageModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" class="p-4">
                <!-- Image size recommendation -->
                <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 0.875rem; color: #0369a1; font-weight: 500;">ðŸ“ Image Requirements</div>
                    <div style="font-size: 0.75rem; color: #0369a1; margin-top: 0.25rem;">Recommended: 200x200px or larger for best quality</div>
                </div>
                
                <div style="display: flex; flex-direction: column; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <button onclick="takeUserPhoto()" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: none; background: white; border-bottom: 1px solid #e5e7eb; cursor: pointer; font-size: 1rem; color: #374151; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                        <span>Take photo</span>
                        <span class="attachment-icon">
                            <img src="assets/icons/camera.svg" class="icon" alt="Camera">
                        </span>
                    </button>
                    <button onclick="chooseUserPhoto()" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: none; background: white; border-bottom: 1px solid #e5e7eb; cursor: pointer; font-size: 1rem; color: #374151; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                        <span>Choose photo</span>
                        <span class="attachment-icon">
                            <img src="assets/icons/gallery.svg" class="icon" alt="Gallery">
                        </span>
                    </button>
                    <button onclick="createUserAIImage()" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: none; background: white; border-bottom: 1px solid #e5e7eb; cursor: pointer; font-size: 1rem; color: #374151; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                        <span>Create AI image</span>
                        <span class="attachment-icon">
                            <img src="assets/icons/star.svg" class="icon" alt="Star">
                        </span>
                    </button>
                    <button onclick="editUserProfileImage()" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: none; background: white; border-bottom: 1px solid #e5e7eb; cursor: pointer; font-size: 1rem; color: #374151; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                        <span>Edit image</span>
                        <span class="attachment-icon">
                            <img src="assets/icons/edit.svg" class="icon" alt="Edit">
                        </span>
                    </button>
                    <button onclick="deleteUserPhoto()" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: none; background: white; cursor: pointer; font-size: 1rem; color: #dc2626; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#fef2f2'" onmouseout="this.style.backgroundColor='white'">
                        <span>Delete photo</span>
                        <span class="attachment-icon">
                            <img src="assets/icons/trash.svg" class="icon" alt="Trash">
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Editor Modal -->
    <div id="imageEditorModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px; width: 90%;">
            <div class="modal-header">
                <h3>Edit Profile Image</h3>
                <button onclick="closeImageEditor()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 0.75rem; position: relative;">
                    <div id="imageEditorContainer" style="position: relative; display: inline-block; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; max-width: 100%;">
                        <!-- Compact overlay toolbar -->
                        <div style="position: absolute; top: 6px; right: 6px; display: flex; gap: 4px; z-index: 3;">
                            <button title="Rotate left" onclick="rotateImage(-90)" style="width:32px;height:32px;border:none;border-radius:16px;background:rgba(17,24,39,0.7);color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">â†º</button>
                            <button title="Rotate right" onclick="rotateImage(90)" style="width:32px;height:32px;border:none;border-radius:16px;background:rgba(17,24,39,0.7);color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">â†»</button>
                            <button id="cropToggleBtn" title="Toggle crop" onclick="toggleCropMode()" style="width:32px;height:32px;border:none;border-radius:16px;background:rgba(17,24,39,0.7);color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">â–¢</button>
                        </div>
                        <canvas id="imageEditorCanvas" style="display: block; cursor: move; max-width: 100%; height: auto;"></canvas>
                        <div id="cropOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                            <div id="cropBox" style="position: absolute; border: 2px solid #2563eb; background: rgba(37, 99, 235, 0.12); cursor: move;">
                                <div class="crop-handle crop-handle-nw" style="position: absolute; top: -4px; left: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: nw-resize;"></div>
                                <div class="crop-handle crop-handle-ne" style="position: absolute; top: -4px; right: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: ne-resize;"></div>
                                <div class="crop-handle crop-handle-sw" style="position: absolute; bottom: -4px; left: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: sw-resize;"></div>
                                <div class="crop-handle crop-handle-se" style="position: absolute; bottom: -4px; right: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: se-resize;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Compact zoom slider -->
                <div style="display:flex;align-items:center;gap:6px;justify-content:center;margin: 0.5rem 0;">
                    <span style="color:#6b7280;font-size:0.75rem;min-width:35px;">Zoom</span>
                    <input id="userZoomSlider" type="range" min="50" max="300" value="100" oninput="setUserZoomFromSlider(this.value)" style="flex: 1; max-width: 180px; height: 4px;">
                </div>
                <!-- Action buttons -->
                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                    <button onclick="closeImageEditor()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>
                    <button onclick="saveEditedImage()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="messaging-service.js">    </script>
    
    <!-- Simple polling for real-time updates -->
    <script>
        // Simple polling every 1 second - bulletproof method
        let pollCount = 0;
        setInterval(function() {
            pollCount++;
            console.log('ðŸ”„ Polling attempt #' + pollCount);
            
            if (window.currentUser && window.loadMessages) {
                console.log('âœ… User and loadMessages function available');
                const messagesSection = document.getElementById('messages');
                console.log('ðŸ“± Messages section found:', !!messagesSection);
                console.log('ðŸ“± Messages section hidden:', messagesSection && messagesSection.classList.contains('hidden'));
                
                if (messagesSection && !messagesSection.classList.contains('hidden')) {
                    console.log('ðŸ”„ Calling loadMessages...');
                    window.loadMessages();
                } else {
                    console.log('âŒ Messages section not active');
                }
            } else {
                console.log('âŒ Missing user or loadMessages function');
                console.log('User:', !!window.currentUser);
                console.log('loadMessages:', !!window.loadMessages);
            }
        }, 1000); // Check every 1 second
        
        // Vehicle Acquisition Type Logic
        let selectedAcquisitionType = null;
        let vehicleDocumentFile = null;
        
        function updateAddVehicleButton() {
            const addVehicleBtn = document.getElementById('addVehicleBtn');
            const disabledMessage = document.getElementById('addVehicleDisabledMessage');
            
            if (selectedAcquisitionType && vehicleDocumentFile) {
                addVehicleBtn.disabled = false;
                disabledMessage.style.display = 'none';
            } else {
                addVehicleBtn.disabled = true;
                disabledMessage.style.display = 'inline';
            }
        }
        
        function clearVehicleDocument() {
            const fileInput = document.getElementById('vehicleDocumentUpload');
            const fileNameDiv = document.getElementById('vehicleDocumentFileName');
            const documentName = document.getElementById('vehicleDocumentName');
            
            fileInput.value = '';
            vehicleDocumentFile = null;
            fileNameDiv.style.display = 'none';
            documentName.textContent = '';
            updateAddVehicleButton();
        }
        
        function resetVehicleAcquisitionSelection() {
            const purchasedCheckbox = document.getElementById('vehiclePurchased');
            const leasedCheckbox = document.getElementById('vehicleLeased');
            const vehicleNotice = document.getElementById('vehicleAcquisitionNotice');
            const documentUploadSection = document.getElementById('vehicleDocumentUploadSection');
            
            if (purchasedCheckbox) purchasedCheckbox.checked = false;
            if (leasedCheckbox) leasedCheckbox.checked = false;
            if (vehicleNotice) vehicleNotice.style.display = 'none';
            if (documentUploadSection) documentUploadSection.style.display = 'none';
            clearVehicleDocument();
            selectedAcquisitionType = null;
            vehicleDocumentFile = null;
            updateAddVehicleButton();
        }
        
        const purchasedCheckbox = document.getElementById("vehiclePurchased");
        const leasedCheckbox = document.getElementById("vehicleLeased");
        const vehicleNotice = document.getElementById("vehicleAcquisitionNotice");
        const documentUploadSection = document.getElementById("vehicleDocumentUploadSection");
        const documentUploadArea = document.getElementById("vehicleDocumentUploadArea");
        const documentUploadInput = document.getElementById("vehicleDocumentUpload");
        const documentFileName = document.getElementById("vehicleDocumentFileName");
        const documentName = document.getElementById("vehicleDocumentName");
        
        if (purchasedCheckbox && leasedCheckbox && vehicleNotice && documentUploadSection) {
            purchasedCheckbox.addEventListener("change", () => {
                if (purchasedCheckbox.checked) {
                    leasedCheckbox.checked = false;
                    selectedAcquisitionType = 'purchased';
                    vehicleNotice.style.display = "block";
                    vehicleNotice.textContent = "Please upload your vehicle purchase invoice.";
                    documentUploadSection.style.display = "block";
                    // Clear any existing document
                    clearVehicleDocument();
                } else {
                    selectedAcquisitionType = null;
                    vehicleNotice.style.display = "none";
                    documentUploadSection.style.display = "none";
                    clearVehicleDocument();
                }
                updateAddVehicleButton();
            });
            
            leasedCheckbox.addEventListener("change", () => {
                if (leasedCheckbox.checked) {
                    purchasedCheckbox.checked = false;
                    selectedAcquisitionType = 'leased';
                    vehicleNotice.style.display = "block";
                    vehicleNotice.textContent = "Please upload your lease agreement.";
                    documentUploadSection.style.display = "block";
                    // Clear any existing document
                    clearVehicleDocument();
                } else {
                    selectedAcquisitionType = null;
                    vehicleNotice.style.display = "none";
                    documentUploadSection.style.display = "none";
                    clearVehicleDocument();
                }
                updateAddVehicleButton();
            });
            
            // Document upload handling
            if (documentUploadArea && documentUploadInput) {
                documentUploadArea.addEventListener('click', () => {
                    documentUploadInput.click();
                });
                
                documentUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    documentUploadArea.style.borderColor = '#0b7285';
                    documentUploadArea.style.background = '#e5f3f7';
                });
                
                documentUploadArea.addEventListener('dragleave', () => {
                    documentUploadArea.style.borderColor = '#cccccc';
                    documentUploadArea.style.background = '#fafafa';
                });
                
                documentUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    documentUploadArea.style.borderColor = '#cccccc';
                    documentUploadArea.style.background = '#fafafa';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        documentUploadInput.files = files;
                        handleDocumentFileSelect(files[0]);
                    }
                });
                
                documentUploadInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleDocumentFileSelect(e.target.files[0]);
                    }
                });
            }
        }
        
        function handleDocumentFileSelect(file) {
            // Validate file type
            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a PDF, JPG, or PNG file.');
                return;
            }
            
            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB.');
                return;
            }
            
            vehicleDocumentFile = file;
            documentName.textContent = file.name;
            documentFileName.style.display = 'block';
            updateAddVehicleButton();
        }
        
    </script>

    <!-- Firebase SDKs (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>

    <!-- My Firebase wiring -->
    <script src="firebase-config.js"></script>
    <script src="firebase-init.js"></script>
    <script src="firebase-api.js"></script>
    <script src="js/client-linking.js"></script>
    <script src="dashboard-auth.js"></script>
    <script>
        // Auto-migrate to Firestore on page load
        (function() {
            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                // Wait a bit for Firestore to initialize
                setTimeout(async () => {
                    if (window.firestoreData) {
                        try {
                            const userDoc = await firebase.firestore().collection('users')
                                .doc(window.firebaseAuth.currentUser.uid).get();
                            
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                if (!userData.migrationComplete) {
                                    console.log('ðŸ”„ Starting migration to Firestore...');
                                    await window.firestoreData.migrateLocalStorageToFirestore();
                                }
                            }
                        } catch (error) {
                            console.warn('Migration check failed:', error);
                        }
                    }
                }, 2000);
            } else {
                // Wait for auth
                if (window.firebaseAuth) {
                    window.firebaseAuth.onAuthStateChanged(async (user) => {
                        if (user && window.firestoreData) {
                            setTimeout(async () => {
                                try {
                                    const userDoc = await firebase.firestore().collection('users')
                                        .doc(user.uid).get();
                                    
                                    if (userDoc.exists) {
                                        const userData = userDoc.data();
                                        if (!userData.migrationComplete) {
                                            console.log('ðŸ”„ Starting migration to Firestore...');
                                            await window.firestoreData.migrateLocalStorageToFirestore();
                                        }
                                    }
                                } catch (error) {
                                    console.warn('Migration check failed:', error);
                                }
                            }, 2000);
                        }
                    });
                }
            }
        })();
    </script>
</body>
</html>
