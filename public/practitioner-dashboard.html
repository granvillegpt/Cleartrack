<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Cleartrack - Practitioner Dashboard</title>
    <link rel="icon" type="image/png" href="assets/images/icon%20logo.png">
    <link rel="stylesheet" href="global-styles.css">
    <link rel="stylesheet" href="whatsapp-messaging.css">
    <link rel="stylesheet" href="responsive-fixes.css">
    <link rel="stylesheet" href="css/ct-theme.css" />
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e5f3f7;
            color: #333;
        }
        
        /* ============================================
           HEADER CONTAINER - Desktop Base Styles
           ============================================ */
        .header {
            background: #0b7285;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        
        /* ============================================
           HEADER TOP SECTION
           ============================================ */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2.5rem;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* ============================================
           LOGOUT BUTTON - DESKTOP POSITIONING
           ============================================ */
        #desktopLogoutBtn {
            display: block;
            margin-left: auto;
        }
        
        /* ============================================
           LOGO
           ============================================ */
        .header .logo {
            display: flex;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .header .logo img {
            height: 48px;
            width: auto;
            filter: brightness(0) invert(1);
            display: block;
        }
        
        /* ============================================
           NAVIGATION
           ============================================ */
        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
            justify-content: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            width: 100%;
            box-sizing: border-box;
        }
        
        .nav a {
            text-decoration: none;
            color: #e0fbff;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
        }
        
        .nav a::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 0;
            width: 0;
            height: 2px;
            background: #ffffff;
            transition: width 0.3s ease;
        }
        
        .nav a:hover::after,
        .nav a.active::after {
            width: 100%;
        }
        
        .nav a:hover,
        .nav a.active {
            color: #ffffff;
        }
        
        /* ============================================
           MENU TOGGLE BUTTON (Style 6)
           ============================================ */
        .menu-toggle-style6 {
            display: none;
            background: transparent;
            border: none;
            color: #e0fbff;
            cursor: pointer;
            font-size: 1.3rem;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            transition: transform 0.3s ease;
            padding: 0;
        }
        
        .menu-toggle-style6:hover {
            transform: scale(1.1);
        }
        
        .menu-toggle-style6.active {
            transform: rotate(90deg);
        }
        
        /* ============================================
           NAVIGATION (nav-style6) - Desktop Base Styles
           ============================================ */
        .nav-style6 {
            /* Desktop: horizontal navigation bar */
            display: flex;
            gap: 2rem;
            align-items: center;
            justify-content: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            width: 100%;
            box-sizing: border-box;
            position: static;
        }
        
        .nav-style6 a {
            color: #e0fbff;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            position: relative;
            padding: 0.5rem 0;
            display: inline-block;
        }
        
        .nav-style6 a::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 0;
            width: 0;
            height: 2px;
            background: #ffffff;
            transition: width 0.3s ease;
        }
        
        .nav-style6 a:hover::after,
        .nav-style6 a.active::after {
            width: 100%;
        }
        
        .nav-style6 a:hover,
        .nav-style6 a.active {
            color: #ffffff;
        }
        
        /* ============================================
           DESKTOP STYLES (min-width: 769px)
           ============================================ */
        @media (min-width: 769px) {
            /* Hide mobile menu toggle on desktop */
            .menu-toggle-style6 {
                display: none;
            }
            
            /* Desktop: nav-style6 is horizontal nav bar (already styled above) */
        }
        
        /* ============================================
           MOBILE STYLES (max-width: 768px) - STYLE 6 EXACT COPY
           ============================================ */
        @media (max-width: 768px) {
            /* STYLE 6: Header - EXACT COPY from hamburger-menu-styles.html */
            .header {
                background: #0b7285;
                color: #fff;
                padding: 1rem 1.5rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: relative;
            }
            
            /* STYLE 6: Header-top - flex container for logo and hamburger */
            .header-top {
                padding: 0 !important;
                display: flex !important;
                align-items: center;
                justify-content: space-between !important;
                width: 100%;
                position: static !important;
            }
            
            /* STYLE 6: Logo becomes brand-style6 - EXACT (left side) */
            /* Must override desktop absolute positioning to participate in flexbox */
            .header .logo {
                font-weight: 700;
                font-size: 1.2rem;
                position: static !important;
                left: auto !important;
                right: auto !important;
                transform: none !important;
                display: flex !important;
                align-items: center;
            }
            
            /* Increase logo image size on mobile - maintain aspect ratio */
            .header .logo img {
                height: 44px !important;
                width: auto !important;
                max-width: none !important;
                object-fit: contain !important;
            }
            
            /* STYLE 6: Hide logout on mobile */
            #desktopLogoutBtn {
                display: none !important;
            }
            
            /* STYLE 6: Menu toggle - EXACT COPY (right side) - Increased size */
            .menu-toggle-style6 {
                background: transparent;
                border: none;
                color: #e0fbff;
                cursor: pointer;
                font-size: 1.6rem;
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                transition: transform 0.3s ease;
            }
            
            .menu-toggle-style6:hover {
                transform: scale(1.1);
            }
            
            .menu-toggle-style6.active {
                transform: rotate(90deg);
            }
            
            /* STYLE 6: Navigation dropdown - EXACT COPY from hamburger-menu-styles.html */
            /* Reset ALL desktop styles and apply Style 6 dropdown */
            .nav-style6 {
                /* Reset desktop styles */
                display: block;
                gap: 0;
                align-items: stretch;
                justify-content: flex-start;
                padding: 0;
                background: white;
                border-top: none;
                width: auto;
                box-sizing: border-box;
                
                /* Style 6 dropdown styles */
                position: absolute;
                top: calc(100% + 0.5rem);
                right: 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                min-width: 220px;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease, opacity 0.3s ease;
                opacity: 0;
                z-index: 1000;
            }
            
            .nav-style6.active {
                max-height: 400px;
                opacity: 1;
            }
            
            /* Reset desktop link styles and apply Style 6 link styles */
            .nav-style6 a {
                color: #1f2933;
                text-decoration: none;
                padding: 0.75rem 1.25rem;
                display: block;
                font-size: 0.95rem;
                transition: all 0.2s;
                font-weight: normal;
                position: static;
                width: auto;
            }
            
            .nav-style6 a::after {
                display: none;
            }
            
            .nav-style6 a:hover {
                background: #f5f7fa;
                color: #0b7285;
                padding-left: 1.5rem;
            }
            
            .nav-style6 a.active {
                background: #e0f7fb;
                color: #0b7285;
                font-weight: 600;
            }
            
            .nav-style6 a:first-child {
                border-radius: 12px 12px 0 0;
            }
            
            .nav-style6 a:last-child {
                border-radius: 0 0 12px 12px;
            }
        }
        
        /* ============================================
           SMALL MOBILE STYLES (max-width: 480px)
           ============================================ */
        @media (max-width: 480px) {
            /* Adjust dropdown position for smaller screens */
            .nav-style6.active {
                right: 0.75rem !important;
                min-width: 200px !important;
            }
            
            /* Slightly smaller text and padding for compact mobile */
            .nav-style6 a {
                font-size: 0.9rem;
                padding: 0.625rem 1rem;
            }
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .practitioner-badge {
            background: #059669;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Clickable Tile Styles */
        .clickable-tile {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .clickable-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .clickable-tile:active {
            transform: translateY(0);
        }
        
        .tile-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .clickable-tile:hover .tile-hint {
            opacity: 1;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0b7285;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            z-index: 10;
        }
        
        .btn-primary {
            background: #0b7285;
            color: white;
        }
        
        .btn-primary:hover {
            background: #095a69;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-outline:not(#desktopLogoutBtn) {
            background: transparent;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .btn-outline:not(#desktopLogoutBtn):hover {
            background: #f9fafb;
        }
        
        /* Document action buttons */
        .document-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .document-actions .btn {
            white-space: nowrap;
            min-width: auto;
        }
        
        /* Client Search Styles */
        .search-container {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #0b7285;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1rem;
            pointer-events: none;
        }
        
        .search-filters {
            flex-shrink: 0;
        }
        
        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #0b7285;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .client-count {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        /* Checkbox grid styles matching onboarding */
        #profile .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        #profile .checkbox-label {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            padding: 0.625rem 0.875rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
            gap: 0.625rem;
            width: 100%;
        }
        
        #profile .checkbox-label:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        #profile .checkbox-input {
            width: 16px !important;
            height: 16px !important;
            cursor: pointer;
            accent-color: #0b7285;
            flex-shrink: 0;
            margin: 0 !important;
            display: inline-block !important;
            vertical-align: middle;
        }
        
        #profile .checkbox-label:has(input:checked) {
            background: #ffffff;
            border-color: #0b7285;
        }
        
        #profile .attachment-text {
            font-size: 0.9rem;
            color: #374151;
            user-select: none;
            line-height: 1.4;
            display: inline-block;
            vertical-align: middle;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0b7285;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .table tbody tr:hover {
            background: #f9fafb;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }
        
        .modal-overlay:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        
        .modal-overlay:not(.hidden) .modal {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: none;
            margin-bottom: 0;
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
            background: linear-gradient(135deg, #0b7285 0%, #0891b2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            width: 100%;
            box-sizing: border-box;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
            margin: 0;
        }
        
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .hidden {
            display: none;
        }
        
        /* Icon Styles - Ensure icons from assets/icons work properly */
        .icon {
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        /* Icon sizes for img tags */
        img.icon {
            width: 1.25rem;
            height: 1.25rem;
            object-fit: contain;
            display: inline-block;
            vertical-align: middle;
        }
        
        img.icon-sm {
            width: 1rem;
            height: 1rem;
        }
        
        img.icon-lg {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        img.icon-xl {
            width: 2rem;
            height: 2rem;
        }
        
        img.icon-2xl {
            width: 3rem;
            height: 3rem;
        }
        
        /* Icon colors for images using CSS filters */
        img.icon-gray-500 {
            filter: brightness(0) saturate(100%) invert(48%) sepia(6%) saturate(750%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        
        img.icon-green-600 {
            filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
        }
        
        img.icon-blue-600 {
            filter: brightness(0) saturate(100%) invert(39%) sepia(96%) saturate(1352%) hue-rotate(194deg) brightness(97%) contrast(96%);
        }
        
        img.icon-red-600 {
            filter: brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%);
        }
        
        /* Ensure icons align properly in buttons and text */
        .btn .icon,
        .btn img.icon {
            margin-right: 0.375rem;
        }
        
        .btn .icon:last-child,
        .btn img.icon:last-child {
            margin-right: 0;
            margin-left: 0.375rem;
        }
        
        /* Invoice Preview Styles */
        .preview-banner {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #92400e;
            font-weight: 500;
        }
        
        .preview-mode {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .invoice-content {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .invoice-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .invoice-header-left {
            flex-shrink: 0;
        }
        
        .invoice-header-right {
            flex: 1;
            text-align: right;
        }
        
        .invoice-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            margin: 0 0 10px 0;
        }
        
        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .from-section h3,
        .invoice-info h3 {
            color: #374151;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .client-section {
            margin-bottom: 30px;
        }
        
        .client-section h3 {
            color: #374151;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .invoice-table th,
        .invoice-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            max-width: 0;
        }
        
        .invoice-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }
        
        .totals-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .total-final {
            font-weight: 700;
            font-size: 1.2rem;
            color: #111827;
            border-top: 2px solid #e5e7eb;
            padding-top: 12px;
            margin-top: 12px;
        }
        
        .payment-section {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0f2fe;
        }
        
        .payment-section h4 {
            color: #0369a1;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .payment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .payment-grid h5 {
            color: #374151;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .notes {
            font-style: italic;
            color: #6b7280;
            margin-top: 15px;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid;
        }
        
        .alert-success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }
        
        .alert-error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }
        
        .alert-info {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: #1e40af;
        }
        
        .client-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s;
        }
        
        .client-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .client-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
        }
        
        .client-email {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .client-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .client-stat {
            text-align: center;
        }
        
        .client-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0b7285;
        }
        
        .client-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .practitioner-code {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .practitioner-code h4 {
            color: #0369a1;
            margin-bottom: 0.5rem;
        }
        
        .practitioner-code .code {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: #0b7285;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }
        
        @media (max-width: 768px) {
            /* Header styles removed - Style 6 handles all mobile header styling */
            
            .main {
                padding: 1rem;
            }
            
            .section {
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-bottom: 1.5rem;
            }
            
            .stat-card {
                padding: 0.75rem;
                border-radius: 8px;
            }
            
            .stat-value {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
                font-weight: 500;
            }
            
            /* Tax Returns Mobile Fixes - 768px */
            .search-container {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .search-input-wrapper {
                width: 100%;
                min-width: 100%;
            }
            
            .search-filters {
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
            
            /* Table Mobile Fixes - 768px */
            .card-body {
                padding: 0.75rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table {
                min-width: 600px;
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 0.625rem 0.5rem;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .stat-card {
                padding: 0.75rem !important;
            }
            
            .stat-value {
                font-size: 1.375rem !important;
            }
            
            .stat-label {
                font-size: 0.75rem !important;
            }
            
            /* Tax Returns Mobile Fixes - 480px */
            .section {
                padding: 0.75rem;
            }
            
            .card {
                padding: 0.75rem;
            }
            
            .search-container {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .search-input-wrapper {
                width: 100% !important;
                min-width: 100% !important;
            }
            
            .search-input {
                font-size: 0.875rem !important;
                padding: 0.625rem 0.75rem 0.625rem 2.5rem !important;
            }
            
            .search-filters {
                width: 100% !important;
            }
            
            .filter-select {
                width: 100% !important;
                font-size: 0.875rem !important;
            }
            
            /* Table Mobile Fixes - 480px */
            .card-body {
                padding: 0.5rem !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .table {
                min-width: 600px !important;
                font-size: 0.75rem !important;
            }
            
            .table th,
            .table td {
                padding: 0.5rem 0.375rem !important;
                font-size: 0.75rem !important;
                white-space: nowrap !important;
            }
            
            .table th {
                font-size: 0.7rem !important;
                font-weight: 600 !important;
            }
            
            /* Quick Actions buttons - REBUILT: side-by-side on mobile */
            .quick-actions-buttons {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                width: 100% !important;
            }
            
            .quick-actions-buttons .btn {
                flex: 1 1 calc(50% - 0.25rem) !important;
                min-width: 0 !important;
                max-width: calc(50% - 0.25rem) !important;
                padding: 0.5rem 0.75rem !important;
                font-size: 0.8125rem !important;
                min-height: 38px !important;
                margin: 0 !important;
            }
            
            .actions-grid {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
                width: 100% !important;
            }
            
            .actions-grid .action-btn {
                flex: 1 1 calc(50% - 0.25rem) !important;
                min-width: 0 !important;
                max-width: calc(50% - 0.25rem) !important;
                padding: 0.5rem 0.75rem !important;
                font-size: 0.8125rem !important;
                min-height: 38px !important;
                margin: 0 !important;
            }
            
            /* Tax Returns Mobile Fixes */
            .search-container {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .search-input-wrapper {
                width: 100% !important;
                min-width: 100% !important;
            }
            
            .search-input {
                font-size: 0.875rem !important;
                padding: 0.625rem 0.75rem 0.625rem 2.5rem !important;
            }
            
            .search-filters {
                width: 100% !important;
            }
            
            .filter-select {
                width: 100% !important;
                font-size: 0.875rem !important;
            }
            
            /* Table Mobile Fixes */
            .card-body {
                padding: 0.75rem !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .table {
                min-width: 600px !important;
                font-size: 0.75rem !important;
            }
            
            .table th,
            .table td {
                padding: 0.5rem 0.375rem !important;
                font-size: 0.75rem !important;
                white-space: nowrap !important;
            }
            
            .table th {
                font-size: 0.7rem !important;
                font-weight: 600 !important;
            }
        }

        /* Vehicle Information Styles */
        .vehicle-info-section {
            margin-bottom: 2rem;
        }

        .vehicle-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .vehicle-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.25rem;
            transition: all 0.2s ease;
        }

        .vehicle-card:hover {
            border-color: #0b7285;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }

        .vehicle-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .vehicle-icon {
            width: 40px;
            height: 40px;
            background: #dbeafe;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vehicle-title h4 {
            margin: 0;
            color: #1e293b;
            font-weight: 600;
            font-size: 1rem;
        }

        .vehicle-title p {
            margin: 0;
            color: #64748b;
            font-size: 0.875rem;
        }

        .vehicle-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .vehicle-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            font-size: 0.875rem;
            color: #1e293b;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .vehicle-details-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Vehicle Modal Styles */
        .vehicle-modal {
            max-width: 900px;
            width: 95%;
        }

        /* Expense Information Styles */
        .expense-tab-section {
            margin-bottom: 2rem;
        }

        .expense-tab-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .expense-tab-section .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            color: #374151;
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* New Invoice Modal Styles */
        .invoice-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .invoice-section .section-title {
            color: #374151;
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .client-selection {
            position: relative;
        }

        .selected-client-info {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #d1d5db;
        }

        .client-details h5 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
            font-size: 1.125rem;
        }

        .client-details p {
            margin: 0;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .vat-calculation {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            margin-top: 1rem;
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .calculation-row:last-child {
            border-bottom: none;
        }

        .calculation-row.total {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1f2937;
            border-top: 2px solid #e5e7eb;
            margin-top: 0.5rem;
            padding-top: 0.75rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .vehicle-modal-content {
            padding: 0;
        }

        .vehicle-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .summary-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .summary-card:hover {
            border-color: #0b7285;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }

        .summary-icon {
            width: 48px;
            height: 48px;
            background: #dbeafe;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .summary-icon img {
            width: 24px;
            height: 24px;
        }

        .summary-info {
            flex: 1;
        }

        .summary-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .vehicle-list-detailed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .vehicle-card-detailed {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .vehicle-card-detailed:hover {
            border-color: #0b7285;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);
        }

        .vehicle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .vehicle-main-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .vehicle-icon-large {
            width: 56px;
            height: 56px;
            background: #dbeafe;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vehicle-icon-large img {
            width: 28px;
            height: 28px;
        }

        .vehicle-title-section h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .vehicle-registration {
            margin: 0.25rem 0 0 0;
            color: #64748b;
            font-size: 0.875rem;
        }

        .vehicle-status .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-badge.status-high {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-badge.status-medium {
            background: #fef3c7;
            color: #ca8a04;
        }

        .vehicle-details-section {
            padding: 1.5rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-item label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-item .detail-value {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 600;
        }

        .mileage-tracking {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .mileage-title {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }

        .mileage-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .mileage-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mileage-input-group label {
            font-size: 0.875rem;
            color: #374151;
            font-weight: 500;
        }

        .mileage-input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .mileage-input:focus {
            outline: none;
            border-color: #0b7285;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .mileage-calculations {
            display: flex;
            gap: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .calculation-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .calc-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .calc-value {
            font-size: 1.125rem;
            color: #1e293b;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
        }

        .empty-state-icon {
            margin-bottom: 1rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .vehicle-summary {
                grid-template-columns: 1fr;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .mileage-inputs {
                grid-template-columns: 1fr;
            }
            
            .mileage-calculations {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Document Preview Styles */
        .document-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }
        
        .document-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .document-preview-container {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 1200px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .document-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .document-preview-header h3 {
            margin: 0;
            color: #374151;
            font-size: 1.125rem;
        }
        
        .document-preview-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: #f8f9fa;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .document-preview-content iframe {
            width: 100%;
            height: 80vh;
            border: none;
            display: block;
            background: white;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* PDF content styling to prevent text overlap */
        .document-preview-content iframe[src*="pdf"] {
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            height: 100vh;
        }
        
        /* Additional PDF viewer styling */
        .document-preview-content {
            overflow: auto;
        }
        
        .document-preview-content iframe[src*="pdf"] + * {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* Enhanced PDF viewer container */
        .document-preview-content.pdf-viewer {
            position: relative;
            overflow: hidden;
        }
        
        .document-preview-content.pdf-viewer iframe {
            transform: scale(0.75);
            transform-origin: top left;
            width: 133.33%;
            height: 133.33%;
            border: none;
        }
        
        /* Alternative PDF viewer styling */
        .document-preview-content iframe[src*="data:application/pdf"] {
            transform: scale(0.7);
            transform-origin: top left;
            width: 142.86%;
            height: 142.86%;
        }
        
        /* Enhanced PDF viewer for better compatibility */
        .document-preview-content.pdf-viewer iframe {
            min-height: 600px;
            background: white;
        }
        
        /* Fallback for PDFs that don't load properly */
        .document-preview-content.pdf-viewer iframe:not([src]) {
            display: none;
        }
        
        .document-preview-content.pdf-viewer iframe:not([src]) + .pdf-fallback {
            display: block;
        }
        
        .pdf-fallback {
            display: none;
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem;
        }
        
        .document-preview-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .document-preview-modal .close-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .document-preview-modal .download-btn {
            background: #0b7285;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Enhanced Document Attachment Styles */
        .message-attachment.document {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .document-preview {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .document-icon {
            font-size: 2rem;
            color: #0b7285;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .document-size {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .document-actions {
            display: flex;
            gap: 0.5rem;
        }

        .preview-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .preview-btn:hover {
            background: #059669;
        }
        
        /* Document Preview Modal Styles */
        .document-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }
        
        .document-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .document-preview-container {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 1200px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .document-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .document-preview-header h3 {
            margin: 0;
            color: #374151;
            font-size: 1.125rem;
        }
        
        .document-preview-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: #f8f9fa;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .document-preview-content iframe {
            width: 100%;
            height: 80vh;
            border: none;
            display: block;
            background: white;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* PDF content styling to prevent text overlap */
        .document-preview-content iframe[src*="pdf"] {
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            height: 100vh;
        }
        
        /* Additional PDF viewer styling */
        .document-preview-content {
            overflow: auto;
        }
        
        .document-preview-content iframe[src*="pdf"] + * {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        /* Enhanced PDF viewer container */
        .document-preview-content.pdf-viewer {
            position: relative;
            overflow: hidden;
        }
        
        .document-preview-content.pdf-viewer iframe {
            transform: scale(0.75);
            transform-origin: top left;
            width: 133.33%;
            height: 133.33%;
            border: none;
        }
        
        /* Alternative PDF viewer styling */
        .document-preview-content iframe[src*="data:application/pdf"] {
            transform: scale(0.7);
            transform-origin: top left;
            width: 142.86%;
            height: 142.86%;
        }
        
        /* Enhanced PDF viewer for better compatibility */
        .document-preview-content.pdf-viewer iframe {
            min-height: 600px;
            background: white;
        }
        
        /* Fallback for PDFs that don't load properly */
        .document-preview-content.pdf-viewer iframe:not([src]) {
            display: none;
        }
        
        .document-preview-content.pdf-viewer iframe:not([src]) + .pdf-fallback {
            display: block;
        }
        
        .pdf-fallback {
            display: none;
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem;
        }
        
        .document-preview-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .close-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .download-btn {
            background: #0b7285;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .whatsapp-file-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .whatsapp-file-preview {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .pdf-attachment {
            border-left: 4px solid #dc3545;
        }
        
        /* Client Selection Modal Styles */
        .modal-overlay {
            z-index: 10001 !important;
        }
        
        .client-selection-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .client-selection-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .client-selection-item:hover {
            background: #f3f4f6;
            border-color: #0b7285;
        }
        
        .client-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0b7285;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .client-info {
            flex: 1;
        }
        
        .client-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .client-email {
            color: #6b7280;
            font-size: 14px;
        }
        
        .client-status {
            margin-left: 12px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.active {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-badge.inactive {
            background: #fef2f2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <img src="assets/images/full%20logo%20CT.png" alt="ClearTrack Logo">
                </div>
                <button class="menu-toggle-style6" id="menuToggle" onclick="toggleMenu('style6')" aria-label="Toggle navigation menu"></button>
                <button class="btn btn-outline" onclick="window.location.href='/login.html'" style="background: rgba(255,255,255,0.2); color: #ffffff; border-color: rgba(255,255,255,0.3);" id="desktopLogoutBtn">Logout</button>
            </div>
            <nav class="nav-style6" id="nav-style6">
                <a href="#" class="nav-link active" onclick="handleNavClick('dashboard', event)">Dashboard</a>
                <a href="#" class="nav-link" onclick="handleNavClick('clients', event)">Clients</a>
                <a href="#" class="nav-link" onclick="handleNavClick('messages', event)">Messages</a>
                <a href="#" class="nav-link" onclick="handleNavClick('requests', event)">Requests</a>
                <a href="#" class="nav-link" onclick="handleNavClick('tax-returns', event)">Tax Returns</a>
                <a href="#" class="nav-link" onclick="handleNavClick('invoices', event)">Invoices</a>
                <a href="#" class="nav-link" onclick="handleNavClick('profile', event)">Profile</a>
            </nav>
        </header>
        
        <main class="main">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <h1 class="mb-6">Practitioner Dashboard</h1>
                
                <div class="dashboard-grid">
                    <div class="stat-card clickable-tile" onclick="showClientsModal()">
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                        <div class="tile-hint">Click to view all clients</div>
                    </div>
                    
                    <div class="stat-card clickable-tile" onclick="showActiveClientsModal()">
                        <div class="stat-value" id="activeClients">0</div>
                        <div class="stat-label">Active Clients</div>
                        <div class="tile-hint">Click to view active clients</div>
                    </div>
                    
                    <div class="stat-card clickable-tile" onclick="showPendingReturnsModal()">
                        <div class="stat-value" id="pendingReturns">0</div>
                        <div class="stat-label">Pending Returns</div>
                        <div class="tile-hint">Click to view pending returns</div>
                    </div>
                    
                    <div class="stat-card clickable-tile" onclick="showCompletedReturnsModal()">
                        <div class="stat-value" id="completedReturns">0</div>
                        <div class="stat-label">Completed Returns</div>
                        <div class="tile-hint">Click to view completed returns</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Practitioner Code</h3>
                    </div>
                    <div class="practitioner-code">
                        <h4>Share this code with clients to connect:</h4>
                        <div class="code" id="practitionerCode">Loading...</div>
                        <button class="btn btn-primary btn-copy-code" id="copyCodeBtn" onclick="copyPractitionerCode()">
                            <img src="assets/icons/copy-and-paste.svg" class="icon icon-sm" alt="Copy"> Copy Your Code
                        </button>
                        <div id="copySuccessMessage" class="copy-success-message">
                            <img src="assets/icons/check.svg" class="icon icon-sm icon-green-600" alt="Success"> Code copied to clipboard successfully!
                        </div>
                        <p class="text-muted-small">
                            Clients can use this code to connect to your practice
                        </p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Client Activity</h3>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <p class="text-muted-center">No recent activity</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Clients Section -->
            <div id="clients" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1>Client Management</h1>
                    <button class="btn btn-primary" onclick="showAddClientModal()">Add Client</button>
                </div>
                
                <!-- Add Client Section (Invite via Mobile + Code) -->
                <div id="practitioner-add-client-section" class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">Invite Client via Mobile</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="add-client-mobile">Client Mobile Number</label>
                            <input id="add-client-mobile" type="tel" placeholder="Client mobile number" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="add-client-name">Client Name (Optional)</label>
                            <input id="add-client-name" type="text" placeholder="Client name" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="add-client-note">Note (Optional)</label>
                            <textarea id="add-client-note" rows="2" placeholder="Optional note" class="form-control"></textarea>
                        </div>
                        <button id="add-client-submit-btn" class="btn btn-primary">Add client</button>
                        <div id="add-client-feedback" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Client Search Bar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <input type="text" id="clientSearchInput" placeholder="Search clients by name, email, or phone..." class="search-input">
                                <div class="search-icon">
                                <img src="assets/icons/search.svg" class="icon icon-gray-500" alt="Search">
                            </div>
                            </div>
                            <div class="search-filters">
                                <select id="clientFilterSelect" class="filter-select">
                                    <option value="all">All Clients</option>
                                    <option value="with-documents">With Documents</option>
                                    <option value="with-expenses">With Expenses</option>
                                    <option value="recent">Recently Added</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Clients</h3>
                        <div id="clientCount" class="client-count">0 clients</div>
                    </div>
                    <div class="card-body">
                        <div id="clientsList">
                            <p class="text-muted-center">No clients connected yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Messages Section -->
            <div id="messages" class="section hidden">
                <h1 class="mb-6">Messages</h1>
                
                <!-- WhatsApp-style messaging interface -->
                <div class="whatsapp-messaging">
                    <!-- Left sidebar - Client list -->
                    <div class="whatsapp-sidebar">
                        <div class="whatsapp-sidebar-header">
                            <div class="whatsapp-sidebar-actions">
                                <button onclick="refreshPractitionerMessages()" title="Refresh">
                                    <img src="assets/icons/refresh.svg" class="icon icon-sm" alt="Refresh">
                                </button>
                        </div>
                            </div>
                        
                        <div class="whatsapp-search" style="position: relative;">
                            <input type="text" placeholder="Search clients" id="clientSearch" style="padding-left: 40px; position: relative;">
                            <div class="search-icon" style="position: absolute; left: 28px; top: 50%; transform: translateY(-50%); pointer-events: none; z-index: 1;">
                                <img src="assets/icons/search.svg" class="icon icon-gray-500" alt="Search" style="width: 18px; height: 18px;">
                            </div>
                        </div>
                        
                        <div class="whatsapp-chat-list" id="conversationsList">
                            <p style="color: #667781; text-align: center; padding: 20px;">No clients connected yet</p>
                        </div>
                    </div>
                    
                    <!-- Main chat area -->
                    <div class="whatsapp-main">
                        <div class="whatsapp-chat-header" id="chatHeaderInfo">
                            <div class="whatsapp-chat-contact">
                                <div class="whatsapp-chat-contact-avatar">
                                    <img src="assets/icons/user.svg" class="icon icon-lg" alt="Profile">
                                </div>
                                <div class="whatsapp-chat-contact-info">
                                <h3>Select a client to start chatting</h3>
                                <p>Choose a client from the left to view your conversation</p>
                                </div>
                            </div>
                            <div class="whatsapp-chat-actions">
                                <button onclick="callClient()" title="Call">
                                    <img src="assets/icons/phone.svg" class="icon icon-sm" alt="Call">
                                </button>
                                <button onclick="videoCallClient()" title="Video">
                                    <img src="assets/icons/video.svg" class="icon icon-sm" alt="Video">
                                </button>
                            </div>
                        </div>
                        
                        <div class="whatsapp-messages" id="conversationMessages">
                                <div class="chat-empty-state">
                                    <div class="chat-empty-icon">
                                        <img src="assets/icons/message.svg" class="icon icon-2xl icon-gray-500" alt="Message">
                                    </div>
                                    <h3 class="chat-empty-title">No conversation selected</h3>
                                    <p class="chat-empty-text">Select a client from the left to start or continue your conversation</p>
                            </div>
                        </div>
                        
                        <div class="whatsapp-input-area" id="messageInputArea" style="display: none; position: relative;">
                            <!-- Attachment menu -->
                            <div class="whatsapp-attachment-menu" id="attachmentMenu">
                                <button class="whatsapp-attachment-item" onclick="document.getElementById('fileInput').click(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">
                                        <img src="assets/icons/document.svg" class="icon icon-sm" alt="Document">
                                    </div>
                                    <div class="whatsapp-attachment-text">Document</div>
                                        </button>
                                <button class="whatsapp-attachment-item" onclick="document.getElementById('imageInput').click(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">
                                        <img src="assets/icons/camera.svg" class="icon icon-sm" alt="Camera">
                                    </div>
                                    <div class="whatsapp-attachment-text">Camera</div>
                                        </button>
                                <button class="whatsapp-attachment-item" onclick="document.getElementById('fileInput').click(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">
                                        <img src="assets/icons/gallery.svg" class="icon icon-sm" alt="Gallery">
                                    </div>
                                    <div class="whatsapp-attachment-text">Gallery</div>
                                        </button>
                                <button class="whatsapp-attachment-item" onclick="startVoiceRecording(); closeAttachmentMenu();">
                                    <div class="whatsapp-attachment-icon">
                                        <img src="assets/icons/message.svg" class="icon icon-sm" alt="Audio">
                                    </div>
                                    <div class="whatsapp-attachment-text">Audio</div>
                                        </button>
                                </div>
                                
                            <!-- Emoji picker -->
                            <div class="whatsapp-emoji-picker" id="emojiPicker">
                                <div class="whatsapp-emoji-grid" id="emojiGrid">
                                        <!-- Emojis will be added here -->
                                    </div>
                                </div>
                                
                            <div class="whatsapp-input-container">
                                <div class="whatsapp-input-actions">
                                    <button onclick="toggleAttachmentMenu()" title="Attach">
                                        <img src="assets/icons/document.svg" class="icon icon-sm" alt="Attach">
                                    </button>
                                    <button onclick="toggleEmojiPicker()" title="Emoji"></button>
                                </div>
                                <textarea id="practitionerMessageText" class="whatsapp-input" placeholder="Type a message" rows="1" onkeydown="handleMessageKeydown(event)" oninput="autoResize(this)"></textarea>
                                <div class="whatsapp-input-actions">
                                    <button onclick="sendPractitionerMessage()" class="send" title="Send">
                                        <img src="assets/icons/message.svg" class="icon icon-sm" alt="Send">
                                    </button>
                                </div>
                                </div>
                                
                                <!-- Hidden file inputs -->
                                <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" class="hidden-input" onchange="handleFileUpload(event)">
                                <input type="file" id="imageInput" accept="image/*,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" capture="camera" class="hidden-input" onchange="handleFileUpload(event)">
                        </div>
                                
                                <!-- Voice recording indicator -->
                        <div class="whatsapp-voice-recording" id="voiceRecording">
                            <div class="whatsapp-voice-indicator">
                                <div class="whatsapp-voice-dot"></div>
                                <span>Recording... Tap to stop</span>
                                <button onclick="stopVoiceRecording()" style="background: #dc2626; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px; margin-left: 8px;">Stop</button>
                                    </div>
                                </div>
                            </div>
                </div>
            </div>
            
            <!-- Connection Requests Section -->
            <div id="requests" class="section hidden">
                <h1 class="mb-6">Connection Requests</h1>
                
                <!-- New Client Requests Section -->
                <div id="practitioner-requests-section" class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">New Client Requests</h3>
                    </div>
                    <div class="card-body">
                        <div id="practitioner-requests-list">
                            <p class="text-muted-center">No new client requests</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pending Requests</h3>
                    </div>
                    <div class="card-body">
                        <div id="connectionRequestsList">
                            <!-- Connection requests will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tax Returns Section -->
            <div id="tax-returns" class="section hidden">
                <h1 class="mb-6">Tax Returns</h1>
                
            <!-- Tax Returns Search Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="search-container">
                        <div class="search-input-wrapper">
                            <input type="text" id="taxReturnsSearchInput" placeholder="Search tax returns by client name, tax year, or status..." class="search-input">
                            <div class="search-icon">
                                <img src="assets/icons/search.svg" class="icon icon-gray-500" alt="Search">
                            </div>
                        </div>
                        <div class="search-filters">
                            <select id="taxReturnsFilterSelect" class="filter-select">
                                <option value="all">All Returns</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="current-year">Current Year</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Client Tax Returns</h3>
                        <div id="taxReturnsCount" class="client-count">0 returns</div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Client Name</th>
                                    <th>Tax Year</th>
                                    <th>Status</th>
                                    <th>Documents</th>
                                    <th>Expenses</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="taxReturnsTable">
                                <tr>
                                    <td colspan="6" class="table-empty-cell">No tax returns to display</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Invoices Section -->
            <div id="invoices" class="section hidden">
                <h1 class="mb-6">Invoice Management</h1>
                
                <!-- Invoice Search Bar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <input type="text" id="invoiceSearchInput" placeholder="Search invoices by client name, invoice number, or amount..." class="search-input">
                                <div class="search-icon">
                                <img src="assets/icons/search.svg" class="icon icon-gray-500" alt="Search">
                            </div>
                            </div>
                            <div class="search-filters">
                                <select id="invoiceFilterSelect" class="filter-select">
                                    <option value="all">All Invoices</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="current-year">Current Year</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Generated Invoices</h3>
                        <div id="invoiceCount" class="client-count">0 invoices</div>
                    </div>
                    <div class="card-body">
                        <div id="invoicesList" class="invoices-list">
                            <!-- Invoices will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Section -->
            <div id="profile" class="section hidden">
                <h1 class="mb-6">Practitioner Profile</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Practice Information</h3>
                    </div>
                    <div class="card-body">
                        <form id="practitionerProfileForm">
                            <div class="form-group">
                                <label>Profile Image</label>
                                <div class="profile-section-flex">
                                    <div class="profile-image-section">
                                        <div id="practitionerProfileImageContainer" class="profile-image-container clickable" onclick="triggerPractitionerProfileImageSelect()" tabindex="0" role="button" aria-label="Upload profile image" onkeypress="if(event.key==='Enter'||event.key===' '){triggerPractitionerProfileImageSelect();}">
                                            <img id="practitionerProfileImage" src="" alt="Profile Image" class="profile-image">
                                            <div id="practitionerProfileImagePlaceholder" class="profile-image-placeholder">No Image</div>
                                        </div>
                                        <button type="button" onclick="openPractitionerProfileImageModal()" class="profile-edit-btn">Edit</button>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="practitionerProfileImageInput" accept="image/*" class="hidden-input" onchange="handlePractitionerProfileImageUpload(event)">
                                        <input type="file" id="practitionerCameraInput" accept="image/*" capture="environment" class="hidden-input" onchange="handlePractitionerProfileImageUpload(event)">
                                        <input type="file" id="practitionerGalleryInput" accept="image/*" class="hidden-input" onchange="handlePractitionerProfileImageUpload(event)">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name</label>
                                    <input type="text" id="firstName" value="" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name</label>
                                    <input type="text" id="lastName" value="" required>
                                </div>
                            </div>
                            
                                <div class="form-group">
                                    <label for="practiceName">Practice Name</label>
                                    <input type="text" id="practiceName" value="" required>
                            </div>
                            
                                <div class="form-group">
                                    <label for="yearsExperience">Years Experience</label>
                                <input type="number" id="yearsExperience" value="" min="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="qualifications">Qualifications</label>
                                <textarea id="qualifications" rows="3" placeholder="List your qualifications"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Specializations</label>
                                <div class="checkbox-grid">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Individual Tax Returns" class="checkbox-input">
                                        <span class="attachment-text">Individual Tax Returns</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Small Business Tax" class="checkbox-input">
                                        <span class="attachment-text">Small Business Tax</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="SARS Compliance" class="checkbox-input">
                                        <span class="attachment-text">SARS Compliance</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Corporate Tax" class="checkbox-input">
                                        <span class="attachment-text">Corporate Tax</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Tax Planning" class="checkbox-input">
                                        <span class="attachment-text">Tax Planning</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="VAT Returns" class="checkbox-input">
                                        <span class="attachment-text">VAT Returns</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Payroll Tax" class="checkbox-input">
                                        <span class="attachment-text">Payroll Tax</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Tax Audits" class="checkbox-input">
                                        <span class="attachment-text">Tax Audits</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Estate Planning" class="checkbox-input">
                                        <span class="attachment-text">Estate Planning</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="specialization" value="Dispute" class="checkbox-input">
                                        <span class="attachment-text">Disputes / Verifications</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label-large">
                                    <input type="checkbox" id="isPubliclyVisible" class="checkbox-input-large">
                                    <div>
                                        <span class="checkbox-title">Make my profile visible to users</span>
                                        <div class="checkbox-description">Allow users to find and connect with me through the "Available Practitioners" section</div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label for="bio">Bio</label>
                                <textarea id="bio" rows="4" placeholder="Tell clients about yourself"></textarea>
                            </div>
                        </form>
                    </div>
                            </div>
                            
                <!-- Bank Details Section -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">Bank Details</h3>
                        <p style="color: #6b7280; font-size: 0.875rem; margin: 0.5rem 0 0 0;">Your bank details will be automatically included in invoices</p>
                    </div>
                    <div class="card-body">
                        <form id="bankDetailsForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="profileBankName">Bank Name</label>
                                    <input type="text" id="profileBankName" placeholder="e.g., Standard Bank, FNB, ABSA">
                                </div>
                                <div class="form-group">
                                    <label for="profileBankBranch">Branch Code</label>
                                    <input type="text" id="profileBankBranch" placeholder="e.g., 051001">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="profileAccountNumber">Account Number</label>
                                    <input type="text" id="profileAccountNumber" placeholder="Your account number">
                                </div>
                                <div class="form-group">
                                    <label for="profileAccountType">Account Type</label>
                                    <select id="profileAccountType">
                                        <option value="business">Business Account</option>
                                        <option value="personal">Personal Account</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="profileBankReference">Payment Reference</label>
                                <input type="text" id="profileBankReference" placeholder="e.g., Invoice number or client name">
                                <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;">This will be used as the default payment reference on invoices</small>
                            </div>
                            
                            <button type="button" onclick="saveBankDetailsFromProfile()" class="btn btn-outline">Save Bank Details</button>
                        </form>
                    </div>
                </div>
                
                <!-- Invoice Message Section -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">Invoice Messages</h3>
                        <p style="color: #6b7280; font-size: 0.875rem; margin: 0.5rem 0 0 0;">Customize messages that appear on your invoices</p>
                    </div>
                    <div class="card-body">
                        <form id="invoiceMessageForm">
                            <div class="form-group">
                                <label for="defaultInvoiceNotes">Default Invoice Notes</label>
                                <textarea id="defaultInvoiceNotes" rows="3" placeholder="e.g., Payment due within 30 days. Thank you for your business."></textarea>
                                <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;">This message will appear on all new invoices by default</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="invoiceFooterMessage">Invoice Footer Message</label>
                                <textarea id="invoiceFooterMessage" rows="2" placeholder="e.g., For any queries, please contact us at info@yourpractice.com"></textarea>
                                <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;">Optional footer message for invoices</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="invoiceTerms">Payment Terms</label>
                                <textarea id="invoiceTerms" rows="2" placeholder="e.g., Payment is due within 30 days of invoice date. Late payments may incur interest charges."></textarea>
                                <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;">Terms and conditions for payment</small>
                            </div>
                            
                            <button type="button" onclick="saveInvoiceMessages()" class="btn btn-outline">Save Invoice Messages</button>
                        </form>
                    </div>
                </div>
                
                <!-- Profile Update Section -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-body">
                        <button type="button" onclick="updatePractitionerProfile()" class="btn btn-primary">Update Profile</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal-overlay hidden" onclick="hideAddClientModalOnOverlay(event)">
        <div class="modal" style="max-width: 600px; width: 90%;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="addClientModalTitle" class="modal-title">Add Client</h3>
                <button onclick="hideAddClientModal()" class="modal-close">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="addClientForm" style="display: flex; flex-direction: column; gap: 0;">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="clientFirstName" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 14px;">First Name <span style="color: #dc2626;">*</span></label>
                            <input type="text" id="clientFirstName" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.2s ease; background: white;" onfocus="this.style.borderColor='#0b7285'; this.style.boxShadow='0 0 0 3px rgba(11, 114, 133, 0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="clientLastName" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 14px;">Last Name <span style="color: #dc2626;">*</span></label>
                            <input type="text" id="clientLastName" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.2s ease; background: white;" onfocus="this.style.borderColor='#0b7285'; this.style.boxShadow='0 0 0 3px rgba(11, 114, 133, 0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label for="clientEmail" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 14px;">Email Address <span style="color: #dc2626;">*</span></label>
                        <input type="email" id="clientEmail" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.2s ease; background: white;" onfocus="this.style.borderColor='#0b7285'; this.style.boxShadow='0 0 0 3px rgba(11, 114, 133, 0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="clientPhone" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 14px;">Phone Number</label>
                            <input type="tel" id="clientPhone" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.2s ease; background: white;" onfocus="this.style.borderColor='#0b7285'; this.style.boxShadow='0 0 0 3px rgba(11, 114, 133, 0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="clientTaxNumber" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 14px;">Tax Number</label>
                            <input type="text" id="clientTaxNumber" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.2s ease; background: white;" onfocus="this.style.borderColor='#0b7285'; this.style.boxShadow='0 0 0 3px rgba(11, 114, 133, 0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label for="clientNotes" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 14px;">Notes <span style="color: #6b7280; font-weight: 400; font-size: 13px;">(Optional)</span></label>
                        <textarea id="clientNotes" rows="3" placeholder="Any additional notes about this client" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.2s ease; background: white; resize: vertical; font-family: inherit;" onfocus="this.style.borderColor='#0b7285'; this.style.boxShadow='0 0 0 3px rgba(11, 114, 133, 0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button type="button" onclick="hideAddClientModal()" style="padding: 12px 24px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: white; color: #374151;" onmouseover="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">Cancel</button>
                        <button type="submit" style="padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: linear-gradient(135deg, #0b7285 0%, #0891b2 100%); color: white; box-shadow: 0 4px 12px rgba(11, 114, 133, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(11, 114, 133, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(11, 114, 133, 0.3)';">Add Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Client Details Modal -->
    <div id="clientDetailsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="clientDetailsTitle">Client Details</h3>
                <button class="modal-close" onclick="hideClientDetailsModal()">&times;</button>
            </div>
            
            <div id="clientDetailsContent">
                <!-- Client details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Vehicle Details Modal -->
    <div id="vehicleDetailsModal" class="modal-overlay hidden">
        <div class="modal vehicle-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="vehicleDetailsTitle">Vehicle Details</h3>
                <button class="modal-close" onclick="hideVehicleModal()">&times;</button>
            </div>
            
            <div id="vehicleDetailsContent">
                <!-- Vehicle details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Document Download Modal -->
    <div id="documentDownloadModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Download Client Documents</h3>
                <button class="modal-close" onclick="hideDocumentDownloadModal()">&times;</button>
            </div>
            
            <div id="documentDownloadContent">
                <!-- Document list will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Document Viewer Modal -->
    <div id="documentViewerModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 90vw; max-height: 90vh; width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title" id="documentViewerTitle">Document Viewer</h3>
                <button class="modal-close" onclick="hideDocumentViewerModal()">&times;</button>
            </div>
            
            <div id="documentViewerContent" style="padding: 1rem; max-height: 70vh; overflow-y: auto; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                <!-- Document content will be loaded here -->
            </div>
            
            <div style="padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-outline" onclick="hideDocumentViewerModal()">Close</button>
                <button class="btn btn-primary" id="downloadFromViewerBtn" onclick="downloadFromViewer()">
                    <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download"> Download
                </button>
            </div>
        </div>
    </div>
    
    <!-- Client Data View Modal -->
    <div id="clientDataModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="clientDataTitle">Client Data View</h3>
                <button class="modal-close" onclick="hideClientDataModal()">&times;</button>
            </div>
            
            <div id="clientDataContent">
                <!-- Client data will be loaded here -->
            </div>
        </div>
        </div>
    
    <!-- Dashboard Tile Modals -->
    <!-- All Clients Modal -->
    <div id="allClientsModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">All Clients Overview</h3>
                <button class="modal-close" onclick="hideAllClientsModal()">&times;</button>
            </div>
            
            <div id="allClientsContent" class="p-4">
                <!-- All clients will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Active Clients Modal -->
    <div id="activeClientsModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Active Clients</h3>
                <button class="modal-close" onclick="hideActiveClientsModal()">&times;</button>
            </div>
            
            <div id="activeClientsContent" class="p-4">
                <!-- Active clients will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Pending Returns Modal -->
    <div id="pendingReturnsModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Pending Tax Returns</h3>
                <button class="modal-close" onclick="hidePendingReturnsModal()">&times;</button>
            </div>
            
            <div id="pendingReturnsContent" class="p-4">
                <!-- Pending returns will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Completed Returns Modal -->
    <div id="completedReturnsModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Completed Tax Returns</h3>
                <button class="modal-close" onclick="hideCompletedReturnsModal()">&times;</button>
            </div>
            
            <div id="completedReturnsContent" class="p-4">
                <!-- Completed returns will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- New Clean Invoice Generation Modal -->
    <div id="newInvoiceModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Generate Invoice</h3>
                <button class="modal-close" onclick="closeNewInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Client Selection Section -->
                <div class="invoice-section">
                    <h4 class="section-title">Select Client</h4>
                    <div class="client-selection">
                        <select id="newInvoiceClientSelect" class="form-control" required>
                            <option value="">Choose a client...</option>
                        </select>
                        <div id="selectedClientInfo" class="selected-client-info hidden">
                            <div class="client-details">
                                <h5 id="selectedClientName"></h5>
                                <p id="selectedClientEmail"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoice Details Section -->
                <div class="invoice-section">
                    <h4 class="section-title">Invoice Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newInvoiceNumber">Invoice Number</label>
                            <input type="text" id="newInvoiceNumber" class="form-control" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="newInvoiceDate">Invoice Date</label>
                            <input type="date" id="newInvoiceDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="newInvoiceDueDate">Due Date</label>
                            <input type="date" id="newInvoiceDueDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newInvoiceTaxYear">Tax Year</label>
                            <select id="newInvoiceTaxYear" class="form-control" required>
                                <option value="2024/2025">2024/2025</option>
                                <option value="2025/2026" selected>2025/2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newInvoiceAmount">Amount (R)</label>
                            <input type="number" id="newInvoiceAmount" class="form-control" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newInvoiceDescription">Description</label>
                        <textarea id="newInvoiceDescription" class="form-control" rows="3" required placeholder="Describe the services provided..."></textarea>
                    </div>
                </div>

                <!-- VAT Section -->
                <div class="invoice-section">
                    <h4 class="section-title">VAT Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newInvoiceVATType">VAT Type</label>
                            <select id="newInvoiceVATType" class="form-control" required>
                                <option value="standard">Standard (15%)</option>
                                <option value="exempt">VAT Exempt</option>
                                <option value="zero">Zero-rated</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newInvoiceVATReason">VAT Exemption Reason (if applicable)</label>
                            <input type="text" id="newInvoiceVATReason" class="form-control" placeholder="Enter reason for VAT exemption">
                        </div>
                    </div>
                    <div class="vat-calculation">
                        <div class="calculation-row">
                            <span>Subtotal:</span>
                            <span id="vatSubtotal">R 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>VAT (15%):</span>
                            <span id="vatAmount">R 0.00</span>
                        </div>
                        <div class="calculation-row total">
                            <span>Total:</span>
                            <span id="vatTotal">R 0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="invoice-section">
                    <h4 class="section-title">Additional Information</h4>
                    <div class="form-group">
                        <label for="newInvoiceNotes">Notes</label>
                        <textarea id="newInvoiceNotes" class="form-control" rows="2" placeholder="Additional notes or payment instructions..."></textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeNewInvoiceModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="generateNewInvoice()">Generate Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal-overlay hidden" onclick="handleInvoiceModalClick(event)">
        <div class="modal" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Invoice Preview</h3>
                <button class="modal-close" onclick="hideInvoicePreviewModal()">&times;</button>
                    </div>
                    
            <div class="modal-body">
                <div id="invoicePreviewContent" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                    <!-- Invoice preview will be loaded here -->
                    </div>
                    
                <div class="invoice-actions" style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 16px;">Invoice Actions</h4>
                    <div id="invoiceActionButtons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <!-- Actions will be populated dynamically based on invoice status -->
                    </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Expense Details Modal -->
    <div id="expenseModal" class="modal-overlay hidden" onclick="closeExpenseModal()">
        <div class="modal" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Expense Details</h3>
                <button class="modal-close" onclick="closeExpenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="expenseContent">
                    <!-- Expense details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="shared-data.js"></script>
    <script>
        // Practitioner state - now using real data storage
        let practitioner = null;
        window.practitioner = practitioner; // Make it global for event listeners
        let clients = [];
        let taxReturns = [];
        let currentClientId = null;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Messaging service is already initialized globally in messaging-service.js
            
            // Clear any sample practitioners that might exist
            cleartrackData.clearSamplePractitioners();
            
            // Clear any test practitioner data that might have been created during testing
            const data = cleartrackData.getData();
            if (data && data.practitioners) {
                for (let practitionerId in data.practitioners) {
                    const practitioner = data.practitioners[practitionerId];
                    // Only remove practitioners with specific test names, not default names
                    if (practitioner.name === 'Dr. Test Practitioner' ||
                        practitioner.name === 'Test Practitioner' ||
                        practitioner.practiceName === 'Test Practice') {
                        delete data.practitioners[practitionerId];
                    }
                }
                cleartrackData.setData(data);
            }
            initializePractitioner();
            // Load data - updateDashboard will be called by loadClients() after clients are loaded
            loadClients();
            loadTaxReturns();
            loadInvoices();
            // Also call updateDashboard here as a fallback, but loadClients() will call it too
            setTimeout(() => updateDashboard(), 100);
            
            // Setup invoice form
            setupInvoiceForm();
            
            // Setup client linking handlers
            setupClientLinkingHandlers();
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                const attachmentMenu = document.getElementById('attachmentMenu');
                const emojiPicker = document.getElementById('emojiPicker');
                const attachmentButton = document.querySelector('[onclick="toggleAttachmentMenu()"]');
                const emojiButton = document.querySelector('[onclick="toggleEmojiPicker()"]');
                
                // Check if click is outside both modals and their buttons
                if (!attachmentMenu.contains(event.target) && 
                    !emojiPicker.contains(event.target) && 
                    !attachmentButton.contains(event.target) && 
                    !emojiButton.contains(event.target)) {
                    closeAllModals();
                }
            });
            
        });
        
        // Initialize practitioner from Firebase Auth and Firestore
        async function initializePractitioner() {
            console.log(' DEBUG: initializePractitioner() called');
            
            // Ensure data storage is properly initialized
            if (!cleartrackData.getData()) {
                console.log(' DEBUG: Initializing data storage');
                cleartrackData.initializeData();
            }
            
            // Check if Firebase Auth is available
            if (!window.firebaseAuth) {
                console.error(' DEBUG: Firebase Auth not available');
                // Fallback to local storage
                loadPractitionerFromLocalStorage();
                return;
            }
            
            // Get current Firebase user
            const firebaseUser = window.firebaseAuth.currentUser;
            if (!firebaseUser) {
                console.log(' DEBUG: No Firebase user logged in, checking auth state...');
                // Wait for auth state to be determined
                window.firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        await loadPractitionerFromFirestore(user.uid);
                    } else {
                        loadPractitionerFromLocalStorage();
                    }
                });
                return;
            }
            
            // Load practitioner profile from Firestore
            await loadPractitionerFromFirestore(firebaseUser.uid);
        }
        
        // Load practitioner profile from Firestore and sync with local storage
        async function loadPractitionerFromFirestore(uid) {
            try {
                console.log(' DEBUG: Loading practitioner from Firestore, UID:', uid);
                
                // Load profile from Firestore
                let firestoreProfile = null;
                if (window.cleartrackAuthApi && window.cleartrackAuthApi.getUserProfile) {
                    firestoreProfile = await window.cleartrackAuthApi.getUserProfile(uid);
                } else if (window.firebaseApi && window.firebaseApi.getData) {
                    firestoreProfile = await window.firebaseApi.getData('users', uid);
                }
                
                if (!firestoreProfile) {
                    console.warn(' DEBUG: No Firestore profile found, creating new practitioner');
                    // Create new practitioner in Firestore
                    await createPractitionerInFirestore(uid);
                    return;
                }
                
                console.log(' DEBUG: Firestore profile loaded:', firestoreProfile);
                
                // Get or create practitioner in local storage using Firebase UID as the practitioner ID
                const data = cleartrackData.getData();
                
                // Use Firebase UID as the practitioner ID to ensure consistency
                if (data.practitioners[uid]) {
                    // Update existing practitioner with Firestore data
                    practitioner = data.practitioners[uid];
                    
                    // Merge Firestore data into local practitioner
                    practitioner = {
                        ...practitioner,
                        id: uid, // Ensure ID matches Firebase UID
                        firstName: firestoreProfile.firstName || practitioner.firstName || '',
                        lastName: firestoreProfile.lastName || practitioner.lastName || '',
                        name: firestoreProfile.name || `${firestoreProfile.firstName || ''} ${firestoreProfile.lastName || ''}`.trim() || practitioner.name || '',
                        email: firestoreProfile.email || practitioner.email || '',
                        practiceName: firestoreProfile.practiceName || practitioner.practiceName || '',
                        practiceNumber: firestoreProfile.practiceNumber || practitioner.practiceNumber || '',
                        sarsNumber: firestoreProfile.sarsNumber || practitioner.sarsNumber || '',
                        yearsExperience: firestoreProfile.yearsExperience || practitioner.yearsExperience || 0,
                        qualifications: firestoreProfile.qualifications || practitioner.qualifications || '',
                        specializations: firestoreProfile.specializations || practitioner.specializations || [],
                        bio: firestoreProfile.bio || practitioner.bio || '',
                        phone: firestoreProfile.phone || practitioner.phone || '',
                        isPubliclyVisible: firestoreProfile.isPubliclyVisible !== undefined ? firestoreProfile.isPubliclyVisible : (practitioner.isPubliclyVisible || false),
                        // Ensure practitionerCode exists - generate if missing
                        practitionerCode: firestoreProfile.practitionerCode || practitioner.practitionerCode || cleartrackData.generatePractitionerCode(),
                        profileImage: practitioner.profileImage || firestoreProfile.profileImage || ''
                    };
                    
                    // Update local storage
                    cleartrackData.updatePractitioner(uid, practitioner);
                } else {
                    // Create new practitioner in local storage with Firestore data
                    const practitionerCode = firestoreProfile.practitionerCode || cleartrackData.generatePractitionerCode();
                    practitioner = cleartrackData.createPractitionerWithId(uid, {
                        firstName: firestoreProfile.firstName || '',
                        lastName: firestoreProfile.lastName || '',
                        name: firestoreProfile.name || `${firestoreProfile.firstName || ''} ${firestoreProfile.lastName || ''}`.trim() || '',
                        email: firestoreProfile.email || '',
                        practiceName: firestoreProfile.practiceName || '',
                        practiceNumber: firestoreProfile.practiceNumber || '',
                        sarsNumber: firestoreProfile.sarsNumber || '',
                        yearsExperience: firestoreProfile.yearsExperience || 0,
                        qualifications: firestoreProfile.qualifications || '',
                        specializations: firestoreProfile.specializations || [],
                        bio: firestoreProfile.bio || '',
                        phone: firestoreProfile.phone || '',
                        isPubliclyVisible: firestoreProfile.isPubliclyVisible || false,
                        practitionerCode: practitionerCode
                    });
                }
                
                // Ensure practitionerCode is saved to Firestore if it wasn't there
                if (!firestoreProfile.practitionerCode && practitioner.practitionerCode) {
                    try {
                        await window.firebaseApi.saveData('users', uid, {
                            practitionerCode: practitioner.practitionerCode
                        });
                        console.log(' DEBUG: Practitioner code saved to Firestore');
                    } catch (error) {
                        console.error(' DEBUG: Error saving practitioner code to Firestore:', error);
                    }
                }
                
                window.practitioner = practitioner;
                console.log(' DEBUG: Current practitioner set from Firestore:', practitioner);
                updatePractitionerInterface();
                
            } catch (error) {
                console.error(' DEBUG: Error loading practitioner from Firestore:', error);
                // Fallback to local storage
                loadPractitionerFromLocalStorage();
            }
        }
        
        // Create new practitioner in Firestore
        async function createPractitionerInFirestore(uid) {
            try {
                console.log(' DEBUG: Creating new practitioner in Firestore');
                
                // Generate practitioner code
                const practitionerCode = cleartrackData.generatePractitionerCode();
                
                // Get Firebase user email
                const firebaseUser = window.firebaseAuth.currentUser;
                const email = firebaseUser ? firebaseUser.email : '';
                
                // Create practitioner data
                const practitionerData = {
                    role: 'practitioner',
                    email: email,
                    practitionerCode: practitionerCode,
                    firstName: '',
                    lastName: '',
                    name: '',
                    practiceName: '',
                    practiceNumber: '',
                    sarsNumber: '',
                    yearsExperience: 0,
                    qualifications: '',
                    specializations: [],
                    bio: '',
                    phone: '',
                    isPubliclyVisible: false,
                    createdAt: new Date().toISOString()
                };
                
                // Save to Firestore
                if (window.firebaseApi && window.firebaseApi.saveData) {
                    await window.firebaseApi.saveData('users', uid, practitionerData);
                    console.log(' DEBUG: New practitioner created in Firestore');
                }
                
                // Create in local storage
                practitioner = cleartrackData.createPractitionerWithId(uid, practitionerData);
                window.practitioner = practitioner;
                updatePractitionerInterface();
                
            } catch (error) {
                console.error(' DEBUG: Error creating practitioner in Firestore:', error);
                // Fallback to local storage
                loadPractitionerFromLocalStorage();
            }
        }
        
        // Fallback: Load practitioner from local storage only
        function loadPractitionerFromLocalStorage() {
            console.log(' DEBUG: Loading practitioner from local storage');
            const data = cleartrackData.getData();
            const practitionerIds = Object.keys(data.practitioners || {});
            
            if (practitionerIds.length > 0) {
                practitioner = data.practitioners[practitionerIds[0]];
                window.practitioner = practitioner;
                console.log(' DEBUG: Current practitioner set from local storage:', practitioner);
                updatePractitionerInterface();
            } else {
                console.log(' DEBUG: No practitioners found, creating new practitioner');
                practitioner = cleartrackData.createPractitioner({
                    name: 'Practitioner',
                    practiceName: 'Your Practice Name',
                    practiceNumber: 'PR' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                    sarsNumber: 'SARS' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                    yearsExperience: 0,
                    qualifications: '',
                    specializations: [],
                    bio: '',
                    email: '',
                    phone: '',
                    isPubliclyVisible: false
                });
                window.practitioner = practitioner;
                console.log(' DEBUG: New practitioner created:', practitioner);
                updatePractitionerInterface();
            }
            
            // Simple messaging - no complex service needed
            console.log(' Practitioner messaging ready');
        }
        
        // Update practitioner interface
        function updatePractitionerInterface() {
            if (practitioner) {
                // Update practitioner name in mobile menu
                const mobileNameElement = document.getElementById('mobilePractitionerName');
                if (mobileNameElement) {
                    mobileNameElement.textContent = practitioner.name || 'Practitioner';
                }
                
                // Update practitioner code display
                document.getElementById('practitionerCode').textContent = practitioner.practitionerCode;
                
                // Update profile form
                document.getElementById('firstName').value = practitioner.firstName || '';
                document.getElementById('lastName').value = practitioner.lastName || '';
                document.getElementById('practiceName').value = practitioner.practiceName || '';
                document.getElementById('yearsExperience').value = practitioner.yearsExperience || '';
                document.getElementById('qualifications').value = practitioner.qualifications || '';
                
                // Update visibility checkbox
                document.getElementById('isPubliclyVisible').checked = practitioner.isPubliclyVisible || false;
                
                // Update profile image
                const profileImg = document.getElementById('practitionerProfileImage');
                const placeholder = document.getElementById('practitionerProfileImagePlaceholder');
                const editBtn = document.getElementById('editPractitionerProfileImage');
                const removeBtn = document.getElementById('removePractitionerProfileImage');
                
                if (practitioner.profileImage) {
                    if (profileImg) profileImg.src = practitioner.profileImage;
                    if (profileImg) profileImg.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                    if (editBtn) editBtn.style.display = 'inline-block';
                    if (removeBtn) removeBtn.style.display = 'inline-block';
                } else {
                    if (profileImg) profileImg.src = '';
                    if (profileImg) profileImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'block';
                    if (editBtn) editBtn.style.display = 'none';
                    if (removeBtn) removeBtn.style.display = 'none';
                }
                
                // Load bank details
                loadBankDetailsInProfile();
                
                // Load invoice messages
                loadInvoiceMessagesInProfile();
                
                // Update specializations checkboxes
                const specializationCheckboxes = document.querySelectorAll('input[name="specialization"]');
                specializationCheckboxes.forEach(checkbox => {
                    checkbox.checked = false; // Reset all first
                });
                
                if (practitioner.specializations && Array.isArray(practitioner.specializations)) {
                    practitioner.specializations.forEach(spec => {
                        const checkbox = document.querySelector(`input[name="specialization"][value="${spec}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                } else if (practitioner.specializations && typeof practitioner.specializations === 'string') {
                    // Handle legacy string format
                    const specs = practitioner.specializations.split(', ').map(s => s.trim());
                    specs.forEach(spec => {
                        const checkbox = document.querySelector(`input[name="specialization"][value="${spec}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                document.getElementById('bio').value = practitioner.bio || '';
            }
        }
        
        // Download client documents
        function downloadClientDocuments(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Set current client ID for download function
            currentClientId = clientId;
            
            const documents = cleartrackData.getUserDocuments(clientId);
            
            document.getElementById('documentDownloadContent').innerHTML = `
                <div class="mb-4">
                    <h4>Documents for ${client.firstName} ${client.lastName}</h4>
                    <p style="color: #6b7280;">View documents in browser or download them</p>
                </div>
                
                ${documents.length === 0 ? 
                    '<p style="color: #6b7280; text-align: center; padding: 2rem;">No documents uploaded yet</p>' :
                    documents.map(doc => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;">
                            <div class="flex-1">
                                <div class="font-medium">${doc.type}</div>
                                <div class="text-sm text-gray-500">Tax Year: ${doc.taxYear} | ${doc.fileName}</div>
                                ${doc.description ? `<div class="text-sm text-gray-500">${doc.description}</div>` : ''}
                            </div>
                            <div class="document-actions">
                                <button class="btn btn-outline btn-sm" onclick="viewDocument('${doc.id}', '${doc.fileName}')">
                                    <img src="assets/icons/eye.svg" class="icon icon-sm" alt="View"> View
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="downloadDocument('${doc.id}', '${doc.fileName}')">
                                    <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download"> Download
                                </button>
                            </div>
                        </div>
                    `).join('')
                }
                
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn btn-outline" onclick="hideDocumentDownloadModal()">Close</button>
                </div>
            `;
            
            document.getElementById('documentDownloadModal').classList.remove('hidden');
        }
        
        function hideDocumentDownloadModal() {
            document.getElementById('documentDownloadModal').classList.add('hidden');
        }
        
        // View document function
        function viewDocument(docId, fileName) {
            if (!currentClientId) {
                alert('Client session not found. Please refresh and try again.');
                return;
            }
            
            try {
                // Get the document data from storage
                const documents = cleartrackData.getUserDocuments(currentClientId);
                
                if (!documents || documents.length === 0) {
                    alert('No documents found for this client.');
                    return;
                }
                
                // Find the document by ID first, then by filename as fallback
                let docData = documents.find(doc => doc.id === docId);
                
                if (!docData) {
                    docData = documents.find(doc => doc.fileName === fileName);
                }
                
                if (!docData) {
                    alert('Document not found. The document may have been removed.');
                    return;
                }
                
                if (!docData.fileContent) {
                    alert('File content is missing. The document may be corrupted.');
                    return;
                }
                
                // Store current document for download from viewer
                window.currentViewingDocument = { docId, fileName, docData };
                
                // Determine file type and display accordingly
                const fileExtension = fileName.split('.').pop().toLowerCase();
                let viewerContent = '';
                
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                    // Image files
                    viewerContent = `
                        <div style="text-align: center;">
                            <img src="${docData.fileContent}" alt="${fileName}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </div>
                    `;
                } else if (fileExtension === 'pdf') {
                    // PDF files
                    viewerContent = `
                        <div style="text-align: center; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                            <iframe src="${docData.fileContent}" width="100%" height="600px" style="border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;"></iframe>
                        </div>
                    `;
                } else if (['txt', 'csv'].includes(fileExtension)) {
                    // Text files - try to display as text
                    try {
                        const textContent = atob(docData.fileContent.split(',')[1]);
                        viewerContent = `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 60vh; overflow-y: auto; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                ${textContent}
                            </div>
                        `;
                    } catch (e) {
                        viewerContent = `
                            <div style="text-align: center; padding: 2rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                <div class="no-client-icon">
                                    <img src="assets/icons/document.svg" class="icon icon-2xl icon-gray-500" alt="Document">
                                </div>
                                <p style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">This file type cannot be previewed in the browser.</p>
                                <p class="text-gray-500 text-sm" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">Please download the file to view it.</p>
                            </div>
                        `;
                    }
                } else {
                    // Other file types - show download option
                    viewerContent = `
                        <div style="text-align: center; padding: 2rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                            <div class="no-client-icon">
                                <img src="assets/icons/document.svg" class="icon icon-2xl icon-gray-500" alt="Document">
                            </div>
                            <h3 class="mb-4" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">${fileName}</h3>
                            <p style="color: #6b7280; margin-bottom: 1.5rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">This file type cannot be previewed in the browser.</p>
                            <p class="text-gray-500 text-sm" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">Please download the file to view it.</p>
                        </div>
                    `;
                }
                
                // Update modal content
                document.getElementById('documentViewerTitle').textContent = `Viewing: ${fileName}`;
                document.getElementById('documentViewerContent').innerHTML = viewerContent;
                
                // Show the modal
                document.getElementById('documentViewerModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error viewing document:', error);
                alert('An error occurred while loading the document. Please try again.');
            }
        }
        
        // Download from viewer
        function downloadFromViewer() {
            if (window.currentViewingDocument) {
                const { docId, fileName, docData, isExpenseDocument } = window.currentViewingDocument;
                
                if (isExpenseDocument) {
                    // Handle expense document download
                    if (!docData || !docData.fileContent) {
                        alert('File content is missing. Cannot download document.');
                        return;
                    }
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = docData.fileContent;
                    link.download = fileName || 'expense_document';
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    // Handle regular document download
                    downloadDocument(docId, fileName);
                }
            }
        }
        
        // Hide document viewer modal
        function hideDocumentViewerModal() {
            document.getElementById('documentViewerModal').classList.add('hidden');
            window.currentViewingDocument = null;
        }
        
        // View expense document function
        function viewExpenseDocument(clientId, expenseId) {
            try {
                // Get the expense from the client's expenses
                const expenses = cleartrackData.getUserExpenses(clientId);
                
                if (!expenses || expenses.length === 0) {
                    alert('No expenses found for this client.');
                    return;
                }
                
                // Find the expense by ID
                const expense = expenses.find(e => e.id === expenseId || String(e.id) === String(expenseId));
                
                if (!expense) {
                    alert('Expense not found.');
                    return;
                }
                
                if (!expense.document) {
                    alert('No document attached to this expense.');
                    return;
                }
                
                if (!expense.document.fileContent) {
                    alert('File content is missing. The document may be corrupted.');
                    return;
                }
                
                const docData = expense.document;
                const fileName = docData.fileName || 'expense_document';
                
                // Store current document for download from viewer
                window.currentViewingDocument = { 
                    docId: expenseId, 
                    fileName: fileName, 
                    docData: docData,
                    isExpenseDocument: true,
                    expenseId: expenseId,
                    clientId: clientId
                };
                
                // Determine file type and display accordingly
                const fileExtension = fileName.split('.').pop().toLowerCase();
                let viewerContent = '';
                
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                    // Image files
                    viewerContent = `
                        <div style="text-align: center;">
                            <img src="${docData.fileContent}" alt="${fileName}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </div>
                    `;
                } else if (fileExtension === 'pdf') {
                    // PDF files
                    viewerContent = `
                        <div style="text-align: center; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                            <iframe src="${docData.fileContent}" width="100%" height="600px" style="border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;"></iframe>
                        </div>
                    `;
                } else if (['txt', 'csv'].includes(fileExtension)) {
                    // Text files - try to display as text
                    try {
                        const textContent = atob(docData.fileContent.split(',')[1]);
                        viewerContent = `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 60vh; overflow-y: auto; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                ${textContent}
                            </div>
                        `;
                    } catch (e) {
                        viewerContent = `
                            <div style="text-align: center; padding: 2rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                <div class="no-client-icon">
                                    <img src="assets/icons/document.svg" class="icon icon-2xl icon-gray-500" alt="Document">
                                </div>
                                <p style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">This file type cannot be previewed in the browser.</p>
                                <p class="text-gray-500 text-sm" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">Please download the file to view it.</p>
                            </div>
                        `;
                    }
                } else {
                    // Other file types - show download option
                    viewerContent = `
                        <div style="text-align: center; padding: 2rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                            <div class="no-client-icon">
                                <img src="assets/icons/document.svg" class="icon icon-2xl icon-gray-500" alt="Document">
                            </div>
                            <h3 class="mb-4" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">${fileName}</h3>
                            <p style="color: #6b7280; margin-bottom: 1.5rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">This file type cannot be previewed in the browser.</p>
                            <p class="text-gray-500 text-sm" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">Please download the file to view it.</p>
                        </div>
                    `;
                }
                
                // Update modal content
                document.getElementById('documentViewerTitle').textContent = `Viewing: ${fileName}`;
                document.getElementById('documentViewerContent').innerHTML = viewerContent;
                
                // Show the modal
                document.getElementById('documentViewerModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error viewing expense document:', error);
                alert('An error occurred while loading the document. Please try again.');
            }
        }
        
        // Dashboard Tile Modal Functions
        function showClientsModal() {
            const allClients = cleartrackData.getConnectedUsers(practitioner.id);
            const content = document.getElementById('allClientsContent');
            
            if (allClients.length === 0) {
                content.innerHTML = '<p class="no-client-selected">No clients connected yet</p>';
            } else {
                content.innerHTML = `
                    <div class="mb-4">
                        <h4 style="color: #374151; margin-bottom: 0.5rem;">All Connected Clients (${allClients.length})</h4>
                        <p class="text-gray-500 text-sm">Overview of all your connected clients</p>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${allClients.map(client => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #6b7280;">
                                        ${client.firstName.charAt(0)}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #374151;">${client.firstName} ${client.lastName}</div>
                                        <div class="text-sm text-gray-500">${client.email}</div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-outline btn-sm" onclick="viewClientDetails('${client.id}'); hideAllClientsModal();">View Details</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('allClientsModal').classList.remove('hidden');
        }
        
        function hideAllClientsModal() {
            document.getElementById('allClientsModal').classList.add('hidden');
        }
        
        function showActiveClientsModal() {
            const allClients = cleartrackData.getConnectedUsers(practitioner.id);
            const activeClients = allClients.filter(client => 
                (client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0
            );
            const content = document.getElementById('activeClientsContent');
            
            if (activeClients.length === 0) {
                content.innerHTML = '<p class="no-client-selected">No active clients found</p>';
            } else {
                content.innerHTML = `
                    <div class="mb-4">
                        <h4 style="color: #374151; margin-bottom: 0.5rem;">Active Clients (${activeClients.length})</h4>
                        <p class="text-gray-500 text-sm">Clients with documents or expenses</p>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${activeClients.map(client => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #f0f9ff; border-left: 4px solid #059669;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #6b7280;">
                                        ${client.firstName.charAt(0)}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #374151;">${client.firstName} ${client.lastName}</div>
                                        <div class="text-sm text-gray-500">${client.email}</div>
                                        <div style="font-size: 0.75rem; color: #059669; margin-top: 0.25rem;">
                                            <img src="assets/icons/document.svg" class="icon icon-sm icon-gray-500" alt="Documents"> ${client.documentCount || 0} Documents  <img src="assets/icons/money.svg" class="icon icon-sm icon-gray-500" alt="Expenses"> ${client.expenseCount || 0} Expenses
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-outline btn-sm" onclick="viewClientDetails('${client.id}'); hideActiveClientsModal();">View Details</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('activeClientsModal').classList.remove('hidden');
        }
        
        function hideActiveClientsModal() {
            document.getElementById('activeClientsModal').classList.add('hidden');
        }
        
        function showPendingReturnsModal() {
            const pendingReturns = cleartrackData.getTaxReturnsForPractitioner(practitioner.id).filter(return_ => 
                return_.status === 'pending' || return_.status === 'in_progress'
            );
            const content = document.getElementById('pendingReturnsContent');
            
            if (pendingReturns.length === 0) {
                content.innerHTML = '<p class="no-client-selected">No pending tax returns</p>';
            } else {
                content.innerHTML = `
                    <div class="mb-4">
                        <h4 style="color: #374151; margin-bottom: 0.5rem;">Pending Tax Returns (${pendingReturns.length})</h4>
                        <p class="text-gray-500 text-sm">Tax returns that need attention</p>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${pendingReturns.map(return_ => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #fef3c7; border-left: 4px solid #d97706;">
                                <div>
                                    <div style="font-weight: 600; color: #374151;">Tax Year ${return_.taxYear}</div>
                                    <div class="text-sm text-gray-500">Client: ${return_.clientName || 'Unknown'}</div>
                                    <div style="font-size: 0.75rem; color: #d97706; margin-top: 0.25rem;">
                                        Status: ${return_.status.replace('_', ' ').toUpperCase()}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-outline btn-sm" onclick="viewInvoiceFromTaxReturn('${return_.id}'); hidePendingReturnsModal();">View Details</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('pendingReturnsModal').classList.remove('hidden');
        }
        
        function hidePendingReturnsModal() {
            document.getElementById('pendingReturnsModal').classList.add('hidden');
        }
        
        function showCompletedReturnsModal() {
            const completedReturns = cleartrackData.getTaxReturnsForPractitioner(practitioner.id).filter(return_ => 
                return_.status === 'completed'
            );
            const content = document.getElementById('completedReturnsContent');
            
            if (completedReturns.length === 0) {
                content.innerHTML = '<p class="no-client-selected">No completed tax returns</p>';
            } else {
                content.innerHTML = `
                    <div class="mb-4">
                        <h4 style="color: #374151; margin-bottom: 0.5rem;">Completed Tax Returns (${completedReturns.length})</h4>
                        <p class="text-gray-500 text-sm">Successfully completed tax returns</p>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${completedReturns.map(return_ => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #fef2f2; border-left: 4px solid #dc2626;">
                                <div>
                                    <div style="font-weight: 600; color: #374151;">Tax Year ${return_.taxYear}</div>
                                    <div class="text-sm text-gray-500">Client: ${return_.clientName || 'Unknown'}</div>
                                    <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                                        <img src="assets/icons/check.svg" class="icon icon-sm icon-green-600" alt="Completed"> Completed on ${new Date(return_.completedAt || return_.createdAt).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-outline btn-sm" onclick="viewInvoiceFromTaxReturn('${return_.id}'); hideCompletedReturnsModal();">View Details</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('completedReturnsModal').classList.remove('hidden');
        }
        
        function hideCompletedReturnsModal() {
            document.getElementById('completedReturnsModal').classList.add('hidden');
        }
        
        // Mark tax return as completed
        function markTaxReturnCompleted(returnId) {
            if (!returnId) {
                alert('Invalid tax return ID. Please try again.');
                return;
            }
            
            // Find the tax return
            const taxReturn = taxReturns.find(r => r.id === returnId);
            if (!taxReturn) {
                alert('Tax return not found. Please refresh and try again.');
                return;
            }
            
            // Confirm the action
            const clientName = taxReturn.clientName || 'Unknown Client';
            const taxYear = taxReturn.taxYear || new Date().getFullYear();
            
            if (!confirm(`Are you sure you want to mark the tax return for ${clientName} (${taxYear}) as completed?`)) {
                return;
            }
            
            try {
                // Update the tax return status
                const success = cleartrackData.updateTaxReturnStatus(returnId, 'completed');
                
                if (success) {
                    // Update local data
                    taxReturn.status = 'completed';
                    taxReturn.completedAt = new Date().toISOString();
                    
                    // Refresh the tax returns display
                    loadTaxReturns();
                    updateDashboard();
                    
                    // Show success message
                    alert(`Tax return for ${clientName} (${taxYear}) has been marked as completed!`);
                } else {
                    alert('Failed to update tax return status. Please try again.');
                }
            } catch (error) {
                console.error('Error marking tax return as completed:', error);
                alert('An error occurred while updating the tax return. Please try again.');
            }
        }
        
        // Generate invoice for completed tax return
        function generateInvoice(returnId) {
            if (!returnId) {
                alert('Invalid tax return ID. Please try again.');
                return;
            }
            
            if (!practitioner) {
                alert('Practitioner not found. Please log in again.');
                return;
            }
            
            // Find the tax return
            const taxReturn = taxReturns.find(r => r.id === returnId);
            if (!taxReturn) {
                alert('Tax return not found. Please refresh and try again.');
                return;
            }
            
            // Validate user-practitioner connection for this tax return
            if (!cleartrackData.isUserConnectedToPractitioner(taxReturn.userId, practitioner.id)) {
                alert('This tax return is not associated with your practice. Please ensure the client is properly connected.');
                return;
            }
            
            // Check if already invoiced and ask for confirmation
            if (taxReturn.invoiceGenerated) {
                if (!confirm('An invoice has already been generated for this tax return. Do you want to generate an additional invoice for additional charges?')) {
                    return;
                }
            }
            
            // Get client details for invoice
            const client = clients.find(c => c.id === taxReturn.userId);
            if (!client) {
                alert('Client details not found. Please refresh and try again.');
                return;
            }
            
            // Show invoice modal first
            const invoiceModal = document.getElementById('newInvoiceModal');
            if (!invoiceModal) {
                alert('Invoice generation form not found. Please refresh the page and try again.');
                return;
            }
            
            // Store return ID and user ID for later reference
            invoiceModal.dataset.returnId = returnId;
            invoiceModal.dataset.userId = taxReturn.userId;
            
            // Show the modal
            invoiceModal.classList.remove('hidden');
            
            // Wait for modal to be visible, then populate form
            setTimeout(() => {
                // Populate client select dropdown first
                const clientSelect = document.getElementById('newInvoiceClientSelect');
                if (clientSelect) {
                    // Clear existing options
                    clientSelect.innerHTML = '<option value="">Choose a client...</option>';
                    // Add the client for this tax return
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.firstName} ${client.lastName}`;
                    option.selected = true;
                    clientSelect.appendChild(option);
                    
                    // Show selected client info
                    const selectedClientInfo = document.getElementById('selectedClientInfo');
                    const selectedClientName = document.getElementById('selectedClientName');
                    const selectedClientEmail = document.getElementById('selectedClientEmail');
                    if (selectedClientInfo && selectedClientName && selectedClientEmail) {
                        selectedClientName.textContent = `${client.firstName} ${client.lastName}`;
                        selectedClientEmail.textContent = client.email || '';
                        selectedClientInfo.classList.remove('hidden');
                    }
                }
                
                // Populate invoice form with real user data
                const taxYearField = document.getElementById('newInvoiceTaxYear');
                const invoiceNumberField = document.getElementById('newInvoiceNumber');
                const invoiceDateField = document.getElementById('newInvoiceDate');
                const descriptionField = document.getElementById('newInvoiceDescription');
                const amountField = document.getElementById('newInvoiceAmount');
                const dueDateField = document.getElementById('newInvoiceDueDate');
                const notesField = document.getElementById('newInvoiceNotes');
                
                if (taxYearField) {
                    // Set tax year - format as "2025/2026"
                    const currentYear = taxReturn.taxYear || new Date().getFullYear();
                    const nextYear = currentYear + 1;
                    taxYearField.value = `${currentYear}/${nextYear}`;
                }
                if (invoiceNumberField) invoiceNumberField.value = generateInvoiceNumber();
                if (invoiceDateField) invoiceDateField.value = new Date().toISOString().split('T')[0];
                if (descriptionField) descriptionField.value = `Tax return preparation and filing services for ${taxReturn.taxYear || new Date().getFullYear()}`;
                if (amountField) amountField.value = '';
                if (dueDateField) dueDateField.value = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                if (notesField) {
                    // Use saved default notes if available, otherwise use default message
                    const defaultNotes = practitioner && practitioner.invoiceMessages ? 
                        practitioner.invoiceMessages.defaultNotes : 
                        'Payment due within 30 days. Thank you for your business.';
                    notesField.value = defaultNotes;
                }
                
                // Trigger VAT calculation if amount field exists
                if (amountField) {
                    amountField.dispatchEvent(new Event('input'));
                }
            }, 100);
        }
        
        // Generate unique invoice number
        function generateInvoiceNumber() {
            const year = new Date().getFullYear();
            const timestamp = Date.now().toString().slice(-6);
            const randomSuffix = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const invoiceNumber = `INV-${year}-${timestamp}${randomSuffix}`;
            
            // Check if invoice number already exists
            const existingInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const isDuplicate = existingInvoices.some(inv => inv.invoiceNumber === invoiceNumber);
            
            if (isDuplicate) {
                // Generate a new number if duplicate
                return generateInvoiceNumber();
            }
            
            return invoiceNumber;
        }
        
        // Hide invoice generation modal
        function hideInvoiceGenerationModal() {
            document.getElementById('invoiceModal').classList.add('hidden');
        }
        
        // Hide invoice preview modal
        function hideInvoicePreviewModal() {
            const modal = document.getElementById('invoicePreviewModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.zIndex = '-1';
                window.viewingInvoice = false;
            }
        }
        
        
        // Handle modal overlay click
        function handleInvoiceModalClick(event) {
            // Only close if clicking the overlay itself, not the modal content
            if (event.target.id === 'invoicePreviewModal') {
                hideInvoicePreviewModal();
            }
        }
        
        // Hide invoice preview modal
        
        // Send invoice via chat
        function sendInvoiceViaChat() {
            if (!window.currentInvoice) {
                alert('No invoice available to send.');
                return;
            }
            
            const invoice = window.currentInvoice;
            const message = ` **Invoice ${invoice.invoiceNumber}**\n\n` +
                          `**Client:** ${invoice.clientName}\n` +
                          `**Amount:** R ${invoice.total.toFixed(2)}\n` +
                          `**Due Date:** ${new Date(invoice.dueDate).toLocaleDateString()}\n\n` +
                          `Please find your invoice attached. Payment details are included in the document.`;
            
            // Get connected users from data storage
            const connectedUsers = cleartrackData.getConnectedUsers(practitioner.id);
            
            // Find the client in the connected users - try different name formats
            let client = connectedUsers.find(c => c.name === invoice.clientName);
            if (!client) {
                // Try with first name only
                const firstName = invoice.clientName.split(' ')[0];
                client = connectedUsers.find(c => c.name === firstName || c.firstName === firstName);
            }
            if (!client) {
                // Try with last name only
                const lastName = invoice.clientName.split(' ').pop();
                client = connectedUsers.find(c => c.name === lastName || c.lastName === lastName);
            }
            if (!client) {
                // Try case-insensitive match
                client = connectedUsers.find(c => 
                    c.name.toLowerCase() === invoice.clientName.toLowerCase() ||
                    (c.firstName && c.lastName && 
                     `${c.firstName} ${c.lastName}`.toLowerCase() === invoice.clientName.toLowerCase())
                );
            }
            if (!client) {
                // Try partial name matching (first name + last name)
                const nameParts = invoice.clientName.toLowerCase().split(' ');
                if (nameParts.length >= 2) {
                    const firstName = nameParts[0];
                    const lastName = nameParts[nameParts.length - 1];
                    client = connectedUsers.find(c => 
                        c.firstName && c.lastName &&
                        c.firstName.toLowerCase() === firstName &&
                        c.lastName.toLowerCase() === lastName
                    );
                }
            }
            
            if (!client) {
                alert(`Client "${invoice.clientName}" not found in your connected users. Please ensure the client is properly connected.`);
                return;
            }
            
            // Get the proper client name for display
            const clientDisplayName = client.name || `${client.firstName || ''} ${client.lastName || ''}`.trim() || invoice.clientName;
            
            // Send message to client
            const messageData = {
                sender: 'practitioner',
                senderName: `${practitioner.firstName} ${practitioner.lastName}`,
                receiverName: clientDisplayName,
                text: message,
                type: 'invoice',
                invoiceData: invoice
            };
            
            // Save message with correct parameters - CORRECTED PARAMETER ORDER
            cleartrackData.addMessage(client.id, practitioner.id, messageData);
            
            // Close preview modal
            hideInvoicePreviewModal();
            
            // Show success message with proper client name
            alert(`Invoice sent to ${clientDisplayName} via chat!`);
            
            // Navigate to messages if needed
            showSection('messages');
        }
        
        // Send invoice via email
        function sendInvoiceViaEmail() {
            if (!window.currentInvoice) {
                alert('No invoice available to send.');
                return;
            }
            
            const invoice = window.currentInvoice;
            
            // Get connected users from data storage
            const connectedUsers = cleartrackData.getConnectedUsers(practitioner.id);
            
            // Find the client in the connected users - try different name formats
            let client = connectedUsers.find(c => c.name === invoice.clientName);
            if (!client) {
                // Try with first name only
                const firstName = invoice.clientName.split(' ')[0];
                client = connectedUsers.find(c => c.name === firstName || c.firstName === firstName);
            }
            if (!client) {
                // Try with last name only
                const lastName = invoice.clientName.split(' ').pop();
                client = connectedUsers.find(c => c.name === lastName || c.lastName === lastName);
            }
            if (!client) {
                // Try case-insensitive match
                client = connectedUsers.find(c => 
                    c.name.toLowerCase() === invoice.clientName.toLowerCase() ||
                    (c.firstName && c.lastName && 
                     `${c.firstName} ${c.lastName}`.toLowerCase() === invoice.clientName.toLowerCase())
                );
            }
            
            if (!client || !client.email) {
                alert('Client email not found. Please ensure the client is properly connected and has an email address.');
                return;
            }
            
            // Create email content
            const subject = `Invoice ${invoice.invoiceNumber} - ClearTrack Tax Services`;
            const body = `Dear ${invoice.clientName},\n\n` +
                        `Please find attached your invoice for tax return services.\n\n` +
                        `Invoice Details:\n` +
                        `- Invoice Number: ${invoice.invoiceNumber}\n` +
                        `- Amount: R ${invoice.total.toFixed(2)}\n` +
                        `- Due Date: ${new Date(invoice.dueDate).toLocaleDateString()}\n\n` +
                        `Payment details are included in the attached invoice.\n\n` +
                        `Thank you for your business!\n\n` +
                        `Best regards,\n` +
                        `${practitioner.firstName} ${practitioner.lastName}`;
            
            // Create mailto link
            const mailtoLink = `mailto:${client.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            // Get the proper client name for display
            const clientDisplayName = client.name || `${client.firstName || ''} ${client.lastName || ''}`.trim() || invoice.clientName;
            
            alert(`Email client opened for ${clientDisplayName}. The invoice PDF will need to be attached manually.`);
        }
        
        // Download current invoice PDF
        function downloadCurrentInvoicePDF() {
            if (!window.currentInvoice) {
                alert('No invoice available to download.');
                return;
            }
            
            // Use the existing PDF generation function
            createInvoicePDFFile(window.currentInvoice);
        }
        
        
        
        // Update invoice action buttons based on invoice status
        function updateInvoiceActionButtons(invoice) {
            const actionButtons = document.getElementById('invoiceActionButtons');
            if (!actionButtons) return;
            
            const isPreview = invoice.status === 'preview';
            
            if (isPreview) {
                // Preview invoice actions
                actionButtons.innerHTML = `
                    <button class="btn btn-primary" onclick="generateInvoiceFromPreview('${invoice.taxYear}')" style="display: flex; align-items: center; gap: 8px; background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
                        <img src="assets/icons/money.svg" class="icon icon-sm" alt="Generate"> Generate Invoice
                    </button>
                    <button class="btn btn-outline" onclick="hideInvoicePreviewModal()" style="display: flex; align-items: center; gap: 8px; background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
                        <img src="assets/icons/trash.svg" class="icon icon-sm" alt="Close"> Close Preview
                    </button>
                `;
            } else {
                // Real invoice actions
                actionButtons.innerHTML = `
                    <button class="btn btn-primary" onclick="sendInvoiceViaChat()" style="display: flex; align-items: center; gap: 8px; background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
                        <img src="assets/icons/message.svg" class="icon icon-sm" alt="Chat"> Send via Chat
                    </button>
                    <button class="btn btn-success" onclick="sendInvoiceViaEmail()" style="display: flex; align-items: center; gap: 8px; background: #10b981; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
                        <img src="assets/icons/email.svg" class="icon icon-sm" alt="Email"> Send via Email
                    </button>
                    <button class="btn btn-outline" onclick="downloadCurrentInvoicePDF()" style="display: flex; align-items: center; gap: 8px; background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
                        <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download"> Download PDF
                    </button>
                    <button class="btn btn-secondary" onclick="printInvoice()" style="display: flex; align-items: center; gap: 8px; background: #6b7280; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
                        <img src="assets/icons/document.svg" class="icon icon-sm" alt="Print"> Print Invoice
                    </button>
                `;
            }
        }
        
        // Generate invoice from preview
        function generateInvoiceFromPreview(taxYear) {
            // Find the tax return for this tax year
            const taxReturn = taxReturns.find(tr => tr.taxYear === taxYear && tr.status === 'completed');
            if (taxReturn) {
                // Close the preview modal
                hideInvoicePreviewModal();
                // Open the invoice generation modal
                generateInvoice(taxReturn.id);
            } else {
                alert('No completed tax return found for this tax year.');
            }
        }
        
        // Download invoice PDF by ID
        function downloadInvoicePDF(invoiceId) {
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const invoice = allInvoices.find(inv => inv.id === invoiceId);
            
            if (!invoice) {
                alert('Invoice not found.');
                return;
            }
            
            // Use the existing PDF generation function
            createInvoicePDFFile(invoice);
        }
        
        // Send invoice via chat by ID
        function sendInvoiceViaChatById(invoiceId) {
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const invoice = allInvoices.find(inv => inv.id === invoiceId);
            
            if (!invoice) {
                alert('Invoice not found.');
                return;
            }
            
            // Store invoice for chat function
            window.currentInvoice = invoice;
            
            // Use existing chat function
            sendInvoiceViaChat();
        }
        
        // Send invoice via email by ID
        function sendInvoiceViaEmailById(invoiceId) {
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const invoice = allInvoices.find(inv => inv.id === invoiceId);
            
            if (!invoice) {
                alert('Invoice not found.');
                return;
            }
            
            // Store invoice for email function
            window.currentInvoice = invoice;
            
            // Use existing email function
            sendInvoiceViaEmail();
        }
        
        // Mark invoice as paid
        function markInvoicePaid(invoiceId) {
            if (!confirm('Are you sure you want to mark this invoice as paid?')) {
                return;
            }
            
            try {
                // Update invoice status in data storage
                const data = cleartrackData.getData();
                if (data.invoices && data.invoices[invoiceId]) {
                    data.invoices[invoiceId].status = 'paid';
                    data.invoices[invoiceId].paidAt = new Date().toISOString();
                    cleartrackData.setData(data);
                    
                    // Close preview modal if open
                    if (typeof hideInvoicePreviewModal === 'function') {
                        hideInvoicePreviewModal();
                    }
                    
                    // Refresh invoice display
                    if (typeof loadInvoices === 'function') {
                        loadInvoices();
                    }
                    
                    alert('Invoice marked as paid successfully!');
                } else {
                    alert('Invoice not found. This may be a preview invoice. Please generate the invoice first.');
                }
            } catch (error) {
                console.error('Error marking invoice as paid:', error);
                alert('An error occurred while updating the invoice status.');
            }
        }
        
        // Delete invoice
        function deleteInvoice(invoiceId) {
            if (!invoiceId) {
                alert('Invalid invoice ID. Please try again.');
                return;
            }
            
            // Find the invoice to show details in confirmation
            let invoice = null;
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            invoice = allInvoices.find(inv => inv.id === invoiceId);
            
            // If not found in storage, check current invoice in modal (for error message)
            if (!invoice && window.currentInvoice && window.currentInvoice.id === invoiceId) {
                invoice = window.currentInvoice;
            }
            
            if (!invoice) {
                alert('Invoice not found. This may be a preview invoice.');
                return;
            }
            
            // Check if it's a preview invoice
            if (invoice.status === 'preview' || invoiceId.startsWith('preview_')) {
                alert('Cannot delete preview invoices. Please generate the invoice first.');
                return;
            }
            
            // Confirm deletion
            const confirmMessage = `Are you sure you want to delete invoice ${invoice.invoiceNumber}?\n\nClient: ${invoice.clientName}\nAmount: R ${invoice.total.toFixed(2)}\n\nThis action cannot be undone.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // Delete invoice from data storage
                const data = cleartrackData.getData();
                if (data.invoices && data.invoices[invoiceId]) {
                    delete data.invoices[invoiceId];
                    
                    // Clear invoiceGenerated flag on matching tax returns
                    if (data.taxReturns) {
                        for (let taxReturnId in data.taxReturns) {
                            const taxReturn = data.taxReturns[taxReturnId];
                            // Match by clientId/userId and tax year, or by client name and tax year
                            const matchesByClientId = invoice.clientId && taxReturn.userId && 
                                                     invoice.clientId === taxReturn.userId &&
                                                     taxReturn.taxYear === invoice.taxYear;
                            const matchesByClientName = invoice.clientName && taxReturn.clientName &&
                                                       invoice.clientName === taxReturn.clientName &&
                                                       taxReturn.taxYear === invoice.taxYear;
                            
                            if (taxReturn.practitionerId === practitioner.id && 
                                (matchesByClientId || matchesByClientName)) {
                                // Clear the invoiceGenerated flag
                                data.taxReturns[taxReturnId].invoiceGenerated = false;
                                console.log(`Cleared invoiceGenerated flag for tax return ${taxReturnId}`);
                            }
                        }
                    }
                    
                    cleartrackData.setData(data);
                    
                    // Close preview modal if open
                    if (typeof hideInvoicePreviewModal === 'function') {
                        hideInvoicePreviewModal();
                    }
                    
                    // Refresh invoice display
                    if (typeof loadInvoices === 'function') {
                        loadInvoices();
                    }
                    
                    // Refresh tax returns display to update "Invoiced" status
                    if (typeof loadTaxReturns === 'function') {
                        loadTaxReturns();
                    }
                    
                    alert('Invoice deleted successfully!');
                } else {
                    alert('Invoice not found in storage. This may be a preview invoice.');
                }
            } catch (error) {
                console.error('Error deleting invoice:', error);
                alert('An error occurred while deleting the invoice. Please try again.');
            }
        }
        
        // View invoice from chat (opens in modal/overlay)
        function viewInvoiceFromChat(invoiceId) {
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const invoice = allInvoices.find(inv => String(inv.id) === String(invoiceId));
            
            if (!invoice) {
                alert('Invoice not found.');
                return;
            }
            
            // Use the same invoice preview function as practitioner generates
            openInvoicePreview(invoice);
        }
        
        // Download invoice from chat
        function downloadInvoiceFromChat(invoiceId) {
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const invoice = allInvoices.find(inv => String(inv.id) === String(invoiceId));
            
            if (!invoice) {
                alert('Invoice not found.');
                return;
            }
            
            // Create a proper PDF download
            downloadInvoiceAsPDF(invoice);
        }
        
        
        // Download invoice as PDF file
        function downloadInvoiceAsPDF(invoice) {
            try {
                // Get practitioner details
                const practitionerName = practitioner ? `${practitioner.firstName} ${practitioner.lastName}` : 'Practitioner';
                const practitionerEmail = practitioner ? practitioner.email : '';
                const practitionerPhone = practitioner ? practitioner.phone : '';
                
                // Ensure bank details exist
                const bankDetails = invoice.bankDetails || {
                    bankName: '',
                    bankBranch: '',
                    accountNumber: '',
                    accountType: 'business',
                    bankReference: ''
                };
                
                // Create HTML content for PDF
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Invoice ${invoice.invoiceNumber}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: white; }
                            .invoice-container { max-width: 800px; margin: 0 auto; background: white; }
                            .invoice-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid #0b7285; padding-bottom: 20px; }
                            .invoice-header-left { flex-shrink: 0; }
                            .invoice-header-right { flex: 1; text-align: right; }
                            .invoice-title { color: #0b7285; font-size: 28px; margin: 0 0 5px 0; font-weight: bold; }
                            .invoice-subtitle { color: #6b7280; font-size: 16px; margin: 0; }
                            .invoice-details { display: flex; justify-content: space-between; margin-bottom: 30px; }
                            .invoice-info, .client-info { flex: 1; }
                            .info-section h3 { color: #374151; font-size: 14px; margin: 0 0 10px 0; font-weight: 600; }
                            .info-section p { margin: 5px 0; color: #6b7280; font-size: 14px; }
                            .invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                            .invoice-table th, .invoice-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; word-wrap: break-word; word-break: break-word; white-space: normal; overflow-wrap: break-word; }
                            .invoice-table th { background: #f9fafb; font-weight: 600; color: #374151; }
                            .invoice-table .amount { text-align: right; }
                            .invoice-totals { margin-left: auto; width: 300px; }
                            .total-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
                            .total-row:last-child { border-bottom: 2px solid #0b7285; font-weight: bold; font-size: 16px; }
                            .bank-details { margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px; }
                            .bank-details h3 { color: #374151; margin: 0 0 15px 0; font-size: 16px; }
                            .bank-details p { margin: 5px 0; color: #6b7280; font-size: 14px; }
                            .notes { margin-top: 30px; padding: 20px; background: #f0f9ff; border-left: 4px solid #0b7285; }
                            .notes h3 { color: #374151; margin: 0 0 10px 0; font-size: 16px; }
                            .notes p { margin: 0; color: #6b7280; font-size: 14px; line-height: 1.5; }
                        </style>
                    </head>
                    <body>
                        <div class="invoice-container">
                            <div class="invoice-header">
                                <h1 class="invoice-title">INVOICE</h1>
                                <p class="invoice-subtitle">ClearTrack Tax Services</p>
                            </div>
                            
                            <div class="invoice-details">
                                <div class="invoice-info">
                                    <div class="info-section">
                                        <h3>From:</h3>
                                        <p><strong>${practitionerName}</strong></p>
                                        <p>${practitionerEmail}</p>
                                        <p>${practitionerPhone}</p>
                                    </div>
                                </div>
                                <div class="client-info">
                                    <div class="info-section">
                                        <h3>Invoice Details:</h3>
                                        <p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
                                        <p><strong>Date:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString()}</p>
                                        <p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>
                                    </div>
                                    <div class="info-section" style="margin-top: 20px;">
                                        <h3>Bill To:</h3>
                                        <p><strong>${invoice.clientName}</strong></p>
                                        <p>Tax Year: ${invoice.taxYear}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <table class="invoice-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th class="amount">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>${invoice.description}</td>
                                        <td class="amount">R ${invoice.amount.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="invoice-totals">
                                <div class="total-row">
                                    <span>Subtotal:</span>
                                    <span>R ${invoice.amount.toFixed(2)}</span>
                                </div>
                                <div class="total-row">
                                    <span>${getVATLabel(invoice.vatType)}:</span>
                                    <span>R ${invoice.vat.toFixed(2)}</span>
                                </div>
                                <div class="total-row">
                                    <span>Total:</span>
                                    <span>R ${invoice.total.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            ${bankDetails.bankName ? `
                                <div class="bank-details">
                                    <h3>Payment Details</h3>
                                    <p><strong>Bank:</strong> ${bankDetails.bankName}</p>
                                    <p><strong>Branch Code:</strong> ${bankDetails.bankBranch}</p>
                                    <p><strong>Account Number:</strong> ${bankDetails.accountNumber}</p>
                                    <p><strong>Account Type:</strong> ${bankDetails.accountType === 'business' ? 'Business Account' : 'Personal Account'}</p>
                                    <p><strong>Reference:</strong> ${bankDetails.bankReference || invoice.invoiceNumber}</p>
                                </div>
                            ` : ''}
                            
                            ${invoice.notes ? `
                                <div class="notes">
                                    <h3>Notes</h3>
                                    <p>${invoice.notes}</p>
                                </div>
                            ` : ''}
                        </div>
                    </body>
                    </html>
                `;
                
                // Open in new window for printing/downloading
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                // Add print styles for better PDF output
                const printStyles = `
                    <style>
                        @media print {
                            body { margin: 0; padding: 0; }
                            .invoice-container { max-width: none; margin: 0; }
                            .invoice-header { page-break-inside: avoid; }
                            .invoice-table { page-break-inside: avoid; }
                            .bank-details { page-break-inside: avoid; }
                            .notes { page-break-inside: avoid; }
                        }
                    </style>
                `;
                
                // Wait for content to load, then show instructions
                printWindow.onload = function() {
                    printWindow.document.head.innerHTML += printStyles;
                    printWindow.focus();
                    
                    // Show user-friendly message
                    const message = `
                        <div style="position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 10px 15px; border-radius: 6px; font-size: 14px; z-index: 9999;">
                            <img src="assets/icons/info.svg" class="icon icon-sm" alt="Info"> Tip: Use Ctrl+P (Cmd+P on Mac) to print or save as PDF
                        </div>
                    `;
                    printWindow.document.body.insertAdjacentHTML('afterbegin', message);
                    
                    // Auto-trigger print dialog after a short delay
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                };
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('An error occurred while generating the invoice PDF. Please try again.');
            }
        }
        
        // Print invoice
        function printInvoice() {
            if (!window.currentInvoice) {
                alert('No invoice available to print.');
                return;
            }
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Please allow pop-ups for this site to print the invoice.');
                return;
            }
            
            // Use unified invoice HTML generator
            const printHTML = generateUnifiedInvoiceHTML(window.currentInvoice);
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load, then trigger print dialog
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            };
        }
        
        
        // Setup invoice form event listeners
        function setupInvoiceForm() {
            const invoiceForm = document.getElementById('invoiceForm');
            const amountInput = document.getElementById('invoiceAmount');
            const vatInput = document.getElementById('invoiceVAT');
            const totalInput = document.getElementById('invoiceTotal');
            const vatTypeSelect = document.getElementById('invoiceVATType');
            const vatReasonInput = document.getElementById('invoiceVATReason');
            
            // VAT calculation on amount change
            if (amountInput) {
                amountInput.addEventListener('input', calculateVAT);
            }
            
            // VAT type change
            if (vatTypeSelect) {
                vatTypeSelect.addEventListener('change', function() {
                    calculateVAT();
                    toggleVATReason();
                });
            }
            
            // Form submission
            if (invoiceForm) {
                invoiceForm.addEventListener('submit', function(e) {
                    console.log(' Form submit event triggered!');
                    e.preventDefault();
                    handleInvoiceSubmission();
                });
            }
            
            // Load saved bank details
            loadBankDetails();
        }
        
        // Calculate VAT based on selected type
        function calculateVAT() {
            const amount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
            const vatType = document.getElementById('invoiceVATType').value;
            const vatInput = document.getElementById('invoiceVAT');
            const totalInput = document.getElementById('invoiceTotal');
            
            let vatRate = 0;
            let vat = 0;
            
            switch (vatType) {
                case 'standard':
                    vatRate = 0.15; // 15%
                    vat = amount * vatRate;
                    break;
                case 'exempt':
                    vatRate = 0; // 0%
                    vat = 0;
                    break;
                case 'zero':
                    vatRate = 0; // 0%
                    vat = 0;
                    break;
            }
            
            const total = amount + vat;
            
            vatInput.value = vat.toFixed(2);
            totalInput.value = total.toFixed(2);
        }
        
        // Toggle VAT exemption reason field
        function toggleVATReason() {
            const vatType = document.getElementById('invoiceVATType').value;
            const vatReasonInput = document.getElementById('invoiceVATReason');
            
            if (vatType === 'exempt') {
                vatReasonInput.style.display = 'block';
                vatReasonInput.required = true;
            } else {
                vatReasonInput.style.display = 'none';
                vatReasonInput.required = false;
                vatReasonInput.value = '';
            }
        }
        
        // Load saved bank details
        function loadBankDetails() {
            const bankDetails = cleartrackData.getPractitionerBankDetails();
            if (bankDetails) {
                const bankNameField = document.getElementById('bankName');
                const bankBranchField = document.getElementById('bankBranch');
                const accountNumberField = document.getElementById('accountNumber');
                const accountTypeField = document.getElementById('accountType');
                const bankReferenceField = document.getElementById('bankReference');
                
                if (bankNameField) bankNameField.value = bankDetails.bankName || '';
                if (bankBranchField) bankBranchField.value = bankDetails.bankBranch || '';
                if (accountNumberField) accountNumberField.value = bankDetails.accountNumber || '';
                if (accountTypeField) accountTypeField.value = bankDetails.accountType || 'business';
                if (bankReferenceField) bankReferenceField.value = bankDetails.bankReference || '';
            }
        }
        
        // Save bank details
        function saveBankDetails() {
            const bankNameField = document.getElementById('bankName');
            const bankBranchField = document.getElementById('bankBranch');
            const accountNumberField = document.getElementById('accountNumber');
            const accountTypeField = document.getElementById('accountType');
            const bankReferenceField = document.getElementById('bankReference');
            
            const bankDetails = {
                bankName: bankNameField ? bankNameField.value : '',
                bankBranch: bankBranchField ? bankBranchField.value : '',
                accountNumber: accountNumberField ? accountNumberField.value : '',
                accountType: accountTypeField ? accountTypeField.value : 'business',
                bankReference: bankReferenceField ? bankReferenceField.value : ''
            };
            
            cleartrackData.savePractitionerBankDetails(bankDetails);
        }
        
        // Function to save banking details from profile form
        function saveBankDetailsFromProfile() {
            const bankNameField = document.getElementById('profileBankName');
            const bankBranchField = document.getElementById('profileBankBranch');
            const accountNumberField = document.getElementById('profileAccountNumber');
            const accountTypeField = document.getElementById('profileAccountType');
            const bankReferenceField = document.getElementById('profileBankReference');
            
            const bankDetails = {
                bankName: bankNameField ? bankNameField.value : '',
                bankBranch: bankBranchField ? bankBranchField.value : '',
                accountNumber: accountNumberField ? accountNumberField.value : '',
                accountType: accountTypeField ? accountTypeField.value : 'business',
                bankReference: bankReferenceField ? bankReferenceField.value : ''
            };
            
            // Save to practitioner profile
            if (practitioner) {
                practitioner.bankDetails = bankDetails;
                cleartrackData.updatePractitioner(practitioner.id, practitioner);
                alert('Bank details saved successfully!');
            } else {
                alert('Error: Practitioner not found. Please refresh and try again.');
            }
        }
        
        // Function to save invoice messages from profile form
        function saveInvoiceMessages() {
            const defaultNotesField = document.getElementById('defaultInvoiceNotes');
            const footerMessageField = document.getElementById('invoiceFooterMessage');
            const termsField = document.getElementById('invoiceTerms');
            
            const invoiceMessages = {
                defaultNotes: defaultNotesField ? defaultNotesField.value : '',
                footerMessage: footerMessageField ? footerMessageField.value : '',
                paymentTerms: termsField ? termsField.value : ''
            };
            
            // Save to practitioner profile
            if (practitioner) {
                practitioner.invoiceMessages = invoiceMessages;
                cleartrackData.updatePractitioner(practitioner.id, practitioner);
                alert('Invoice messages saved successfully!');
            } else {
                alert('Error: Practitioner not found. Please refresh and try again.');
            }
        }
        
        // Handle invoice form submission
        function handleInvoiceSubmission() {
            console.log(' handleInvoiceSubmission called!');
            
            // Prevent multiple submissions
            const submitButton = document.querySelector('#invoiceForm button[type="submit"]');
            console.log('Submit button found:', submitButton);
            
            if (submitButton && submitButton.disabled) {
                console.log('Button already disabled, returning');
                return; // Already processing
            }
            
            // Disable submit button to prevent duplicate submissions
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Generating...';
            }
            
            // Add timeout to prevent button from being stuck forever
            const timeoutId = setTimeout(() => {
                console.log(' Invoice generation timeout - re-enabling button');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Generate Invoice';
                }
            }, 10000); // 10 second timeout
            
            // Get banking details from form or practitioner profile
            const formBankDetails = {
                bankName: document.getElementById('bankName')?.value || '',
                bankBranch: document.getElementById('bankBranch')?.value || '',
                accountNumber: document.getElementById('accountNumber')?.value || '',
                accountType: document.getElementById('accountType')?.value || 'business',
                bankReference: document.getElementById('bankReference')?.value || ''
            };
            
            // Get banking details from practitioner profile if form fields are empty
            const practitionerBankDetails = cleartrackData.getPractitionerBankDetails() || {};
            const bankDetails = {
                bankName: formBankDetails.bankName || practitionerBankDetails.bankName || '',
                bankBranch: formBankDetails.bankBranch || practitionerBankDetails.bankBranch || '',
                accountNumber: formBankDetails.accountNumber || practitionerBankDetails.accountNumber || '',
                accountType: formBankDetails.accountType || practitionerBankDetails.accountType || 'business',
                bankReference: formBankDetails.bankReference || practitionerBankDetails.bankReference || ''
            };
            
            // Get invoice notes from form
            let notes = document.getElementById('invoiceNotes')?.value || '';
            
            // Combine invoice messages from practitioner profile with form notes
            if (practitioner && practitioner.invoiceMessages) {
                const invoiceMessages = practitioner.invoiceMessages;
                
                // Add default notes if available
                if (invoiceMessages.defaultNotes) {
                    notes = notes ? `${invoiceMessages.defaultNotes}\n\n${notes}` : invoiceMessages.defaultNotes;
                }
                
                // Add footer message if available
                if (invoiceMessages.footerMessage) {
                    notes = notes ? `${notes}\n\n${invoiceMessages.footerMessage}` : invoiceMessages.footerMessage;
                }
                
                // Add payment terms if available
                if (invoiceMessages.paymentTerms) {
                    notes = notes ? `${notes}\n\nPayment Terms:\n${invoiceMessages.paymentTerms}` : `Payment Terms:\n${invoiceMessages.paymentTerms}`;
                }
            }
            
            const formData = {
                clientName: document.getElementById('invoiceClientName').value,
                taxYear: document.getElementById('invoiceTaxYear').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                description: document.getElementById('invoiceDescription').value,
                amount: parseFloat(document.getElementById('invoiceAmount').value) || 0,
                vatType: document.getElementById('invoiceVATType').value,
                vat: parseFloat(document.getElementById('invoiceVAT').value) || 0,
                vatReason: document.getElementById('invoiceVATReason').value,
                total: parseFloat(document.getElementById('invoiceTotal').value) || 0,
                dueDate: document.getElementById('invoiceDueDate').value,
                notes: notes,
                bankDetails: bankDetails
            };
            
            // Validate required fields
            console.log(' Validating form data:', formData);
            if (!formData.clientName || !formData.invoiceNumber || !formData.amount) {
                console.log(' Validation failed - missing required fields');
                alert('Please fill in all required fields.');
                // Re-enable button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Generate Invoice';
                }
                return;
            }
            console.log(' Validation passed');
            
            if (formData.amount <= 0) {
                alert('Please enter a valid amount greater than 0.');
                // Re-enable button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Generate Invoice';
                }
                return;
            }
            
            // Skip duplicate check for now - just generate the invoice
            
            try {
                
                // Save bank details for future use
                saveBankDetails();
                
                // Skip user validation for now - just generate the invoice
                
                // Create invoice directly
                console.log('Creating invoice with data:', formData);
                const invoiceId = 'inv_' + Date.now();
                const invoice = {
                    id: invoiceId,
                    practitionerId: practitioner.id,
                    clientName: formData.clientName,
                    taxYear: formData.taxYear,
                    invoiceNumber: formData.invoiceNumber,
                    invoiceDate: formData.invoiceDate,
                    dueDate: formData.dueDate,
                    description: formData.description,
                    amount: formData.amount,
                    vatType: formData.vatType,
                    vat: formData.vat,
                    vatReason: formData.vatReason,
                    total: formData.total,
                    notes: formData.notes,
                    bankDetails: formData.bankDetails,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                console.log('Invoice created:', invoice);
                
                // Save invoice to data storage
                console.log(' Saving invoice to data storage...');
                const savedInvoice = cleartrackData.addInvoice(invoice);
                console.log(' Invoice saved:', savedInvoice);
                
                // Verify invoice was saved
                const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
                console.log(' All invoices after save:', allInvoices);
                console.log(' Invoice count:', allInvoices.length);
                
                // Hide modal and show success
                console.log(' Invoice created successfully!');
                hideInvoiceGenerationModal();
                alert('Invoice generated successfully!');
                
                // Refresh invoices display
                console.log(' Refreshing invoice display...');
                loadInvoices();
                
            } catch (error) {
                console.error('Error generating invoice:', error);
                alert('An error occurred while generating the invoice. Please try again.');
            } finally {
                // Clear timeout
                clearTimeout(timeoutId);
                
                // Re-enable button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Generate Invoice';
                }
            }
        }
        
        // REMOVED: generateInvoicePDF function - was duplicate code
        // Invoice creation is now handled directly in handleInvoiceSubmission()
        
        // Test function to verify invoice generation works
        function testInvoiceGeneration() {
            console.log(' Testing invoice generation...');
            
            // Test 1: Check if all required functions exist
            console.log(' openClientSelectionModal:', typeof openClientSelectionModal);
            console.log(' selectClientForInvoice:', typeof selectClientForInvoice);
            console.log(' openInvoiceModalForClient:', typeof openInvoiceModalForClient);
            console.log(' handleInvoiceSubmission:', typeof handleInvoiceSubmission);
            console.log(' cleartrackData.addInvoice:', typeof cleartrackData.addInvoice);
            console.log(' loadInvoices:', typeof loadInvoices);
            
            // Test 2: Check if form fields exist
            const requiredFields = [
                'invoiceClientName',
                'invoiceAmount', 
                'invoiceNumber',
                'invoiceDate',
                'invoiceDescription'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                console.log(` Field ${fieldId}:`, field ? 'EXISTS' : 'MISSING');
            });
            
            // Test 3: Check if invoice modal exists
            const invoiceModal = document.getElementById('invoiceModal');
            console.log(' Invoice Modal:', invoiceModal ? 'EXISTS' : 'MISSING');
            
            // Test 4: Check if invoices list exists
            const invoicesList = document.getElementById('invoicesList');
            console.log(' Invoices List:', invoicesList ? 'EXISTS' : 'MISSING');
            
            console.log(' Invoice generation test complete!');
        }
        
        // ========================================
        // NEW CLEAN INVOICE SYSTEM
        // ========================================
        
        // Open new invoice modal
        function openNewInvoiceModal() {
            console.log(' Opening new invoice modal');
            
            if (!practitioner) {
                alert('Practitioner not found. Please log in again.');
                return;
            }
            
            const modal = document.getElementById('newInvoiceModal');
            if (!modal) {
                alert('Invoice modal not found. Please refresh the page.');
                return;
            }
            
            // Populate client dropdown
            populateClientDropdown();
            
            // Generate invoice number
            generateNewInvoiceNumber();
            
            // Set default dates
            setDefaultDates();
            
            // Setup event listeners
            setupNewInvoiceEventListeners();
            
            // Show modal
            modal.classList.remove('hidden');
        }
        
        // Close new invoice modal
        function closeNewInvoiceModal() {
            const modal = document.getElementById('newInvoiceModal');
            if (modal) {
                modal.classList.add('hidden');
                resetNewInvoiceForm();
            }
        }
        
        // Populate client dropdown
        function populateClientDropdown() {
            const clientSelect = document.getElementById('newInvoiceClientSelect');
            if (!clientSelect) return;
            
            // Clear existing options
            clientSelect.innerHTML = '<option value="">Choose a client...</option>';
            
            // Add clients
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.firstName} ${client.lastName}`;
                option.dataset.email = client.email;
                clientSelect.appendChild(option);
            });
        }
        
        // Generate new invoice number
        function generateNewInvoiceNumber() {
            const year = new Date().getFullYear();
            const timestamp = Date.now().toString().slice(-6);
            const randomSuffix = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const invoiceNumber = `INV-${year}-${timestamp}${randomSuffix}`;
            
            const invoiceNumberField = document.getElementById('newInvoiceNumber');
            if (invoiceNumberField) {
                invoiceNumberField.value = invoiceNumber;
            }
        }
        
        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const dueDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days from today
            
            const invoiceDateField = document.getElementById('newInvoiceDate');
            const dueDateField = document.getElementById('newInvoiceDueDate');
            
            if (invoiceDateField) {
                invoiceDateField.value = today.toISOString().split('T')[0];
            }
            if (dueDateField) {
                dueDateField.value = dueDate.toISOString().split('T')[0];
            }
        }
        
        // Setup event listeners for new invoice modal
        function setupNewInvoiceEventListeners() {
            // Client selection
            const clientSelect = document.getElementById('newInvoiceClientSelect');
            if (clientSelect) {
                clientSelect.addEventListener('change', handleClientSelection);
            }
            
            // VAT calculation
            const amountField = document.getElementById('newInvoiceAmount');
            const vatTypeField = document.getElementById('newInvoiceVATType');
            
            if (amountField) {
                amountField.addEventListener('input', calculateVAT);
            }
            if (vatTypeField) {
                vatTypeField.addEventListener('change', calculateVAT);
            }
        }
        
        // Handle client selection
        function handleClientSelection(event) {
            const clientId = event.target.value;
            const selectedClientInfo = document.getElementById('selectedClientInfo');
            const selectedClientName = document.getElementById('selectedClientName');
            const selectedClientEmail = document.getElementById('selectedClientEmail');
            
            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    selectedClientName.textContent = `${client.firstName} ${client.lastName}`;
                    selectedClientEmail.textContent = client.email;
                    selectedClientInfo.classList.remove('hidden');
                }
            } else {
                selectedClientInfo.classList.add('hidden');
            }
        }
        
        // Calculate VAT
        function calculateVAT() {
            const amountField = document.getElementById('newInvoiceAmount');
            const vatTypeField = document.getElementById('newInvoiceVATType');
            const vatSubtotal = document.getElementById('vatSubtotal');
            const vatAmount = document.getElementById('vatAmount');
            const vatTotal = document.getElementById('vatTotal');
            
            if (!amountField || !vatTypeField) return;
            
            const amount = parseFloat(amountField.value) || 0;
            const vatType = vatTypeField.value;
            
            let vatRate = 0;
            if (vatType === 'standard') {
                vatRate = 0.15;
            } else if (vatType === 'zero') {
                vatRate = 0;
            }
            // exempt remains 0
            
            const vat = amount * vatRate;
            const total = amount + vat;
            
            if (vatSubtotal) vatSubtotal.textContent = `R ${amount.toFixed(2)}`;
            if (vatAmount) vatAmount.textContent = `R ${vat.toFixed(2)}`;
            if (vatTotal) vatTotal.textContent = `R ${total.toFixed(2)}`;
        }
        
        // Generate new invoice
        function generateNewInvoice() {
            console.log(' Generating new invoice');
            
            // Get form data
            const formData = {
                clientId: document.getElementById('newInvoiceClientSelect').value,
                clientName: document.getElementById('selectedClientName').textContent,
                clientEmail: document.getElementById('selectedClientEmail').textContent,
                invoiceNumber: document.getElementById('newInvoiceNumber').value,
                invoiceDate: document.getElementById('newInvoiceDate').value,
                dueDate: document.getElementById('newInvoiceDueDate').value,
                taxYear: document.getElementById('newInvoiceTaxYear').value,
                amount: parseFloat(document.getElementById('newInvoiceAmount').value) || 0,
                description: document.getElementById('newInvoiceDescription').value,
                vatType: document.getElementById('newInvoiceVATType').value,
                vatReason: document.getElementById('newInvoiceVATReason').value,
                notes: document.getElementById('newInvoiceNotes').value
            };
            
            // Validate form
            if (!formData.clientId || !formData.invoiceNumber || !formData.amount || !formData.description) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Calculate VAT
            const vatRate = formData.vatType === 'standard' ? 0.15 : 0;
            const vat = formData.amount * vatRate;
            const total = formData.amount + vat;
            
            // Get banking details from practitioner profile
            const practitionerBankDetails = cleartrackData.getPractitionerBankDetails() || {};
            const bankDetails = {
                bankName: practitionerBankDetails.bankName || '',
                bankBranch: practitionerBankDetails.bankBranch || '',
                accountNumber: practitionerBankDetails.accountNumber || '',
                accountType: practitionerBankDetails.accountType || 'business',
                bankReference: practitionerBankDetails.bankReference || formData.invoiceNumber
            };
            
            // Combine invoice messages from practitioner profile with form notes
            let combinedNotes = formData.notes || '';
            
            // Get invoice messages from practitioner profile
            if (practitioner && practitioner.invoiceMessages) {
                const invoiceMessages = practitioner.invoiceMessages;
                
                // Add default notes if available
                if (invoiceMessages.defaultNotes) {
                    combinedNotes = combinedNotes ? `${invoiceMessages.defaultNotes}\n\n${combinedNotes}` : invoiceMessages.defaultNotes;
                }
                
                // Add footer message if available
                if (invoiceMessages.footerMessage) {
                    combinedNotes = combinedNotes ? `${combinedNotes}\n\n${invoiceMessages.footerMessage}` : invoiceMessages.footerMessage;
                }
                
                // Add payment terms if available
                if (invoiceMessages.paymentTerms) {
                    combinedNotes = combinedNotes ? `${combinedNotes}\n\nPayment Terms:\n${invoiceMessages.paymentTerms}` : `Payment Terms:\n${invoiceMessages.paymentTerms}`;
                }
            }
            
            // Create invoice object
            const invoice = {
                id: 'inv_' + Date.now(),
                practitionerId: practitioner.id,
                clientId: formData.clientId,
                clientName: formData.clientName,
                clientEmail: formData.clientEmail,
                invoiceNumber: formData.invoiceNumber,
                invoiceDate: formData.invoiceDate,
                dueDate: formData.dueDate,
                taxYear: formData.taxYear,
                description: formData.description,
                amount: formData.amount,
                vatType: formData.vatType,
                vat: vat,
                vatReason: formData.vatReason,
                total: total,
                notes: combinedNotes,
                bankDetails: bankDetails,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            console.log(' Saving invoice:', invoice);
            
            // Save invoice
            try {
                cleartrackData.addInvoice(invoice);
                console.log(' Invoice saved successfully');
                
                // If invoice was generated from a tax return, mark the return as invoiced
                const invoiceModal = document.getElementById('newInvoiceModal');
                if (invoiceModal && invoiceModal.dataset.returnId && invoiceModal.dataset.returnId !== 'direct_invoice') {
                    const returnId = invoiceModal.dataset.returnId;
                    const taxReturn = taxReturns.find(r => r.id === returnId);
                    if (taxReturn) {
                        taxReturn.invoiceGenerated = true;
                        // Update tax return in storage
                        const data = cleartrackData.getData();
                        if (data.taxReturns && data.taxReturns[returnId]) {
                            data.taxReturns[returnId].invoiceGenerated = true;
                            cleartrackData.setData(data);
                        }
                        // Refresh tax returns display
                        loadTaxReturns();
                    }
                }
                
                // Close modal
                closeNewInvoiceModal();
                
                // Show success message
                alert('Invoice generated successfully!');
                
                // Refresh invoices display
                loadInvoices();
                
                // Show invoice actions
                showInvoiceActions(invoice);
                
            } catch (error) {
                console.error(' Error saving invoice:', error);
                alert('Error generating invoice. Please try again.');
            }
        }
        
        // Show invoice actions after generation
        function showInvoiceActions(invoice) {
            const action = confirm('Invoice generated successfully! Would you like to:\n\nOK - View/Download Invoice\nCancel - Continue');
            
            if (action) {
                // Open invoice preview with actions
                openInvoicePreview(invoice);
            }
        }
        
        // Unified Invoice HTML Generator - Used by all invoice functions to ensure identical output
        function generateUnifiedInvoiceHTML(invoice, options = {}) {
            // Get practitioner details
            const practitionerName = options.practitionerName || (practitioner ? `${practitioner.firstName} ${practitioner.lastName}` : 'Practitioner');
            const practitionerEmail = options.practitionerEmail || (practitioner ? practitioner.email : '');
            const practitionerPhone = options.practitionerPhone || (practitioner ? practitioner.phone : '');
            
            const bankDetails = invoice.bankDetails || {
                bankName: '', bankBranch: '', accountNumber: '', accountType: 'business', bankReference: ''
            };
            
            // VAT label helper
            function getVATLabel(vatType) {
                switch (vatType) {
                    case 'standard': return 'VAT (15%)';
                    case 'exempt': return 'VAT Exempt';
                    case 'zero': return 'Zero Rated (0%)';
                    default: return 'VAT';
                }
            }
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${invoice.invoiceNumber}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: white; }
        .invoice-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid #0b7285; padding-bottom: 20px; }
        .invoice-header-left { flex-shrink: 0; }
        .invoice-header-right { flex: 1; text-align: right; }
        .invoice-title { font-size: 28px; font-weight: bold; color: #0b7285; margin: 0 0 5px 0; }
        .invoice-subtitle { font-size: 16px; color: #6b7280; margin: 0; }
        .invoice-details { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .invoice-info { flex: 1; }
        .client-info { flex: 1; text-align: right; }
        .info-section h3 { margin: 0 0 10px 0; color: #374151; font-size: 16px; }
        .info-section p { margin: 5px 0; color: #6b7280; font-size: 14px; }
        .invoice-table { width: 100%; border-collapse: collapse; margin: 30px 0; }
        .invoice-table th, .invoice-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; word-wrap: break-word; word-break: break-word; white-space: normal; overflow-wrap: break-word; }
        .invoice-table th { background-color: #f9fafb; font-weight: bold; color: #374151; }
        .invoice-table .amount { text-align: right; }
        .invoice-totals { margin-top: 20px; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .total-row.final { font-weight: bold; font-size: 18px; color: #0b7285; border-top: 2px solid #0b7285; margin-top: 10px; }
        .invoice-notes { margin-top: 30px; padding: 15px; background-color: #f9fafb; border-radius: 8px; }
        .invoice-notes h4 { margin: 0 0 10px 0; color: #374151; }
        .invoice-notes p { margin: 0; color: #6b7280; font-size: 14px; line-height: 1.5; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="invoice-header">
        <div class="invoice-header-left">
            <img src="assets/images/full logo CT.png" alt="ClearTrack Logo" style="max-width: 200px; height: auto;">
                    </div>
        <div class="invoice-header-right">
            <h1 class="invoice-title">INVOICE</h1>
            <p class="invoice-subtitle">ClearTrack Tax Services</p>
                </div>
    </div>
    
    <div class="invoice-details">
        <div class="invoice-info">
            <div class="info-section">
                <h3>From:</h3>
                <p><strong>${practitionerName}</strong></p>
                <p>${practitionerEmail}</p>
                <p>${practitionerPhone}</p>
            </div>
        </div>
        <div class="client-info">
            <div class="info-section">
                <h3>Invoice Details:</h3>
                <p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
                <p><strong>Date:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString()}</p>
                <p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>
            </div>
            <div class="info-section" style="margin-top: 20px;">
                <h3>Bill To:</h3>
                <p><strong>${invoice.clientName}</strong></p>
                <p>Tax Year: ${invoice.taxYear}</p>
            </div>
        </div>
    </div>
    
    <table class="invoice-table">
        <thead>
            <tr>
                <th>Description</th>
                <th class="amount">Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>${invoice.description || 'Services'}</td>
                <td class="amount">R ${Number(invoice.amount || 0).toFixed(2)}</td>
            </tr>
        </tbody>
    </table>
    
    <div class="invoice-totals">
        <div class="total-row">
            <span>Subtotal:</span>
            <span>R ${Number(invoice.amount || 0).toFixed(2)}</span>
        </div>
        <div class="total-row">
            <span>${getVATLabel(invoice.vatType || 'standard')}:</span>
            <span>R ${Number(invoice.vat || 0).toFixed(2)}</span>
        </div>
        ${invoice.vatReason ? `<div class="total-row" style="font-size: 12px; color: #6b7280;"><span>VAT Exemption Reason:</span><span>${invoice.vatReason}</span></div>` : ''}
        <div class="total-row final">
            <span>Total:</span>
            <span>R ${Number(invoice.total || 0).toFixed(2)}</span>
        </div>
    </div>
    
    <div class="invoice-notes">
        <h4>Payment Details</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
            <div>
                <h5 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">Bank Details:</h5>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Bank:</strong> ${bankDetails.bankName || 'Not specified'}</p>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Branch:</strong> ${bankDetails.bankBranch || 'Not specified'}</p>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Account:</strong> ${bankDetails.accountNumber || 'Not specified'}</p>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;"><strong>Type:</strong> ${bankDetails.accountType || 'business'}</p>
            </div>
            <div>
                <h5 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">Payment Reference:</h5>
                <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">${bankDetails.bankReference || invoice.invoiceNumber}</p>
            </div>
        </div>
        ${invoice.notes ? `<p style="margin: 10px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.5;">${invoice.notes}</p>` : ''}
    </div>
</body>
</html>`;
        }
        
        // Open invoice preview with actions
        function openInvoicePreview(invoice) {
            // Use unified invoice HTML generator
            const invoiceHTML = generateUnifiedInvoiceHTML(invoice);
            
            // Create modal with iframe
            const modal = document.createElement('div');
            modal.id = 'invoicePreviewModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const iframe = document.createElement('iframe');
            iframe.style.cssText = 'width: 90%; max-width: 900px; height: 90vh; border: none; border-radius: 8px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
            
            window.closeInvoiceModal = () => document.body.removeChild(modal);
            
            modal.appendChild(iframe);
            document.body.appendChild(modal);
            
            // Write content to iframe
            iframe.onload = () => {
                try {
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(invoiceHTML);
                    iframe.contentDocument.close();
                    
                    // Expose functions to iframe
                    iframe.contentWindow.downloadInvoice = (id) => downloadInvoice(id);
                    iframe.contentWindow.emailInvoice = (id) => emailInvoice(id);
                    iframe.contentWindow.chatInvoice = (id) => chatInvoice(id);
                    iframe.contentWindow.getVATLabel = (type) => getVATLabel(type);
                } catch (err) {
                    console.error('Error writing to iframe:', err);
                    iframe.srcdoc = invoiceHTML;
                }
            };
            
            // Try to write immediately
            try {
                iframe.contentDocument.open();
                iframe.contentDocument.write(invoiceHTML);
                iframe.contentDocument.close();
            } catch (err) {
                // Iframe not ready, will use onload
            }
            
            // Close on click outside
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    window.closeInvoiceModal = null;
                }
            };
        }
        
        // Reset new invoice form
        function resetNewInvoiceForm() {
            const form = document.getElementById('newInvoiceModal');
            if (form) {
                form.querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.type === 'checkbox' || field.type === 'radio') {
                        field.checked = false;
                    } else {
                        field.value = '';
                    }
                });
            }
            
            // Hide selected client info
            const selectedClientInfo = document.getElementById('selectedClientInfo');
            if (selectedClientInfo) {
                selectedClientInfo.classList.add('hidden');
            }
            
            // Reset VAT calculations
            calculateVAT();
        }
        
        // ========================================
        // INVOICE ACTIONS (Download, Email, Chat)
        // ========================================
        
        // Download invoice as PDF
        function downloadInvoice(invoiceId) {
            console.log(' Downloading invoice:', invoiceId);
            
            // First try to find invoice in storage
            let invoice = null;
            const invoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            invoice = invoices.find(inv => inv.id === invoiceId);
            
            // If not found, check if it's the current invoice in the modal (preview or recently viewed)
            if (!invoice && window.currentInvoice && window.currentInvoice.id === invoiceId) {
                invoice = window.currentInvoice;
            }
            
            if (!invoice) {
                alert('Invoice not found. Please refresh and try again.');
                return;
            }
            
            // Create PDF content using unified HTML generator
            const pdfContent = generateInvoicePDF(invoice);
            
            // Create and download file
            const blob = new Blob([pdfContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Invoice_${invoice.invoiceNumber}.html`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log(' Invoice downloaded successfully');
        }
        
        // Email invoice
        function emailInvoice(invoiceId) {
            console.log(' Emailing invoice:', invoiceId);
            
            // First try to find invoice in storage
            let invoice = null;
            const invoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            invoice = invoices.find(inv => inv.id === invoiceId);
            
            // If not found, check if it's the current invoice in the modal (preview or recently viewed)
            if (!invoice && window.currentInvoice && window.currentInvoice.id === invoiceId) {
                invoice = window.currentInvoice;
            }
            
            if (!invoice) {
                alert('Invoice not found. Please refresh and try again.');
                return;
            }
            
            // Get connected users to find client email
            const connectedUsers = cleartrackData.getConnectedUsers(practitioner.id);
            
            // Find the client - try different name formats
            let client = connectedUsers.find(c => {
                const clientName = c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim();
                return clientName === invoice.clientName ||
                       (c.firstName && c.lastName && `${c.firstName} ${c.lastName}` === invoice.clientName);
            });
            
            // Try partial matching if exact match fails
            if (!client && invoice.clientName) {
                const nameParts = invoice.clientName.split(' ');
                if (nameParts.length >= 2) {
                    client = connectedUsers.find(c => 
                        c.firstName && c.lastName &&
                        c.firstName.toLowerCase() === nameParts[0].toLowerCase() &&
                        c.lastName.toLowerCase() === nameParts[nameParts.length - 1].toLowerCase()
                    );
                }
            }
            
            // Get client email
            const clientEmail = (client && client.email) || invoice.clientEmail || '';
            
            if (!clientEmail) {
                alert('Client email not found. Please ensure the client is properly connected and has an email address.');
                return;
            }
            
            // Create email content
            const subject = `Invoice ${invoice.invoiceNumber} - ${invoice.clientName}`;
            const body = `Dear ${invoice.clientName},

Please find attached your invoice for the services provided.

Invoice Details:
- Invoice Number: ${invoice.invoiceNumber}
- Amount: R ${invoice.total.toFixed(2)}
- Due Date: ${new Date(invoice.dueDate).toLocaleDateString()}
- Description: ${invoice.description || 'Tax return preparation and filing services'}

Please make payment by the due date.

Thank you for your business.

Best regards,
${practitioner.firstName} ${practitioner.lastName}`;
            
            // Open email client
            const mailtoLink = `mailto:${clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            console.log(' Email opened successfully');
        }
        
        // Send invoice via chat
        function chatInvoice(invoiceId) {
            console.log(' Sending invoice via chat:', invoiceId);
            
            // First try to find invoice in storage
            let invoice = null;
            const invoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            invoice = invoices.find(inv => inv.id === invoiceId);
            
            // If not found, check if it's the current invoice in the modal (preview or recently viewed)
            if (!invoice && window.currentInvoice && window.currentInvoice.id === invoiceId) {
                invoice = window.currentInvoice;
            }
            
            if (!invoice) {
                alert('Invoice not found. Please refresh and try again.');
                return;
            }
            
            // Get connected users to find client
            const connectedUsers = cleartrackData.getConnectedUsers(practitioner.id);
            
            // Find the client - try different name formats
            let client = connectedUsers.find(c => {
                const clientName = c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim();
                return clientName === invoice.clientName ||
                       (c.firstName && c.lastName && `${c.firstName} ${c.lastName}` === invoice.clientName);
            });
            
            // Try partial matching if exact match fails
            if (!client && invoice.clientName) {
                const nameParts = invoice.clientName.split(' ');
                if (nameParts.length >= 2) {
                    client = connectedUsers.find(c => 
                        c.firstName && c.lastName &&
                        c.firstName.toLowerCase() === nameParts[0].toLowerCase() &&
                        c.lastName.toLowerCase() === nameParts[nameParts.length - 1].toLowerCase()
                    );
                }
            }
            
            // Try finding by clientId if available
            if (!client && invoice.clientId) {
                client = connectedUsers.find(c => c.id === invoice.clientId);
            }
            
            if (!client) {
                alert(`Client "${invoice.clientName}" not found in your connected users. Please ensure the client is properly connected.`);
                return;
            }
            
            // Get the proper client name for display
            const clientDisplayName = client.name || `${client.firstName || ''} ${client.lastName || ''}`.trim() || invoice.clientName;
            
            // Create chat message with invoice - using correct API signature
            const messageData = {
                sender: 'practitioner',
                senderName: `${practitioner.firstName} ${practitioner.lastName}`,
                receiverName: clientDisplayName,
                text: ` Invoice ${invoice.invoiceNumber}\n\nAmount: R ${invoice.total.toFixed(2)}\nDue Date: ${new Date(invoice.dueDate).toLocaleDateString()}\n\nPlease review your invoice.`,
                type: 'invoice',
                invoiceData: {
                    id: invoice.id,
                    invoiceNumber: invoice.invoiceNumber,
                    total: invoice.total,
                    amount: invoice.amount,
                    vat: invoice.vat,
                    dueDate: invoice.dueDate,
                    invoiceDate: invoice.invoiceDate,
                    description: invoice.description || 'Tax return preparation and filing services',
                    taxYear: invoice.taxYear
                }
            };
            
            // Save message with correct parameters: userId, practitionerId, messageData
            try {
                cleartrackData.addMessage(client.id, practitioner.id, messageData);
                
                // Show success message
                alert(`Invoice sent to ${clientDisplayName} via chat!`);
                
                // Close preview modal if open
                if (typeof hideInvoicePreviewModal === 'function') {
                    hideInvoicePreviewModal();
                }
                
                // Refresh chat if open
                if (typeof loadConversations === 'function') {
                    loadConversations();
                }
                
                console.log(' Invoice sent via chat successfully');
            } catch (error) {
                console.error('Error sending invoice via chat:', error);
                alert('An error occurred while sending the invoice. Please try again.');
            }
        }
        
        // Generate invoice PDF content
        function generateInvoicePDF(invoice) {
            // Use unified invoice HTML generator
            return generateUnifiedInvoiceHTML(invoice);
        }
        
        // Quick test to verify the fix
        function testInvoiceFix() {
            console.log(' Testing invoice fix...');
            
            // Clear console for clean output
            console.clear();
            
            // Run the debug function
            debugInvoiceIssue();
            
            // Wait a moment then check if invoice appears in UI
            setTimeout(() => {
                const invoicesList = document.getElementById('invoicesList');
                if (invoicesList) {
                    const invoiceCards = invoicesList.querySelectorAll('.invoice-card');
                    console.log(' Invoice cards in UI:', invoiceCards.length);
                    
                    if (invoiceCards.length > 0) {
                        console.log(' SUCCESS: Invoice appears in the UI!');
                        console.log(' The fix is working correctly!');
                    } else {
                        console.log(' FAILED: No invoice cards found in UI');
                        console.log(' Checking invoices list content...');
                        console.log('Invoices list HTML:', invoicesList.innerHTML.substring(0, 200) + '...');
                    }
                } else {
                    console.log(' Invoices list element not found');
                }
            }, 1000);
        }
        
        // Quick test function to manually trigger invoice generation
        function testInvoiceButton() {
            console.log(' Testing invoice button manually...');
            
            // Check if form exists
            const form = document.getElementById('invoiceForm');
            console.log('Form found:', form);
            
            // Check if submit button exists
            const submitButton = document.querySelector('#invoiceForm button[type="submit"]');
            console.log('Submit button found:', submitButton);
            
            // Try to manually trigger the form submission
            if (form) {
                console.log('Manually triggering form submission...');
                const event = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(event);
            }
        }
        
        // Simple test to create a test invoice
        function createTestInvoice() {
            console.log(' Creating test invoice...');
            
            // Create a simple test invoice
            const testInvoice = {
                id: 'test_inv_' + Date.now(),
                practitionerId: practitioner.id,
                clientName: 'Test Client',
                taxYear: '2025/2026',
                invoiceNumber: 'TEST-001',
                invoiceDate: new Date().toISOString().split('T')[0],
                description: 'Test invoice',
                amount: 100,
                vatType: 'standard',
                vat: 15,
                vatReason: '',
                total: 115,
                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                notes: 'Test invoice notes',
                bankDetails: {
                    bankName: 'Test Bank',
                    bankBranch: 'Test Branch',
                    accountNumber: '123456789',
                    accountType: 'business',
                    bankReference: 'TEST123'
                },
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            console.log('Test invoice created:', testInvoice);
            
            // Save the test invoice
            cleartrackData.addInvoice(testInvoice);
            
            // Update display
            loadInvoices();
            
            console.log(' Test invoice created and saved!');
        }
        
        // Force reset the invoice button if it gets stuck
        function resetInvoiceButton() {
            console.log(' Resetting invoice button...');
            const submitButton = document.querySelector('#invoiceForm button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = 'Generate Invoice';
                console.log(' Button reset successfully');
            } else {
                console.log(' Submit button not found');
            }
        }
        
        // Generate actual PDF file for download
        function createInvoicePDFFile(invoice) {
            try {
                // Create a new window for PDF generation
                const printWindow = window.open('', '_blank');
                
                if (!printWindow) {
                    alert('Please allow pop-ups for this site to generate the invoice PDF.');
                    return;
                }
                
                // Use unified invoice HTML generator
                const invoiceHTML = generateUnifiedInvoiceHTML(invoice);
            
                // Write HTML to the new window
                printWindow.document.write(invoiceHTML);
                printWindow.document.close();
                
                // Wait for content to load, then trigger print dialog
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 500);
                };
                
            } catch (error) {
                console.error('Error creating invoice PDF:', error);
                alert('Error generating invoice PDF. Please try again.');
            }
        }
        
        // Get VAT label based on type
        function getVATLabel(vatType) {
            switch (vatType) {
                case 'standard':
                    return 'VAT (15%)';
                case 'exempt':
                    return 'VAT Exempt';
                case 'zero':
                    return 'Zero Rated (0%)';
                default:
                    return 'VAT';
            }
        }
        
        function downloadDocument(docId, fileName) {
            // Validate required parameters
            if (!docId || !fileName) {
                alert('Invalid document parameters. Please try again.');
                return;
            }
            
            if (!currentClientId) {
                alert('Client session not found. Please refresh and try again.');
                return;
            }
            
            try {
                // Get the document data from storage
                const documents = cleartrackData.getUserDocuments(currentClientId);
                
                if (!documents || documents.length === 0) {
                    alert('No documents found for this client.');
                    return;
                }
                
                // Find the document by ID first, then by filename as fallback
                let docData = documents.find(doc => doc.id === docId);
                
                if (!docData) {
                    docData = documents.find(doc => doc.fileName === fileName);
                }
                
                if (!docData) {
                    alert('Document not found. The document may have been removed.');
                    return;
                }
                
                if (!docData.fileContent) {
                    alert('File content is missing. The document may be corrupted.');
                    return;
                }
                
                // Create and trigger download
                const link = document.createElement('a');
                link.href = docData.fileContent;
                link.download = fileName;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Error downloading document:', error);
                alert('An error occurred while downloading the document. Please try again.');
            }
        }
        
        // View comprehensive client data
        function viewClientData(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const documents = cleartrackData.getUserDocuments(clientId);
            const vehicles = cleartrackData.getUserVehicles(clientId);
            const expenses = cleartrackData.getUserExpenses(clientId);
            
            document.getElementById('clientDataTitle').textContent = `${client.firstName} ${client.lastName} - Complete Data View`;
            
            document.getElementById('clientDataContent').innerHTML = `
                <div class="mb-8">
                    <h4 style="margin-bottom: 1rem; color: #374151;">
                        <img src="assets/icons/document.svg" class="icon icon-sm" alt="Documents"> Documents (${documents.length})
                    </h4>
                    ${documents.length === 0 ? 
                        '<p style="color: #6b7280; text-align: center; padding: 1rem;">No documents uploaded</p>' :
                        documents.map(doc => `
                            <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div class="font-medium">${doc.type} - ${doc.taxYear}</div>
                                <div class="text-sm text-gray-500">${doc.fileName} | Uploaded: ${new Date(doc.uploadedAt).toLocaleDateString()}</div>
                                ${doc.description ? `<div class="text-sm text-gray-500">${doc.description}</div>` : ''}
                            </div>
                        `).join('')
                    }
                </div>
                
                <div class="mb-8">
                    <h4 style="margin-bottom: 1rem; color: #374151;">
                        <img src="assets/icons/car.svg" class="icon icon-sm" alt="Vehicles"> Vehicles (${vehicles.length})
                    </h4>
                    ${vehicles.length === 0 ? 
                        '<p style="color: #6b7280; text-align: center; padding: 1rem;">No vehicles registered</p>' :
                        vehicles.map(vehicle => `
                            <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div class="font-medium">${vehicle.registration} - ${vehicle.make} ${vehicle.model} (${vehicle.year})</div>
                                <div class="text-sm text-gray-500">${vehicle.fuelType} | Business Use: ${vehicle.businessUse}%</div>
                                ${vehicle.notes ? `<div class="text-sm text-gray-500">${vehicle.notes}</div>` : ''}
                            </div>
                        `).join('')
                    }
                </div>
                
                <div class="mb-8">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #374151; margin: 0;">
                            <img src="assets/icons/money.svg" class="icon icon-sm" alt="Expenses"> Expenses (${expenses.length}) - Total: R ${expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0).toLocaleString()}
                        </h4>
                        ${expenses.length > 0 ? `
                            <button class="btn btn-outline btn-sm" onclick="openExpenseModal('${clientId}')">
                                <img src="assets/icons/eye.svg" class="icon icon-sm" alt="View">
                                View Expense Details
                            </button>
                        ` : ''}
                    </div>
                    ${expenses.length === 0 ? 
                        '<p style="color: #6b7280; text-align: center; padding: 1rem;">No expenses recorded</p>' :
                        expenses.map(expense => `
                            <div style="padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <div class="font-medium">${expense.description} - R ${expense.amount.toLocaleString()}</div>
                                        <div class="text-sm text-gray-500">${expense.category.replace('_', ' ')} | ${new Date(expense.date).toLocaleDateString()} | Business Use: ${expense.businessUse}%</div>
                                    </div>
                                    ${expense.document ? `
                                        <button class="btn btn-outline btn-sm" onclick="viewExpenseDocument('${clientId}', '${expense.id}')" style="margin-left: 0.5rem; flex-shrink: 0;">
                                            <img src="assets/icons/document.svg" class="icon icon-sm" alt="View">
                                            View Document
                                        </button>
                                    ` : ''}
                                </div>
                                ${expense.notes ? `<div class="text-sm text-gray-500">${expense.notes}</div>` : ''}
                            </div>
                        `).join('')
                    }
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-outline" onclick="hideClientDataModal()">Close</button>
                </div>
            `;
            
            document.getElementById('clientDataModal').classList.remove('hidden');
        }
        
        function hideClientDataModal() {
            document.getElementById('clientDataModal').classList.add('hidden');
        }
        
        // Copy practitioner code to clipboard
        function copyPractitionerCode() {
            const code = document.getElementById('practitionerCode').textContent;
            
            // Use the modern clipboard API if available
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(code).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopyTextToClipboard(code);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(code);
            }
        }
        
        // Fallback copy function for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    showCopyError();
                }
            } catch (err) {
                showCopyError();
            }
            
            document.body.removeChild(textArea);
        }
        
        // Show copy success message
        function showCopySuccess() {
            const button = document.getElementById('copyCodeBtn');
            const successMessage = document.getElementById('copySuccessMessage');
            const originalText = button.textContent;
            
            // Show success message
            successMessage.style.display = 'block';
            
            // Update button
            button.innerHTML = '<img src="assets/icons/check.svg" class="icon icon-sm icon-green-600" alt="Copied"> Copied!';
            button.style.background = '#059669';
            
            // Hide success message and reset button after 3 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
                button.innerHTML = '<img src="assets/icons/copy-and-paste.svg" class="icon icon-sm" alt="Copy"> Copy Your Code';
                button.style.background = '#2563eb';
            }, 3000);
        }
        
        // Show copy error message
        function showCopyError() {
            const button = document.getElementById('copyCodeBtn');
            const successMessage = document.getElementById('copySuccessMessage');
            const originalText = button.textContent;
            
            // Show error message
            successMessage.style.display = 'block';
            successMessage.style.background = '#fef2f2';
            successMessage.style.borderColor = '#fecaca';
            successMessage.style.color = '#991b1b';
            successMessage.textContent = ' Copy failed. Please try again.';
            
            // Update button
            button.textContent = ' Copy Failed';
            button.style.background = '#dc2626';
            
            // Hide error message and reset button after 3 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
                successMessage.style.background = '#f0fdf4';
                successMessage.style.borderColor = '#bbf7d0';
                successMessage.style.color = '#166534';
                successMessage.textContent = ' Code copied to clipboard successfully!';
                button.textContent = originalText;
                button.style.background = '#2563eb';
            }, 3000);
        }
        
        // Show section
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update data if needed
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'clients') {
                loadClients();
            } else if (sectionName === 'tax-returns') {
                loadTaxReturns();
            } else if (sectionName === 'messages') {
                loadConversations();
            } else if (sectionName === 'requests') {
                loadConnectionRequests();
            } else if (sectionName === 'invoices') {
                loadInvoices();
            }
        }
        
        // Handle navigation click - wraps showSection and closes mobile nav
        function handleNavClick(sectionName, event) {
            if (event) {
                event.preventDefault();
            }
            
            // ALWAYS close mobile menu first (before any other logic)
            const nav = document.getElementById("nav-style6");
            const toggle = document.querySelector(".menu-toggle-style6");
            if (nav && nav.classList.contains("active")) {
                nav.classList.remove("active");
                if (toggle) toggle.classList.remove("active");
            }
            
            // Get the clicked element - handle both direct clicks and clicks on child elements
            let clickedLink = event ? (event.target || event.currentTarget) : null;
            if (clickedLink && !clickedLink.classList.contains('nav-link')) {
                clickedLink = clickedLink.closest('.nav-link') || clickedLink.closest('a');
            }
            
            showSection(sectionName);
            
            // Update active state for ALL nav links (both desktop .nav a and mobile .nav-style6 a)
            document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Activate the clicked link
            if (clickedLink) {
                clickedLink.classList.add('active');
                
                // Also activate corresponding link in the other nav by matching onclick attribute
                const clickedOnclick = clickedLink.getAttribute('onclick');
                if (clickedOnclick) {
                    document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
                    if (link.getAttribute('onclick') === clickedOnclick) {
                        link.classList.add('active');
                    }
                });
                }
            } else {
                // Fallback: find link by section name
                document.querySelectorAll('.nav-link, .nav a, .nav-style6 a').forEach(link => {
                    const onclick = link.getAttribute('onclick');
                    if (onclick && onclick.includes("'" + sectionName + "'")) {
                        link.classList.add('active');
                    }
                });
            }
        }
        
        // Style 6 Mobile Navigation Functions - EXACT FROM REFERENCE
        function toggleMenu(style) {
            const nav = document.getElementById(`nav-style${style.slice(-1)}`);
            const toggle = document.querySelector(`.menu-toggle-style${style.slice(-1)}`);
            const overlay = document.getElementById(`overlay-style${style.slice(-1)}`);
            
            if (nav) {
                nav.classList.toggle('active');
            }
            if (toggle) {
                toggle.classList.toggle('active');
            }
            if (overlay) {
                overlay.classList.toggle('active');
            }
        }

        // Close menus when clicking outside (for dropdowns) - EXACT FROM REFERENCE
        document.addEventListener('click', function(event) {
            const nav = document.getElementById('nav-style6');
            const toggle = document.querySelector('.menu-toggle-style6');
            const header = toggle?.closest('.header');
            
            if (nav && nav.classList.contains('active')) {
                if (header && !header.contains(event.target)) {
                    nav.classList.remove('active');
                    if (toggle) toggle.classList.remove('active');
                }
            }
        });
        
        // Keep toggleMenuStyle6 for backward compatibility
        function toggleMenuStyle6() {
            toggleMenu('style6');
        }
        
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobileNav');
            if (mobileNav) {
                mobileNav.classList.toggle('active');
                // Prevent body scroll when mobile nav is open
                if (mobileNav.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }
        
        function closeMobileNav() {
            const mobileNav = document.getElementById('mobileNav');
            if (mobileNav) {
                mobileNav.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        function closeMobileNavOnOverlay(event) {
            // Close nav only if clicking on the overlay, not the content
            if (event.target.classList.contains('mobile-nav')) {
                closeMobileNav();
            }
        }
        
        // Close mobile nav when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeMobileNav();
            }
        });
        
        // Close mobile nav when window is resized to desktop size
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMobileNav();
            }
        });
        
        // Update dashboard statistics
        function updateDashboard() {
            // Ensure clients array exists
            if (!clients) {
                clients = [];
            }
            
            // Safely update total clients with null check
            const totalClientsEl = document.getElementById('totalClients');
            if (totalClientsEl) {
                totalClientsEl.textContent = clients.length || 0;
            }
            
            // Count active clients (those with documents or expenses)
            const activeClientsCount = clients.filter(client => 
                (client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0
            ).length;
            
            const activeClientsEl = document.getElementById('activeClients');
            if (activeClientsEl) {
                activeClientsEl.textContent = activeClientsCount;
            }
            
            // Ensure taxReturns array exists
            if (!taxReturns) {
                taxReturns = [];
            }
            
            const pendingReturns = taxReturns.filter(r => r.status === 'pending' || r.status === 'in_progress').length;
            const completedReturns = taxReturns.filter(r => r.status === 'completed').length;
            
            const pendingReturnsEl = document.getElementById('pendingReturns');
            if (pendingReturnsEl) {
                pendingReturnsEl.textContent = pendingReturns;
            }
            
            const completedReturnsEl = document.getElementById('completedReturns');
            if (completedReturnsEl) {
                completedReturnsEl.textContent = completedReturns;
            }
            
            // Add status summary
            updateStatusSummary(clients.length, activeClientsCount, pendingReturns, completedReturns);
            
            updateRecentActivity();
        }
        
        // Update status summary section
        function updateStatusSummary(totalClients, activeClients, pendingReturns, completedReturns) {
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const invoicedClients = new Set(allInvoices.map(inv => inv.clientName)).size;
            const readyForInvoicing = completedReturns - invoicedClients;
            const clientsNeedingAttention = totalClients - completedReturns;
            
            // Find or create status summary element
            let statusSummary = document.getElementById('statusSummary');
            if (!statusSummary) {
                // Create status summary element
                const dashboardContent = document.querySelector('.dashboard-content');
                if (dashboardContent) {
                    const statusDiv = document.createElement('div');
                    statusDiv.id = 'statusSummary';
                    statusDiv.style.marginBottom = '1.5rem';
                    dashboardContent.insertBefore(statusDiv, dashboardContent.firstChild);
                    statusSummary = statusDiv;
                }
            }
            
            if (statusSummary) {
                statusSummary.innerHTML = `
                    <div style="background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1rem 0; color: #374151; font-size: 1.125rem; font-weight: 600;"> Status Overview</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 0.5rem; border: 1px solid #e0f2fe;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0369a1;">${completedReturns}</div>
                                <div class="text-gray-500 text-sm"> Completed</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #dcfce7;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #16a34a;">${invoicedClients}</div>
                                <div class="text-gray-500 text-sm"> Invoiced</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #fefce8; border-radius: 0.5rem; border: 1px solid #fef3c7;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #ca8a04;">${readyForInvoicing}</div>
                                <div class="text-gray-500 text-sm"> Ready to Invoice</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #fef2f2; border-radius: 0.5rem; border: 1px solid #fecaca;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${clientsNeedingAttention}</div>
                                <div class="text-gray-500 text-sm"> Need Attention</div>
                            </div>
                        </div>
                        ${readyForInvoicing > 0 ? `
                            <div style="padding: 0.75rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.375rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: #92400e; font-weight: 500;">
                                    <span>
                                        <img src="assets/icons/info.svg" class="icon icon-sm icon-red-600" alt="Warning">
                                    </span>
                                    <span>${readyForInvoicing} client${readyForInvoicing !== 1 ? 's' : ''} ready for invoicing</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        // Update recent activity
        function updateRecentActivity() {
            const activityDiv = document.getElementById('recentActivity');
            
            if (clients.length === 0) {
                activityDiv.innerHTML = '<p style="color: #6b7280; text-align: center;">No recent activity</p>';
                return;
            }
            
            const recentClients = clients.slice(-3).reverse();
            activityDiv.innerHTML = recentClients.map(client => `
                <div style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                    <div class="font-medium">${client.firstName} ${client.lastName}</div>
                    <div class="text-sm text-gray-500">Connected ${client.connectedAt}</div>
                </div>
            `).join('');
        }
        
        // Load clients from real data storage
        function loadClients() {
            if (!practitioner) {
                // If no practitioner, ensure clients is an empty array
                clients = [];
                updateDashboard();
                return;
            }
            
            clients = cleartrackData.getConnectedUsers(practitioner.id) || [];
            
            // Calculate document and expense counts for each client
            clients.forEach(client => {
                const documents = cleartrackData.getUserDocuments(client.id);
                const expenses = cleartrackData.getUserExpenses(client.id);
                
                client.documentCount = documents ? documents.length : 0;
                client.expenseCount = expenses ? expenses.length : 0;
                client.totalExpenses = expenses ? expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0) : 0;
                
                // Update isActive status based on activity (documents or expenses)
                client.isActive = (client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0;
            });
            
            updateClientsDisplay();
            setupClientSearch();
            // Always update dashboard after loading clients
            updateDashboard();
        }
        
        // Original loadClients display logic (now in updateClientsDisplay)
        function loadClientsDisplay() {
            const clientsList = document.getElementById('clientsList');
            
            if (clients.length === 0) {
                clientsList.innerHTML = '<p style="color: #6b7280; text-align: center;">No clients connected yet</p>';
                return;
            }
            
            clientsList.innerHTML = clients.map(client => {
                // Get client's tax return and invoice status
                const clientTaxReturns = taxReturns.filter(tr => tr.userId === client.id);
                const clientInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id).filter(inv => 
                    inv.clientName === `${client.firstName} ${client.lastName}`
                );
                
                const hasCompletedReturn = clientTaxReturns.some(tr => tr.status === 'completed');
                const hasInvoice = clientInvoices.length > 0;
                const hasPendingReturn = clientTaxReturns.some(tr => tr.status === 'pending' || tr.status === 'in_progress');
                
                return `
                <div class="client-card">
                    <div class="client-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; color: #6b7280; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; overflow: hidden; flex-shrink: 0; border: 2px solid #e5e7eb;">
                                ${client.profileImage ? 
                                    `<img src="${client.profileImage}" alt="${client.firstName} ${client.lastName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />` : 
                                    client.firstName.charAt(0)
                                }
                            </div>
                        <div class="flex-1">
                            <div class="client-name">${client.firstName} ${client.lastName}</div>
                            <div class="client-email">${client.email}</div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                ${hasCompletedReturn ? 
                                    '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;"> Completed</span>' : 
                                    ''
                                }
                                ${hasInvoice ? 
                                    '<span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;"> Invoiced</span>' : 
                                    ''
                                }
                                ${hasPendingReturn ? 
                                    '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;"> Pending</span>' : 
                                    ''
                                }
                                ${!hasCompletedReturn && !hasInvoice && !hasPendingReturn ? 
                                    '<span style="background: #6b7280; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500;"> New</span>' : 
                                    ''
                                }
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-outline" onclick="viewClientDetails('${client.id}')">View Details</button>
                            <button class="btn btn-sm" onclick="disconnectClient('${client.id}')" style="background: #dc2626; color: white; border: none;">Disconnect</button>
                        </div>
                    </div>
                    <div class="client-stats">
                        <div class="client-stat">
                            <div class="client-stat-value">${client.documentCount || 0}</div>
                            <div class="client-stat-label">Documents</div>
                        </div>
                        <div class="client-stat">
                            <div class="client-stat-value">${client.vehicleCount || 0}</div>
                            <div class="client-stat-label">Vehicles</div>
                        </div>
                        <div class="client-stat">
                            <div class="client-stat-value">${client.expenseCount || 0}</div>
                            <div class="client-stat-label">Expenses</div>
                        </div>
                        <div class="client-stat">
                            <div class="client-stat-value">R ${(client.totalExpenses || 0).toLocaleString()}</div>
                            <div class="client-stat-label">Total Expenses</div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Setup client search functionality
        function setupClientSearch() {
            const searchInput = document.getElementById('clientSearchInput');
            const filterSelect = document.getElementById('clientFilterSelect');
            
            if (searchInput) {
                searchInput.addEventListener('input', handleClientSearch);
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', handleClientSearch);
            }
        }
        
        // Setup tax returns search functionality
        function setupTaxReturnsSearch() {
            const searchInput = document.getElementById('taxReturnsSearchInput');
            const filterSelect = document.getElementById('taxReturnsFilterSelect');
            
            if (searchInput) {
                searchInput.addEventListener('input', handleTaxReturnsSearch);
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', handleTaxReturnsSearch);
            }
        }
        
        // Setup invoice search functionality
        function setupInvoiceSearch() {
            const searchInput = document.getElementById('invoiceSearchInput');
            const filterSelect = document.getElementById('invoiceFilterSelect');
            
            if (searchInput) {
                searchInput.addEventListener('input', handleInvoiceSearch);
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', handleInvoiceSearch);
            }
        }
        
        // Handle invoice search and filtering
        function handleInvoiceSearch() {
            const searchTerm = document.getElementById('invoiceSearchInput').value.toLowerCase();
            const filterValue = document.getElementById('invoiceFilterSelect').value;
            
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            let filteredInvoices = allInvoices;
            
            // Apply text search
            if (searchTerm) {
                filteredInvoices = filteredInvoices.filter(invoice => 
                    invoice.clientName.toLowerCase().includes(searchTerm) ||
                    invoice.invoiceNumber.toLowerCase().includes(searchTerm) ||
                    invoice.total.toString().includes(searchTerm)
                );
            }
            
            // Apply status filter
            if (filterValue !== 'all') {
                switch (filterValue) {
                    case 'pending':
                        filteredInvoices = filteredInvoices.filter(invoice => invoice.status === 'pending');
                        break;
                    case 'paid':
                        filteredInvoices = filteredInvoices.filter(invoice => invoice.status === 'paid');
                        break;
                    case 'overdue':
                        filteredInvoices = filteredInvoices.filter(invoice => 
                            new Date(invoice.dueDate) < new Date() && invoice.status !== 'paid'
                        );
                        break;
                    case 'current-year':
                        const currentYear = new Date().getFullYear();
                        filteredInvoices = filteredInvoices.filter(invoice => 
                            new Date(invoice.invoiceDate).getFullYear() === currentYear
                        );
                        break;
                }
            }
            
            updateInvoicesDisplay(filteredInvoices);
        }
        
        // Handle client search and filtering
        function handleClientSearch() {
            const searchTerm = document.getElementById('clientSearchInput').value.toLowerCase();
            const filterValue = document.getElementById('clientFilterSelect').value;
            
            let filteredClients = clients;
            
            // Apply search filter
            if (searchTerm) {
                filteredClients = filteredClients.filter(client => 
                    client.firstName.toLowerCase().includes(searchTerm) ||
                    client.lastName.toLowerCase().includes(searchTerm) ||
                    client.email.toLowerCase().includes(searchTerm) ||
                    (client.phone && client.phone.includes(searchTerm))
                );
            }
            
            // Apply category filter
            switch (filterValue) {
                case 'with-documents':
                    filteredClients = filteredClients.filter(client => (client.documentCount || 0) > 0);
                    break;
                case 'with-expenses':
                    filteredClients = filteredClients.filter(client => (client.expenseCount || 0) > 0);
                    break;
                case 'recent':
                    filteredClients = filteredClients.filter(client => {
                        const createdAt = new Date(client.createdAt);
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        return createdAt > thirtyDaysAgo;
                    });
                    break;
            }
            
            // Update display
            updateClientsDisplay(filteredClients);
        }
        
        // Handle tax returns search and filtering
        function handleTaxReturnsSearch() {
            const searchTerm = document.getElementById('taxReturnsSearchInput').value.toLowerCase();
            const filterValue = document.getElementById('taxReturnsFilterSelect').value;
            
            let filteredReturns = taxReturns;
            
            // Apply text search
            if (searchTerm) {
                filteredReturns = filteredReturns.filter(return_ => 
                    return_.clientName.toLowerCase().includes(searchTerm) ||
                    (return_.taxYear && return_.taxYear.toString().includes(searchTerm)) ||
                    return_.status.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply status filter
            if (filterValue !== 'all') {
                switch (filterValue) {
                    case 'pending':
                        filteredReturns = filteredReturns.filter(return_ => return_.status === 'pending');
                        break;
                    case 'in_progress':
                        filteredReturns = filteredReturns.filter(return_ => return_.status === 'in_progress');
                        break;
                    case 'completed':
                        filteredReturns = filteredReturns.filter(return_ => return_.status === 'completed');
                        break;
                    case 'current-year':
                        const currentYear = new Date().getFullYear();
                        filteredReturns = filteredReturns.filter(return_ => 
                            return_.taxYear === currentYear
                        );
                        break;
                }
            }
            
            updateTaxReturnsDisplay(filteredReturns);
        }
        
        // Update clients display with optional filtered list
        function updateClientsDisplay(clientList = null) {
            const displayClients = clientList || clients;
            const clientsList = document.getElementById('clientsList');
            const clientCount = document.getElementById('clientCount');
            
            if (clientCount) {
                clientCount.textContent = `${displayClients.length} client${displayClients.length !== 1 ? 's' : ''}`;
            }
            
            if (displayClients.length === 0) {
                clientsList.innerHTML = '<p style="color: #6b7280; text-align: center;">No clients found</p>';
                return;
            }
            
            clientsList.innerHTML = displayClients.map(client => `
                <div class="client-card">
                    <div class="client-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; color: #6b7280; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; overflow: hidden; flex-shrink: 0; border: 2px solid #e5e7eb;">
                                ${client.profileImage ? 
                                    `<img src="${client.profileImage}" alt="${client.firstName} ${client.lastName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />` : 
                                    client.firstName.charAt(0)
                                }
                        </div>
                        <div>
                            <div class="client-name">${client.firstName} ${client.lastName}</div>
                            <div class="client-email">${client.email}</div>
                        </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-outline" onclick="viewClientDetails('${client.id}')">View Details</button>
                            <button class="btn btn-sm" onclick="disconnectClient('${client.id}')" style="background: #dc2626; color: white; border: none;">Disconnect</button>
                        </div>
                    </div>
                    <div class="client-stats">
                        <div class="client-stat">
                            <div class="client-stat-value">${client.documentCount || 0}</div>
                            <div class="client-stat-label">Documents</div>
                        </div>
                        <div class="client-stat">
                            <div class="client-stat-value">${client.vehicleCount || 0}</div>
                            <div class="client-stat-label">Vehicles</div>
                        </div>
                        <div class="client-stat">
                            <div class="client-stat-value">${client.expenseCount || 0}</div>
                            <div class="client-stat-label">Expenses</div>
                        </div>
                        <div class="client-stat">
                            <div class="client-stat-value">R ${(client.totalExpenses || 0).toLocaleString()}</div>
                            <div class="client-stat-label">Total Expenses</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Load tax returns from real data storage
        function loadTaxReturns() {
            if (!practitioner) return;
            
            taxReturns = cleartrackData.getTaxReturnsForPractitioner(practitioner.id);
            updateTaxReturnsDisplay();
            setupTaxReturnsSearch();
        }
        
        // Load invoices from real data storage
        function loadInvoices() {
            console.log(' loadInvoices called');
            if (!practitioner) {
                console.log(' No practitioner found');
                return;
            }
            
            console.log(' Practitioner ID:', practitioner.id);
            const invoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            console.log(' Raw invoices from storage:', invoices);
            console.log(' Invoice count:', invoices.length);
            
            // Clean up potential duplicates
            const cleanedInvoices = cleanDuplicateInvoices(invoices);
            console.log(' Cleaned invoices:', cleanedInvoices);
            console.log(' Cleaned invoice count:', cleanedInvoices.length);
            
            updateInvoicesDisplay(cleanedInvoices);
            setupInvoiceSearch();
        }
        
        // Clean up duplicate invoices
        function cleanDuplicateInvoices(invoices) {
            const uniqueInvoices = [];
            const seenNumbers = new Set();
            const seenCombinations = new Set();
            
            for (const invoice of invoices) {
                // Create a unique combination key for the same client, tax year, and amount
                const combinationKey = `${invoice.clientName}-${invoice.taxYear}-${invoice.amount}-${invoice.invoiceDate}`;
                
                // Check for duplicate invoice numbers
                if (seenNumbers.has(invoice.invoiceNumber)) {
                    continue;
                }
                
                // Check for duplicate combinations (same client, tax year, amount, date)
                if (seenCombinations.has(combinationKey)) {
                    continue;
                }
                
                seenNumbers.add(invoice.invoiceNumber);
                seenCombinations.add(combinationKey);
                uniqueInvoices.push(invoice);
            }
            
            // If we found duplicates, update the data storage
            if (uniqueInvoices.length !== invoices.length) {
                console.log(`Cleaned up ${invoices.length - uniqueInvoices.length} duplicate invoices`);
                
                // Update data storage with cleaned invoices
                const data = cleartrackData.getData();
                if (data.invoices) {
                    const cleanedInvoiceData = {};
                    uniqueInvoices.forEach(invoice => {
                        cleanedInvoiceData[invoice.id] = invoice;
                    });
                    data.invoices = cleanedInvoiceData;
                    cleartrackData.setData(data);
                }
            }
            
            return uniqueInvoices;
        }
        
        // Update invoices display
        function updateInvoicesDisplay(invoiceList = null) {
            console.log(' updateInvoicesDisplay called with:', invoiceList);
            const displayInvoices = invoiceList || [];
            const invoicesList = document.getElementById('invoicesList');
            const invoiceCount = document.getElementById('invoiceCount');
            
            console.log(' Display invoices count:', displayInvoices.length);
            console.log(' Invoices list element:', invoicesList);
            console.log(' Invoice count element:', invoiceCount);
            
            if (invoiceCount) {
                invoiceCount.textContent = `${displayInvoices.length} invoice${displayInvoices.length !== 1 ? 's' : ''}`;
            }
            
            if (displayInvoices.length === 0) {
                invoicesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="margin-bottom: 16px;">
                            <img src="assets/icons/folder.svg" class="icon icon-2xl icon-gray-500" alt="Invoice">
                        </div>
                        <h3 style="margin: 0 0 8px 0; color: #374151;">No invoices found</h3>
                        <p class="no-client-text">Generate your first invoice from the Tax Returns tab.</p>
                    </div>
                `;
                return;
            }
            
            invoicesList.innerHTML = displayInvoices.map(invoice => {
                const isOverdue = new Date(invoice.dueDate) < new Date() && invoice.status !== 'paid';
                const statusClass = invoice.status === 'paid' ? 'success' : isOverdue ? 'error' : 'warning';
                const statusText = invoice.status === 'paid' ? 'Paid' : isOverdue ? 'Overdue' : 'Pending';
                
                return `
                    <div class="invoice-card" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 16px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: #374151; font-size: 18px;">${invoice.invoiceNumber}</h4>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">${invoice.clientName}  Tax Year ${invoice.taxYear}</p>
                            </div>
                            <div style="text-align: right;">
                                <span class="status ${statusClass}" style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; margin-bottom: 8px;">
                                    ${statusText}
                                </span>
                                <div style="font-size: 20px; font-weight: bold; color: #0b7285;">R ${(invoice.total || 0).toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px; font-size: 14px; color: #6b7280;">
                            <div>
                                <strong>Invoice Date:</strong><br>
                                ${new Date(invoice.invoiceDate).toLocaleDateString()}
                            </div>
                            <div>
                                <strong>Due Date:</strong><br>
                                ${new Date(invoice.dueDate).toLocaleDateString()}
                            </div>
                            <div>
                                <strong>Amount:</strong><br>
                                R ${invoice.amount.toFixed(2)}
                            </div>
                            <div>
                                <strong>VAT:</strong><br>
                                R ${invoice.vat.toFixed(2)} (${getVATLabel(invoice.vatType)})
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-outline" onclick="viewInvoiceFromList('${invoice.id}')" class="flex items-center gap-1">
                                <img src="assets/icons/eye.svg" class="icon icon-sm" alt="View"> View
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="downloadInvoice('${invoice.id}')" class="flex items-center gap-1">
                                <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download"> Download
                            </button>
                            <button class="btn btn-sm btn-success" onclick="chatInvoice('${invoice.id}')" class="flex items-center gap-1">
                                <img src="assets/icons/message.svg" class="icon icon-sm" alt="Send Chat"> Send Chat
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="emailInvoice('${invoice.id}')" class="flex items-center gap-1">
                                <img src="assets/icons/email.svg" class="icon icon-sm" alt="Email"> Email
                            </button>
                            ${invoice.status !== 'paid' ? `
                                <button class="btn btn-sm btn-success" onclick="markInvoicePaid('${invoice.id}')" class="flex items-center gap-1">
                                    <img src="assets/icons/check.svg" class="icon icon-sm icon-green-600" alt="Mark Paid"> Mark Paid
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${invoice.id}')" class="flex items-center gap-1" style="background: #dc2626; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer;">
                                <img src="assets/icons/trash.svg" class="icon icon-sm" alt="Delete" style="width: 16px; height: 16px;"> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update tax returns display with optional filtered list
        function updateTaxReturnsDisplay(returnList = null) {
            const displayReturns = returnList || taxReturns;
            const tbody = document.getElementById('taxReturnsTable');
            const returnsCount = document.getElementById('taxReturnsCount');
            
            if (returnsCount) {
                returnsCount.textContent = `${displayReturns.length} return${displayReturns.length !== 1 ? 's' : ''}`;
            }
            
            if (displayReturns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="table-empty-cell">No tax returns found</td></tr>';
                return;
            }
            
            tbody.innerHTML = displayReturns.map(return_ => {
                // Check if invoice actually exists for this tax return (don't rely on flag)
                const existingInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
                const hasInvoice = existingInvoices.some(inv => 
                    inv.clientName === return_.clientName && 
                    inv.taxYear === return_.taxYear &&
                    inv.practitionerId === practitioner.id
                );
                
                // Sync the flag with actual invoice existence
                if (return_.invoiceGenerated !== hasInvoice) {
                    const data = cleartrackData.getData();
                    if (data.taxReturns && data.taxReturns[return_.id]) {
                        data.taxReturns[return_.id].invoiceGenerated = hasInvoice;
                        cleartrackData.setData(data);
                    }
                }
                
                return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>${return_.clientName}</span>
                            ${hasInvoice ? 
                                '<span style="background: #3b82f6; color: white; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;"> Invoiced</span>' : 
                                ''
                            }
                        </div>
                    </td>
                    <td>${return_.taxYear || new Date().getFullYear()}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="status ${return_.status}">${return_.status}</span>
                            ${return_.status === 'completed' ? 
                                '<span style="color: #10b981; font-size: 0.875rem;"></span>' : 
                                return_.status === 'pending' ? 
                                '<span style="color: #f59e0b; font-size: 0.875rem;"></span>' : 
                                '<span class="text-gray-500 text-sm"></span>'
                            }
                        </div>
                    </td>
                    <td>${return_.documents || 0}</td>
                    <td>${return_.expenses || 0}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-outline" onclick="viewInvoiceFromTaxReturn('${return_.id}')" style="background: #f8fafc; border: 1px solid #e2e8f0; color: #475569; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;">
                                <img src="assets/icons/document.svg" class="icon icon-sm" alt="Invoice"> View Invoice
                            </button>
                            ${return_.status === 'pending' || return_.status === 'in_progress' ? 
                                `<button class="btn btn-sm btn-success" onclick="markTaxReturnCompleted('${return_.id}')" title="Mark as completed" style="background: #10b981; color: white; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; border: none; transition: all 0.2s;"> Complete</button>` : 
                                return_.status === 'completed' ? 
                                    `<div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-primary" onclick="generateInvoice('${return_.id}')" title="Generate invoice" style="background: #3b82f6; color: white; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; border: none; transition: all 0.2s;">
                                        <img src="assets/icons/money.svg" class="icon icon-sm" alt="Invoice"> Generate Invoice
                                        </button>
                                        ${hasInvoice ? 
                                            `<span style="color: #10b981; font-size: 0.875rem; font-weight: 500;"> Has Invoice</span>` : 
                                            ''
                                        }
                                    </div>` :
                                    ''
                            }
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        // Add client modal
        function showAddClientModal() {
            const modal = document.getElementById('addClientModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function hideAddClientModal() {
            const modal = document.getElementById('addClientModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            document.getElementById('addClientForm').reset();
        }

        function hideAddClientModalOnOverlay(event) {
            if (event.target.id === 'addClientModal') {
                hideAddClientModal();
            }
        }
        
        // Add client form
        document.getElementById('addClientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newClient = {
                id: Date.now(),
                firstName: document.getElementById('clientFirstName').value,
                lastName: document.getElementById('clientLastName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                taxNumber: document.getElementById('clientTaxNumber').value,
                notes: document.getElementById('clientNotes').value,
                status: 'active',
                connectedAt: new Date().toLocaleDateString(),
                documents: 0,
                vehicles: 0,
                expenses: 0,
                totalExpenses: 0
            };
            
            clients.push(newClient);
            loadClients();
            updateDashboard();
            hideAddClientModal();
            
            alert('Client added successfully!');
        });
        
        // View client details
        function viewClientDetails(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Get client's tax returns and invoices for enhanced display
            const clientTaxReturns = taxReturns.filter(tr => tr.userId === client.id);
            const clientInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id).filter(inv => 
                inv.clientName === `${client.firstName} ${client.lastName}`
            );
            
            const hasCompletedReturn = clientTaxReturns.some(tr => tr.status === 'completed');
            const hasInvoice = clientInvoices.length > 0;
            const hasPendingReturn = clientTaxReturns.some(tr => tr.status === 'pending' || tr.status === 'in_progress');
            
            document.getElementById('clientDetailsTitle').textContent = `${client.firstName} ${client.lastName} - Details`;
            
            document.getElementById('clientDetailsContent').innerHTML = `
                <!-- Enhanced Client Header -->
                <div class="enhanced-client-header">
                    <div class="client-avatar-section">
                        <div class="client-avatar-large">
                            ${client.profileImage ? 
                                `<img src="${client.profileImage}" alt="${client.firstName} ${client.lastName}" class="client-avatar-img" />` : 
                                client.firstName.charAt(0)
                            }
                        </div>
                        <div class="client-status-badges">
                            ${hasCompletedReturn ? '<span class="status-badge status-completed"><img src="assets/icons/check.svg" class="icon icon-sm" alt="Completed"> Completed</span>' : ''}
                            ${hasInvoice ? '<span class="status-badge status-invoiced"><img src="assets/icons/money.svg" class="icon icon-sm" alt="Invoiced"> Invoiced</span>' : ''}
                            ${hasPendingReturn ? '<span class="status-badge status-pending"><img src="assets/icons/clock.svg" class="icon icon-sm" alt="Pending"> Pending</span>' : ''}
                            ${!hasCompletedReturn && !hasInvoice && !hasPendingReturn ? '<span class="status-badge status-new"><img src="assets/icons/document.svg" class="icon icon-sm" alt="New"> New</span>' : ''}
                        </div>
                    </div>
                    <div class="client-info-section">
                        <h2 class="client-name-large">${client.firstName} ${client.lastName}</h2>
                        <p class="client-email-large">${client.email}</p>
                        <p class="client-phone-large">${client.phone || 'No phone provided'}</p>
                        <p class="client-connected">Connected: ${client.createdAt ? new Date(client.createdAt).toLocaleDateString() : 'Unknown'}</p>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                <div class="quick-actions-section">
                    <h3 class="section-title">
                        <img src="assets/icons/star.svg" class="icon icon-sm" alt="Actions">
                        Quick Actions
                    </h3>
                    <div class="actions-grid">
                        <button class="action-btn" onclick="generateTaxReturn('${clientId}')">
                            <img src="assets/icons/document.svg" class="icon" alt="Tax Return">
                            <span>Generate Tax Return</span>
                        </button>
                        <button class="action-btn" onclick="generateInvoiceForClient('${clientId}')">
                            <img src="assets/icons/money.svg" class="icon" alt="Invoice">
                            <span>Generate Invoice</span>
                        </button>
                        <button class="action-btn" onclick="markClientAsComplete('${clientId}')">
                            <img src="assets/icons/check.svg" class="icon" alt="Complete">
                            <span>Mark as Complete</span>
                        </button>
                        <button class="action-btn" onclick="viewClientDocuments('${clientId}')">
                            <img src="assets/icons/document.svg" class="icon" alt="Documents">
                            <span>View Documents</span>
                        </button>
                        <button class="action-btn" onclick="downloadAllClientFiles('${clientId}')">
                            <img src="assets/icons/download.svg" class="icon" alt="Download">
                            <span>Download All</span>
                        </button>
                        <button class="action-btn" onclick="sendMessageToClient('${clientId}')">
                            <img src="assets/icons/message.svg" class="icon" alt="Message">
                            <span>Send Message</span>
                        </button>
                        <button class="action-btn" onclick="updateClientStatus('${clientId}')">
                            <img src="assets/icons/info.svg" class="icon" alt="Status">
                            <span>Update Status</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity Section -->
                <div class="recent-activity-section">
                    <h3 class="section-title">
                        <img src="assets/icons/clock.svg" class="icon icon-sm" alt="Activity">
                        Recent Activity
                    </h3>
                    <div class="activity-timeline">
                        ${clientInvoices.length > 0 ? `
                            <div class="activity-item">
                                <div class="activity-icon activity-invoice">
                                    <img src="assets/icons/document.svg" class="icon" alt="Invoice">
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Invoice ${clientInvoices[clientInvoices.length - 1].invoiceNumber} generated</div>
                                    <div class="activity-time">${new Date(clientInvoices[clientInvoices.length - 1].createdAt).toLocaleDateString()}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${client.documentCount > 0 ? `
                            <div class="activity-item">
                                <div class="activity-icon activity-document">
                                    <img src="assets/icons/folder.svg" class="icon" alt="Document">
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${client.documentCount} document(s) uploaded</div>
                                    <div class="activity-time">Recently</div>
                                </div>
                            </div>
                        ` : ''}
                        ${hasCompletedReturn ? `
                            <div class="activity-item">
                                <div class="activity-icon activity-complete">
                                    <img src="assets/icons/check.svg" class="icon" alt="Complete">
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Tax return marked as completed</div>
                                    <div class="activity-time">Recently</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Documents Section -->
                <div class="documents-section">
                    <h3 class="section-title">
                        <img src="assets/icons/document.svg" class="icon icon-sm" alt="Documents">
                        Documents & Files (${client.documentCount || 0})
                    </h3>
                    <div class="documents-grid">
                        <div class="document-item">
                            <div class="document-icon">
                                <img src="assets/icons/document.svg" class="icon" alt="Tax Documents">
                            </div>
                            <div class="document-info">
                                <div class="document-name">Tax Documents</div>
                                <div class="document-count">${client.documentCount || 0} files</div>
                            </div>
                        </div>
                        <div class="document-item">
                            <div class="document-icon">
                                <img src="assets/icons/money.svg" class="icon" alt="Financial Records">
                            </div>
                            <div class="document-info">
                                <div class="document-name">Financial Records</div>
                                <div class="document-count">${client.expenseCount || 0} expenses</div>
                            </div>
                        </div>
                        <div class="document-item">
                            <div class="document-icon">
                                <img src="assets/icons/car.svg" class="icon" alt="Vehicle Records">
                            </div>
                            <div class="document-info">
                                <div class="document-name">Vehicle Records</div>
                                <div class="document-count">${client.vehicleCount || 0} vehicles</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoices Section -->
                <div class="invoices-section">
                    <h3 class="section-title">
                        <img src="assets/icons/money.svg" class="icon icon-sm" alt="Invoices">
                        Invoices (${clientInvoices.length})
                    </h3>
                    ${clientInvoices.length > 0 ? `
                        <div class="invoices-list">
                            ${clientInvoices.map(invoice => `
                                <div class="invoice-item">
                                    <div class="invoice-info">
                                        <div class="invoice-number">${invoice.invoiceNumber}</div>
                                        <div class="invoice-amount">R ${(invoice.total || 0).toLocaleString()}</div>
                                    </div>
                                    <div class="invoice-status status-${invoice.status}">${invoice.status}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="no-invoices">No invoices generated yet</p>'}
                </div>

                <!-- Contact Information Section -->
                <div class="contact-info-section">
                    <h3 class="section-title">
                        <img src="assets/icons/info.svg" class="icon icon-sm" alt="Contact">
                        Contact Information
                    </h3>
                    <div class="contact-details">
                        <div class="contact-item">
                            <span class="contact-label">Email:</span>
                            <span class="contact-value">${client.email}</span>
                        </div>
                        <div class="contact-item">
                            <span class="contact-label">Phone:</span>
                            <span class="contact-value">${client.phone || 'Not provided'}</span>
                        </div>
                        <div class="contact-item">
                            <span class="contact-label">Tax Number:</span>
                            <span class="contact-value">${client.taxNumber || 'Not provided'}</span>
                        </div>
                        <div class="contact-item">
                            <span class="contact-label">ID Number:</span>
                            <span class="contact-value">${client.idNumber || 'Not provided'}</span>
                        </div>
                        <div class="contact-item">
                            <span class="contact-label">Address:</span>
                            <span class="contact-value">${client.address || 'Not provided'}</span>
                        </div>
                    </div>
                </div>

                <!-- Tax Data Summary -->
                <div class="tax-summary-section">
                    <h3 class="section-title">
                        <img src="assets/icons/info.svg" class="icon icon-sm" alt="Summary">
                        Tax Data Summary
                    </h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-number">${client.documentCount || 0}</div>
                            <div class="summary-label">Documents</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number">${client.vehicleCount || 0}</div>
                            <div class="summary-label">Vehicles</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number">${client.expenseCount || 0}</div>
                            <div class="summary-label">Expenses</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number">R ${(client.totalExpenses || 0).toLocaleString()}</div>
                            <div class="summary-label">Total Expenses</div>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Tab Section -->
                <div class="vehicle-tab-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <img src="assets/icons/car.svg" class="icon icon-sm" alt="Vehicles">
                            Vehicle Information (${client.vehicleCount || 0})
                        </h3>
                        <button class="btn btn-outline btn-sm" onclick="openVehicleModal('${clientId}')">
                            <img src="assets/icons/eye.svg" class="icon icon-sm" alt="View">
                            View Vehicle Details
                        </button>
                    </div>
                </div>

                <!-- Expense Tab Section -->
                <div class="expense-tab-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <img src="assets/icons/money.svg" class="icon icon-sm" alt="Expenses">
                            Expense Information (${client.expenseCount || 0})
                        </h3>
                        ${(client.expenseCount || 0) > 0 ? `
                            <button class="btn btn-outline btn-sm" onclick="openExpenseModal('${clientId}')">
                                <img src="assets/icons/eye.svg" class="icon icon-sm" alt="View">
                                View Expense Details
                            </button>
                        ` : ''}
                    </div>
                </div>

                <!-- Client Notes Section -->
                <div class="notes-section">
                    <h3 class="section-title">
                        <img src="assets/icons/info.svg" class="icon icon-sm" alt="Notes">
                        Client Notes
                    </h3>
                    <textarea class="client-notes-textarea" placeholder="Add notes about this client..." id="clientNotes_${clientId}">${client.notes || ''}</textarea>
                    <button class="btn btn-primary btn-sm" onclick="saveClientNotes('${clientId}')">Save Notes</button>
                </div>
                
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="hideClientDetailsModal()">Close</button>
                    <button class="btn btn-primary" onclick="editClient('${clientId}')">Edit Client</button>
                </div>
            `;
            
            document.getElementById('clientDetailsModal').classList.remove('hidden');
        }
        
        function hideClientDetailsModal() {
            document.getElementById('clientDetailsModal').classList.add('hidden');
        }

        // Function to open vehicle details modal
        function openVehicleModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }

            document.getElementById('vehicleDetailsTitle').textContent = `Vehicle Details - ${client.firstName} ${client.lastName}`;
            document.getElementById('vehicleDetailsContent').innerHTML = getProfessionalVehicleDisplay(client);
            document.getElementById('vehicleDetailsModal').classList.remove('hidden');
        }

        // Function to hide vehicle modal
        function hideVehicleModal() {
            document.getElementById('vehicleDetailsModal').classList.add('hidden');
        }

        // Professional vehicle display for modal
        function getProfessionalVehicleDisplay(client) {
            if (!client || !client.vehicles || client.vehicles.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <img src="assets/icons/car.svg" alt="No vehicles" style="width: 64px; height: 64px; opacity: 0.3;">
                        </div>
                        <h3 style="color: #6b7280; margin: 1rem 0 0.5rem 0;">No Vehicles Registered</h3>
                        <p style="color: #9ca3af; margin: 0;">This client hasn't registered any vehicles yet.</p>
                    </div>
                `;
            }

            return `
                <div class="vehicle-modal-content">
                    <div class="vehicle-summary">
                        <div class="summary-card">
                            <div class="summary-icon">
                                <img src="assets/icons/car.svg" alt="Total Vehicles">
                            </div>
                            <div class="summary-info">
                                <div class="summary-number">${client.vehicles.length}</div>
                                <div class="summary-label">Total Vehicles</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">
                                <img src="assets/icons/road.svg" alt="Total Mileage">
                            </div>
                            <div class="summary-info">
                                <div class="summary-number">${getTotalMileage(client.vehicles).toLocaleString()}</div>
                                <div class="summary-label">Total Mileage (km)</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">
                                <img src="assets/icons/percent.svg" alt="Average Business Use">
                            </div>
                            <div class="summary-info">
                                <div class="summary-number">${getAverageBusinessUse(client.vehicles)}%</div>
                                <div class="summary-label">Avg Business Use</div>
                            </div>
                        </div>
                    </div>

                    <div class="vehicle-list-detailed">
                        ${client.vehicles.map((vehicle, index) => `
                            <div class="vehicle-card-detailed">
                                <div class="vehicle-card-header">
                                    <div class="vehicle-main-info">
                                        <div class="vehicle-icon-large">
                                            <img src="assets/icons/car.svg" alt="Vehicle">
                                        </div>
                                        <div class="vehicle-title-section">
                                            <h3 class="vehicle-name">${vehicle.make} ${vehicle.model}</h3>
                                            <p class="vehicle-registration">Registration: ${vehicle.registration}</p>
                                        </div>
                                    </div>
                                    <div class="vehicle-status">
                                        <span class="status-badge ${vehicle.businessUsePercentage > 50 ? 'status-high' : 'status-medium'}">
                                            ${vehicle.businessUsePercentage || 0}% Business Use
                                        </span>
                                    </div>
                                </div>

                                <div class="vehicle-details-section">
                                    <div class="details-grid">
                                        <div class="detail-item">
                                            <label>Year of Manufacture</label>
                                            <span class="detail-value">${vehicle.year}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Fuel Type</label>
                                            <span class="detail-value">${vehicle.fuelType || 'Not specified'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Business Use Percentage</label>
                                            <span class="detail-value">${vehicle.businessUsePercentage || 0}%</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Current Mileage</label>
                                            <span class="detail-value">${vehicle.mileage ? vehicle.mileage.toLocaleString() : '0'} km</span>
                                        </div>
                                    </div>

                                    <div class="mileage-tracking">
                                        <h4 class="mileage-title">Mileage Tracking</h4>
                                        <div class="mileage-inputs">
                                            <div class="mileage-input-group">
                                                <label for="openingMileage_${index}">Opening Mileage (km)</label>
                                                <input type="number" id="openingMileage_${index}" class="mileage-input" 
                                                       value="${vehicle.openingMileage || ''}" 
                                                       placeholder="Enter opening mileage">
                                            </div>
                                            <div class="mileage-input-group">
                                                <label for="closingMileage_${index}">Closing Mileage (km)</label>
                                                <input type="number" id="closingMileage_${index}" class="mileage-input" 
                                                       value="${vehicle.closingMileage || ''}" 
                                                       placeholder="Enter closing mileage">
                                            </div>
                                        </div>
                                        <div class="mileage-calculations">
                                            <div class="calculation-item">
                                                <span class="calc-label">Business Mileage:</span>
                                                <span class="calc-value">${calculateBusinessMileage(vehicle)} km</span>
                                            </div>
                                            <div class="calculation-item">
                                                <span class="calc-label">Total Distance:</span>
                                                <span class="calc-value">${calculateTotalDistance(vehicle)} km</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Helper functions for vehicle calculations
        function getTotalMileage(vehicles) {
            return vehicles.reduce((total, vehicle) => total + (vehicle.mileage || 0), 0);
        }

        function getAverageBusinessUse(vehicles) {
            if (vehicles.length === 0) return 0;
            const total = vehicles.reduce((sum, vehicle) => sum + (vehicle.businessUsePercentage || 0), 0);
            return Math.round(total / vehicles.length);
        }

        function calculateBusinessMileage(vehicle) {
            const opening = vehicle.openingMileage || 0;
            const closing = vehicle.closingMileage || vehicle.mileage || 0;
            const totalDistance = closing - opening;
            const businessPercentage = (vehicle.businessUsePercentage || 0) / 100;
            return Math.round(totalDistance * businessPercentage);
        }

        function calculateTotalDistance(vehicle) {
            const opening = vehicle.openingMileage || 0;
            const closing = vehicle.closingMileage || vehicle.mileage || 0;
            return Math.max(0, closing - opening);
        }

        // Clean rebuild of generate invoice function
        function generateInvoiceForClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            // Refresh client status before opening invoice modal
            refreshClientStatus();
            
            // Simply open the invoice modal for editing
            openInvoiceModalForClient(clientId, `${client.firstName} ${client.lastName}`, client.email);
        }
        
        // Function to refresh client status
        function refreshClientStatus() {
            clients.forEach(client => {
                const documents = cleartrackData.getUserDocuments(client.id);
                const expenses = cleartrackData.getUserExpenses(client.id);
                
                client.documentCount = documents ? documents.length : 0;
                client.expenseCount = expenses ? expenses.length : 0;
                client.isActive = (client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0;
            });
        }
        
        // Function to open expense details modal
        function openExpenseModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const expenses = cleartrackData.getUserExpenses(clientId);
            if (!expenses || expenses.length === 0) {
                alert('No expenses found for this client');
                return;
            }
            
            const modal = document.getElementById('expenseModal');
            const content = document.getElementById('expenseContent');
            
            // Calculate totals
            const totalAmount = expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const businessAmount = expenses.reduce((sum, exp) => sum + ((exp.amount || 0) * (exp.businessUse || 0) / 100), 0);
            const personalAmount = totalAmount - businessAmount;
            
            // Group expenses by category
            const expensesByCategory = expenses.reduce((acc, expense) => {
                const category = expense.category || 'Other';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(expense);
                return acc;
            }, {});
            
            content.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px;">${client.firstName} ${client.lastName} - Expense Details</h4>
                        <p style="color: #6b7280; margin: 0;">Total: ${expenses.length} expenses</p>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 24px; font-weight: bold; color: #1f2937;">R ${totalAmount.toLocaleString()}</div>
                            <div style="color: #6b7280; font-size: 14px;">Total Expenses</div>
                        </div>
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #bae6fd;">
                            <div style="font-size: 24px; font-weight: bold; color: #0369a1;">R ${businessAmount.toLocaleString()}</div>
                            <div style="color: #6b7280; font-size: 14px;">Business Use</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border: 1px solid #fde68a;">
                            <div style="font-size: 24px; font-weight: bold; color: #92400e;">R ${personalAmount.toLocaleString()}</div>
                            <div style="color: #6b7280; font-size: 14px;">Personal Use</div>
                        </div>
                    </div>
                    
                    <!-- Download Button -->
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="downloadExpenses('${clientId}')">
                            <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download">
                            Download All Expenses (CSV)
                        </button>
                    </div>
                    
                    <!-- Expenses by Category -->
                    ${Object.entries(expensesByCategory).map(([category, categoryExpenses]) => `
                        <div style="margin-bottom: 25px;">
                            <h5 style="color: #374151; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb;">
                                ${category.replace('_', ' ').toUpperCase()} (${categoryExpenses.length})
                            </h5>
                            <div style="display: grid; gap: 10px;">
                                ${categoryExpenses.map(expense => `
                                    <div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #374151; font-size: 16px;">${expense.description}</div>
                                                <div style="font-weight: bold; color: #1f2937; font-size: 18px; margin-top: 4px;">R ${expense.amount.toLocaleString()}</div>
                                            </div>
                                            ${expense.document ? `
                                                <button class="btn btn-outline btn-sm" onclick="viewExpenseDocument('${clientId}', '${expense.id}')" style="margin-left: 0.5rem; flex-shrink: 0;">
                                                    <img src="assets/icons/document.svg" class="icon icon-sm" alt="View">
                                                    View Document
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 8px;">
                                            <div style="color: #6b7280; font-size: 14px;">
                                                <strong>Date:</strong> ${new Date(expense.date).toLocaleDateString()}
                                            </div>
                                            <div style="color: #6b7280; font-size: 14px;">
                                                <strong>Business Use:</strong> ${expense.businessUse || 0}%
                                            </div>
                                            <div style="color: #6b7280; font-size: 14px;">
                                                <strong>Business Amount:</strong> R ${((expense.amount || 0) * (expense.businessUse || 0) / 100).toLocaleString()}
                                            </div>
                                            <div style="color: #6b7280; font-size: 14px;">
                                                <strong>Personal Amount:</strong> R ${((expense.amount || 0) * (100 - (expense.businessUse || 0)) / 100).toLocaleString()}
                                            </div>
                                        </div>
                                        ${expense.notes ? `
                                            <div style="color: #6b7280; font-size: 14px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                                <strong>Notes:</strong> ${expense.notes}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        // Function to close expense modal
        function closeExpenseModal() {
            const modal = document.getElementById('expenseModal');
            modal.classList.add('hidden');
        }
        
        // Function to download expenses as CSV
        function downloadExpenses(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const expenses = cleartrackData.getUserExpenses(clientId);
            if (!expenses || expenses.length === 0) {
                alert('No expenses found for this client');
                return;
            }
            
            // Create CSV content
            const headers = ['Date', 'Description', 'Category', 'Amount', 'Business Use %', 'Business Amount', 'Personal Amount', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...expenses.map(expense => [
                    new Date(expense.date).toLocaleDateString(),
                    `"${(expense.description || '').replace(/"/g, '""')}"`,
                    `"${(expense.category || '').replace('_', ' ')}"`,
                    expense.amount || 0,
                    expense.businessUse || 0,
                    ((expense.amount || 0) * (expense.businessUse || 0) / 100).toFixed(2),
                    ((expense.amount || 0) * (100 - (expense.businessUse || 0)) / 100).toFixed(2),
                    `"${(expense.notes || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${client.firstName}_${client.lastName}_Expenses_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        
        // Clean rebuild of client selection modal for invoice generation
        function openClientSelectionModal() {
            // Close any existing modals first
            hideClientDetailsModal();
            
            // Create a simple, clean modal
            const modal = document.createElement('div');
            modal.id = 'clientSelectionModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10003;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 8px;
                    width: 90%;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                ">
                    <div style="
                        padding: 20px;
                        border-bottom: 1px solid #e5e7eb;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; color: #374151;">Select Client for Invoice</h3>
                        <button onclick="closeClientSelectionModal()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6b7280;
                        ">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        ${clients.map(client => `
                            <div onclick="selectClientForInvoice('${client.id}')" style="
                                display: flex;
                                align-items: center;
                                padding: 15px;
                                border: 1px solid #e5e7eb;
                                border-radius: 8px;
                                margin-bottom: 10px;
                                cursor: pointer;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='white'">
                                <div style="
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    background: #0b7285;
                                    color: white;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    margin-right: 15px;
                                ">${client.firstName.charAt(0)}${client.lastName.charAt(0)}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">${client.firstName} ${client.lastName}</div>
                                    <div style="color: #6b7280; font-size: 14px;">${client.email}</div>
                                </div>
                                <div style="
                                    padding: 4px 8px;
                                    border-radius: 12px;
                                    font-size: 12px;
                                    font-weight: 500;
                                    background: ${(client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0 ? '#dcfce7' : '#fef2f2'};
                                    color: ${(client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0 ? '#166534' : '#991b1b'};
                                ">${(client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0 ? 'Active' : 'Inactive'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeClientSelectionModal();
                }
            });
            
            document.body.appendChild(modal);
        }
        
        function closeClientSelectionModal() {
            const modal = document.getElementById('clientSelectionModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function selectClientForInvoice(clientId) {
            // Close the modal immediately
            closeClientSelectionModal();
            
            // Open invoice modal for the selected client
            const client = clients.find(c => c.id === clientId);
            if (client) {
                // Ensure client status is up to date before opening invoice modal
                const documents = cleartrackData.getUserDocuments(client.id);
                const expenses = cleartrackData.getUserExpenses(client.id);
                client.documentCount = documents ? documents.length : 0;
                client.expenseCount = expenses ? expenses.length : 0;
                client.isActive = (client.documentCount || 0) > 0 || (client.expenseCount || 0) > 0;
                
                openInvoiceModalForClient(clientId, `${client.firstName} ${client.lastName}`, client.email);
            }
        }
        
        // Function to open invoice modal for a specific client
        function openInvoiceModalForClient(clientId, clientName, clientEmail) {
            console.log(' Opening invoice modal for client:', clientName);
            
            const invoiceModal = document.getElementById('invoiceModal');
            if (!invoiceModal) {
                alert('Invoice generation form not found. Please refresh the page and try again.');
                return;
            }
            
            // Store client data for the invoice
            invoiceModal.dataset.clientId = clientId;
            invoiceModal.dataset.clientName = clientName;
            invoiceModal.dataset.clientEmail = clientEmail;
            invoiceModal.dataset.userId = clientId; // Set userId for invoice generation
            invoiceModal.dataset.returnId = 'direct_invoice'; // Set a placeholder returnId
            
            // Show the modal
            invoiceModal.classList.remove('hidden');
            
            // Wait for modal to be visible, then populate form
            setTimeout(() => {
                // Populate invoice form with client data
                const clientNameField = document.getElementById('invoiceClientName');
                const clientEmailField = document.getElementById('invoiceClientEmail');
                
                if (clientNameField) {
                    clientNameField.value = clientName;
                }
                if (clientEmailField) {
                    clientEmailField.value = clientEmail;
                }
                
                // Set today's date
                const dateField = document.getElementById('invoiceDate');
                if (dateField) {
                    dateField.value = new Date().toISOString().split('T')[0];
                }
                
                // Set due date to 30 days from now
                const dueDateField = document.getElementById('invoiceDueDate');
                if (dueDateField) {
                    const dueDate = new Date();
                    dueDate.setDate(dueDate.getDate() + 30);
                    dueDateField.value = dueDate.toISOString().split('T')[0];
                }
                
                // Auto-generate tax year (dropdown will have current year selected by default)
                const taxYearField = document.getElementById('invoiceTaxYear');
                if (taxYearField) {
                    const currentYear = new Date().getFullYear();
                    const currentTaxYear = `${currentYear}/${currentYear + 1}`;
                    // Set the dropdown to the current tax year
                    taxYearField.value = currentTaxYear;
                }
                
                // Auto-generate invoice number
                const invoiceNumberField = document.getElementById('invoiceNumber');
                if (invoiceNumberField) {
                    const currentYear = new Date().getFullYear();
                    const invoiceCount = invoices ? invoices.length + 1 : 1;
                    invoiceNumberField.value = `INV-${currentYear}-${String(invoiceCount).padStart(4, '0')}`;
                }
                
                // Auto-generate VAT exemption
                const vatExemptionField = document.getElementById('vatExemption');
                if (vatExemptionField) {
                    vatExemptionField.checked = true; // Default to VAT exempt
                }
                
                // Populate with practitioner's banking details
                populateBankingDetails();
                
                // Populate with practitioner's invoice messages
                populateInvoiceMessages();
                
                console.log(' Invoice modal populated with client data and practitioner details');
            }, 100);
        }
        
        // Function to populate banking details from practitioner profile
        function populateBankingDetails() {
            const bankNameField = document.getElementById('profileBankName');
            const bankBranchField = document.getElementById('profileBankBranch');
            const accountNumberField = document.getElementById('profileAccountNumber');
            const accountTypeField = document.getElementById('profileAccountType');
            
            if (bankNameField && bankNameField.value) {
                const bankDetailsField = document.getElementById('invoiceBankDetails');
                if (bankDetailsField) {
                    bankDetailsField.value = `${bankNameField.value}\nBranch: ${bankBranchField?.value || ''}\nAccount: ${accountNumberField?.value || ''}\nType: ${accountTypeField?.value || 'business'}`;
                }
            }
        }
        
        // Function to populate invoice messages from practitioner profile
        function populateInvoiceMessages() {
            const defaultNotesField = document.getElementById('defaultInvoiceNotes');
            const footerMessageField = document.getElementById('invoiceFooterMessage');
            const termsField = document.getElementById('invoiceTerms');
            
            // Populate invoice notes
            const notesField = document.getElementById('invoiceNotes');
            if (notesField && defaultNotesField && defaultNotesField.value) {
                notesField.value = defaultNotesField.value;
            }
            
            // Add footer message if available
            if (footerMessageField && footerMessageField.value && notesField) {
                const currentNotes = notesField.value || '';
                notesField.value = currentNotes + (currentNotes ? '\n\n' : '') + footerMessageField.value;
            }
            
            // Add payment terms if available
            if (termsField && termsField.value && notesField) {
                const currentNotes = notesField.value || '';
                notesField.value = currentNotes + (currentNotes ? '\n\nPayment Terms:\n' : 'Payment Terms:\n') + termsField.value;
            }
        }

        function markClientAsComplete(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const clientTaxReturns = taxReturns.filter(tr => tr.userId === clientId);
            const pendingReturn = clientTaxReturns.find(tr => tr.status === 'pending' || tr.status === 'in_progress');
            
            if (!pendingReturn) {
                alert('No pending tax return found for this client.');
                return;
            }
            
            if (confirm(`Mark tax return for ${client.firstName} ${client.lastName} as completed?`)) {
                cleartrackData.updateTaxReturnStatus(pendingReturn.id, 'completed');
                loadTaxReturns();
                loadClientsDisplay();
                alert('Tax return marked as completed successfully!');
                hideClientDetailsModal();
            }
        }

        function viewClientDocuments(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            // Set current client ID for document functions
            currentClientId = clientId;
            
            // Get client documents
            const clientDocuments = cleartrackData.getUserDocuments(clientId);
            
            // Always show the modal, even if no documents
            showClientDocumentsModal(client, clientDocuments || []);
        }
        
        function showClientDocumentsModal(client, documents) {
            // Set current client ID for document functions
            currentClientId = client.id;
            
            // Remove any existing modal first
            const existingModal = document.getElementById('clientDocumentsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHTML = `
                <div id="clientDocumentsModal" class="modal-overlay">
                    <div class="modal modal-large">
                        <div class="modal-header">
                            <h2 class="modal-title">
                                <img src="assets/icons/document.svg" class="icon icon-sm" alt="Documents">
                                Documents for ${client.firstName} ${client.lastName}
                            </h2>
                            <button class="btn-close" onclick="hideClientDocumentsModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="documents-viewer">
                                <div class="documents-header">
                                    <div class="documents-stats">
                                        <span class="stat-item">
                                            <img src="assets/icons/document.svg" class="icon icon-sm" alt="Total">
                                            <span>${documents.length} documents</span>
                                        </span>
                                        <span class="stat-item">
                                            <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download">
                                            <button class="btn btn-primary btn-sm" onclick="downloadAllClientFiles('${client.id}')">Download All</button>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="documents-grid">
                                    ${documents.map((doc, index) => {
                                        // Create a better document name
                                        const docName = doc.name || doc.filename || doc.title || `Document ${index + 1}`;
                                        const docType = doc.type || doc.fileType || doc.category || 'Document';
                                        const docSize = doc.size ? formatFileSize(doc.size) : 'Unknown Size';
                                        const docDate = doc.uploadDate || doc.createdAt || doc.date || new Date().toISOString();
                                        
                                        return `
                                        <div class="document-card">
                                            <div class="document-icon">
                                                <img src="assets/icons/document.svg" class="icon" alt="Document">
                                            </div>
                                            <div class="document-info">
                                                <div class="document-name">${docName}</div>
                                                <div class="document-meta">
                                                    <span class="document-type">${docType}</span>
                                                    <span class="document-size">${docSize}</span>
                                                </div>
                                                <div class="document-date">${new Date(docDate).toLocaleDateString()}</div>
                                            </div>
                                            <div class="document-actions">
                                                <button class="btn btn-sm btn-outline" onclick="viewDocument('${doc.id || doc._id || index}', '${doc.name || doc.filename || doc.title || `Document ${index + 1}`}')">
                                                    <img src="assets/icons/eye.svg" class="icon icon-sm" alt="View">
                                                    View
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="downloadDocument('${doc.id || doc._id || index}', '${doc.name || doc.filename || doc.title || `Document ${index + 1}`}')">
                                                    <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download">
                                                    Download
                                                </button>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${documents.length === 0 ? `
                                    <div class="no-documents">
                                        <img src="assets/icons/document.svg" class="icon icon-2xl" alt="No Documents">
                                        <h3>No documents found</h3>
                                        <p>This client hasn't uploaded any documents yet.</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="hideClientDocumentsModal()">Close</button>
                            <button class="btn btn-primary" onclick="uploadNewDocument('${client.id}')">
                                <img src="assets/icons/document.svg" class="icon icon-sm" alt="Upload">
                                Upload New Document
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Show modal
            const modal = document.getElementById('clientDocumentsModal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Add click outside to close
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideClientDocumentsModal();
                    }
                });
            }
        }
        
        function hideClientDocumentsModal() {
            const modal = document.getElementById('clientDocumentsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown Size';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        
        
        
        
        
        
        
        
        function uploadNewDocument(clientId) {
            // This would open a file upload dialog
            console.log('Upload new document for client:', clientId);
        }

        function downloadAllClientFiles(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            if (confirm(`Download all files for ${client.firstName} ${client.lastName}?`)) {
                // Get all documents for this client
                const clientDocuments = cleartrackData.getUserDocuments(clientId);
                
                if (!clientDocuments || clientDocuments.length === 0) {
                    alert('No documents found for this client.');
                    return;
                }
                
                // Create a zip file or trigger individual downloads
                alert(`Initiating download of ${clientDocuments.length} files for ${client.firstName} ${client.lastName}...`);
                
                // You could implement actual bulk download here
                // For now, we'll show the count and let the user know
                console.log(`Would download ${clientDocuments.length} files for client ${clientId}`);
            }
        }

        function sendMessageToClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            // Switch to chat tab and open conversation with this client
            document.getElementById('chat').classList.remove('hidden');
            document.getElementById('clients').classList.add('hidden');
            
            // Open the conversation with this client
            openConversation(clientId);
            hideClientDetailsModal();
        }

        function updateClientStatus(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const newStatus = prompt(`Update status for ${client.firstName} ${client.lastName}:\n\nCurrent status: ${client.status || 'Active'}\n\nEnter new status:`, client.status || 'Active');
            
            if (newStatus && newStatus !== client.status) {
                // Update client status in the data
                client.status = newStatus;
                cleartrackData.updateUser(client);
                loadClientsDisplay();
                alert('Client status updated successfully!');
            }
        }

        function saveClientNotes(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const notesTextarea = document.getElementById(`clientNotes_${clientId}`);
            if (!notesTextarea) {
                alert('Notes textarea not found');
                return;
            }
            
            const notes = notesTextarea.value;
            client.notes = notes;
            cleartrackData.updateUser(client);
            
            alert('Client notes saved successfully!');
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            // Open the add client modal and populate it with existing data
            showAddClientModal();
            
            // Populate the form with existing client data
            setTimeout(() => {
                const firstNameInput = document.getElementById('clientFirstName');
                const lastNameInput = document.getElementById('clientLastName');
                const emailInput = document.getElementById('clientEmail');
                const phoneInput = document.getElementById('clientPhone');
                const taxNumberInput = document.getElementById('clientTaxNumber');
                const idNumberInput = document.getElementById('clientIdNumber');
                const addressInput = document.getElementById('clientAddress');
                
                if (firstNameInput) firstNameInput.value = client.firstName || '';
                if (lastNameInput) lastNameInput.value = client.lastName || '';
                if (emailInput) emailInput.value = client.email || '';
                if (phoneInput) phoneInput.value = client.phone || '';
                if (taxNumberInput) taxNumberInput.value = client.taxNumber || '';
                if (idNumberInput) idNumberInput.value = client.idNumber || '';
                if (addressInput) addressInput.value = client.address || '';
                
                // Change the modal title and button text for editing
                const modalTitle = document.getElementById('addClientModalTitle');
                const submitButton = document.querySelector('#addClientForm button[type="submit"]');
                
                if (modalTitle) modalTitle.textContent = 'Edit Client';
                if (submitButton) {
                    submitButton.textContent = 'Update Client';
                    submitButton.onclick = (e) => {
                        e.preventDefault();
                        updateClient(clientId);
                    };
                }
            }, 100);
            
            hideClientDetailsModal();
        }
        
        function updateClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            // Get form data
            const formData = {
                firstName: document.getElementById('clientFirstName').value,
                lastName: document.getElementById('clientLastName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                taxNumber: document.getElementById('clientTaxNumber').value,
                idNumber: document.getElementById('clientIdNumber').value,
                address: document.getElementById('clientAddress').value
            };
            
            // Validate required fields
            if (!formData.firstName || !formData.lastName || !formData.email) {
                alert('Please fill in all required fields (First Name, Last Name, Email)');
                return;
            }
            
            // Update client data
            Object.assign(client, formData);
            cleartrackData.updateUser(client);
            
            // Refresh displays
            loadClientsDisplay();
            
            // Close modal and show success
            hideAddClientModal();
            alert('Client updated successfully!');
        }
        
        // Generate tax return
        function generateTaxReturn(clientId) {
            if (!practitioner) {
                alert('Practitioner not found. Please log in again.');
                return;
            }
            
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found. Please refresh and try again.');
                return;
            }
            
            // Validate user-practitioner connection
            if (!cleartrackData.isUserConnectedToPractitioner(clientId, practitioner.id)) {
                alert('This client is not connected to you. Please ensure the client has connected using your practitioner code.');
                return;
            }
            
            // Create tax return with proper user-practitioner relationship
            const newTaxReturn = cleartrackData.createTaxReturn(practitioner.id, clientId, {
                clientName: `${client.firstName} ${client.lastName}`,
                clientEmail: client.email,
                clientPhone: client.phone,
                taxYear: new Date().getFullYear(),
                documents: client.documentCount || 0,
                expenses: client.expenseCount || 0,
                practitionerName: `${practitioner.firstName} ${practitioner.lastName}`,
                practitionerEmail: practitioner.email,
                practitionerPhone: practitioner.phone
            });
            
            if (newTaxReturn) {
                loadTaxReturns();
                updateDashboard();
                hideClientDetailsModal();
                alert(`Tax return generated for ${client.firstName} ${client.lastName}!`);
            } else {
                alert('Error generating tax return. Please try again.');
            }
        }
        
        
        
        // ===== CLEAN VIEW INVOICE SYSTEM =====
        
        // View invoice from tax returns table
        function viewInvoiceFromTaxReturn(returnId) {
            if (window.viewingInvoice) return;
            window.viewingInvoice = true;
            
            const taxReturn = taxReturns.find(r => r.id === returnId);
            if (!taxReturn) {
                alert('Tax return not found.');
                window.viewingInvoice = false;
                return;
            }
            
            // Check for existing invoice
            const existingInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            
            // Helper function to normalize tax year for comparison
            const normalizeTaxYear = (year) => {
                if (typeof year === 'number') return year;
                if (typeof year === 'string') {
                    // Handle "2025/2026" format - extract first year
                    const match = year.match(/^(\d{4})/);
                    return match ? parseInt(match[1]) : null;
                }
                return null;
            };
            
            // Get client for better matching
            const client = clients.find(c => c.id === taxReturn.userId);
            const taxReturnClientName = client ? `${client.firstName} ${client.lastName}` : taxReturn.clientName;
            const taxReturnYear = normalizeTaxYear(taxReturn.taxYear);
            
            // Find matching invoice by multiple criteria
            const existingInvoice = existingInvoices.find(inv => {
                // Match by practitioner ID
                if (inv.practitionerId !== practitioner.id) return false;
                
                // Match by clientId/userId (most reliable)
                if (inv.clientId && taxReturn.userId && inv.clientId === taxReturn.userId) {
                    const invoiceYear = normalizeTaxYear(inv.taxYear);
                    if (invoiceYear === taxReturnYear) {
                        return true;
                    }
                }
                
                // Match by client name and tax year (fallback)
                const invoiceClientName = inv.clientName || '';
                const invoiceYear = normalizeTaxYear(inv.taxYear);
                
                if (invoiceClientName === taxReturnClientName && invoiceYear === taxReturnYear) {
                    return true;
                }
                
                return false;
            });
            
            if (existingInvoice) {
                // Show the actual invoice
                showInvoiceModal(existingInvoice);
            } else {
                // No invoice exists - show clear message instead of preview
                const client = clients.find(c => c.id === taxReturn.userId);
                const clientName = client ? `${client.firstName} ${client.lastName}` : taxReturn.clientName;
                
                // Show message that no invoice exists
                const message = `No invoice has been generated for ${clientName} - Tax Year ${taxReturn.taxYear || new Date().getFullYear()}.\n\nWould you like to generate an invoice now?`;
                
                if (confirm(message)) {
                    // User wants to generate invoice - open the generate invoice function
                    generateInvoice(returnId);
                }
                
                // Reset viewing flag
                window.viewingInvoice = false;
                return;
            }
            
            setTimeout(() => { window.viewingInvoice = false; }, 1000);
        }
        
        // View invoice from invoice list
        function viewInvoiceFromList(invoiceId) {
            if (window.viewingInvoice) return;
            window.viewingInvoice = true;
            
            const allInvoices = cleartrackData.getInvoicesForPractitioner(practitioner.id);
            const invoice = allInvoices.find(inv => inv.id === invoiceId);
            
            if (!invoice) {
                alert('Invoice not found.');
                window.viewingInvoice = false;
                return;
            }
            
            showInvoiceModal(invoice);
            setTimeout(() => { window.viewingInvoice = false; }, 1000);
        }
        
        // Show invoice modal (single function for all invoice viewing)
        // Uses unified generator with iframe to ensure identical rendering
        function showInvoiceModal(invoice) {
            const modal = document.getElementById('invoicePreviewModal');
            const content = document.getElementById('invoicePreviewContent');
            
            if (!modal || !content) {
                // Fallback to openInvoicePreview if modal not found
                openInvoicePreview(invoice);
                return;
            }
            
            // Clear existing content
            content.innerHTML = '';
            
            // Use unified invoice HTML generator
            const invoiceHTML = generateUnifiedInvoiceHTML(invoice);
            
            // Create iframe for consistent rendering (same as openInvoicePreview)
            const iframe = document.createElement('iframe');
            iframe.style.cssText = 'width: 100%; min-height: 600px; border: none; border-radius: 8px; background: white;';
            content.appendChild(iframe);
            
            // Write unified invoice HTML to iframe
            iframe.onload = () => {
                try {
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(invoiceHTML);
                    iframe.contentDocument.close();
                } catch (err) {
                    console.error('Error writing to iframe:', err);
                    iframe.srcdoc = invoiceHTML;
                }
            };
            
            // Try to write immediately
            try {
                iframe.contentDocument.open();
                iframe.contentDocument.write(invoiceHTML);
                iframe.contentDocument.close();
            } catch (err) {
                // Iframe not ready, will use onload
            }
            
            // Show modal
            modal.classList.remove('hidden');
            modal.style.display = '';
            modal.style.visibility = '';
            modal.style.opacity = '';
            modal.style.zIndex = '';
            
            // Update action buttons
            updateInvoiceActionButtons(invoice);
            
            // Store current invoice for action buttons
            window.currentInvoice = invoice;
        }
        
        // Update action buttons based on invoice status
        function updateInvoiceActionButtons(invoice) {
            const actionButtons = document.getElementById('invoiceActionButtons');
            if (!actionButtons) return;
            
            const isPreview = invoice.status === 'preview';
            const invoiceId = invoice.id;
            
            // Always show the same action buttons as in the invoice list
            // For preview invoices, some actions may not work, but buttons are shown for consistency
            let buttonsHTML = `
                <button class="btn btn-sm btn-primary" onclick="downloadInvoice('${invoiceId}')" class="flex items-center gap-1">
                    <img src="assets/icons/download.svg" class="icon icon-sm" alt="Download"> Download
                </button>
                <button class="btn btn-sm btn-success" onclick="chatInvoice('${invoiceId}')" class="flex items-center gap-1">
                    <img src="assets/icons/message.svg" class="icon icon-sm" alt="Send Chat"> Send Chat
                </button>
                <button class="btn btn-sm btn-secondary" onclick="emailInvoice('${invoiceId}')" class="flex items-center gap-1">
                    <img src="assets/icons/email.svg" class="icon icon-sm" alt="Email"> Email
                </button>
            `;
            
            // Only show Mark Paid button if invoice is not paid and not a preview
            if (!isPreview && invoice.status !== 'paid') {
                buttonsHTML += `
                    <button class="btn btn-sm btn-success" onclick="markInvoicePaid('${invoiceId}')" class="flex items-center gap-1">
                        <img src="assets/icons/check.svg" class="icon icon-sm icon-green-600" alt="Mark Paid"> Mark Paid
                    </button>
                `;
            }
            
            // Only show Delete button for non-preview invoices
            if (!isPreview) {
                buttonsHTML += `
                    <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${invoiceId}')" class="flex items-center gap-1" style="background: #dc2626; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer;">
                        <img src="assets/icons/trash.svg" class="icon icon-sm" alt="Delete" style="width: 16px; height: 16px;"> Delete
                    </button>
                `;
            }
            
            actionButtons.innerHTML = `<div style="display: flex; gap: 8px; flex-wrap: wrap;">${buttonsHTML}</div>`;
        }
        
        
        // ===== END CLEAN VIEW INVOICE SYSTEM =====
        
        
        // Save bank details from profile
        function saveBankDetailsFromProfile() {
            const bankDetails = {
                bankName: document.getElementById('profileBankName').value,
                bankBranch: document.getElementById('profileBankBranch').value,
                accountNumber: document.getElementById('profileAccountNumber').value,
                accountType: document.getElementById('profileAccountType').value,
                bankReference: document.getElementById('profileBankReference').value
            };
            
            const success = cleartrackData.savePractitionerBankDetails(bankDetails);
            if (success) {
                alert('Bank details saved successfully!');
            } else {
                alert('Failed to save bank details. Please try again.');
            }
        }
        
        // Save invoice messages
        function saveInvoiceMessages() {
            const invoiceMessages = {
                defaultNotes: document.getElementById('defaultInvoiceNotes').value,
                footerMessage: document.getElementById('invoiceFooterMessage').value,
                paymentTerms: document.getElementById('invoiceTerms').value
            };
            
            // Save to practitioner profile
            const updatedPractitioner = cleartrackData.updatePractitioner(practitioner.id, {
                invoiceMessages: invoiceMessages
            });
            
            if (updatedPractitioner) {
                alert('Invoice messages saved successfully!');
            } else {
                alert('Failed to save invoice messages. Please try again.');
            }
        }
        
        // Load bank details in profile
        function loadBankDetailsInProfile() {
            const bankDetails = cleartrackData.getPractitionerBankDetails();
            if (bankDetails) {
                const bankNameField = document.getElementById('profileBankName');
                const bankBranchField = document.getElementById('profileBankBranch');
                const accountNumberField = document.getElementById('profileAccountNumber');
                const accountTypeField = document.getElementById('profileAccountType');
                const bankReferenceField = document.getElementById('profileBankReference');
                
                if (bankNameField) bankNameField.value = bankDetails.bankName || '';
                if (bankBranchField) bankBranchField.value = bankDetails.bankBranch || '';
                if (accountNumberField) accountNumberField.value = bankDetails.accountNumber || '';
                if (accountTypeField) accountTypeField.value = bankDetails.accountType || 'business';
                if (bankReferenceField) bankReferenceField.value = bankDetails.bankReference || '';
            }
        }
        
        // Load invoice messages in profile
        function loadInvoiceMessagesInProfile() {
            if (practitioner && practitioner.invoiceMessages) {
                const defaultNotesField = document.getElementById('defaultInvoiceNotes');
                const footerMessageField = document.getElementById('invoiceFooterMessage');
                const paymentTermsField = document.getElementById('invoiceTerms');
                
                if (defaultNotesField) defaultNotesField.value = practitioner.invoiceMessages.defaultNotes || '';
                if (footerMessageField) footerMessageField.value = practitioner.invoiceMessages.footerMessage || '';
                if (paymentTermsField) paymentTermsField.value = practitioner.invoiceMessages.paymentTerms || '';
            }
        }
        
        // Update practitioner profile
        async function updatePractitionerProfile() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const practiceName = document.getElementById('practiceName').value.trim();
            
            // Basic form validation
            if (!firstName || !lastName) {
                alert('First name and last name are required.');
                return;
            }
            
            if (!practiceName) {
                alert('Practice name is required.');
                return;
            }
            
            const fullName = `${firstName} ${lastName}`;
            
            // Get selected specializations
            const selectedSpecializations = Array.from(document.querySelectorAll('input[name="specialization"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Prepare updated data
            const updatedData = {
                name: fullName,
                firstName: firstName,
                lastName: lastName,
                practiceName: practiceName,
                yearsExperience: parseInt(document.getElementById('yearsExperience').value) || 0,
                qualifications: document.getElementById('qualifications').value.trim(),
                specializations: selectedSpecializations,
                bio: document.getElementById('bio').value.trim(),
                isPubliclyVisible: document.getElementById('isPubliclyVisible').checked
            };
            
            // Update local storage
            const updatedPractitioner = cleartrackData.updatePractitioner(practitioner.id, updatedData);
            
            // Also save to Firestore if Firebase is available
            if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                try {
                    const uid = window.firebaseAuth.currentUser.uid;
                    if (window.firebaseApi && window.firebaseApi.saveData) {
                        // Preserve practitionerCode when updating
                        const firestoreData = {
                            ...updatedData,
                            practitionerCode: practitioner.practitionerCode || updatedPractitioner.practitionerCode
                        };
                        await window.firebaseApi.saveData('users', uid, firestoreData);
                        console.log(' DEBUG: Practitioner profile updated in Firestore');
                    }
                } catch (error) {
                    console.error(' DEBUG: Error updating practitioner profile in Firestore:', error);
                    // Continue anyway - local storage update succeeded
                }
            }
            
            if (updatedPractitioner) {
                practitioner = updatedPractitioner;
                window.practitioner = practitioner; // Update global reference
                updatePractitionerInterface();
                alert('Practitioner profile updated successfully!');
            } else {
                alert('Error updating profile. Please try again.');
            }
        }
        
        // Add form submit event listener for practitioner profile
        document.getElementById('practitionerProfileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updatePractitionerProfile();
        });
        
        // Load connection requests
        function loadConnectionRequests() {
            const requests = cleartrackData.getConnectionRequests(practitioner.id);
            const requestsList = document.getElementById('connectionRequestsList');
            
            if (requests.length === 0) {
                requestsList.innerHTML = '<p style="color: #6b7280; text-align: center;">No pending connection requests.</p>';
                return;
            }
            
            requestsList.innerHTML = requests.map(request => {
                const user = cleartrackData.getData().users[request.userId];
                if (!user) return '';
                
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0 0 0.25rem 0; color: #374151;">${user.firstName} ${user.lastName}</h4>
                                <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">${user.email}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; color: #6b7280;">${new Date(request.timestamp).toLocaleDateString()}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${new Date(request.timestamp).toLocaleTimeString()}</div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="attachment-text">
                                <strong>Request Status:</strong> <span style="color: #f59e0b; font-weight: 600;">Pending</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="approveConnectionRequest('${request.id}')" style="background: #10b981; color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#059669'" onmouseout="this.style.backgroundColor='#10b981'">
                                Approve
                            </button>
                            <button onclick="rejectConnectionRequest('${request.id}')" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">
                                Reject
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Approve connection request
        async function approveConnectionRequest(requestId) {
            const request = cleartrackData.updateConnectionRequest(requestId, 'approved');
            
            if (request) {
                // Connect the user to the practitioner (now async)
                const connectionResult = await cleartrackData.connectUserToPractitioner(request.userId, request.practitionerId);
                
                if (connectionResult) {
                alert('Connection request approved! The user is now connected to you.');
                loadConnectionRequests(); // Refresh the list
                } else {
                    alert('Error establishing connection. Please try again.');
                }
            } else {
                alert('Error approving connection request. Please try again.');
            }
        }
        
        // Reject connection request
        function rejectConnectionRequest(requestId) {
            const request = cleartrackData.updateConnectionRequest(requestId, 'rejected');
            if (request) {
                alert('Connection request rejected.');
                loadConnectionRequests(); // Refresh the list
            } else {
                alert('Error rejecting connection request. Please try again.');
            }
        }

        // Logout handler function
        async function handleLogout(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            console.log('[logout] Logout button clicked');
            
            // Close mobile nav if it's open
            if (typeof closeMobileNav === 'function') {
                closeMobileNav();
            }
            
            try {
                // Check if Firebase Auth is available
                if (!window.firebaseAuth) {
                    console.error('[logout] Firebase Auth not available. Please ensure firebase-init.js is loaded.');
                    return;
                }
                
                console.log('[logout] Signing out from Firebase...');
                
                // Sign out from Firebase
                await window.firebaseAuth.signOut();
                
                console.log('[logout] Firebase sign out successful');
                
                // Clear any local storage
                localStorage.removeItem('token');
                localStorage.removeItem('firebaseUser');
                
                console.log('[logout] Local storage cleared, redirecting to login...');
                
                // Redirect to login page
                window.location.href = '/index.html';
            } catch (error) {
                console.error('[logout] Error signing out:', error);
                console.error('[logout] Error details:', error.message, error.code);
            }
        }
        
        // Initialize logout buttons on page load
        function initLogoutButtons() {
            const logoutButtons = document.querySelectorAll('[data-ct-logout]');
            
            console.log('[logout] Found logout buttons:', logoutButtons.length);
            
            if (logoutButtons.length === 0) {
                console.warn('[logout] No logout buttons found with data-ct-logout attribute');
                return;
            }
            
            logoutButtons.forEach((button, index) => {
                // Remove any existing event listeners by cloning the button
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // Add click event listener
                newButton.addEventListener('click', handleLogout);
                console.log(`[logout] Attached event listener to button ${index + 1}`);
            });
        }
        
        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initLogoutButtons();
                
                // Show/hide desktop logout button based on screen size
                const desktopLogoutBtn = document.getElementById('desktopLogoutBtn');
                const menuToggle = document.getElementById('menuToggle');
                
                function updateLogoutButtonVisibility() {
                    if (window.innerWidth > 768) {
                        // Desktop: show logout button, hide mobile menu toggle
                        if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'block';
                        if (menuToggle) menuToggle.style.display = 'none';
                    } else {
                        // Mobile: hide logout button, show mobile menu toggle
                        if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'none';
                        if (menuToggle) menuToggle.style.display = 'flex';
                    }
                }
                
                // Update on load and resize
                updateLogoutButtonVisibility();
                window.addEventListener('resize', updateLogoutButtonVisibility);
            });
        } else {
            // DOM already loaded
            initLogoutButtons();
            
            // Show/hide desktop logout button based on screen size
            const desktopLogoutBtn = document.getElementById('desktopLogoutBtn');
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            
            function updateLogoutButtonVisibility() {
                if (window.innerWidth > 768) {
                    // Desktop: show logout button, hide mobile menu toggle
                    if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'block';
                    if (mobileMenuToggle) mobileMenuToggle.style.display = 'none';
                } else {
                    // Mobile: hide logout button, show mobile menu toggle
                    if (desktopLogoutBtn) desktopLogoutBtn.style.display = 'none';
                    if (mobileMenuToggle) mobileMenuToggle.style.display = 'block';
                }
            }
            
            // Update on load and resize
            updateLogoutButtonVisibility();
            window.addEventListener('resize', updateLogoutButtonVisibility);
        }
        
        // Messaging functionality
        let currentConversationClient = null;
        
        function loadConversations() {
            if (!practitioner) {
                return;
            }
            
            // Make function global for polling
            window.loadConversations = loadConversations;
            
            const conversationsList = document.getElementById('conversationsList');
            const connectedUsers = cleartrackData.getConnectedUsers(practitioner.id);
            
            if (connectedUsers.length === 0) {
                conversationsList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">No clients connected yet</p>';
                return;
            }
            
            // Update the clients array
            clients = connectedUsers;
            
            conversationsList.innerHTML = connectedUsers.map(client => {
                const unreadCount = cleartrackData.getUnreadMessageCount(client.id, practitioner.id);
                const lastMessage = getLastMessage(client.id, practitioner.id);
                const isActive = currentConversationClient && currentConversationClient.id === client.id;
                
                return `
                    <div class="client-item" onclick="openConversation('${client.id}')" style="
                        padding: 1rem; 
                        border-bottom: 1px solid #e5e7eb; 
                        cursor: pointer; 
                        transition: background-color 0.2s;
                        background: ${isActive ? '#eff6ff' : 'transparent'};
                        border-left: ${isActive ? '3px solid #0b7285' : '3px solid transparent'};
                    " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='${isActive ? '#eff6ff' : 'transparent'}'">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div class="flex-1">
                                <div style="font-weight: 600; color: #111827; margin-bottom: 0.25rem;">${client.firstName} ${client.lastName}</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">${client.email}</div>
                                ${lastMessage ? `
                                    <div style="font-size: 0.875rem; color: #6b7280; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${lastMessage.text.substring(0, 30)}${lastMessage.text.length > 30 ? '...' : ''}
                                        </span>
                                        <span style="font-size: 0.75rem; color: #9ca3af;">
                                            ${new Date(lastMessage.timestamp).toLocaleDateString()}
                                        </span>
                                    </div>
                                ` : '<div style="font-size: 0.875rem; color: #9ca3af;">No messages yet</div>'}
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${unreadCount > 0 ? `<span style="background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${unreadCount}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getLastMessage(userId, practitionerId) {
            const messages = cleartrackData.getMessages(userId, practitionerId);
            return messages.length > 0 ? messages[messages.length - 1] : null;
        }
        
        function openConversation(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                return;
            }
            
            currentConversationClient = client;
            window.currentConversationClient = client; // Make it global for polling
            console.log(' Set currentConversationClient:', currentConversationClient);
            
            // Update chat header with back button for mobile
            const isMobileForHeader = window.matchMedia('(max-width: 768px)').matches;
            const backButtonHtml = isMobileForHeader ? '<button class="whatsapp-back-button" onclick="goBackToClientList()" title="Back" style="display: inline-flex !important; align-items: center !important; justify-content: center !important; background: none !important; border: none !important; color: #54656f !important; cursor: pointer !important; padding: 8px !important; border-radius: 50% !important; margin-right: 12px !important; font-size: 24px !important; min-width: 40px !important; min-height: 40px !important; line-height: 1 !important;"></button>' : '';
            
            document.getElementById('chatHeaderInfo').innerHTML = `
                ${backButtonHtml}
                <div class="whatsapp-chat-contact">
                    <div class="whatsapp-chat-contact-avatar">
                        ${client.profileImage ? `<img src="${client.profileImage}" alt="${client.firstName} ${client.lastName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />` : client.firstName.charAt(0).toUpperCase()}
                    </div>
                    <div class="whatsapp-chat-contact-info">
                        <h3>${client.firstName} ${client.lastName}</h3>
                        <p>Online</p>
                    </div>
                </div>
                <div class="whatsapp-chat-actions">
                    <button onclick="callClient()" title="Call">
                        <img src="assets/icons/phone.svg" class="icon icon-sm" alt="Call">
                    </button>
                    <button onclick="videoCallClient()" title="Video">
                        <img src="assets/icons/video.svg" class="icon icon-sm" alt="Video">
                    </button>
                </div>
            `;
            
            // Show chat view on mobile (WhatsApp-style) - Force with inline styles using cssText
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            console.log(' Mobile check - isMobile:', isMobile, 'Window width:', window.innerWidth);
            
            if (isMobile) {
                const messagingContainer = document.querySelector('.whatsapp-messaging');
                const sidebar = document.querySelector('.whatsapp-sidebar');
                const mainChat = document.querySelector('.whatsapp-main');
                
                console.log(' Elements check:', {
                    messaging: !!messagingContainer,
                    sidebar: !!sidebar,
                    mainChat: !!mainChat
                });
                
                if (messagingContainer && sidebar && mainChat) {
                    // Add class for CSS transitions
                    messagingContainer.classList.add('chat-active');
                    
                    // FORCE with cssText - highest priority, overrides everything
                    sidebar.style.cssText = 'transform: translateX(-100%) !important; position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; transition: transform 0.3s ease !important;';
                    
                    mainChat.style.cssText = 'transform: translateX(0) !important; position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 2 !important; display: flex !important; flex-direction: column !important; transition: transform 0.3s ease !important;';
                    
                    messagingContainer.style.cssText = 'position: relative !important; overflow: hidden !important;';
                    
                    console.log('  Mobile styles applied - sidebar should be hidden, chat should be visible');
                } else {
                    console.error('  Missing elements!', { messagingContainer, sidebar, mainChat });
                }
            }
            
            // Show message input area
            const messageInputArea = document.getElementById('messageInputArea');
            const noClientSelected = document.getElementById('noClientSelected');
            
            if (messageInputArea) {
                messageInputArea.style.display = 'block';
            }
            if (noClientSelected) {
                noClientSelected.style.display = 'none';
            }
            
            // Mark messages as read
            cleartrackData.markMessagesAsRead(clientId, practitioner.id);
            
            // Debug: Check if messages exist
            const messages = cleartrackData.getMessages(clientId, practitioner.id);
            
            // Load messages using the robust messaging system
            loadPractitionerMessages();
            
            // Force refresh after a short delay to ensure messages are loaded
            setTimeout(() => {
                console.log(' Force refreshing messages after conversation open...');
                loadPractitionerMessages();
            }, 500);
            
            // Refresh the client list to update active state
            loadConversations();
        }
        
        // Function to go back to client list on mobile
        function goBackToClientList() {
            console.log(' Going back to client list');
            const messagingContainer = document.querySelector('.whatsapp-messaging');
            const sidebar = document.querySelector('.whatsapp-sidebar');
            const mainChat = document.querySelector('.whatsapp-main');
            
            if (messagingContainer) {
                messagingContainer.classList.remove('chat-active');
            }
            
            // Force reset with inline styles
            if (sidebar) {
                sidebar.style.cssText = `
                    transform: translateX(0) !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    z-index: 1 !important;
                    transition: transform 0.3s ease !important;
                `;
            }
            
            if (mainChat) {
                mainChat.style.cssText = `
                    transform: translateX(100%) !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    z-index: 2 !important;
                    display: flex !important;
                    flex-direction: column !important;
                    transition: transform 0.3s ease !important;
                `;
            }
            
            // Clear current conversation client
            currentConversationClient = null;
            window.currentConversationClient = null;
            
            // Reset chat header
            document.getElementById('chatHeaderInfo').innerHTML = `
                <div class="whatsapp-chat-contact">
                    <div class="whatsapp-chat-contact-avatar">
                        <img src="assets/icons/user.svg" class="icon icon-lg" alt="Profile">
                    </div>
                    <div class="whatsapp-chat-contact-info">
                        <h3>Select a client to start chatting</h3>
                        <p>Choose a client from the left to view your conversation</p>
                    </div>
                </div>
                <div class="whatsapp-chat-actions">
                    <button onclick="callClient()" title="Call">
                        <img src="assets/icons/phone.svg" class="icon icon-sm" alt="Call">
                    </button>
                    <button onclick="videoCallClient()" title="Video">
                        <img src="assets/icons/video.svg" class="icon icon-sm" alt="Video">
                    </button>
                </div>
            `;
            
            // Hide message input area
            const messageInputArea = document.getElementById('messageInputArea');
            if (messageInputArea) {
                messageInputArea.style.display = 'none';
            }
            
            // Clear messages
            const messagesContainer = document.getElementById('conversationMessages');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="chat-empty-state">
                        <div class="chat-empty-icon">
                            <img src="assets/icons/message.svg" class="icon icon-2xl icon-gray-500" alt="Message">
                        </div>
                        <h3 class="chat-empty-title">No conversation selected</h3>
                        <p class="chat-empty-text">Select a client from the left to start or continue your conversation</p>
                    </div>
                `;
            }
        }
        
        function displayConversationMessages(messages) {
            const messagesContainer = document.getElementById('conversationMessages');
            console.log(' Displaying messages:', messages);
            console.log(' Messages container found:', !!messagesContainer);
            console.log(' Current conversation client:', currentConversationClient);
            
            if (!messagesContainer) {
                console.error(' Messages container not found!');
                return;
            }
            
            if (!messages || messages.length === 0) {
                console.log(' No messages to display');
                messagesContainer.innerHTML = `
                    <div class="whatsapp-date-separator">
                        <div class="whatsapp-date-badge">Today</div>
                    </div>
                    <div style="text-align: center; padding: 3rem; color: #667781;">
                        <div class="no-client-icon"></div>
                        <h3 class="no-client-title">No messages yet</h3>
                        <p class="no-client-text">Start the conversation with ${currentConversationClient ? currentConversationClient.firstName : 'your client'}!</p>
                    </div>
                `;
                return;
            }
            
            console.log(' Processing', messages.length, 'messages for display');
            
            // Group messages by date
            const groupedMessages = groupMessagesByDate(messages);
            
            let html = '';
            for (const [date, dayMessages] of Object.entries(groupedMessages)) {
                html += `
                    <div class="whatsapp-date-separator">
                        <div class="whatsapp-date-badge">${date}</div>
                    </div>
                `;
                
                html += dayMessages.map(message => {
                    const isPractitionerMessage = message.sender === 'practitioner';
                    const messageTime = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    let content = '';
                if (message.type === 'voice') {
                    content = `
                            <div class="whatsapp-file-attachment">
                                <div class="whatsapp-file-icon"></div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">Voice Message</div>
                                    <div class="whatsapp-file-size">Audio</div>
                                </div>
                            <audio controls style="max-width: 200px;">
                                <source src="${message.audioData}" type="audio/wav">
                            </audio>
                        </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                    `;
                } else if (message.type === 'image') {
                    const fileData = message.fileData || (message.attachment && message.attachment.fileData);
                    const fileName = message.fileName || (message.attachment && message.attachment.fileName);
                    content = `
                            <div class="whatsapp-image-attachment">
                                <img src="${fileData}" alt="${fileName}" onclick="openImageModal('${fileData}', '${fileName}')">
                        </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                    `;
                } else if (message.type === 'file' || message.type === 'document') {
                    let fileData = message.fileData || (message.attachment && message.attachment.fileData);
                    const fileName = message.fileName || (message.attachment && message.attachment.fileName);
                    const fileType = message.fileType || (message.attachment && message.attachment.fileType);
                    
                    // Ensure fileData is properly formatted as a data URL
                    if (fileData && !fileData.startsWith('data:')) {
                        const fileExtension = fileName.split('.').pop().toLowerCase();
                        let mimeType = 'application/octet-stream';
                        
                        // Determine MIME type based on file extension
                        switch (fileExtension) {
                            case 'pdf':
                                mimeType = 'application/pdf';
                                break;
                            case 'jpg':
                            case 'jpeg':
                                mimeType = 'image/jpeg';
                                break;
                            case 'png':
                                mimeType = 'image/png';
                                break;
                            case 'gif':
                                mimeType = 'image/gif';
                                break;
                            case 'txt':
                                mimeType = 'text/plain';
                                break;
                            case 'csv':
                                mimeType = 'text/csv';
                                break;
                            case 'doc':
                                mimeType = 'application/msword';
                                break;
                            case 'docx':
                                mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                                break;
                        }
                        
                        fileData = `data:${mimeType};base64,${fileData}`;
                    }
                    
                    // Check if it's a PDF for inline viewing
                    if (fileType === 'application/pdf') {
                        content = `
                            <div class="whatsapp-file-attachment pdf-attachment">
                                <div class="whatsapp-file-icon">
                                    <img src="assets/icons/document.svg" class="icon icon-sm" alt="PDF">
                                </div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">${fileName}</div>
                                    <div class="whatsapp-file-size">PDF Document</div>
                                </div>
                                <div class="whatsapp-file-actions">
                                    <button class="whatsapp-file-preview" onclick="openDocumentPreview('${fileData}', '${fileName}')">Preview</button>
                                    <button class="whatsapp-file-download" onclick="downloadFile('${fileData}', '${fileName}')">Download</button>
                                </div>
                            </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                        `;
                    } else {
                        // Other document types
                        content = `
                            <div class="whatsapp-file-attachment">
                                <div class="whatsapp-file-icon">
                                    <img src="assets/icons/document.svg" class="icon icon-sm" alt="Document">
                                </div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">${fileName}</div>
                                    <div class="whatsapp-file-size">Document</div>
                                </div>
                                <button class="whatsapp-file-download" onclick="downloadFile('${fileData}', '${fileName}')">Download</button>
                            </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                        `;
                    }
                } else if (message.type === 'invoice') {
                    const inv = message.invoiceData || {};
                    const invNum = inv.invoiceNumber || 'N/A';
                    const invId = inv.id || inv.invoiceId || '';
                    const totalNum = Number(inv.total ?? inv.amount ?? 0);
                    const totalDisplay = isFinite(totalNum) ? totalNum.toFixed(2) : '0.00';
                    content = `
                            <div class="whatsapp-file-attachment">
                                <div class="whatsapp-file-icon">
                                    <img src="assets/icons/document.svg" class="icon icon-sm" alt="Invoice">
                                </div>
                                <div class="whatsapp-file-info">
                                    <div class="whatsapp-file-name">Invoice ${invNum}</div>
                                    <div class="whatsapp-file-size">R ${totalDisplay}</div>
                            </div>
                                <div class="whatsapp-file-actions">
                                    <button class="whatsapp-file-preview" onclick="viewInvoiceFromChat('${invId}')">View</button>
                                    <button class="whatsapp-file-download" onclick="downloadInvoiceFromChat('${invId}')">Download</button>
                                </div>
                            </div>
                            ${message.text ? `<div class="whatsapp-message-text">${message.text}</div>` : ''}
                    `;
                } else {
                        // Ensure message.text is properly handled
                        const messageText = typeof message.text === 'string' ? message.text : (message.text || '');
                        content = `<div class="whatsapp-message-text">${messageText}</div>`;
                    }
                    
                    // Determine message status for read receipts
                    let statusIcon = '';
                    if (isPractitionerMessage) {
                        const messageStatus = message.read ? 'read' : (message.delivered ? 'delivered' : 'sent');
                        const statusColor = message.read ? 'read' : (message.delivered ? 'delivered' : 'sent');
                        statusIcon = `<span class="whatsapp-message-status ${statusColor}">${message.read ? '' : (message.delivered ? '' : '')}</span>`;
                }
                
                return `
                        <div class="whatsapp-message ${isPractitionerMessage ? 'sent' : 'received'}">
                            <div class="whatsapp-message-bubble">
                            ${content}
                                <div class="whatsapp-message-time">
                                    ${messageTime}
                                    ${statusIcon}
                                </div>
                        </div>
                    </div>
                `;
            }).join('');
            }
            
            messagesContainer.innerHTML = html;
            console.log(' HTML set to container, length:', html.length);
            console.log(' Container innerHTML length:', messagesContainer.innerHTML.length);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            console.log(' Scrolled to bottom');
        }
        
        function groupMessagesByDate(messages) {
            const groups = {};
            messages.forEach(message => {
                const date = new Date(message.timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let dateKey;
                if (date.toDateString() === today.toDateString()) {
                    dateKey = 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    dateKey = 'Yesterday';
                } else {
                    dateKey = date.toLocaleDateString();
                }
                
                if (!groups[dateKey]) {
                    groups[dateKey] = [];
                }
                groups[dateKey].push(message);
            });
            return groups;
        }
        
        // WhatsApp-style functions for practitioner dashboard
        function refreshPractitionerMessages() {
            // Add spinning animation to refresh button
            const refreshButton = document.querySelector('.whatsapp-sidebar-actions button[onclick="refreshPractitionerMessages()"]');
            if (refreshButton) {
                refreshButton.classList.add('spinning');
                setTimeout(() => {
                    refreshButton.classList.remove('spinning');
                }, 600); // Remove class after animation completes
            }
            loadConversations();
        }
        
        function triggerPractitionerProfileImageSelect() {
            const input = document.getElementById('practitionerProfileImageInput');
            if (input) {
                input.click();
            }
        }

        
        // WebRTC calling functionality
        let localStream = null;
        let peerConnection = null;
        let isCallActive = false;

        function callClient() {
            if (!currentConversationClient) {
                alert('Please select a client first');
                return;
            }
            
            if (isCallActive) {
                alert('A call is already active');
                return;
            }
            
            startAudioCall();
        }
        
        function videoCallClient() {
            if (!currentConversationClient) {
                alert('Please select a client first');
                return;
            }
            
            if (isCallActive) {
                alert('A call is already active');
                return;
            }
            
            startVideoCall();
        }
        
        async function startAudioCall() {
            try {
                // Request microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
                
                // Create peer connection
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    const remoteStream = event.streams[0];
                    playRemoteAudio(remoteStream);
                };
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // In a real app, you'd send this offer to the client via your messaging system
                console.log('Call offer created:', offer);
                
                isCallActive = true;
                showCallInterface('audio');
                
                // Simulate client accepting the call (in real app, this would come from client)
                setTimeout(() => {
                    simulateClientCallAcceptance();
                }, 2000);
                
            } catch (error) {
                console.error('Error starting call:', error);
                alert('Unable to start call. Please check microphone permissions.');
            }
        }
        
        async function startVideoCall() {
            try {
                // Request camera and microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: true 
                });
                
                // Create peer connection
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    const remoteStream = event.streams[0];
                    playRemoteVideo(remoteStream);
                };
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // In a real app, you'd send this offer to the client via your messaging system
                console.log('Video call offer created:', offer);
                
                isCallActive = true;
                showCallInterface('video');
                
                // Simulate client accepting the call (in real app, this would come from client)
                setTimeout(() => {
                    simulateClientCallAcceptance();
                }, 2000);
                
            } catch (error) {
                console.error('Error starting video call:', error);
                alert('Unable to start video call. Please check camera and microphone permissions.');
            }
        }
        
        function showCallInterface(type) {
            // Create call interface overlay
            const callOverlay = document.createElement('div');
            callOverlay.id = 'callOverlay';
            callOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
            `;
            
            callOverlay.innerHTML = `
                <div style="text-align: center; background: #1a1a1a; padding: 2rem; border-radius: 10px;">
                    <h3>Calling ${currentConversationClient.firstName} ${currentConversationClient.lastName}</h3>
                    <p>${type === 'video' ? 'Video' : 'Audio'} call in progress...</p>
                    <div style="margin: 1rem 0;">
                        <button onclick="endCall()" style="background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            End Call
                        </button>
                    </div>
                    ${type === 'video' ? '<video id="localVideo" autoplay muted style="width: 200px; height: 150px; background: #333;"></video>' : ''}
                </div>
            `;
            
            document.body.appendChild(callOverlay);
            
            // Show local video if it's a video call
            if (type === 'video' && localStream) {
                const localVideo = document.getElementById('localVideo');
                if (localVideo) {
                    localVideo.srcObject = localStream;
                }
            }
        }
        
        function playRemoteAudio(stream) {
            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.volume = 1.0;
            document.body.appendChild(audio);
        }
        
        function playRemoteVideo(stream) {
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.style.cssText = 'width: 200px; height: 150px; background: #333;';
            document.getElementById('callOverlay').querySelector('div').appendChild(video);
        }
        
        function simulateClientCallAcceptance() {
            // In a real app, this would be triggered by the client accepting the call
            console.log('Client accepted the call');
        }
        
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            isCallActive = false;
            
            // Remove call overlay
            const callOverlay = document.getElementById('callOverlay');
            if (callOverlay) {
                callOverlay.remove();
            }
            
            // Notify user that call ended
            const callEnd = {
                type: 'call_end',
                timestamp: new Date().toISOString()
            };
            
            // Store call end notification in localStorage for user to pick up
            const callEvents = JSON.parse(localStorage.getItem('cleartrack_call_events') || '[]');
            callEvents.push(callEnd);
            localStorage.setItem('cleartrack_call_events', JSON.stringify(callEvents));
            
            console.log('Call ended - notification sent to user');
        }
        
        // Incoming call detection and handling
        function checkForIncomingCalls() {
            const callOffers = JSON.parse(localStorage.getItem('cleartrack_call_offers') || '[]');
            if (callOffers.length > 0) {
                const latestOffer = callOffers[callOffers.length - 1];
                if (latestOffer.type === 'call_offer') {
                    showIncomingCall(latestOffer);
                }
            }
        }
        
        function showIncomingCall(callOffer) {
            // Don't show multiple incoming call dialogs
            if (document.getElementById('incomingCallOverlay')) {
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.id = 'incomingCallOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; background: #1a1a1a; padding: 2rem; border-radius: 10px; border: 2px solid #10b981;">
                    <h3> Incoming ${callOffer.callType === 'video' ? 'Video' : 'Audio'} Call</h3>
                    <p>From: ${window.currentConversationClient ? window.currentConversationClient.firstName + ' ' + window.currentConversationClient.lastName : 'Client'}</p>
                    <div style="margin: 1rem 0; display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="acceptCall('${callOffer.callType}')" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Accept
                        </button>
                        <button onclick="rejectCall()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Reject
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function acceptCall(callType) {
            // Remove incoming call overlay
            const overlay = document.getElementById('incomingCallOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Clear call offers
            localStorage.removeItem('cleartrack_call_offers');
            
            // Start the call on practitioner side
            if (callType === 'video') {
                startVideoCall();
            } else {
                startAudioCall();
            }
        }
        
        function rejectCall() {
            // Remove incoming call overlay
            const overlay = document.getElementById('incomingCallOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Clear call offers
            localStorage.removeItem('cleartrack_call_offers');
            
            console.log('Call rejected');
        }
        
        function checkForCallEnd() {
            const callEvents = JSON.parse(localStorage.getItem('cleartrack_call_events') || '[]');
            if (callEvents.length > 0) {
                const latestEvent = callEvents[callEvents.length - 1];
                if (latestEvent.type === 'call_end') {
                    // End call on practitioner side
                    if (isCallActive) {
                        endCall();
                    }
                    // Clear call events
                    localStorage.removeItem('cleartrack_call_events');
                }
            }
        }
        
        
        // Simulate message status updates (like WhatsApp)
        function simulatePractitionerMessageStatusUpdates() {
            // Simulate delivery after 1-2 seconds
            setTimeout(() => {
                updatePractitionerMessageStatus('delivered');
            }, Math.random() * 1000 + 1000);
            
            // Simulate read after 3-5 seconds
            setTimeout(() => {
                updatePractitionerMessageStatus('read');
            }, Math.random() * 2000 + 3000);
        }
        
        function updatePractitionerMessageStatus(status) {
            const messages = document.querySelectorAll('.whatsapp-message.sent');
            const lastMessage = messages[messages.length - 1];
            if (lastMessage) {
                const statusElement = lastMessage.querySelector('.whatsapp-message-status');
                if (statusElement) {
                    if (status === 'delivered') {
                        statusElement.textContent = '';
                        statusElement.className = 'whatsapp-message-status delivered';
                    } else if (status === 'read') {
                        statusElement.textContent = '';
                        statusElement.className = 'whatsapp-message-status read';
                    }
                }
            }
        }
        
        
        // Simple message loading - just like user dashboard
        function loadPractitionerMessages() {
            if (!currentConversationClient || !practitioner) {
                console.log(' Cannot load messages - missing client or practitioner');
                return;
            }
            
            console.log(' Loading messages for:', currentConversationClient.id, practitioner.id);
            // Use same approach as user dashboard
            const messages = cleartrackData.getMessages(currentConversationClient.id, practitioner.id);
            console.log(' Found messages:', messages.length);
            console.log(' Messages:', messages);
            displayConversationMessages(messages);
        }
        
        // Helper functions for file handling
        function openImageModal(imageSrc, fileName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; cursor: pointer;';
            modal.onclick = () => document.body.removeChild(modal);
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
            img.onclick = (e) => e.stopPropagation();
            
            modal.appendChild(img);
            document.body.appendChild(modal);
        }
        
        function downloadFile(fileData, fileName) {
            console.log('Downloading file:', fileName, 'Data type:', typeof fileData);
            
            // If it's already a data URL, use it directly
            if (fileData && fileData.startsWith('data:')) {
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }
            
            // If it's a file path, try to fetch it first
            if (fileData && !fileData.startsWith('http')) {
                fetch(fileData)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('File not found');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(error => {
                        console.error('Error downloading file:', error);
                        alert('Error downloading file. Please try again.');
                    });
                return;
            }
            
            // For HTTP URLs, try to download directly
            if (fileData && fileData.startsWith('http')) {
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }
            
            // Fallback: try to create a data URL from the file data
            try {
                // If fileData looks like base64 content, try to create a data URL
                if (fileData && typeof fileData === 'string' && !fileData.includes(' ')) {
                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    let mimeType = 'application/octet-stream';
                    
                    // Determine MIME type based on file extension
                    switch (fileExtension) {
                        case 'pdf':
                            mimeType = 'application/pdf';
                            break;
                        case 'jpg':
                        case 'jpeg':
                            mimeType = 'image/jpeg';
                            break;
                        case 'png':
                            mimeType = 'image/png';
                            break;
                        case 'gif':
                            mimeType = 'image/gif';
                            break;
                        case 'txt':
                            mimeType = 'text/plain';
                            break;
                        case 'csv':
                            mimeType = 'text/csv';
                            break;
                        case 'doc':
                            mimeType = 'application/msword';
                            break;
                        case 'docx':
                            mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                            break;
                    }
                    
                    const dataUrl = `data:${mimeType};base64,${fileData}`;
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    return;
                }
            } catch (error) {
                console.error('Error creating data URL:', error);
            }
            
            // Final fallback: show error message
            alert('Unable to download file. The file data is not in a supported format.');
        }
        
        // Document preview functionality
        function openDocumentPreview(fileData, fileName) {
            // Debug the document preview
            debugDocumentPreview(fileData, fileName);
            
            const modal = document.createElement('div');
            modal.className = 'document-preview-modal';
            
            // Determine file type and create appropriate content
            const fileExtension = fileName.split('.').pop().toLowerCase();
            let previewContent = '';
            let isPdf = false;
            
            // If fileData looks like a file path, try to convert it to a data URL
            if (fileData && !fileData.startsWith('data:') && !fileData.startsWith('http')) {
                // This might be a file path, try to fetch it
                fetch(fileData)
                    .then(response => response.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onload = function() {
                            const dataUrl = reader.result;
                            // Recreate the modal with the actual file data
                            modal.remove();
                            openDocumentPreview(dataUrl, fileName);
                        };
                        reader.readAsDataURL(blob);
                    })
                    .catch(error => {
                        console.error('Error fetching file:', error);
                        // Fall back to iframe display
                    });
            }
            
            // Check if it's a PDF by extension, content, or MIME type
            const isPdfByExtension = fileExtension === 'pdf';
            const isPdfByContent = fileData && fileData.includes('pdf');
            const isPdfByMimeType = fileData && fileData.includes('data:application/pdf');
            
            if (isPdfByExtension || isPdfByContent || isPdfByMimeType) {
                isPdf = true;
                previewContent = `
                    <div class="document-preview-content pdf-viewer">
                        <iframe src="${fileData}" width="100%" height="600px" frameborder="0" style="border: none; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"></iframe>
                        <div class="pdf-fallback">
                            <div class="no-client-icon">
                                <img src="assets/icons/document.svg" class="icon icon-2xl icon-gray-500" alt="Document">
                            </div>
                            <h3 style="margin: 1rem 0 0.5rem 0; color: #374151;">PDF Preview Not Available</h3>
                            <p style="color: #6b7280; margin: 0;">This PDF cannot be previewed in the browser. Please download it to view.</p>
                        </div>
                    </div>
                `;
            } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                previewContent = `
                    <div class="document-preview-content">
                        <div style="text-align: center;">
                            <img src="${fileData}" alt="${fileName}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                `;
            } else if (['txt', 'csv'].includes(fileExtension)) {
                // Try to display text files
                try {
                    if (fileData.includes('data:text/') || fileData.includes('data:application/')) {
                        const textContent = atob(fileData.split(',')[1]);
                        previewContent = `
                            <div class="document-preview-content">
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 60vh; overflow-y: auto; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                    ${textContent}
                                </div>
                            </div>
                        `;
                    } else {
                        throw new Error('Not a data URL');
                    }
                } catch (e) {
                    previewContent = `
                        <div class="document-preview-content">
                            <div style="text-align: center; padding: 2rem; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                                <div class="no-client-icon">
                                    <img src="assets/icons/document.svg" class="icon icon-2xl icon-gray-500" alt="Document">
                                </div>
                                <p style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">This file type cannot be previewed in the browser.</p>
                                <p class="text-gray-500 text-sm" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">Please download the file to view it.</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                // For other file types, try to display as iframe first
                previewContent = `
                    <div class="document-preview-content">
                        <iframe src="${fileData}" width="100%" height="600px" frameborder="0" style="border: none; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;"></iframe>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="document-preview-overlay" onclick="closeDocumentPreview()">
                    <div class="document-preview-container" onclick="event.stopPropagation()">
                        <div class="document-preview-header">
                            <h3>${fileName}</h3>
                            <button class="close-btn" onclick="closeDocumentPreview()">&times;</button>
                        </div>
                        ${previewContent}
                        <div class="document-preview-footer">
                            <button onclick="downloadFile('${fileData}', '${fileName}')" class="download-btn">Download</button>
                            <button onclick="closeDocumentPreview()" class="close-btn">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add PDF-specific handling
            if (isPdf) {
                const iframe = modal.querySelector('iframe');
                if (iframe) {
                    iframe.onload = function() {
                        // Add a small delay to ensure proper rendering
                        setTimeout(() => {
                            iframe.style.transform = 'scale(0.7)';
                            iframe.style.transformOrigin = 'top left';
                            iframe.style.width = '142.86%';
                            iframe.style.height = '142.86%';
                        }, 100);
                    };
                }
            }
        }
        
        function closeDocumentPreview() {
            const modal = document.querySelector('.document-preview-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // Debug function to help troubleshoot document preview issues
        function debugDocumentPreview(fileData, fileName) {
            console.log('Document Preview Debug Info:');
            console.log('File Name:', fileName);
            console.log('File Data Type:', typeof fileData);
            console.log('File Data Length:', fileData ? fileData.length : 'N/A');
            console.log('File Extension:', fileName.split('.').pop().toLowerCase());
            console.log('Is Data URL:', fileData ? fileData.startsWith('data:') : false);
            console.log('Contains PDF:', fileData ? fileData.includes('pdf') : false);
            console.log('MIME Type:', fileData && fileData.startsWith('data:') ? fileData.split(';')[0] : 'N/A');
        }

        
        function sendPractitionerMessage() {
            const messageText = document.getElementById('practitionerMessageText').value.trim();
            if (!messageText || !currentConversationClient) return;
            
            // Create message data
            const messageData = {
                text: messageText,
                sender: 'practitioner',
                type: 'text',
                timestamp: new Date().toISOString()
            };
            
            console.log(' Sending message:', messageData);
            console.log(' User ID:', currentConversationClient.id);
            console.log(' Practitioner ID:', practitioner.id);
            
            // Store message - same as user dashboard
            const storedMessage = cleartrackData.addMessage(currentConversationClient.id, practitioner.id, messageData);
            console.log(' Message stored:', storedMessage);
            
            // Clear input
                document.getElementById('practitionerMessageText').value = '';
                
            // Reload messages to show the new one
            loadPractitionerMessages();
            
            // Refresh conversations list
                loadConversations();
        }
        
        
        // Mobile keyboard support
        function handleMessageKeydown(event) {
            // Send message on Enter (but allow Shift+Enter for new lines)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendPractitionerMessage();
            }
        }
        
        // Simple emoji picker functions
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const attachmentMenu = document.getElementById('attachmentMenu');
            
            // Close attachment menu if open
            attachmentMenu.style.display = 'none';
            
            if (picker.style.display === 'none') {
                picker.style.display = 'block';
                loadEmojis();
            } else {
                picker.style.display = 'none';
            }
        }
        
        function closeEmojiPicker() {
            document.getElementById('emojiPicker').style.display = 'none';
        }
        
        // WhatsApp-style attachment menu
        function toggleAttachmentMenu() {
            const menu = document.getElementById('attachmentMenu');
            const emojiPicker = document.getElementById('emojiPicker');
            
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                emojiPicker.style.display = 'none';
            } else {
                menu.style.display = 'none';
            }
        }
        
        function closeAttachmentMenu() {
            document.getElementById('attachmentMenu').style.display = 'none';
        }
        
        // Close modals when clicking outside
        function closeAllModals() {
            document.getElementById('attachmentMenu').style.display = 'none';
            document.getElementById('emojiPicker').style.display = 'none';
        }
        
        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }
        
        function loadEmojis() {
            const grid = document.getElementById('emojiGrid');
            if (grid.children.length > 0) return; // Already loaded
            
            const emojis = ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''];
            
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.textContent = emoji;
                button.style.cssText = 'background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.25rem; border-radius: 4px; transition: background-color 0.2s;';
                button.onmouseover = () => button.style.backgroundColor = '#f3f4f6';
                button.onmouseout = () => button.style.backgroundColor = 'transparent';
                button.onclick = () => insertEmoji(emoji);
                grid.appendChild(button);
            });
        }
        
        function insertEmoji(emoji) {
            const textarea = document.getElementById('practitionerMessageText');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + emoji.length, start + emoji.length);
            
            closeEmojiPicker();
        }
        
        // Voice recording functionality
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        
        function startVoiceRecording() {
            if (!currentConversationClient) {
                alert('Please select a client first');
                return;
            }
            
            if (isRecording) {
                stopVoiceRecording();
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendVoiceMessage(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('voiceRecording').style.display = 'block';
                    document.getElementById('voiceButton').innerHTML = '<img src="assets/icons/message.svg" class="icon icon-sm" alt="Voice">';
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    alert('Microphone access denied. Please allow microphone access to record voice notes.');
                });
        }
        
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('voiceRecording').style.display = 'none';
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {
                    voiceButton.innerHTML = '<img src="assets/icons/message.svg" class="icon icon-sm" alt="Voice">';
                }
            }
        }
        
        function sendVoiceMessage(audioBlob) {
            const message = cleartrackData.addMessage(currentConversationClient.id, practitioner.id, {
                text: '[Voice Message]',
                sender: 'practitioner',
                type: 'voice',
                audioData: URL.createObjectURL(audioBlob)
            });
            
            if (message) {
                const messages = cleartrackData.getMessages(currentConversationClient.id, practitioner.id);
                displayConversationMessages(messages);
                loadConversations();
            }
        }
        
        // Simple document sending function
        function handleFileUpload(event) {
            console.log(' File upload triggered!');
            const file = event.target.files[0];
            if (!file) {
                console.log(' No file selected');
                return;
            }
            
            console.log(' File selected:', file.name, file.type, file.size);
            
            if (!currentConversationClient) {
                alert('Please select a client first');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size too large. Please select a file smaller than 10MB.');
                return;
            }
            
            console.log(' Converting file to base64...');
            // Convert file to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log(' File converted to base64');
                const fileData = e.target.result;
                const messageType = file.type.startsWith('image/') ? 'image' : 'document';
                
                console.log(' Creating message with attachment...');
                // Create message with attachment
                const message = cleartrackData.addMessage(currentConversationClient.id, practitioner.id, {
                    text: `[${file.type.startsWith('image/') ? 'Image' : 'Document'}: ${file.name}]`,
                    sender: 'practitioner',
                    type: messageType,
                    fileName: file.name,
                    fileData: fileData,
                    fileType: file.type,
                    fileSize: file.size
                });
                
                if (message) {
                    console.log(' Document sent successfully:', message);
                    loadPractitionerMessages();
                    loadConversations();
                } else {
                    console.error(' Failed to create message');
                }
            };
            reader.onerror = function(error) {
                console.error(' File conversion failed:', error);
            };
            reader.readAsDataURL(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // Test function for document sending
        function testDocumentSending() {
            console.log(' Testing document sending...');
            
            // Create a test file
            const testContent = 'This is a test document content';
            const testFile = new File([testContent], 'test-document.txt', { type: 'text/plain' });
            
            // Create a test event
            const testEvent = {
                target: {
                    files: [testFile],
                    value: ''
                }
            };
            
            console.log(' Test file created:', testFile.name, testFile.type, testFile.size);
            
            // Call the file upload function
            handleFileUpload(testEvent);
        }
        
        // Make test function globally available
        window.testDocumentSending = testDocumentSending;
        
        // Profile image handling - modern, efficient upload with orientation, crop-to-square, resize, and compression
        async function handlePractitionerProfileImageUpload(event) {
            const input = event.target;
            const file = input && input.files && input.files[0];
            if (!file) return;
            
            // Basic validation
            const isImage = file.type && file.type.startsWith('image/');
            if (!isImage) {
                alert('Please select a valid image file (JPEG/PNG/HEIC/WebP).');
                input.value = '';
                return;
            }
            // Hard cap (10MB) with guidance
            const MAX_BYTES = 10 * 1024 * 1024;
            if (file.size > MAX_BYTES) {
                alert('Image is too large. Please choose a file smaller than 10MB.');
                input.value = '';
                return;
            }
            
            try {
                const processedDataUrl = await resizeAndCompressToSquare(file, 512, 0.85);
                // Optional: thumbnail if needed later
                // const thumbDataUrl = await resizeAndCompressToSquare(file, 128, 0.85);
                
                // Update UI instantly
                const profileImg = document.getElementById('practitionerProfileImage');
                const placeholder = document.getElementById('practitionerProfileImagePlaceholder');
                const container = document.getElementById('practitionerProfileImageContainer');
                if (profileImg) {
                    profileImg.src = processedDataUrl;
                    profileImg.style.display = 'block';
                }
                if (placeholder) placeholder.style.display = 'none';
                if (container) {
                    container.classList.add('flash-success');
                    setTimeout(() => container.classList.remove('flash-success'), 900);
                }
                
                // Update modal preview if modal is open
                const modalPreview = document.getElementById('practitionerImagePreview');
                const modalPlaceholder = document.getElementById('practitionerImagePlaceholder');
                const modalContainer = document.getElementById('practitionerImagePreviewContainer');
                if (modalPreview && modalPlaceholder && modalContainer) {
                    modalPreview.src = processedDataUrl;
                    modalPreview.style.display = 'block';
                    modalPlaceholder.style.display = 'none';
                    modalContainer.style.border = '2px solid #0b7285';
                }
                
                // Persist to practitioner data store
                if (practitioner) {
                    practitioner.profileImage = processedDataUrl;
                    cleartrackData.updatePractitioner(practitioner.id, { profileImage: processedDataUrl });
                }
            } catch (err) {
                console.error('Profile image processing failed:', err);
                alert('Could not process the image. Please try a different photo.');
            } finally {
                // Reset input so selecting same file again retriggers change
                input.value = '';
            }
        }

        // Helper: resize and compress to a square canvas with EXIF orientation respected when possible
        async function resizeAndCompressToSquare(file, targetSize, quality) {
            // Prefer createImageBitmap with EXIF orientation support
            const useBitmap = typeof createImageBitmap === 'function';
            let source;
            if (useBitmap) {
                try {
                    source = await createImageBitmap(file, { imageOrientation: 'from-image' });
                } catch (_) {
                    source = await loadHTMLImage(file);
                }
            } else {
                source = await loadHTMLImage(file);
            }
            const width = source.width || source.naturalWidth;
            const height = source.height || source.naturalHeight;
            if (!width || !height) throw new Error('Invalid image dimensions');
            
            // Compute cover crop rect to make a square without distortion (center-crop)
            const srcAspect = width / height;
            const dstSize = targetSize;
            let sx, sy, sw, sh;
            if (srcAspect > 1) {
                // Wider than tall: crop left/right
                sh = height;
                sw = height; // square from height
                sx = (width - sw) / 2;
                sy = 0;
            } else {
                // Taller than wide: crop top/bottom
                sw = width;
                sh = width; // square from width
                sx = 0;
                sy = (height - sh) / 2;
            }
            
            // Draw to canvas at target size
            const canvas = document.createElement('canvas');
            canvas.width = dstSize;
            canvas.height = dstSize;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0, 0, dstSize, dstSize);
            ctx.drawImage(source, sx, sy, sw, sh, 0, 0, dstSize, dstSize);
            
            // Export as high-quality JPEG
            return canvas.toDataURL('image/jpeg', quality);
        }

        function loadHTMLImage(file) {
            return new Promise((resolve, reject) => {
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
                img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
                img.src = url;
            });
        }
        
        function removePractitionerProfileImage() {
            const img = document.getElementById('practitionerProfileImage');
            const placeholder = document.getElementById('practitionerProfileImagePlaceholder');
            const removeBtn = document.getElementById('removePractitionerProfileImage');
            const editBtn = document.getElementById('editPractitionerProfileImage');
            
            img.src = '';
            img.style.display = 'none';
            placeholder.style.display = 'block';
            removeBtn.style.display = 'none';
            editBtn.style.display = 'none';
            
            // Remove from practitioner data
            if (practitioner) {
                practitioner.profileImage = null;
                cleartrackData.updatePractitioner(practitioner.id, {
                    profileImage: null
                });
            }
        }
        
        // Manual message refresh for debugging
        function refreshPractitionerMessages() {
            // Add spinning animation to refresh button
            const refreshButton = document.querySelector('.whatsapp-sidebar-actions button[onclick="refreshPractitionerMessages()"]');
            if (refreshButton) {
                refreshButton.classList.add('spinning');
                setTimeout(() => {
                    refreshButton.classList.remove('spinning');
                }, 600); // Remove class after animation completes
            }
            console.log(' Manual refresh triggered');
            if (window.currentConversationClient) {
                console.log(' Refreshing messages for client:', window.currentConversationClient);
                loadPractitionerMessages();
            } else {
                console.log(' No current conversation client selected');
            }
        }
        
        // Professional practitioner profile image functions - Complete modern implementation
        function openPractitionerProfileImageModal() {
            const modal = document.getElementById('practitionerProfileImageOptionsModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Load current image preview if exists
            const currentImg = document.getElementById('practitionerProfileImage');
            const preview = document.getElementById('practitionerImagePreview');
            const placeholder = document.getElementById('practitionerImagePlaceholder');
            const container = document.getElementById('practitionerImagePreviewContainer');
            
            if (currentImg && currentImg.src && currentImg.style.display !== 'none') {
                preview.src = currentImg.src;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                container.style.border = '2px solid #0b7285';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'block';
                container.style.border = '2px dashed #e5e7eb';
            }
        }
        
        function closePractitionerProfileImageModal() {
            const modal = document.getElementById('practitionerProfileImageOptionsModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function closePractitionerProfileImageModalOnOverlay(event) {
            if (event.target.id === 'practitionerProfileImageOptionsModal') {
                closePractitionerProfileImageModal();
            }
        }
        
        function takePractitionerPhoto() {
            closePractitionerProfileImageModal();
            document.getElementById('practitionerCameraInput').click();
        }
        
        function choosePractitionerPhoto() {
            closePractitionerProfileImageModal();
            document.getElementById('practitionerGalleryInput').click();
        }
        
        function deletePractitionerPhoto() {
            closePractitionerProfileImageModal();
            const currentImg = document.getElementById('practitionerProfileImage');
            if (!currentImg.src || currentImg.style.display === 'none') {
                alert('No profile photo to delete.');
                return;
            }
            if (confirm('Are you sure you want to delete your profile photo?\n\nThis action cannot be undone.')) {
                removePractitionerProfileImage();
                const container = document.getElementById('practitionerProfileImageContainer');
                if (container) {
                    container.classList.remove('flash-success');
                    setTimeout(() => {}, 100);
                }
            }
        }
        
        // Practitioner Image Editor Functions
        let currentPractitionerImageData = null;
        let currentPractitionerRotation = 0;
        let practitionerZoom = 1;
        let isDraggingPractitioner = false;
        let startX, startY, currentX, currentY;
        
        // Practitioner crop functionality variables
        let isPractitionerCropMode = false;
        let isDraggingPractitionerCrop = false;
        let isResizingPractitionerCrop = false;
        let practitionerCropBox = null;
        let practitionerCropStartX, practitionerCropStartY;
        let practitionerCropBoxX = 0, practitionerCropBoxY = 0, practitionerCropBoxWidth = 200, practitionerCropBoxHeight = 200;
        
        // Cropper.js instance for practitioner
        let practitionerCropper = null;

        function editPractitionerProfileImageWithCrop() {
            const currentImg = document.getElementById('practitionerProfileImage');
            if (!currentImg || !currentImg.src || currentImg.style.display === 'none') {
                alert('Please select an image first');
                return;
            }
            
            // Close main modal and open crop modal
            closePractitionerProfileImageModal();
            openPractitionerCropModal(currentImg.src);
        }

        function openPractitionerCropModal(imageSrc) {
            const cropModal = document.getElementById('practitionerCropModal');
            const cropImage = document.getElementById('practitionerCropImage');
            
            cropImage.src = imageSrc;
            cropModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Initialize cropper after image loads
            setTimeout(() => {
                if (practitionerCropper) {
                    practitionerCropper.destroy();
                }
                
                practitionerCropper = new Cropper(cropImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.8,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    responsive: true,
                    background: true,
                    modal: true
                });
            }, 100);
        }

        function closePractitionerCropModal() {
            const cropModal = document.getElementById('practitionerCropModal');
            cropModal.classList.add('hidden');
            document.body.style.overflow = '';
            
            if (practitionerCropper) {
                practitionerCropper.destroy();
                practitionerCropper = null;
            }
        }

        function closePractitionerCropModalOnOverlay(event) {
            if (event.target.id === 'practitionerCropModal') {
                closePractitionerCropModal();
            }
        }

        function savePractitionerCroppedImage() {
            if (!practitionerCropper) {
                alert('Cropper not initialized');
                return;
            }
            
            // Get cropped canvas
            const canvas = practitionerCropper.getCroppedCanvas({
                width: 512,
                height: 512,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            if (!canvas) {
                alert('Error creating cropped image');
                return;
            }
            
            // Convert to blob
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const croppedDataUrl = e.target.result;
                    
                    // Update profile image
                    const profileImg = document.getElementById('practitionerProfileImage');
                    const placeholder = document.getElementById('practitionerProfileImagePlaceholder');
                    const container = document.getElementById('practitionerProfileImageContainer');
                    
                    profileImg.src = croppedDataUrl;
                    profileImg.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                    if (container) {
                        container.classList.add('flash-success');
                        setTimeout(() => container.classList.remove('flash-success'), 900);
                    }
                    
                    // Save to practitioner data
                    if (practitioner) {
                        practitioner.profileImage = croppedDataUrl;
                        cleartrackData.updatePractitioner(practitioner.id, {
                            profileImage: croppedDataUrl
                        });
                    }
                    
                    // Show success
                    showPractitionerSuccess('Image cropped and saved successfully');
                    
                    // Close crop modal
                    closePractitionerCropModal();
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.92);
        }

        function showPractitionerSuccess(message) {
            // Create success overlay
            const successOverlay = document.createElement('div');
            successOverlay.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 32px;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
                animation: scaleIn 0.3s ease;
            `;
            
            successOverlay.innerHTML = `
                <div style="width: 60px; height: 60px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; animation: scaleIn 0.3s ease;">
                    <span style="color: white; font-size: 32px; font-weight: bold;"></span>
                </div>
                <div style="font-size: 16px; font-weight: 600; color: #374151; margin-top: 8px;">${message}</div>
            `;
            
            document.body.appendChild(successOverlay);
            
            setTimeout(() => {
                successOverlay.style.animation = 'scaleIn 0.3s ease reverse';
                setTimeout(() => {
                    if (document.body.contains(successOverlay)) {
                        document.body.removeChild(successOverlay);
                    }
                }, 300);
            }, 2000);
        }

        // Keep old function for backward compatibility but redirect to crop
        function editPractitionerProfileImage() {
            editPractitionerProfileImageWithCrop();
        }
        
        function editPractitionerProfileImageOld() {
            if (!practitioner || !practitioner.profileImage) {
                alert('No image to edit. Please upload an image first.');
                closePractitionerProfileImageModal();
                return;
            }
            closePractitionerProfileImageModal();
            currentPractitionerImageData = practitioner.profileImage;
            currentPractitionerRotation = 0;
            practitionerZoom = 1;
            isPractitionerCropMode = false;
            const modal = document.getElementById('practitionerImageEditorModal');
            if (modal) {
                modal.classList.remove('hidden');
                loadPractitionerImageIntoEditor();
            } else {
                alert('Image editor not available. Please refresh the page.');
            }
        }
        
        // Add drag & drop and paste from clipboard support
        function initializePractitionerProfileImageDragDrop() {
            const container = document.getElementById('practitionerProfileImageContainer');
            if (!container) return;
            
            // Drag & drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                container.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                container.addEventListener(eventName, () => container.classList.add('drag-over'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                container.addEventListener(eventName, () => container.classList.remove('drag-over'), false);
            });
            
            container.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files && files.length > 0) {
                    const file = files[0];
                    if (file.type && file.type.startsWith('image/')) {
                        const input = document.getElementById('practitionerProfileImageInput');
                        if (input) {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            input.files = dataTransfer.files;
                            handlePractitionerProfileImageUpload({ target: input });
                        }
                    }
                }
            }, false);
            
            // Paste from clipboard
            document.addEventListener('paste', (e) => {
                if (document.getElementById('practitionerProfileImageOptionsModal') && !document.getElementById('practitionerProfileImageOptionsModal').classList.contains('hidden')) {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const blob = items[i].getAsFile();
                            const file = new File([blob], 'pasted-image.png', { type: blob.type });
                            const input = document.getElementById('practitionerProfileImageInput');
                            if (input) {
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                input.files = dataTransfer.files;
                                handlePractitionerProfileImageUpload({ target: input });
                            }
                            break;
                        }
                    }
                }
            });
        }
        
        // Initialize drag & drop on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePractitionerProfileImageDragDrop);
        } else {
            initializePractitionerProfileImageDragDrop();
        }
        
        function loadPractitionerImageIntoEditor() {
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Set canvas size - compact to match modal size
                const canvasSize = 350;
                canvas.width = canvasSize;
                canvas.height = canvasSize;
                
                // Calculate image dimensions to fit canvas while maintaining aspect ratio
                const imgAspect = img.width / img.height;
                const canvasAspect = canvasSize / canvasSize;
                
                let drawWidth, drawHeight;
                if (imgAspect > canvasAspect) {
                    // Image is wider than canvas
                    drawWidth = canvasSize;
                    drawHeight = canvasSize / imgAspect;
                } else {
                    // Image is taller than canvas
                    drawHeight = canvasSize;
                    drawWidth = canvasSize * imgAspect;
                }
                
                // Center the image
                const x = (canvasSize - drawWidth) / 2;
                const y = (canvasSize - drawHeight) / 2;
                
                // Clear canvas and draw the image
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, x, y, drawWidth, drawHeight);
                
                // Store original image data for reference
                window.practitionerOriginalImage = img;
                window.practitionerImageX = x;
                window.practitionerImageY = y;
                window.practitionerImageWidth = drawWidth;
                window.practitionerImageHeight = drawHeight;
                
                // Initialize crop functionality
                addPractitionerCropEventListeners();
            };
            
            img.src = currentPractitionerImageData;
        }
        
        function drawPractitionerImage() {
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((currentPractitionerRotation * Math.PI) / 180);
                ctx.scale(practitionerZoom, practitionerZoom);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            };
            
            img.src = currentPractitionerImageData;
        }
        
        function rotatePractitionerImage(degrees) {
            currentPractitionerRotation += degrees;
            
            // Redraw the image with new rotation
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((currentPractitionerRotation * Math.PI) / 180);
                ctx.scale(practitionerZoom, practitionerZoom);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            };
            
            img.src = currentPractitionerImageData;
        }
        
        function zoomPractitionerImage(zoomDelta) {
            const newZoom = practitionerZoom + zoomDelta;
            if (newZoom >= 0.5 && newZoom <= 3) {
                practitionerZoom = newZoom;
                
                // Redraw the image with new zoom
                const canvas = document.getElementById('practitionerImageEditorCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((currentPractitionerRotation * Math.PI) / 180);
            ctx.scale(practitionerZoom, practitionerZoom);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    ctx.restore();
                };
                
                img.src = currentPractitionerImageData;
                updatePractitionerZoomSlider();
            }
        }
        
        function resetPractitionerImage() {
            currentPractitionerRotation = 0;
            practitionerZoom = 1;
            loadPractitionerImageIntoEditor();
            updatePractitionerZoomSlider();
        }

        function setPractitionerZoomFromSlider(value) {
            const normalized = Math.max(50, Math.min(300, Number(value)));
            const target = normalized / 100; // 0.5 - 3.0
            practitionerZoom = target;
            drawPractitionerImage();
        }

        function updatePractitionerZoomSlider() {
            const slider = document.getElementById('practitionerZoomSlider');
            if (slider) slider.value = String(Math.round(practitionerZoom * 100));
        }
        
        function saveEditedPractitionerImage() {
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            const resizedCanvas = document.createElement('canvas');
            const resizedCtx = resizedCanvas.getContext('2d');
            
            // Create high-quality resized version
            const size = 400;
            resizedCanvas.width = size;
            resizedCanvas.height = size;
            
            resizedCtx.imageSmoothingEnabled = true;
            resizedCtx.imageSmoothingQuality = 'high';
            
            if (isPractitionerCropMode) {
                // Crop the image based on crop box
                const sourceX = practitionerCropBoxX;
                const sourceY = practitionerCropBoxY;
                const sourceWidth = practitionerCropBoxWidth;
                const sourceHeight = practitionerCropBoxHeight;
                
                // Draw cropped portion to resized canvas
                resizedCtx.drawImage(
                    canvas,
                    sourceX, sourceY, sourceWidth, sourceHeight,
                    0, 0, size, size
                );
            } else {
                // Use entire image - get the actual image area
                const imageX = window.practitionerImageX || 0;
                const imageY = window.practitionerImageY || 0;
                const imageWidth = window.practitionerImageWidth || canvas.width;
                const imageHeight = window.practitionerImageHeight || canvas.height;
                
                resizedCtx.drawImage(
                    canvas,
                    imageX, imageY, imageWidth, imageHeight,
                    0, 0, size, size
                );
            }
            
            const editedDataUrl = resizedCanvas.toDataURL('image/jpeg', 0.95);
            
            // Update profile image
            const profileImg = document.getElementById('practitionerProfileImage');
            const placeholder = document.getElementById('practitionerProfileImagePlaceholder');
            
            profileImg.src = editedDataUrl;
            profileImg.style.display = 'block';
            placeholder.style.display = 'none';
            const container = document.getElementById('practitionerProfileImageContainer');
            if (container) {
                container.classList.add('flash-success');
                setTimeout(() => container.classList.remove('flash-success'), 900);
            }
            
            // Save to practitioner data
            if (practitioner) {
                practitioner.profileImage = editedDataUrl;
                cleartrackData.updatePractitioner(practitioner.id, {
                    profileImage: editedDataUrl
                });
            }
            
            closePractitionerImageEditor();
        }
        
        function closePractitionerImageEditor() {
            document.getElementById('practitionerImageEditorModal').classList.add('hidden');
        }
        
        // Practitioner crop functionality
        function togglePractitionerCropMode() {
            isPractitionerCropMode = !isPractitionerCropMode;
            const cropOverlay = document.getElementById('practitionerCropOverlay');
            const cropToggleBtn = document.getElementById('practitionerCropToggleBtn');
            
            if (isPractitionerCropMode) {
                cropOverlay.style.pointerEvents = 'auto';
                cropToggleBtn.style.background = '#dc2626';
                cropToggleBtn.title = 'Exit crop';
                initializePractitionerCropBox();
            } else {
                cropOverlay.style.pointerEvents = 'none';
                cropToggleBtn.style.background = 'rgba(17,24,39,0.7)';
                cropToggleBtn.title = 'Toggle crop';
            }
        }
        
        function initializePractitionerCropBox() {
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            
            // Set initial crop box to center of the actual image area
            const imageX = window.practitionerImageX || 0;
            const imageY = window.practitionerImageY || 0;
            const imageWidth = window.practitionerImageWidth || canvas.width;
            const imageHeight = window.practitionerImageHeight || canvas.height;
            
            // Make crop box 80% of the smaller dimension of the image
            const cropSize = Math.min(imageWidth, imageHeight) * 0.8;
            practitionerCropBoxWidth = cropSize;
            practitionerCropBoxHeight = cropSize; // Square crop
            
            // Center crop box within the image area
            practitionerCropBoxX = imageX + (imageWidth - cropSize) / 2;
            practitionerCropBoxY = imageY + (imageHeight - cropSize) / 2;
            
            updatePractitionerCropBox();
        }
        
        function updatePractitionerCropBox() {
            const cropBoxElement = document.getElementById('practitionerCropBox');
            cropBoxElement.style.left = practitionerCropBoxX + 'px';
            cropBoxElement.style.top = practitionerCropBoxY + 'px';
            cropBoxElement.style.width = practitionerCropBoxWidth + 'px';
            cropBoxElement.style.height = practitionerCropBoxHeight + 'px';
        }
        
        // Add event listeners for practitioner crop functionality
        function addPractitionerCropEventListeners() {
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            const cropBoxElement = document.getElementById('practitionerCropBox');
            const cropHandles = document.querySelectorAll('.practitioner-crop-handle');
            
            // Canvas click to move crop box
            canvas.addEventListener('mousedown', function(e) {
                if (!isPractitionerCropMode) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if click is inside crop box
                if (x >= practitionerCropBoxX && x <= practitionerCropBoxX + practitionerCropBoxWidth && 
                    y >= practitionerCropBoxY && y <= practitionerCropBoxY + practitionerCropBoxHeight) {
                    isDraggingPractitionerCrop = true;
                    practitionerCropStartX = x - practitionerCropBoxX;
                    practitionerCropStartY = y - practitionerCropBoxY;
                }
            });
            
            // Crop box drag
            cropBoxElement.addEventListener('mousedown', function(e) {
                if (!isPractitionerCropMode) return;
                e.stopPropagation();
                isDraggingPractitionerCrop = true;
                const rect = canvas.getBoundingClientRect();
                practitionerCropStartX = e.clientX - rect.left - practitionerCropBoxX;
                practitionerCropStartY = e.clientY - rect.top - practitionerCropBoxY;
            });
            
            // Crop handle resize
            cropHandles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    if (!isPractitionerCropMode) return;
                    e.stopPropagation();
                    isResizingPractitionerCrop = true;
                    isDraggingPractitionerCrop = false;
                    
                    const rect = canvas.getBoundingClientRect();
                    practitionerCropStartX = e.clientX - rect.left;
                    practitionerCropStartY = e.clientY - rect.top;
                });
            });
            
            // Mouse move
            document.addEventListener('mousemove', function(e) {
                if (!isPractitionerCropMode) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Get image bounds
                const imageX = window.practitionerImageX || 0;
                const imageY = window.practitionerImageY || 0;
                const imageWidth = window.practitionerImageWidth || canvas.width;
                const imageHeight = window.practitionerImageHeight || canvas.height;
                
                if (isDraggingPractitionerCrop) {
                    // Move crop box within image bounds
                    practitionerCropBoxX = Math.max(imageX, Math.min(imageX + imageWidth - practitionerCropBoxWidth, x - practitionerCropStartX));
                    practitionerCropBoxY = Math.max(imageY, Math.min(imageY + imageHeight - practitionerCropBoxHeight, y - practitionerCropStartY));
                    updatePractitionerCropBox();
                } else if (isResizingPractitionerCrop) {
                    // Resize crop box
                    const deltaX = x - practitionerCropStartX;
                    const deltaY = y - practitionerCropStartY;
                    const newWidth = Math.max(50, practitionerCropBoxWidth + deltaX);
                    const newHeight = Math.max(50, practitionerCropBoxHeight + deltaY);
                    
                    // Keep square aspect ratio
                    const size = Math.min(newWidth, newHeight);
                    practitionerCropBoxWidth = size;
                    practitionerCropBoxHeight = size;
                    
                    // Ensure crop box stays within image bounds
                    if (practitionerCropBoxX + practitionerCropBoxWidth > imageX + imageWidth) {
                        practitionerCropBoxWidth = (imageX + imageWidth) - practitionerCropBoxX;
                        practitionerCropBoxHeight = practitionerCropBoxWidth;
                    }
                    if (practitionerCropBoxY + practitionerCropBoxHeight > imageY + imageHeight) {
                        practitionerCropBoxHeight = (imageY + imageHeight) - practitionerCropBoxY;
                        practitionerCropBoxWidth = practitionerCropBoxHeight;
                    }
                    
                    updatePractitionerCropBox();
                }
            });
            
            // Mouse up
            document.addEventListener('mouseup', function() {
                isDraggingPractitionerCrop = false;
                isResizingPractitionerCrop = false;
            });
        }
        
        // Disconnect a specific client
        function disconnectClient(userId) {
            if (!practitioner) {
                alert('Practitioner not found. Please refresh the page.');
                return;
            }
            
            const user = cleartrackData.getUser(userId);
            if (!user) {
                alert('User not found.');
                return;
            }
            
            if (confirm(`Are you sure you want to disconnect ${user.firstName} ${user.lastName}? This will end your professional relationship.`)) {
                const success = cleartrackData.disconnectUserFromPractitioner(userId);
                
                if (success) {
                    alert(`Successfully disconnected from ${user.firstName} ${user.lastName}.`);
                    loadClients(); // Refresh the clients list
                    updateDashboard(); // Update dashboard statistics
                } else {
                    alert('Error disconnecting from client. Please try again.');
                }
            }
        }
        
        
        
        function updatePractitionerZoomDisplay() {
            // Simple zoom display - no need for complex UI
            console.log('Zoom level:', Math.round(practitionerZoom * 100) + '%');
        }
        
        function rotatePractitionerImage(degrees) {
            currentPractitionerRotation += degrees;
            
            // Redraw the image with new rotation
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((currentPractitionerRotation * Math.PI) / 180);
                ctx.scale(practitionerZoom, practitionerZoom);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            };
            
            img.src = currentPractitionerImageData;
        }
        
        function zoomPractitionerImage(zoomDelta) {
            const newZoom = practitionerZoom + zoomDelta;
            if (newZoom >= 0.5 && newZoom <= 3) {
                practitionerZoom = newZoom;
                drawPractitionerImage();
                updatePractitionerZoomDisplay();
            }
        }
        
        function resetPractitionerImageZoom() {
            practitionerZoom = 1;
            drawPractitionerImage();
            updatePractitionerZoomDisplay();
        }
        
        function zoomPractitionerImage(zoomDelta) {
            const newZoom = practitionerZoom + zoomDelta;
            if (newZoom >= 0.5 && newZoom <= 3) {
                practitionerZoom = newZoom;
                
                // Redraw the image with new zoom
                const canvas = document.getElementById('practitionerImageEditorCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate((currentPractitionerRotation * Math.PI) / 180);
                    ctx.scale(practitionerZoom, practitionerZoom);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    ctx.restore();
                };
                
                img.src = currentPractitionerImageData;
            }
        }
        
        function resetPractitionerImage() {
            currentPractitionerRotation = 0;
            practitionerZoom = 1;
            loadPractitionerImageIntoEditor();
        }
        
        function saveEditedPractitionerImage() {
            const canvas = document.getElementById('practitionerImageEditorCanvas');
            const resizedCanvas = document.createElement('canvas');
            const resizedCtx = resizedCanvas.getContext('2d');
            
            // Create high-quality resized version
            const size = 400;
            resizedCanvas.width = size;
            resizedCanvas.height = size;
            
            resizedCtx.imageSmoothingEnabled = true;
            resizedCtx.imageSmoothingQuality = 'high';
            
            if (isPractitionerCropMode) {
                // Crop the image based on crop box
                const sourceX = practitionerCropBoxX;
                const sourceY = practitionerCropBoxY;
                const sourceWidth = practitionerCropBoxWidth;
                const sourceHeight = practitionerCropBoxHeight;
                
                // Draw cropped portion to resized canvas
                resizedCtx.drawImage(
                    canvas,
                    sourceX, sourceY, sourceWidth, sourceHeight,
                    0, 0, size, size
                );
            } else {
                // Use entire image - get the actual image area
                const imageX = window.practitionerImageX || 0;
                const imageY = window.practitionerImageY || 0;
                const imageWidth = window.practitionerImageWidth || canvas.width;
                const imageHeight = window.practitionerImageHeight || canvas.height;
                
                resizedCtx.drawImage(
                    canvas,
                    imageX, imageY, imageWidth, imageHeight,
                    0, 0, size, size
                );
            }
            
            const editedDataUrl = resizedCanvas.toDataURL('image/jpeg', 0.95);
            
            // Update profile image
            const profileImg = document.getElementById('practitionerProfileImage');
            const placeholder = document.getElementById('practitionerProfileImagePlaceholder');
            
            profileImg.src = editedDataUrl;
            profileImg.style.display = 'block';
            placeholder.style.display = 'none';
            const container2 = document.getElementById('practitionerProfileImageContainer');
            if (container2) {
                container2.classList.add('flash-success');
                setTimeout(() => container2.classList.remove('flash-success'), 900);
            }
            
            // Save to practitioner data
            if (practitioner) {
                practitioner.profileImage = editedDataUrl;
                cleartrackData.updatePractitioner(practitioner.id, {
                    profileImage: editedDataUrl
                });
            }
            
            closePractitionerImageEditor();
        }
        
        function closePractitionerImageEditor() {
            document.getElementById('practitionerImageEditorModal').classList.add('hidden');
        }
        
        // Client Linking Handlers
        function setupClientLinkingHandlers() {
            // Add Client button handler
            const addClientBtn = document.getElementById('add-client-submit-btn');
            if (addClientBtn) {
                addClientBtn.addEventListener('click', async function() {
                    const mobile = document.getElementById('add-client-mobile').value.trim();
                    const clientName = document.getElementById('add-client-name').value.trim();
                    const note = document.getElementById('add-client-note').value.trim();
                    const feedback = document.getElementById('add-client-feedback');
                    
                    if (!mobile) {
                        feedback.innerHTML = '<div class="alert alert-error">Mobile number is required</div>';
                        return;
                    }
                    
                    if (!window.CTClientLinking) {
                        feedback.innerHTML = '<div class="alert alert-error">Client linking module not loaded</div>';
                        return;
                    }
                    
                    try {
                        addClientBtn.disabled = true;
                        addClientBtn.textContent = 'Creating invite...';
                        feedback.innerHTML = '';
                        
                        const result = await window.CTClientLinking.createClientInvite(mobile, clientName || null, note || null);
                        
                        // Show success with code for dev/testing
                        feedback.innerHTML = `<div class="alert alert-success">
                            <strong>Invite created successfully!</strong><br>
                            Code: <strong>${result.code}</strong> (for testing)<br>
                            Expires: ${new Date(result.expiresAt).toLocaleString()}
                        </div>`;
                        
                        // Clear form
                        document.getElementById('add-client-mobile').value = '';
                        document.getElementById('add-client-name').value = '';
                        document.getElementById('add-client-note').value = '';
                    } catch (error) {
                        feedback.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
                    } finally {
                        addClientBtn.disabled = false;
                        addClientBtn.textContent = 'Add client';
                    }
                });
            }
            
            // Load client requests
            loadClientRequests();
            
            // Set up listener for client requests
            if (window.firebaseDb && window.firebaseAuth) {
                window.firebaseAuth.onAuthStateChanged((user) => {
                    if (user) {
                        setupClientRequestsListener(user.uid);
                    }
                });
            }
        }
        
        // Load client requests from Firestore
        async function loadClientRequests() {
            const requestsList = document.getElementById('practitioner-requests-list');
            if (!requestsList || !window.firebaseDb || !window.firebaseAuth) return;
            
            const user = window.firebaseAuth.currentUser;
            if (!user) return;
            
            try {
                const requestsSnapshot = await window.firebaseDb.collection('clientRequests')
                    .where('assignedPractitionerId', '==', user.uid)
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (requestsSnapshot.empty) {
                    requestsList.innerHTML = '<p class="text-muted-center">No new client requests</p>';
                    return;
                }
                
                requestsList.innerHTML = requestsSnapshot.docs.map(doc => {
                    const request = doc.data();
                    return `
                        <div class="card mb-3" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Client ID:</strong> ${request.clientUid || 'N/A'}
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Needs:</strong> ${request.needs ? request.needs.join(', ') : 'None'}
                            </div>
                            ${request.message ? `<div style="margin-bottom: 0.5rem;"><strong>Message:</strong> ${request.message}</div>` : ''}
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-success" onclick="handleAcceptRequest('${doc.id}')">Accept</button>
                                <button class="btn btn-secondary" onclick="handleDeclineRequest('${doc.id}')">Decline</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading client requests:', error);
                requestsList.innerHTML = '<p class="text-muted-center">Error loading requests</p>';
            }
        }
        
        // Set up real-time listener for client requests
        function setupClientRequestsListener(practitionerId) {
            if (!window.firebaseDb) return;
            
            window.firebaseDb.collection('clientRequests')
                .where('assignedPractitionerId', '==', practitionerId)
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    loadClientRequests();
                }, (error) => {
                    console.error('Error setting up client requests listener:', error);
                });
        }
        
        // Handle Accept Request
        async function handleAcceptRequest(requestId) {
            if (!window.CTClientLinking) {
                alert('Client linking module not loaded');
                return;
            }
            
            try {
                await window.CTClientLinking.respondToClientRequest(requestId, 'accept');
                alert('Request accepted! Client has been linked to you.');
                loadClientRequests();
            } catch (error) {
                alert('Error accepting request: ' + error.message);
            }
        }
        
        // Handle Decline Request
        async function handleDeclineRequest(requestId) {
            if (!window.CTClientLinking) {
                alert('Client linking module not loaded');
                return;
            }
            
            if (!confirm('Are you sure you want to decline this request?')) {
                return;
            }
            
            try {
                await window.CTClientLinking.respondToClientRequest(requestId, 'decline');
                alert('Request declined. It will be reassigned to another practitioner.');
                loadClientRequests();
            } catch (error) {
                alert('Error declining request: ' + error.message);
            }
        }
        
    </script>

    <!-- Practitioner Profile Image Options Modal - Premium Version -->
    <div id="practitionerProfileImageOptionsModal" class="modal-overlay hidden" onclick="closePractitionerProfileImageModalOnOverlay(event)">
        <div class="modal" style="max-width: 500px; width: 90%;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile Picture</h3>
                <button onclick="closePractitionerProfileImageModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Info Banner -->
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 1px solid #93c5fd; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <div style="font-size: 14px; font-weight: 600; color: #1e40af; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        Image Requirements
                    </div>
                    <div style="font-size: 13px; color: #1e3a8a; line-height: 1.5;">
                        For best results, use a square image (1:1 ratio) at least 400x400 pixels. 
                        Supported formats: JPG, PNG, WebP. Max file size: 5MB.
                    </div>
                </div>

                <!-- Image Preview -->
                <div style="margin-bottom: 24px;">
                    <div id="practitionerImagePreviewContainer" style="position: relative; width: 100%; max-width: 300px; margin: 0 auto 16px; border-radius: 12px; overflow: hidden; background: #f9fafb; border: 2px dashed #e5e7eb; aspect-ratio: 1; display: flex; align-items: center; justify-content: center;">
                        <div id="practitionerImagePlaceholder" style="text-align: center; color: #9ca3af; padding: 40px 20px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; margin-bottom: 12px; opacity: 0.5;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <div>No image selected</div>
                        </div>
                        <img id="practitionerImagePreview" src="" alt="Preview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: grid; gap: 12px;">
                    <button onclick="takePractitionerPhoto()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; font-weight: 500; color: #374151; text-align: left;" onmouseover="this.style.borderColor='#0b7285'; this.style.background='#f0fdfa'; this.style.transform='translateX(4px)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'; this.style.transform='translateX(0)';">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 6px; flex-shrink: 0;">
                                <img src="assets/icons/camera.svg" class="icon" alt="Camera" style="width: 16px; height: 16px;">
                            </div>
                            <span>Take Photo</span>
                        </div>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>

                    <button onclick="choosePractitionerPhoto()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; font-weight: 500; color: #374151; text-align: left;" onmouseover="this.style.borderColor='#0b7285'; this.style.background='#f0fdfa'; this.style.transform='translateX(4px)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'; this.style.transform='translateX(0)';">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 6px; flex-shrink: 0;">
                                <img src="assets/icons/gallery.svg" class="icon" alt="Gallery" style="width: 16px; height: 16px;">
                            </div>
                            <span>Choose from Gallery</span>
                        </div>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>

                    <button onclick="editPractitionerProfileImageWithCrop()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; font-weight: 500; color: #374151; text-align: left;" onmouseover="this.style.borderColor='#0b7285'; this.style.background='#f0fdfa'; this.style.transform='translateX(4px)';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'; this.style.transform='translateX(0)';">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 6px; flex-shrink: 0;">
                                <img src="assets/icons/edit.svg" class="icon" alt="Edit" style="width: 16px; height: 16px;">
                            </div>
                            <span>Edit Image</span>
                        </div>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>

                    <button onclick="deletePractitionerPhoto()" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: white; border: 2px solid #fee2e2; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; font-weight: 500; color: #dc2626; text-align: left;" onmouseover="this.style.borderColor='#dc2626'; this.style.background='#fef2f2'; this.style.transform='translateX(4px)';" onmouseout="this.style.borderColor='#fee2e2'; this.style.background='white'; this.style.transform='translateX(0)';">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #fee2e2; border-radius: 6px; flex-shrink: 0;">
                                <img src="assets/icons/trash.svg" class="icon" alt="Trash" style="width: 16px; height: 16px;">
                            </div>
                            <span>Delete Photo</span>
                        </div>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.4">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Practitioner Crop Modal -->
    <div id="practitionerCropModal" class="modal-overlay hidden" onclick="closePractitionerCropModalOnOverlay(event)">
        <div class="modal" style="max-width: 600px; width: 90%;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Crop Image</h3>
                <button onclick="closePractitionerCropModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div style="width: 100%; max-height: 400px; background: #f9fafb; border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
                    <img id="practitionerCropImage" src="" alt="Crop" style="max-width: 100%; display: block;">
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button onclick="closePractitionerCropModal()" style="padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: #e5e7eb; color: #374151;" onmouseover="this.style.background='#d1d5db';" onmouseout="this.style.background='#e5e7eb';">Cancel</button>
                    <button onclick="savePractitionerCroppedImage()" style="padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: #0b7285; color: white;" onmouseover="this.style.background='#095a69';" onmouseout="this.style.background='#0b7285';">Save Crop</button>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Scripts -->
    <script src="messaging-service.js"></script>
    <script>
        // Initialize messaging service - DISABLED FOR FILE:// PROTOCOL
        // This will be initialized after practitioner is available
        let messagingService = null;
        
        // Initialize practitioner data after messaging service setup
        if (typeof practitioner !== 'undefined' && practitioner && practitioner.id) {
            console.log(' Practitioner object available:', practitioner);
            // Store practitioner info in localStorage for messaging service
            localStorage.setItem('current_practitioner', JSON.stringify(practitioner));
            
            // Load connected users
            const connectedUsers = cleartrackData.getConnectedUsers(practitioner.id);
            console.log(' Connected users:', connectedUsers);
        } else {
            console.warn(' Practitioner object not available during initialization');
        }
        
        // Event listeners moved outside DOMContentLoaded to ensure they're always available
    </script>
    
    <!-- Simple polling for real-time updates -->
    <script>
        // Simple polling for real-time updates
        setInterval(function() {
            if (window.practitioner && window.loadConversations) {
                // Refresh conversations to update sidebar
                window.loadConversations();
                
                // Load messages if a client is selected
                if (window.currentConversationClient && window.loadPractitionerMessages) {
                    window.loadPractitionerMessages();
                }
            }
        }, 2000); // Check every 2 seconds
    </script>

    <!-- Practitioner Image Editor Modal -->
    <div id="practitionerImageEditorModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px; width: 90%;">
            <div class="modal-header">
                <h3>Edit Profile Image</h3>
                <button onclick="closePractitionerImageEditor()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 0.75rem; position: relative;">
                    <div id="practitionerImageEditorContainer" style="position: relative; display: inline-block; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; max-width: 100%;">
                        <!-- Compact overlay toolbar -->
                        <div style="position: absolute; top: 6px; right: 6px; display: flex; gap: 4px; z-index: 3;">
                            <button title="Rotate left" onclick="rotatePractitionerImage(-90)" style="width:32px;height:32px;border:none;border-radius:16px;background:rgba(17,24,39,0.7);color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;"></button>
                            <button title="Rotate right" onclick="rotatePractitionerImage(90)" style="width:32px;height:32px;border:none;border-radius:16px;background:rgba(17,24,39,0.7);color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;"></button>
                            <button id="practitionerCropToggleBtn" title="Toggle crop" onclick="togglePractitionerCropMode()" style="width:32px;height:32px;border:none;border-radius:16px;background:rgba(17,24,39,0.7);color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;"></button>
                        </div>
                        <canvas id="practitionerImageEditorCanvas" style="display: block; cursor: move; max-width: 100%; height: auto;"></canvas>
                        <div id="practitionerCropOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                            <div id="practitionerCropBox" style="position: absolute; border: 2px solid #0b7285; background: rgba(11, 114, 133, 0.12); cursor: move;">
                                <div class="practitioner-crop-handle practitioner-crop-handle-nw" style="position: absolute; top: -4px; left: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: nw-resize;"></div>
                                <div class="practitioner-crop-handle practitioner-crop-handle-ne" style="position: absolute; top: -4px; right: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: ne-resize;"></div>
                                <div class="practitioner-crop-handle practitioner-crop-handle-sw" style="position: absolute; bottom: -4px; left: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: sw-resize;"></div>
                                <div class="practitioner-crop-handle practitioner-crop-handle-se" style="position: absolute; bottom: -4px; right: -4px; width: 8px; height: 8px; background: #0b7285; border: 2px solid white; border-radius: 50%; cursor: se-resize;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Compact zoom slider -->
                <div style="display:flex;align-items:center;gap:6px;justify-content:center;margin: 0.5rem 0;">
                    <span style="color:#6b7280;font-size:0.75rem;min-width:35px;">Zoom</span>
                    <input id="practitionerZoomSlider" type="range" min="50" max="300" value="100" oninput="setPractitionerZoomFromSlider(this.value)" style="flex: 1; max-width: 180px; height: 4px;">
                </div>
                <!-- Action buttons -->
                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                    <button onclick="closePractitionerImageEditor()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>
                    <button onclick="saveEditedPractitionerImage()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>

    <!-- My Firebase wiring -->
    <script src="firebase-config.js"></script>
    <script src="firebase-init.js"></script>
    <script src="firebase-api.js"></script>
    <script src="js/client-linking.js"></script>
    <script src="dashboard-auth.js"></script>
    
    <!-- Cropper.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
    
    <!-- Keyboard shortcuts for modals -->
    <script>
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const cropModal = document.getElementById('practitionerCropModal');
                const profileModal = document.getElementById('practitionerProfileImageOptionsModal');
                if (cropModal && !cropModal.classList.contains('hidden')) {
                    closePractitionerCropModal();
                } else if (profileModal && !profileModal.classList.contains('hidden')) {
                    closePractitionerProfileImageModal();
                }
            }
        });
    </script>
</body>
</html>

