<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ClearTrack - Get Started</title>
    <link rel="icon" type="image/png" href="assets/images/icon%20logo.png">
    <link rel="stylesheet" href="global-styles.css">
    <link rel="stylesheet" href="/css/ct-theme.css" />
    <link rel="stylesheet" href="/header-responsive-fixes.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f7fa;
            color: #1f2933;
            margin: 0;
        }
        
        /* Style 6: Compact Dropdown (Minimal) - Clean Implementation */
        header {
            background: #0b7285;
            color: #fff;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
        }

        .brand {
            font-weight: 700;
            letter-spacing: 0.04em;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .brand img {
            height: 35px;
            max-width: 100%;
            width: auto;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        /* Style 6: Hamburger menu button */
        .menu-toggle-style6 {
            background: transparent;
            border: none;
            color: #e0fbff;
            cursor: pointer;
            font-size: 1.3rem;
            display: none;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: transform 0.3s ease;
        }

        .menu-toggle-style6:hover {
            transform: scale(1.1);
        }

        .menu-toggle-style6.active {
            transform: rotate(90deg);
        }

        /* Style 6: Navigation - Desktop (visible by default) */
        nav.nav-style6 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        nav.nav-style6 a {
            color: #e0fbff;
            font-size: 0.95rem;
            text-decoration: none;
            white-space: nowrap;
            padding: 0.25rem 0.5rem;
        }

        nav.nav-style6 a:hover {
            text-decoration: underline;
        }

        /* Desktop: Hide hamburger, show nav */
        @media (min-width: 769px) {
            .menu-toggle-style6 {
                display: none;
            }

            nav.nav-style6 {
                display: flex;
                position: static;
                background: transparent;
                border-radius: 0;
                box-shadow: none;
                min-width: auto;
                max-height: none;
                opacity: 1;
                flex-direction: row;
                gap: 0.75rem;
                overflow: visible;
                z-index: auto;
            }

            nav.nav-style6 a {
                color: #e0fbff;
                font-size: 0.95rem;
                text-decoration: none;
                white-space: nowrap;
                padding: 0.25rem 0.5rem;
                display: inline-block;
                width: auto;
            }

            nav.nav-style6 a:hover {
                text-decoration: underline;
                background: transparent;
                padding-left: 0.5rem;
            }
        }

        /* Mobile: Show hamburger, nav as dropdown */
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            .brand img {
                height: 30px;
            }

            .menu-toggle-style6 {
                display: flex;
            }

            /* Style 6: Nav as dropdown - exactly like demo */
            nav.nav-style6 {
                position: absolute;
                top: calc(100% + 0.5rem);
                right: 1.5rem;
                background: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                min-width: 220px;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease, opacity 0.3s ease;
                opacity: 0;
                z-index: 1000;
                display: block;
                flex-direction: initial;
                align-items: initial;
                gap: 0;
                flex-wrap: initial;
            }

            nav.nav-style6.active {
                max-height: 400px;
                opacity: 1;
            }

            nav.nav-style6 a {
                color: #1f2933;
                text-decoration: none;
                padding: 0.75rem 1.25rem;
                display: block;
                font-size: 0.95rem;
                transition: all 0.2s;
                border: none;
                margin: 0;
                width: 100%;
                box-sizing: border-box;
            }

            nav.nav-style6 a:hover {
                background: #f5f7fa;
                color: #0b7285;
                padding-left: 1.5rem;
            }

            nav.nav-style6 a:first-child {
                border-radius: 12px 12px 0 0;
            }

            nav.nav-style6 a:last-child {
                border-radius: 0 0 12px 12px;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 0.75rem;
            }

            .brand img {
                height: 28px;
            }

            nav.nav-style6 {
                right: 0.75rem;
                min-width: 200px;
            }
        }
        
        main {
            max-width: 800px;
            margin: 0 auto;
            padding: clamp(1.5rem, 4vw, 2rem) clamp(1rem, 3vw, 1.5rem) clamp(2rem, 5vw, 3rem);
            width: 100%;
            box-sizing: border-box;
        }
        
        .onboarding-card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            padding: clamp(1.25rem, 4vw, 2rem);
            margin-bottom: 2rem;
        }
        
        .onboarding-card h2 {
            color: #0b7285;
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: clamp(1.5rem, 5vw, 2rem);
            line-height: 1.2;
            font-weight: 700;
        }
        
        .onboarding-card > p {
            font-size: clamp(0.95rem, 2.5vw, 1.05rem);
            line-height: 1.5;
            color: #6b7280;
            margin-bottom: 2rem;
        }
        
        .onboarding-section {
            margin-top: 2.5rem;
            padding-top: 2.5rem;
            border-top: 2px solid #e5e7eb;
        }
        
        .onboarding-section:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }
        
        .onboarding-section h3 {
            font-size: clamp(1.25rem, 3.5vw, 1.5rem);
            margin-bottom: 0.75rem;
            color: #111827;
            font-weight: 600;
        }
        
        .onboarding-section > p {
            font-size: clamp(0.9rem, 2vw, 0.95rem);
            color: #6b7280;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .form-group {
            margin-bottom: clamp(1.25rem, 3vw, 1.5rem);
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334e68;
            font-size: clamp(0.85rem, 2vw, 0.9rem);
        }
        
        .form-control {
            width: 100%;
            box-sizing: border-box;
            padding: clamp(0.625rem, 2vw, 0.75rem);
            border: 1px solid #cbd2e1;
            border-radius: 8px;
            font-size: clamp(0.9rem, 2.5vw, 0.95rem);
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #0b7285;
            box-shadow: 0 0 0 3px rgba(11, 114, 133, 0.1);
        }
        
        .form-control:focus {
            outline: none;
            border-color: #0b7285;
            box-shadow: 0 0 0 3px rgba(11, 114, 133, 0.1);
        }
        
        #onboarding-questionnaire-section .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        #onboarding-questionnaire-section .checkbox-label {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            padding: 0.625rem 0.875rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
            gap: 0.625rem;
            width: 100%;
        }
        
        #onboarding-questionnaire-section .checkbox-label:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        #onboarding-questionnaire-section .checkbox-input {
            width: 16px !important;
            height: 16px !important;
            cursor: pointer;
            accent-color: #0b7285;
            flex-shrink: 0;
            margin: 0 !important;
            display: inline-block !important;
            vertical-align: middle;
        }
        
        #onboarding-questionnaire-section .checkbox-label:has(input:checked) {
            background: #ffffff;
            border-color: #0b7285;
        }
        
        #onboarding-questionnaire-section .attachment-text {
            font-size: 0.9rem;
            color: #374151;
            user-select: none;
            line-height: 1.4;
            display: inline-block;
            vertical-align: middle;
        }
        
        .btn {
            padding: clamp(0.75rem, 2vw, 0.875rem) clamp(1.5rem, 4vw, 2rem);
            border: none;
            border-radius: 8px;
            font-size: clamp(0.95rem, 2.5vw, 1rem);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .btn-primary {
            background: #0b7285;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #095a69;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }
        
        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }
        
        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .mt-3 {
            margin-top: 1rem;
        }
        
        @media (max-width: 768px) {
            main {
                padding: clamp(1.5rem, 4vw, 2rem) clamp(1rem, 3vw, 1.5rem) clamp(2rem, 5vw, 3rem);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand"><img src="assets/images/full%20logo%20CT.png" alt="ClearTrack Logo" style="height:40px; filter: brightness(0) invert(1);"></div>
        <button class="menu-toggle-style6" aria-label="Toggle menu" id="menuToggle">â˜°</button>
        <nav class="nav-style6" id="mainNav">
            <a href="#" id="logoutLink">Logout</a>
        </nav>
    </header>
    
    <main>
        <div class="onboarding-card">
            <h2>Welcome to ClearTrack</h2>
            <p>Please connect with your practitioner to get started.</p>
            
            <!-- Option A: questionnaire -->
            <section id="onboarding-questionnaire-section" class="onboarding-section">
                <h3>New to ClearTrack?</h3>
                <p>Tell us a bit about your situation so we can match you with the right practitioner.</p>
                
                <div class="form-group">
                    <label>Select what applies to you:</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Individual Tax Returns" class="checkbox-input" />
                            <span class="attachment-text">Individual Tax Returns</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Small Business Tax" class="checkbox-input" />
                            <span class="attachment-text">Small Business Tax</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="SARS Compliance" class="checkbox-input" />
                            <span class="attachment-text">SARS Compliance</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Corporate Tax" class="checkbox-input" />
                            <span class="attachment-text">Corporate Tax</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Tax Planning" class="checkbox-input" />
                            <span class="attachment-text">Tax Planning</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="VAT Returns" class="checkbox-input" />
                            <span class="attachment-text">VAT Returns</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Payroll Tax" class="checkbox-input" />
                            <span class="attachment-text">Payroll Tax</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Tax Audits" class="checkbox-input" />
                            <span class="attachment-text">Tax Audits</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Estate Planning" class="checkbox-input" />
                            <span class="attachment-text">Estate Tax</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" data-need-tag="Dispute" class="checkbox-input" />
                            <span class="attachment-text">Disputes / Verifications</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="onboarding-questionnaire-message">Anything else we should know? (Optional)</label>
                    <textarea id="onboarding-questionnaire-message" placeholder="Optional message to your practitioner" class="form-control" rows="4"></textarea>
                </div>
                
                <button id="onboarding-questionnaire-submit-btn" class="btn btn-primary">Send Request</button>
                <div id="onboarding-questionnaire-feedback" class="mt-3"></div>
            </section>
        </div>
    </main>

    <!-- Firebase SDKs (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>

    <!-- My Firebase wiring -->
    <script src="firebase-config.js"></script>
    <script src="firebase-init.js"></script>
    <script src="firebase-api.js"></script>
    <script src="js/client-linking.js"></script>
    <!-- Note: dashboard-auth.js is NOT included here to avoid conflicts -->
    
    <script>
        // Setup handlers immediately - no auth check on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Setup handlers right away so form works
            setupOnboardingHandlers();
            
            // Check auth status in background (non-blocking) after page is fully loaded
            // This allows the page to stay visible for styling/testing
            window.addEventListener('load', function() {
                setTimeout(() => {
                    checkAuthStatusBackground();
                }, 2000); // Wait 2 seconds after page load
            });
        });
        
        // Background auth check - only redirects if absolutely necessary
        async function checkAuthStatusBackground() {
            try {
                if (!window.firebaseAuth) {
                    console.log('Firebase not ready - page will work without auth check');
                    return;
                }
                
                // Check if user is logged in
                const currentUser = window.firebaseAuth.currentUser;
                
                if (!currentUser) {
                    // Not logged in - but don't redirect immediately
                    // Let them see the page, they'll be redirected when they try to submit
                    console.log('User not logged in - will redirect on form submission');
                    return;
                }
                
                // User is logged in - check if they already have practitioner
                if (!window.firebaseDb) {
                    return;
                }
                
                const userDoc = await window.firebaseDb.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const practitionerId = userData.practitionerId || userData.connectedPractitioner || null;
                    
                    if (practitionerId) {
                        // Already linked - redirect to dashboard
                        console.log('User already has practitioner, redirecting to dashboard');
                        window.location.href = '/user-dashboard.html';
                        return;
                    }
                }
                
                // Setup real-time listener for when practitioner gets linked
                setupPractitionerIdListener(currentUser.uid);
            } catch (error) {
                console.error('Error in background auth check:', error);
                // Don't redirect on error
            }
        }
        
        // Set up real-time listener for practitionerId changes
        function setupPractitionerIdListener(uid) {
            if (!window.firebaseDb) return;
            
            const userRef = window.firebaseDb.collection('users').doc(uid);
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    const practitionerId = userData.practitionerId || userData.connectedPractitioner || null;
                    
                    // If practitioner was just linked, redirect to dashboard
                    if (practitionerId && userData.role === 'client') {
                        window.location.href = '/user-dashboard.html';
                    }
                }
            }, (error) => {
                console.error('Error setting up practitionerId listener:', error);
            });
        }
        
        // Setup onboarding handlers
        function setupOnboardingHandlers() {
            // Questionnaire handler
            const questionnaireBtn = document.getElementById('onboarding-questionnaire-submit-btn');
            const questionnaireFeedback = document.getElementById('onboarding-questionnaire-feedback');
            const questionnaireMessage = document.getElementById('onboarding-questionnaire-message');
            
            if (questionnaireBtn) {
                questionnaireBtn.addEventListener('click', async () => {
                    // Check auth before submitting
                    if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                        questionnaireFeedback.innerHTML = '<div class="alert alert-error">Please log in first. Redirecting to login page...</div>';
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                        return;
                    }
                    
                    questionnaireFeedback.innerHTML = '';
                    
                    if (!window.CTClientLinking) {
                        questionnaireFeedback.innerHTML = '<div class="alert alert-error">Client linking module not loaded</div>';
                        return;
                    }
                    
                    const needCheckboxes = document.querySelectorAll('#onboarding-questionnaire-section input[type="checkbox"][data-need-tag]');
                    const needs = Array.from(needCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.getAttribute('data-need-tag'))
                        .filter(tag => tag); // Filter out any null/empty values
                    
                    if (needs.length === 0) {
                        questionnaireFeedback.innerHTML = '<div class="alert alert-error">Please select at least one option</div>';
                        return;
                    }
                    
                    const message = questionnaireMessage ? questionnaireMessage.value.trim() : '';
                    
                    try {
                        questionnaireBtn.disabled = true;
                        questionnaireBtn.textContent = 'Sending...';
                        
                        await window.CTClientLinking.createClientRequest(needs, message);
                        
                        questionnaireFeedback.innerHTML = '<div class="alert alert-success">Request sent successfully! A practitioner will review and accept your request. You will be redirected to your dashboard once connected.</div>';
                        questionnaireBtn.disabled = false;
                        questionnaireBtn.textContent = 'Send Request';
                        
                        // Optionally redirect after a delay, or wait for practitioner to accept
                        // For now, we'll let them know to wait
                    } catch (err) {
                        questionnaireFeedback.innerHTML = `<div class="alert alert-error">${err.message || 'Could not send request. Please try again.'}</div>`;
                        questionnaireBtn.disabled = false;
                        questionnaireBtn.textContent = 'Send Request';
                    }
                });
            }
        }

        // Style 6: Compact Dropdown Menu Toggle - Clean Implementation
        (function() {
            const menuToggle = document.getElementById("menuToggle");
            const mainNav = document.getElementById("mainNav");

            if (menuToggle && mainNav) {
                function toggleMenu() {
                    mainNav.classList.toggle('active');
                    menuToggle.classList.toggle('active');
                }

                menuToggle.addEventListener("click", function(e) {
                    e.stopPropagation();
                    toggleMenu();
                });

                // Close menu when clicking on a link
                const navLinks = mainNav.querySelectorAll("a");
                navLinks.forEach(function(link) {
                    link.addEventListener("click", function() {
                        mainNav.classList.remove('active');
                        menuToggle.classList.remove('active');
                    });
                });

                // Close menu when clicking outside (Style 6 dropdown)
                document.addEventListener('click', function(event) {
                    const header = document.querySelector("header");
                    if (mainNav.classList.contains('active')) {
                        if (header && !header.contains(event.target)) {
                            mainNav.classList.remove('active');
                            menuToggle.classList.remove('active');
                        }
                    }
                });
            }

            // Logout handler
            const logoutLink = document.getElementById("logoutLink");
            if (logoutLink) {
                logoutLink.addEventListener("click", async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    try {
                        // Check if Firebase Auth is available
                        if (window.firebaseAuth) {
                            await window.firebaseAuth.signOut();
                        }
                        
                        // Clear any local storage
                        localStorage.removeItem('token');
                        localStorage.removeItem('firebaseUser');
                        
                        // Redirect to index page
                        window.location.href = '/index.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        // Still redirect even if logout fails
                        window.location.href = '/index.html';
                    }
                });
            }
        })();
    </script>
</body>
</html>

